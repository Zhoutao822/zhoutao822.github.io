<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android-Q适配-存储方式 | Tao's Notes</title><meta name=keywords content="Android Q"><meta name=description content="Android Q之后对系统存储方式进行了调整，简而言之就是禁止开发人员随意通过路径访问操作外部存储文件，内部存储没有影响。这样做的目的很明显，即往后原生Android的文件管理器将不会出现各种App生成的乱七八糟的文件，不同类型的文件都在其各自相应的位置。"><meta name=author content="Me"><link rel=canonical href=https://zhoutao822.github.io/posts/saf/><meta name=google-site-verification content="Tao"><meta name=yandex-verification content="Tao"><meta name=msvalidate.01 content="Tao"><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://zhoutao822.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zhoutao822.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zhoutao822.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zhoutao822.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zhoutao822.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.103.1"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Android-Q适配-存储方式"><meta property="og:description" content="Android Q之后对系统存储方式进行了调整，简而言之就是禁止开发人员随意通过路径访问操作外部存储文件，内部存储没有影响。这样做的目的很明显，即往后原生Android的文件管理器将不会出现各种App生成的乱七八糟的文件，不同类型的文件都在其各自相应的位置。"><meta property="og:type" content="article"><meta property="og:url" content="https://zhoutao822.github.io/posts/saf/"><meta property="og:image" content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-26T11:02:06+08:00"><meta property="article:modified_time" content="2019-10-26T11:02:06+08:00"><meta property="og:site_name" content="Tao's Notes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Android-Q适配-存储方式"><meta name=twitter:description content="Android Q之后对系统存储方式进行了调整，简而言之就是禁止开发人员随意通过路径访问操作外部存储文件，内部存储没有影响。这样做的目的很明显，即往后原生Android的文件管理器将不会出现各种App生成的乱七八糟的文件，不同类型的文件都在其各自相应的位置。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zhoutao822.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Android-Q适配-存储方式","item":"https://zhoutao822.github.io/posts/saf/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android-Q适配-存储方式","name":"Android-Q适配-存储方式","description":"Android Q之后对系统存储方式进行了调整，简而言之就是禁止开发人员随意通过路径访问操作外部存储文件，内部存储没有影响。这样做的目的很明显，即往后原生Android的文件管理器将不会出现各种App生成的乱七八糟的文件，不同类型的文件都在其各自相应的位置。","keywords":["Android Q"],"articleBody":"Android Q之后对系统存储方式进行了调整，简而言之就是禁止开发人员随意通过路径访问操作外部存储文件，内部存储没有影响。这样做的目的很明显，即往后原生Android的文件管理器将不会出现各种App生成的乱七八糟的文件，不同类型的文件都在其各自相应的位置。\n示意图如下，主要行为变更在媒体文件（音频、视频、图片）以及下载文件中\n1. SAF框架 SAF（Storage Access Framework，存储访问框架），是Android 4.4之后提供的文件选择器，通过Intent方式启动，UI界面由系统提供，一般来说其他厂商魔改的系统都没有对这方面进行重写，所以示意图基本相同，如下\n1.1 外部存储 如果应用有发送文件、选择文件等功能，特别是需要读取系统文件目录的方法都需要修改，在target Q的情况下，试图通过路径访问外部公共文件的方式都会失效，如下所示，因此需要使用SAF框架选取文件，得到的结果是文件的Uri，然后再使用Uri读取或者处理该文件，外部存储路径如果打印出来类似/storage/emulated/0/Android/data/us.zoom.androidqdemo/files/aabb.rar、/storage/emulated/0/Pictures/Screenshots/Screenshot_20191014-141713.png，前者是当前应用的外部路径（可以直接访问），后者是公共图片文件下外部路径；内部路径类似/data/user/0/us.zoom.androidqdemo/data/aabb.png，内部路径无法直接在系统中查看。\n// 在手机外部存储根目录下创建text.txt文件，在Android P上可以成功创建此文件并写入数据，file.exists()返回True； // 在Android Q上无法创建此文件，返回False String filename = \"text.txt\"; File file = new File(Environment.getExternalStorageDirectory(), filename); // File file = new File(getFilesDir(), filename); //如果是内部存储，则两者都是正常访问 // File file = new File(getExternalFilesDir(\"\"), filename); // 外部存储的当前应用路径可以正常访问 try { FileOutputStream outputStream = new FileOutputStream(file); outputStream.write(\"123456\".getBytes()); outputStream.close(); } catch (Exception e) { e.printStackTrace(); } Toast.makeText(this, file.exists() ? \"True\" : \"False\", Toast.LENGTH_SHORT).show(); // 同理对读文件，Android P上可以读取text.txt内容，并且file.exists()返回True；Android Q上FileInputStream报错： // 无法访问，拒绝权限，但是file.exists()返回true String filename = \"text.txt\"; File file = new File(Environment.getExternalStorageDirectory(), filename); // File file = new File(getFilesDir(), filename); //如果是内部存储，则两者都是正常访问 // File file = new File(getExternalFilesDir(\"\"), filename); // 外部存储的当前应用路径可以正常访问 try { FileInputStream inputStream = new FileInputStream(file); InputStreamReader reader = new InputStreamReader(inputStream); BufferedReader br = new BufferedReader(reader); String line = \"\"; line = br.readLine(); while (line != null) { Log.i(\"TestRead\", line); line = br.readLine(); // 一次读入一行数据 } } catch (Exception e) { e.printStackTrace(); } Toast.makeText(this, file.exists() ? \"True\" : \"False\", Toast.LENGTH_SHORT).show(); 1.2 SAF使用 SAF原理可以在Google官网使用存储访问框架打开文件中查看，发送文件不能通过公共路径，那么就需要使用SAF。SAF读取到的文件有四类：图片、音频、视频、下载、内部存储空间（外部存储）以及各种网盘，可以通过setType设置显示的文件类别，其中图片（一般包含根目录以及照片DCIM文件夹、公有图片Pictures文件夹、Download下图片文件）、音频（一般包含根目录以及公有音频Music文件夹、Download下音频文件）、视频（一般包含根目录以及视频DCIM文件夹、公有视频Movies文件夹、Download下视频文件）中都是通过MediaStore保存的文件，下载中都是通过DownloadManager下载的文件，否则不显示在这几个目录中；内部存储空间即外部存储，从这里可以访问各个应用的外部存储；各种网盘也可以访问，从网盘获取文件会先调用网盘的下载功能，然后再获取下载好的文件，下载过程不可见。\n// 4.3及以下用 ACTION_PICK 或 ACTION_GET_CONTENT，Android 4.4以上可以多一个选择ACTION_OPEN_DOCUMENT，ACTION_PICK弹出单项选择窗口 // ACTION_GET_CONTENT与ACTION_OPEN_DOCUMENT类似，且使用ACTION_GET_CONTENT时，应用会导入数据（如图片文件）的副本，即如果 // 只是需要读取数据而不修改原始数据，那就用ACTION_GET_CONTENT，如果需要修改，使用ACTION_OPEN_DOCUMENT Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT); // 过滤器只显示可以打开的结果 intent.addCategory(Intent.CATEGORY_OPENABLE); // 使用图像MIME数据类型过滤以仅显示图像 // intent.setType(\"image/*\"); // 要搜索通过已安装的存储提供商提供的所有文档 intent.setType(\"*/*\"); // 如果需要多选，对应的onActivityResult获取Uri通过data.getClipData() // intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true) startActivityForResult(intent, READ_REQUEST_CODE); 在onActivityResult中获取到文件的Uri，如果是发送文件功能的话，还需要文件名和文件类型，然后加上FileInputStream发送出去，所以需要通过Uri获取文件相关信息\n@Override public void onActivityResult(int requestCode, int resultCode, Intent resultData) { if (requestCode == READ_REQUEST_CODE \u0026\u0026 resultCode == Activity.RESULT_OK) { Uri uri = null; if (resultData != null) { uri = resultData.getData(); } } } 比如：\n图片目录下的图片Uri类似于content://com.android.providers.media.documents/document/image%3A616260， 音频目录下content://com.android.providers.media.documents/document/audio%3A417558， 视频目录下content://com.android.providers.media.documents/document/video%3A616341， 下载目录下content://com.android.providers.downloads.documents/document/2884。 根据Uri可以使用ContentResolver查询相关文件的信息，比如ID、MIME_TYPE等等，查询代码可以看下面的FileUtils，在使用getDataColumn之前需要对Uri进行判断，获取文件种类以及id，比如image%3A616260，这就是一个Image文件，并且id为616260，%3A为冒号:，然后根据文件类型，使用相应的Uri查询，比如Image对应contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;，打印出来的结果是content://media/external/images/media，然后selection为_id=?，selectionArgs为id值。\npublic static String getDataColumn(Context context, Uri uri, String selection, String[] selectionArgs) { Cursor cursor = null; // ContentProvider查询方式，通过uri加上指定的column，类似于查询数据库，uri中包括了provider的全称以及id， // 等价于数据库表与id，column等价于列，这样就可以直接取到对应的值；这里查询的是DISPLAY_NAME，一般来说文件名 // 应该就包含了文件类型，但是在实际使用中，有的文件的DISPLAY_NAME与文件名并不相同，所以需要知道文件类型， // 可以使用MIME_TYPE，还有其他种类的信息例如修改时间等等，并不常用（DATA列已被弃用，但可以查询到文件路径） final String column = MediaStore.Images.ImageColumns.DISPLAY_NAME; final String[] projection = { column }; try { // 查询方法调用query cursor = context.getContentResolver().query( uri, projection, selection, selectionArgs,null); if (cursor != null \u0026\u0026 cursor.moveToFirst()) { final int column_index = cursor.getColumnIndexOrThrow(column); return cursor.getString(column_index); } } catch (Exception e) { e.printStackTrace(); } finally { if (cursor != null) cursor.close(); } return null; } 在测试过程中发现，对于SAF中图片、音频、视频三个目录下的文件都可以获取其正确的信息，但是对于下载目录下的文件存在问题。网上的对于com.android.providers.downloads的查询Uri是如下三种，但是全部无法查询到任何结果，public_downloads报异常Unknown URI（Android 6可以查询到），my_downloads查询结果为空，all_downloads报异常\njava.lang.SecurityException: Permission Denial: reading com.android.providers.downloads.provider.DownloadProvider uri content://downloads/all_downloads/2884 from pid=25434, uid=10786 requires android.permission.ACCESS_ALL_DOWNLOADS, or grantUriPermission() final String id = DocumentsContract.getDocumentId(uri); if (id != null \u0026\u0026 id.startsWith(\"raw:\")) { return id.substring(4); } String[] contentUriPrefixesToTry = new String[]{ \"content://downloads/public_downloads\", \"content://downloads/my_downloads\", \"content://downloads/all_downloads\" }; // 在API 29上多了一个新的Uri MediaStore.Downloads.EXTERNAL_CONTENT_URI，打印结果是 // content://media/external/downloads，类似于上面的MediaStore.Images.Media.EXTERNAL_CONTENT_URI， // 但是还是查询不到任何结果；如果直接拿content://com.android.providers.downloads.documents/document/2884 // 来查询可以查到MIME_TYPE和DISPLAY_NAME，或者通过context.getContentResolver().getType(uri)获取MIME_TYPE for (String contentUriPrefix : contentUriPrefixesToTry) { Uri contentUri = ContentUris.withAppendedId(Uri.parse(contentUriPrefix), Long.valueOf(id)); try { String path = getDataColumn(context, contentUri, null, null); if (path != null) { return path; } } catch (Exception e) { e.printStackTrace(); } } 对于下载目录下的文件获取其文件名以及文件类型的方式就只能通过原始Uri查询了，但是DISPLAY_NAME并不一定与真实文件名相同，然后通过Uri取文件数据，如下所示\n// 读取文件中的字符串 private String readTextFromUri(Uri uri) throws IOException { StringBuilder stringBuilder = new StringBuilder(); try (InputStream inputStream = getContentResolver().openInputStream(uri); BufferedReader reader = new BufferedReader( new InputStreamReader(Objects.requireNonNull(inputStream)))) { String line; while ((line = reader.readLine()) != null) { stringBuilder.append(line); } } return stringBuilder.toString(); } 或者取数据的FileInputStream，再利用FileInputStream进行其他操作，比如复制文件或者发送\nContentResolver contentResolver = this.getContentResolver(); ParcelFileDescriptor parcelFileDescriptor = null; try { parcelFileDescriptor = contentResolver.openFileDescriptor(uri, \"r\"); } catch (FileNotFoundException e) { e.printStackTrace(); } if (parcelFileDescriptor == null) { return; } FileChannel inputChannel = null; FileChannel outputChannel = null; long start = System.currentTimeMillis(); // 为了验证是否获取到数据，可以将数据保存到其他位置，比如这里的aabb.rar String dest = \"/storage/emulated/0/Android/data/us.zoom.androidqdemo/files/aabb.rar\"; try { FileInputStream inputStream = new FileInputStream( parcelFileDescriptor.getFileDescriptor()); inputChannel = inputStream.getChannel(); outputChannel = new FileOutputStream(dest).getChannel(); long srcSize = inputChannel.size(); long size = outputChannel.transferFrom(inputChannel, 0, srcSize); if (size == srcSize) { return; } } catch (Exception e) { e.printStackTrace(); } finally { long end = System.currentTimeMillis(); Toast.makeText(this, \"Time: \" + (end - start), Toast.LENGTH_LONG).show(); try { if (inputChannel != null) { inputChannel.close(); } } catch (IOException e) { e.printStackTrace(); } try { if (outputChannel != null) { outputChannel.close(); } } catch (IOException e) { e.printStackTrace(); } } 1.3 MediaStore使用 MediaStore是用于获取或者添加媒体文件（图片、音频、视频）信息的工具，需要配合ContentResolver使用，MediaStore定义列的名称，通过ContentResolver的query和insert方法去查询和添加文件。\n/** * 获取系统外部存储内所有的图片 * @param context * @return list */ private List\u003cImageInfo\u003e getImageList(Context context) { List\u003cImageInfo\u003e list = new ArrayList(); ContentResolver contentResolver = context.getContentResolver(); // 查询图片需要的Uri Uri uri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI; String[] projection = null; String selection = null; String[] selectionArgs = null; String sortOrder = null; Cursor cursor = contentResolver.query(uri, projection, selection, selectionArgs, sortOrder); if (cursor != null) { while (cursor.moveToNext()) { ImageInfo imageInfo = new ImageInfo(); imageInfo.id = cursor.getInt(cursor.getColumnIndexOrThrow(MediaStore.Images.Media._ID)); // 组装图片uri imageInfo.uri = ContentUris.withAppendedId(uri, imageInfo.id); imageInfo.filePath = cursor.getString(cursor.getColumnIndex(MediaStore.Images.Media.DATA)); imageInfo.mimeType = cursor.getString(cursor.getColumnIndexOrThrow(MediaStore.Images.Media.MIME_TYPE)); imageInfo.title = cursor.getString(cursor.getColumnIndexOrThrow(MediaStore.Images.Media.TITLE)); imageInfo.addTime = cursor.getLong(cursor.getColumnIndex(MediaStore.Images.Media.DATE_ADDED)); list.add(imageInfo); } cursor.close(); } return list; } 得到uri后可以通过上面提到的方式取数据也可以直接通过ImageView.setImageURI(imageInfo.uri)展示出来。如果有加载缩略图的要求，也可以通过Uri获取缩略图的Bitmap，调用loadThumbnail方法，并且可以指定缩略图大小（视频文件也可以加载缩略图），通过query方式查询缩略图的方式在Android Q上基本失效。\ncontext.getContentResolver().loadThumbnail(imageInfo.uri, new Size(50, 50), null) 除了查询之外，比较重要的是插入媒体文件的功能，比如在外部存储的应用私有目录下的图片不会显示在SAF框架中，如果需要将其显示在图片目录中，需要将文件另存到公有目录下，一般是Pictures文件夹中。同理对音频、视频文件也是如此，通过insert方法传入的Uri决定文件保存位置。在Android Q上通过Uri将文件保存到Download目录下似乎不太可行，只能依靠DownloadManager直接下载保存到Download下。\nprivate boolean SavePictureFile(Context context, File file) { if (file == null) { return false; } // 首先需要获取到源文件的File对象，然后根据File对象的相关信息构造Uri，比如MIME_TYPE和DISPLAY_NAME等等 Uri uri = insertFileIntoMediaStore(context, file, true); // 然后通过FileInputStream的方式将文件拷贝到目的文件中 return copyFile(context, file, uri); } private Uri insertFileIntoMediaStore(Context context, File file, boolean isPicture) { ContentValues contentValues = new ContentValues(); contentValues.put(MediaStore.Video.Media.DISPLAY_NAME, file.getName()); contentValues.put(MediaStore.Video.Media.MIME_TYPE, isPicture ? \"image/jpeg\" : \"video/mp4\"); if (Build.VERSION.SDK_INT \u003e= 29) { contentValues.put(MediaStore.Video.Media.DATE_TAKEN, file.lastModified()); // Android Q如果不设置RELATIVE_PATH，则默认保存在Pictures文件夹下，可以通过RELATIVE_PATH添加 // Pictures/MyPictures子文件夹，文件将会保存在MyPictures中 // contentValues.put(MediaStore.Video.Media.RELATIVE_PATH, Environment.DIRECTORY_PICTURES + File.separator + \"MyPictures\"); } Uri uri = null; try { // 通过insert方法得到公有目录下目的文件的Uri uri = context.getContentResolver().insert( (isPicture ? MediaStore.Images.Media.EXTERNAL_CONTENT_URI : MediaStore.Video.Media.EXTERNAL_CONTENT_URI) , contentValues ); } catch (Exception e) { e.printStackTrace(); } return uri; } // 文件复制的方式同上 private boolean copyFile(Context context, File srcFile, Uri destFile) { ContentResolver contentResolver = context.getContentResolver(); ParcelFileDescriptor parcelFileDescriptor = null; try { parcelFileDescriptor = contentResolver.openFileDescriptor(destFile, \"w\"); } catch (FileNotFoundException e) { e.printStackTrace(); } if (parcelFileDescriptor == null) { return false; } FileChannel inputChannel = null; FileChannel outputChannel = null; try { FileInputStream inputStream = new FileInputStream( srcFile); inputChannel = inputStream.getChannel(); outputChannel = new FileOutputStream(parcelFileDescriptor.getFileDescriptor()).getChannel(); long srcSize = inputChannel.size(); long size = outputChannel.transferFrom(inputChannel, 0, srcSize); if (size == srcSize) { return true; } } catch (Exception e) { e.printStackTrace(); } finally { try { if (inputChannel != null) { inputChannel.close(); } } catch (IOException e) { e.printStackTrace(); } try { if (outputChannel != null) { outputChannel.close(); } } catch (IOException e) { e.printStackTrace(); } } return false; } 2. Android系统路径API补充说明 2.1 内部存储与外部存储 首先是内部存储与外部存储，内部存储类似/data/user/0/us.zoom.androidqdemo/，其中us.zoom.androidqdemo是包名，可以通过以下几个方法获取到当前应用的内部路径，内部存储一个最主要的特点就是与应用绑定，如果应用卸载了那么内部存储中应用私有目录的所有文件都会被删除，另一个特点就是内部存储无法直接通过手机中的文件管理或者其他名字的系统应用查看（而外部存储可见），内部存储的空间一般较小，需要谨慎使用，外部存储空间很大。\nEnvironment.getDataDirectory().getAbsolutePath() // /data getFilesDir().getAbsolutePath() // /data/user/0/us.zoom.androidqdemo/files getCacheDir().getAbsolutePath() // /data/user/0/us.zoom.androidqdemo/cache getDir(\"myFile\", MODE_PRIVATE).getAbsolutePath() // /data/user/0/us.zoom.androidqdemo/app_myFile 外部存储类似/storage/emulated/0/Android/data/us.zoom.androidqdemo/files/（外部存储的应用私有目录）、/storage/emulated/0/Pictures/Screenshots/（外部存储的公有目录）这样的路径，我们通过文件管理这个系统应用进入的根目录就是/storage/emulated/0，在Android Q之前我们会发现这个目录下有非常多的乱七八糟的文件夹，除了Alarms, Android, DCIM, Download, Movies, Music, Notifications, Pictures, Podcasts, Ringtones之外，其他文件或者文件夹都是由你安装的其他APP自行生成的，所以Android Q之前的文件系统极其混乱，因此在Android Q之后不允许对外部存储中公有目录随意访问（可能提示权限拒绝），而内部存储以及外部存储的应用私有目录可以直接通过路径访问，因此在Android Q上我们就会发现外部存储的根目录仅有上面我提到的几个文件夹。\nEnvironment.getExternalStorageDirectory().getAbsolutePath() // /storage/emulated/0 Environment.getExternalStoragePublicDirectory(\"\").getAbsolutePath() // /storage/emulated/0 getExternalFilesDir(\"\").getAbsolutePath() // /storage/emulated/0/Android/data/us.zoom.androidqdemo/files getExternalCacheDir().getAbsolutePath() // /storage/emulated/0/Android/data/us.zoom.androidqdemo/cache // 如果手机支持SD卡扩展，那么可以通过getExternalFilesDirs(\"\")获取所有的外部存储（手机内置外部存储+SD卡） 现在的Android手机一般情况下存储空间都非常大了基本在32GB起步，64GB比较常见，一般用到的都是外部存储，但是还是需要判断外部存储空间是否可用，比如通过Environment.getExternalStorageState()判断是否正常挂载，如果不可用那么就需要使用到内部存储。\n2.2 缓存与其他文件 在内部存储和外部存储的应用私有目录下会发现两个文件夹files和cache，很显然，files用于存储普通数据，cache用于存储缓存数据，如何使用这两个目录存储应用的文件就依赖开发人员的选择了，比如如果是应用本身下载的文件但是不想对外公开，那么可以放在files中，如果是应用读写文件过程中产生的临时文件可以放在cache中，实际开发时需自行设计。\n清除缓存：我们知道应用程序在运行过程中需要经过很多过程，比如读入程序，计算，输入输出等等，这些过程中肯定会产生很多的数据，它们在内存中，以供程序运行时调用。所以清除缓存清除的是APP运行过程中所产生的临时数据。\n清除数据：清除数据才是真正的删除了我们保存在文件中的数据（永久性数据，如果不人为删除的话会一直保存在文件中）例如当我们在设置里面清除了某个应用的数据，那么/data/user/0/packname/和/storage/emulated/0/Android/data/packname/下的文件里面的数据会全部删除，包括cache，files，lib，shared_prefs等等。\n3. FileUtils相关代码 package us.zoom.androidqdemo; /* * Copyright (C) 2018 OpenIntents.org * * Licensed under the Apache License, Version 2.0 (the \"License\"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an \"AS IS\" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ import android.content.ContentUris; import android.content.Context; import android.content.Intent; import android.database.Cursor; import android.database.DatabaseUtils; import android.net.Uri; import android.os.Build; import android.os.Environment; import android.provider.DocumentsContract; import android.provider.MediaStore; import android.provider.OpenableColumns; import android.util.Log; import android.webkit.MimeTypeMap; import androidx.annotation.NonNull; import androidx.annotation.Nullable; import androidx.core.content.FileProvider; import java.io.BufferedOutputStream; import java.io.File; import java.io.FileFilter; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.IOException; import java.io.InputStream; import java.text.DecimalFormat; import java.util.Comparator; public class FileUtils { public static final String DOCUMENTS_DIR = \"documents\"; // configured android:authorities in AndroidManifest (https://developer.android.com/reference/android/support/v4/content/FileProvider) public static final String AUTHORITY = \"YOUR_AUTHORITY.provider\"; public static final String HIDDEN_PREFIX = \".\"; /** * TAG for log messages. */ static final String TAG = \"FileUtils\"; private static final boolean DEBUG = false; // Set to true to enable logging /** * File and folder comparator. TODO Expose sorting option method */ public static Comparator\u003cFile\u003e sComparator = (f1, f2) -\u003e { // Sort alphabetically by lower case, which is much cleaner return f1.getName().toLowerCase().compareTo( f2.getName().toLowerCase()); }; /** * File (not directories) filter. */ public static FileFilter sFileFilter = file -\u003e { final String fileName = file.getName(); // Return files only (not directories) and skip hidden files return file.isFile() \u0026\u0026 !fileName.startsWith(HIDDEN_PREFIX); }; /** * Folder (directories) filter. */ public static FileFilter sDirFilter = file -\u003e { final String fileName = file.getName(); // Return directories only and skip hidden directories return file.isDirectory() \u0026\u0026 !fileName.startsWith(HIDDEN_PREFIX); }; private FileUtils() { } //private constructor to enforce Singleton pattern /** * Gets the extension of a file name, like \".png\" or \".jpg\". * * @param uri * @return Extension including the dot(\".\"); \"\" if there is no extension; * null if uri was null. */ public static String getExtension(String uri) { if (uri == null) { return null; } int dot = uri.lastIndexOf(\".\"); if (dot \u003e= 0) { return uri.substring(dot); } else { // No extension. return \"\"; } } /** * @return Whether the URI is a local one. */ public static boolean isLocal(String url) { return url != null \u0026\u0026 !url.startsWith(\"http://\") \u0026\u0026 !url.startsWith(\"https://\"); } /** * @return True if Uri is a MediaStore Uri. * @author paulburke */ public static boolean isMediaUri(Uri uri) { return \"media\".equalsIgnoreCase(uri.getAuthority()); } /** * Convert File into Uri. * * @param file * @return uri */ public static Uri getUri(File file) { return (file != null) ? Uri.fromFile(file) : null; } /** * Returns the path only (without file name). * * @param file * @return */ public static File getPathWithoutFilename(File file) { if (file != null) { if (file.isDirectory()) { // no file to be split off. Return everything return file; } else { String filename = file.getName(); String filepath = file.getAbsolutePath(); // Construct path without file name. String pathwithoutname = filepath.substring(0, filepath.length() - filename.length()); if (pathwithoutname.endsWith(\"/\")) { pathwithoutname = pathwithoutname.substring(0, pathwithoutname.length() - 1); } return new File(pathwithoutname); } } return null; } /** * @return The MIME type for the given file. */ public static String getMimeType(File file) { String extension = getExtension(file.getName()); if (extension.length() \u003e 0) return MimeTypeMap.getSingleton().getMimeTypeFromExtension(extension.substring(1)); return \"application/octet-stream\"; } /** * @return The MIME type for the give Uri. */ public static String getMimeType(Context context, Uri uri) { File file = new File(getPath(context, uri)); return getMimeType(file); } /** * @return The MIME type for the give String Uri. */ public static String getMimeType(Context context, String url) { String type = context.getContentResolver().getType(Uri.parse(url)); if (type == null) { type = \"application/octet-stream\"; } return type; } /** * @param uri The Uri to check. * @return Whether the Uri authority is local. */ public static boolean isLocalStorageDocument(Uri uri) { return AUTHORITY.equals(uri.getAuthority()); } /** * @param uri The Uri to check. * @return Whether the Uri authority is ExternalStorageProvider. */ public static boolean isExternalStorageDocument(Uri uri) { return \"com.android.externalstorage.documents\".equals(uri.getAuthority()); } /** * @param uri The Uri to check. * @return Whether the Uri authority is DownloadsProvider. */ public static boolean isDownloadsDocument(Uri uri) { return \"com.android.providers.downloads.documents\".equals(uri.getAuthority()); } /** * @param uri The Uri to check. * @return Whether the Uri authority is MediaProvider. */ public static boolean isMediaDocument(Uri uri) { return \"com.android.providers.media.documents\".equals(uri.getAuthority()); } /** * @param uri The Uri to check. * @return Whether the Uri authority is Google Photos. */ public static boolean isGooglePhotosUri(Uri uri) { return \"com.google.android.apps.photos.content\".equals(uri.getAuthority()); } /** * Get the value of the data column for this Uri. This is useful for * MediaStore Uris, and other file-based ContentProviders. * * @param context The context. * @param uri The Uri to query. * @param selection (Optional) Filter used in the query. * @param selectionArgs (Optional) Selection arguments used in the query. * @return The value of the _data column, which is typically a file path. */ public static String getDataColumn(Context context, Uri uri, String selection, String[] selectionArgs) { Cursor cursor = null; final String column = MediaStore.Files.FileColumns.DATA; final String[] projection = { column }; try { cursor = context.getContentResolver().query(uri, projection, selection, selectionArgs, null); if (cursor != null \u0026\u0026 cursor.moveToFirst()) { if (DEBUG) DatabaseUtils.dumpCursor(cursor); final int column_index = cursor.getColumnIndexOrThrow(column); return cursor.getString(column_index); } } catch (Exception e) { e.printStackTrace(); } finally { if (cursor != null) cursor.close(); } return null; } /** * Get a file path from a Uri. This will get the the path for Storage Access * Framework Documents, as well as the _data field for the MediaStore and * other file-based ContentProviders.\n* * Callers should check whether the path is local before assuming it * represents a local file. * * @param context The context. * @param uri The Uri to query. * @see #isLocal(String) * @see #getFile(Context, Uri) */ public static String getPath(final Context context, final Uri uri) { String absolutePath = getLocalPath(context, uri); return absolutePath != null ? absolutePath : uri.toString(); } private static String getLocalPath(final Context context, final Uri uri) { if (DEBUG) Log.d(TAG + \" File -\", \"Authority: \" + uri.getAuthority() + \", Fragment: \" + uri.getFragment() + \", Port: \" + uri.getPort() + \", Query: \" + uri.getQuery() + \", Scheme: \" + uri.getScheme() + \", Host: \" + uri.getHost() + \", Segments: \" + uri.getPathSegments().toString() ); final boolean isKitKat = Build.VERSION.SDK_INT \u003e= Build.VERSION_CODES.KITKAT; // DocumentProvider if (isKitKat \u0026\u0026 DocumentsContract.isDocumentUri(context, uri)) { // LocalStorageProvider if (isLocalStorageDocument(uri)) { // The path is the id return DocumentsContract.getDocumentId(uri); } // ExternalStorageProvider else if (isExternalStorageDocument(uri)) { final String docId = DocumentsContract.getDocumentId(uri); final String[] split = docId.split(\":\"); final String type = split[0]; if (\"primary\".equalsIgnoreCase(type)) { return Environment.getExternalStorageDirectory() + \"/\" + split[1]; } else if (\"home\".equalsIgnoreCase(type)) { return Environment.getExternalStorageDirectory() + \"/documents/\" + split[1]; } } // DownloadsProvider else if (isDownloadsDocument(uri)) { final String id = DocumentsContract.getDocumentId(uri); if (id != null \u0026\u0026 id.startsWith(\"raw:\")) { return id.substring(4); } // Android Q 似乎无效 String[] contentUriPrefixesToTry = new String[]{ \"content://downloads/public_downloads\", \"content://downloads/my_downloads\", \"content://downloads/all_downloads\" }; for (String contentUriPrefix : contentUriPrefixesToTry) { Uri contentUri = ContentUris.withAppendedId(Uri.parse(contentUriPrefix), Long.valueOf(id)); try { String path = getDataColumn(context, contentUri, null, null); if (path != null) { return path; } } catch (Exception e) { e.printStackTrace(); } } // path could not be retrieved using ContentResolver, therefore copy file to accessible cache using streams String fileName = getFileName(context, uri); File cacheDir = getDocumentCacheDir(context); File file = generateFileName(fileName, cacheDir); String destinationPath = null; if (file != null) { destinationPath = file.getAbsolutePath(); saveFileFromUri(context, uri, destinationPath); } return destinationPath; } // MediaProvider else if (isMediaDocument(uri)) { final String docId = DocumentsContract.getDocumentId(uri); final String[] split = docId.split(\":\"); final String type = split[0]; Uri contentUri = null; if (\"image\".equals(type)) { contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI; } else if (\"video\".equals(type)) { contentUri = MediaStore.Video.Media.EXTERNAL_CONTENT_URI; } else if (\"audio\".equals(type)) { contentUri = MediaStore.Audio.Media.EXTERNAL_CONTENT_URI; } final String selection = \"_id=?\"; final String[] selectionArgs = new String[]{ split[1] }; return getDataColumn(context, contentUri, selection, selectionArgs); } } // MediaStore (and general) else if (\"content\".equalsIgnoreCase(uri.getScheme())) { // Return the remote address if (isGooglePhotosUri(uri)) { return uri.getLastPathSegment(); } return getDataColumn(context, uri, null, null); } // File else if (\"file\".equalsIgnoreCase(uri.getScheme())) { return uri.getPath(); } return null; } /** * Convert Uri into File, if possible. * * @return file A local file that the Uri was pointing to, or null if the * Uri is unsupported or pointed to a remote resource. * @author paulburke * @see #getPath(Context, Uri) */ public static File getFile(Context context, Uri uri) { if (uri != null) { String path = getPath(context, uri); if (path != null \u0026\u0026 isLocal(path)) { return new File(path); } } return null; } /** * Get the file size in a human-readable string. * * @param size * @return * @author paulburke */ public static String getReadableFileSize(int size) { final int BYTES_IN_KILOBYTES = 1024; final DecimalFormat dec = new DecimalFormat(\"###.#\"); final String KILOBYTES = \" KB\"; final String MEGABYTES = \" MB\"; final String GIGABYTES = \" GB\"; float fileSize = 0; String suffix = KILOBYTES; if (size \u003e BYTES_IN_KILOBYTES) { fileSize = size / BYTES_IN_KILOBYTES; if (fileSize \u003e BYTES_IN_KILOBYTES) { fileSize = fileSize / BYTES_IN_KILOBYTES; if (fileSize \u003e BYTES_IN_KILOBYTES) { fileSize = fileSize / BYTES_IN_KILOBYTES; suffix = GIGABYTES; } else { suffix = MEGABYTES; } } } return String.valueOf(dec.format(fileSize) + suffix); } /** * Get the Intent for selecting content to be used in an Intent Chooser. * * @return The intent for opening a file with Intent.createChooser() */ public static Intent createGetContentIntent() { // Implicitly allow the user to select a particular kind of data final Intent intent = new Intent(Intent.ACTION_GET_CONTENT); // The MIME data type filter intent.setType(\"*/*\"); // Only return URIs that can be opened with ContentResolver intent.addCategory(Intent.CATEGORY_OPENABLE); return intent; } /** * Creates View intent for given file * * @param file * @return The intent for viewing file */ public static Intent getViewIntent(Context context, File file) { //Uri uri = Uri.fromFile(file); Uri uri = FileProvider.getUriForFile(context, AUTHORITY, file); Intent intent = new Intent(Intent.ACTION_VIEW); String url = file.toString(); if (url.contains(\".doc\") || url.contains(\".docx\")) { // Word document intent.setDataAndType(uri, \"application/msword\"); } else if (url.contains(\".pdf\")) { // PDF file intent.setDataAndType(uri, \"application/pdf\"); } else if (url.contains(\".ppt\") || url.contains(\".pptx\")) { // Powerpoint file intent.setDataAndType(uri, \"application/vnd.ms-powerpoint\"); } else if (url.contains(\".xls\") || url.contains(\".xlsx\")) { // Excel file intent.setDataAndType(uri, \"application/vnd.ms-excel\"); } else if (url.contains(\".zip\") || url.contains(\".rar\")) { // WAV audio file intent.setDataAndType(uri, \"application/x-wav\"); } else if (url.contains(\".rtf\")) { // RTF file intent.setDataAndType(uri, \"application/rtf\"); } else if (url.contains(\".wav\") || url.contains(\".mp3\")) { // WAV audio file intent.setDataAndType(uri, \"audio/x-wav\"); } else if (url.contains(\".gif\")) { // GIF file intent.setDataAndType(uri, \"image/gif\"); } else if (url.contains(\".jpg\") || url.contains(\".jpeg\") || url.contains(\".png\")) { // JPG file intent.setDataAndType(uri, \"image/jpeg\"); } else if (url.contains(\".txt\")) { // Text file intent.setDataAndType(uri, \"text/plain\"); } else if (url.contains(\".3gp\") || url.contains(\".mpg\") || url.contains(\".mpeg\") || url.contains(\".mpe\") || url.contains(\".mp4\") || url.contains(\".avi\")) { // Video files intent.setDataAndType(uri, \"video/*\"); } else { intent.setDataAndType(uri, \"*/*\"); } intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION); intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION); return intent; } public static File getDownloadsDir() { return Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS); } public static File getDocumentCacheDir(@NonNull Context context) { File dir = new File(context.getCacheDir(), DOCUMENTS_DIR); if (!dir.exists()) { dir.mkdirs(); } logDir(context.getCacheDir()); logDir(dir); return dir; } private static void logDir(File dir) { if(!DEBUG) return; Log.d(TAG, \"Dir=\" + dir); File[] files = dir.listFiles(); for (File file : files) { Log.d(TAG, \"File=\" + file.getPath()); } } @Nullable public static File generateFileName(@Nullable String name, File directory) { if (name == null) { return null; } File file = new File(directory, name); if (file.exists()) { String fileName = name; String extension = \"\"; int dotIndex = name.lastIndexOf('.'); if (dotIndex \u003e 0) { fileName = name.substring(0, dotIndex); extension = name.substring(dotIndex); } int index = 0; while (file.exists()) { index++; name = fileName + '(' + index + ')' + extension; file = new File(directory, name); } } try { if (!file.createNewFile()) { return null; } } catch (IOException e) { Log.w(TAG, e); return null; } logDir(directory); return file; } // /** // * Writes response body to disk // * // * @param body ResponseBody // * @param path file path // * @return File // */ // public static File writeResponseBodyToDisk(ResponseBody body, String path) { // try { // File target = new File(path); // // InputStream inputStream = null; // OutputStream outputStream = null; // // try { // byte[] fileReader = new byte[4096]; // // inputStream = body.byteStream(); // outputStream = new FileOutputStream(target); // // while (true) { // int read = inputStream.read(fileReader); // // if (read == -1) { // break; // } // // outputStream.write(fileReader, 0, read); // } // // outputStream.flush(); // // return target; // } catch (IOException e) { // return null; // } finally { // if (inputStream != null) { // inputStream.close(); // } // // if (outputStream != null) { // outputStream.close(); // } // } // } catch (IOException e) { // return null; // } // } private static void saveFileFromUri(Context context, Uri uri, String destinationPath) { InputStream is = null; BufferedOutputStream bos = null; try { is = context.getContentResolver().openInputStream(uri); bos = new BufferedOutputStream(new FileOutputStream(destinationPath, false)); byte[] buf = new byte[1024]; is.read(buf); do { bos.write(buf); } while (is.read(buf) != -1); } catch (IOException e) { e.printStackTrace(); } finally { try { if (is != null) is.close(); if (bos != null) bos.close(); } catch (IOException e) { e.printStackTrace(); } } } public static byte[] readBytesFromFile(String filePath) { FileInputStream fileInputStream = null; byte[] bytesArray = null; try { File file = new File(filePath); bytesArray = new byte[(int) file.length()]; //read file into bytes[] fileInputStream = new FileInputStream(file); fileInputStream.read(bytesArray); } catch (IOException e) { e.printStackTrace(); } finally { if (fileInputStream != null) { try { fileInputStream.close(); } catch (IOException e) { e.printStackTrace(); } } } return bytesArray; } public static File createTempImageFile(Context context, String fileName) throws IOException { // Create an image file name File storageDir = new File(context.getCacheDir(), DOCUMENTS_DIR); return File.createTempFile(fileName, \".jpg\", storageDir); } public static String getFileName(@NonNull Context context, Uri uri) { String mimeType = context.getContentResolver().getType(uri); String filename = null; if (mimeType == null \u0026\u0026 context != null) { String path = getPath(context, uri); if (path == null) { filename = getName(uri.toString()); } else { File file = new File(path); filename = file.getName(); } } else { Cursor returnCursor = context.getContentResolver().query(uri, null, null, null, null); if (returnCursor != null) { int nameIndex = returnCursor.getColumnIndex(OpenableColumns.DISPLAY_NAME); returnCursor.moveToFirst(); filename = returnCursor.getString(nameIndex); returnCursor.close(); } } return filename; } public static String getName(String filename) { if (filename == null) { return null; } int index = filename.lastIndexOf('/'); return filename.substring(index + 1); } } 参考： Android Q 隐私权变更：分区存储 Save a file on external storage Android 10(Android Q) 适配 使用存储访问框架打开文件 Android Q 沙箱适配多媒体文件总结 ","wordCount":"3391","inLanguage":"en","datePublished":"2019-10-26T11:02:06+08:00","dateModified":"2019-10-26T11:02:06+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhoutao822.github.io/posts/saf/"},"publisher":{"@type":"Organization","name":"Tao's Notes","logo":{"@type":"ImageObject","url":"https://zhoutao822.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://zhoutao822.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://zhoutao822.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://zhoutao822.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zhoutao822.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://zhoutao822.github.io/series/ title=Series><span>Series</span></a></li><li><a href=https://zhoutao822.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zhoutao822.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://zhoutao822.github.io/posts/>Posts</a></div><h1 class=post-title>Android-Q适配-存储方式</h1><div class=post-meta><span title='2019-10-26 11:02:06 +0800 +0800'>October 26, 2019</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Zhoutao822/zhoutao822.github.io/tree/main/content//posts/SAF.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-saf%e6%a1%86%e6%9e%b6 aria-label="1. SAF框架">1. SAF框架</a><ul><li><a href=#11-%e5%a4%96%e9%83%a8%e5%ad%98%e5%82%a8 aria-label="1.1 外部存储">1.1 外部存储</a></li><li><a href=#12-saf%e4%bd%bf%e7%94%a8 aria-label="1.2 SAF使用">1.2 SAF使用</a></li><li><a href=#13-mediastore%e4%bd%bf%e7%94%a8 aria-label="1.3 MediaStore使用">1.3 MediaStore使用</a></li></ul></li><li><a href=#2-android%e7%b3%bb%e7%bb%9f%e8%b7%af%e5%be%84api%e8%a1%a5%e5%85%85%e8%af%b4%e6%98%8e aria-label="2. Android系统路径API补充说明">2. Android系统路径API补充说明</a><ul><li><a href=#21-%e5%86%85%e9%83%a8%e5%ad%98%e5%82%a8%e4%b8%8e%e5%a4%96%e9%83%a8%e5%ad%98%e5%82%a8 aria-label="2.1 内部存储与外部存储">2.1 内部存储与外部存储</a></li><li><a href=#22-%e7%bc%93%e5%ad%98%e4%b8%8e%e5%85%b6%e4%bb%96%e6%96%87%e4%bb%b6 aria-label="2.2 缓存与其他文件">2.2 缓存与其他文件</a></li></ul></li><li><a href=#3-fileutils%e7%9b%b8%e5%85%b3%e4%bb%a3%e7%a0%81 aria-label="3. FileUtils相关代码">3. FileUtils相关代码</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考：>参考：</a></li></ul></div></details></div><div class=post-content><p>Android Q之后对系统存储方式进行了调整，简而言之就是禁止开发人员随意通过路径访问操作外部存储文件，内部存储没有影响。这样做的目的很明显，即往后原生Android的文件管理器将不会出现各种App生成的乱七八糟的文件，不同类型的文件都在其各自相应的位置。</p><p>示意图如下，主要行为变更在媒体文件（音频、视频、图片）以及下载文件中</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Zhoutao822/hugo-pic/pictures/file.png alt=file></p><h2 id=1-saf框架>1. SAF框架<a hidden class=anchor aria-hidden=true href=#1-saf框架>#</a></h2><p>SAF（Storage Access Framework，存储访问框架），是Android 4.4之后提供的文件选择器，通过Intent方式启动，UI界面由系统提供，一般来说其他厂商魔改的系统都没有对这方面进行重写，所以示意图基本相同，如下</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Zhoutao822/hugo-pic/pictures/saf.png alt=saf></p><h3 id=11-外部存储>1.1 外部存储<a hidden class=anchor aria-hidden=true href=#11-外部存储>#</a></h3><p>如果应用有发送文件、选择文件等功能，特别是需要读取系统文件目录的方法都需要修改，在target Q的情况下，试图通过路径访问外部公共文件的方式都会失效，如下所示，因此需要使用SAF框架选取文件，得到的结果是文件的Uri，然后再使用Uri读取或者处理该文件，外部存储路径如果打印出来类似<code>/storage/emulated/0/Android/data/us.zoom.androidqdemo/files/aabb.rar</code>、<code>/storage/emulated/0/Pictures/Screenshots/Screenshot_20191014-141713.png</code>，前者是当前应用的外部路径（可以直接访问），后者是公共图片文件下外部路径；内部路径类似<code>/data/user/0/us.zoom.androidqdemo/data/aabb.png</code>，内部路径无法直接在系统中查看。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 在手机外部存储根目录下创建text.txt文件，在Android P上可以成功创建此文件并写入数据，file.exists()返回True；
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 在Android Q上无法创建此文件，返回False
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>String filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;text.txt&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>(),</span> filename<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// File file = new File(getFilesDir(), filename); //如果是内部存储，则两者都是正常访问
</span></span></span><span style=display:flex><span><span style=color:#75715e>// File file = new File(getExternalFilesDir(&#34;&#34;), filename); // 外部存储的当前应用路径可以正常访问
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    FileOutputStream outputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream<span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    outputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;123456&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    outputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>()</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;True&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;False&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 同理对读文件，Android P上可以读取text.txt内容，并且file.exists()返回True；Android Q上FileInputStream报错：
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 无法访问，拒绝权限，但是file.exists()返回true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>String filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;text.txt&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>(),</span> filename<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// File file = new File(getFilesDir(), filename); //如果是内部存储，则两者都是正常访问
</span></span></span><span style=display:flex><span><span style=color:#75715e>// File file = new File(getExternalFilesDir(&#34;&#34;), filename); // 外部存储的当前应用路径可以正常访问
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    FileInputStream inputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileInputStream<span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    InputStreamReader reader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InputStreamReader<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    BufferedReader br <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedReader<span style=color:#f92672>(</span>reader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    String line <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    line <span style=color:#f92672>=</span> br<span style=color:#f92672>.</span><span style=color:#a6e22e>readLine</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>line <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;TestRead&#34;</span><span style=color:#f92672>,</span> line<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        line <span style=color:#f92672>=</span> br<span style=color:#f92672>.</span><span style=color:#a6e22e>readLine</span><span style=color:#f92672>();</span> <span style=color:#75715e>// 一次读入一行数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>()</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;True&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;False&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><h3 id=12-saf使用>1.2 SAF使用<a hidden class=anchor aria-hidden=true href=#12-saf使用>#</a></h3><p>SAF原理可以在Google官网<a href="https://developer.android.com/guide/topics/providers/document-provider?hl=zh-cn">使用存储访问框架打开文件</a>中查看，发送文件不能通过公共路径，那么就需要使用SAF。SAF读取到的文件有四类：图片、音频、视频、下载、内部存储空间（外部存储）以及各种网盘，可以通过setType设置显示的文件类别，其中图片（一般包含根目录以及照片DCIM文件夹、公有图片Pictures文件夹、Download下图片文件）、音频（一般包含根目录以及公有音频Music文件夹、Download下音频文件）、视频（一般包含根目录以及视频DCIM文件夹、公有视频Movies文件夹、Download下视频文件）中都是通过MediaStore保存的文件，下载中都是通过DownloadManager下载的文件，否则不显示在这几个目录中；内部存储空间即外部存储，从这里可以访问各个应用的外部存储；各种网盘也可以访问，从网盘获取文件会先调用网盘的下载功能，然后再获取下载好的文件，下载过程不可见。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 4.3及以下用 ACTION_PICK 或 ACTION_GET_CONTENT，Android 4.4以上可以多一个选择ACTION_OPEN_DOCUMENT，ACTION_PICK弹出单项选择窗口
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ACTION_GET_CONTENT与ACTION_OPEN_DOCUMENT类似，且使用ACTION_GET_CONTENT时，应用会导入数据（如图片文件）的副本，即如果
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 只是需要读取数据而不修改原始数据，那就用ACTION_GET_CONTENT，如果需要修改，使用ACTION_OPEN_DOCUMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Intent intent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Intent<span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_OPEN_DOCUMENT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 过滤器只显示可以打开的结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addCategory</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>CATEGORY_OPENABLE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用图像MIME数据类型过滤以仅显示图像
</span></span></span><span style=display:flex><span><span style=color:#75715e>// intent.setType(&#34;image/*&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 要搜索通过已安装的存储提供商提供的所有文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;*/*&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果需要多选，对应的onActivityResult获取Uri通过data.getClipData()
</span></span></span><span style=display:flex><span><span style=color:#75715e>// intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>startActivityForResult<span style=color:#f92672>(</span>intent<span style=color:#f92672>,</span> READ_REQUEST_CODE<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>在onActivityResult中获取到文件的Uri，如果是发送文件功能的话，还需要文件名和文件类型，然后加上FileInputStream发送出去，所以需要通过Uri获取文件相关信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onActivityResult</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> resultCode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                Intent resultData<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestCode <span style=color:#f92672>==</span> READ_REQUEST_CODE <span style=color:#f92672>&amp;&amp;</span> resultCode <span style=color:#f92672>==</span> Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>RESULT_OK</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Uri uri <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resultData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            uri <span style=color:#f92672>=</span> resultData<span style=color:#f92672>.</span><span style=color:#a6e22e>getData</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>比如：</p><ul><li>图片目录下的图片Uri类似于<code>content://com.android.providers.media.documents/document/image%3A616260</code>，</li><li>音频目录下<code>content://com.android.providers.media.documents/document/audio%3A417558</code>，</li><li>视频目录下<code>content://com.android.providers.media.documents/document/video%3A616341</code>，</li><li>下载目录下<code>content://com.android.providers.downloads.documents/document/2884</code>。</li></ul><p>根据Uri可以使用ContentResolver查询相关文件的信息，比如ID、MIME_TYPE等等，查询代码可以看下面的FileUtils，在使用getDataColumn之前需要对Uri进行判断，获取文件种类以及id，比如<code>image%3A616260</code>，这就是一个Image文件，并且id为<code>616260</code>，<code>%3A</code>为冒号<code>:</code>，然后根据文件类型，使用相应的Uri查询，比如Image对应<code>contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;</code>，打印出来的结果是<code>content://media/external/images/media</code>，然后selection为<code>_id=?</code>，selectionArgs为id值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getDataColumn</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> Uri uri<span style=color:#f92672>,</span> String selection<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                    String<span style=color:#f92672>[]</span> selectionArgs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Cursor cursor <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ContentProvider查询方式，通过uri加上指定的column，类似于查询数据库，uri中包括了provider的全称以及id，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 等价于数据库表与id，column等价于列，这样就可以直接取到对应的值；这里查询的是DISPLAY_NAME，一般来说文件名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 应该就包含了文件类型，但是在实际使用中，有的文件的DISPLAY_NAME与文件名并不相同，所以需要知道文件类型，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 可以使用MIME_TYPE，还有其他种类的信息例如修改时间等等，并不常用（DATA列已被弃用，但可以查询到文件路径）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> String column <span style=color:#f92672>=</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ImageColumns</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DISPLAY_NAME</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> projection <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            column
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 查询方法调用query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        cursor <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            uri<span style=color:#f92672>,</span> projection<span style=color:#f92672>,</span> selection<span style=color:#f92672>,</span> selectionArgs<span style=color:#f92672>,</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cursor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToFirst</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> column_index <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndexOrThrow</span><span style=color:#f92672>(</span>column<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>column_index<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cursor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在测试过程中发现，对于SAF中图片、音频、视频三个目录下的文件都可以获取其正确的信息，但是对于下载目录下的文件存在问题。网上的对于<code>com.android.providers.downloads</code>的查询Uri是如下三种，但是全部无法查询到任何结果，<code>public_downloads</code>报异常<code>Unknown URI</code>（Android 6可以查询到），<code>my_downloads</code>查询结果为空，<code>all_downloads</code>报异常</p><pre tabindex=0><code class=language-log data-lang=log>java.lang.SecurityException: Permission Denial: reading com.android.providers.downloads.provider.DownloadProvider uri content://downloads/all_downloads/2884 from pid=25434, uid=10786 requires android.permission.ACCESS_ALL_DOWNLOADS, or grantUriPermission()
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> String id <span style=color:#f92672>=</span> DocumentsContract<span style=color:#f92672>.</span><span style=color:#a6e22e>getDocumentId</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>id <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> id<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;raw:&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> id<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>4<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>String<span style=color:#f92672>[]</span> contentUriPrefixesToTry <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;content://downloads/public_downloads&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;content://downloads/my_downloads&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;content://downloads/all_downloads&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在API 29上多了一个新的Uri MediaStore.Downloads.EXTERNAL_CONTENT_URI，打印结果是
</span></span></span><span style=display:flex><span><span style=color:#75715e>// content://media/external/downloads，类似于上面的MediaStore.Images.Media.EXTERNAL_CONTENT_URI，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 但是还是查询不到任何结果；如果直接拿content://com.android.providers.downloads.documents/document/2884
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 来查询可以查到MIME_TYPE和DISPLAY_NAME，或者通过context.getContentResolver().getType(uri)获取MIME_TYPE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String contentUriPrefix <span style=color:#f92672>:</span> contentUriPrefixesToTry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Uri contentUri <span style=color:#f92672>=</span> ContentUris<span style=color:#f92672>.</span><span style=color:#a6e22e>withAppendedId</span><span style=color:#f92672>(</span>Uri<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span>contentUriPrefix<span style=color:#f92672>),</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>id<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String path <span style=color:#f92672>=</span> getDataColumn<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> contentUri<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>path <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>对于下载目录下的文件获取其文件名以及文件类型的方式就只能通过原始Uri查询了，但是DISPLAY_NAME并不一定与真实文件名相同，然后通过Uri取文件数据，如下所示</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 读取文件中的字符串
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>readTextFromUri</span><span style=color:#f92672>(</span>Uri uri<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    StringBuilder stringBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>(</span>InputStream inputStream <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            getContentResolver<span style=color:#f92672>().</span><span style=color:#a6e22e>openInputStream</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            BufferedReader reader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedReader<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> InputStreamReader<span style=color:#f92672>(</span>Objects<span style=color:#f92672>.</span><span style=color:#a6e22e>requireNonNull</span><span style=color:#f92672>(</span>inputStream<span style=color:#f92672>))))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String line<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>line <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>readLine</span><span style=color:#f92672>())</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            stringBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>line<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> stringBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>或者取数据的FileInputStream，再利用FileInputStream进行其他操作，比如复制文件或者发送</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ContentResolver contentResolver <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>ParcelFileDescriptor parcelFileDescriptor <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    parcelFileDescriptor <span style=color:#f92672>=</span> contentResolver<span style=color:#f92672>.</span><span style=color:#a6e22e>openFileDescriptor</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;r&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>FileNotFoundException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parcelFileDescriptor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FileChannel inputChannel <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>FileChannel outputChannel <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> start <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 为了验证是否获取到数据，可以将数据保存到其他位置，比如这里的aabb.rar
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>String dest <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/storage/emulated/0/Android/data/us.zoom.androidqdemo/files/aabb.rar&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    FileInputStream inputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileInputStream<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            parcelFileDescriptor<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileDescriptor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    inputChannel <span style=color:#f92672>=</span> inputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>getChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    outputChannel <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream<span style=color:#f92672>(</span>dest<span style=color:#f92672>).</span><span style=color:#a6e22e>getChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> srcSize <span style=color:#f92672>=</span> inputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> size <span style=color:#f92672>=</span> outputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>transferFrom</span><span style=color:#f92672>(</span>inputChannel<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> srcSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>==</span> srcSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> end <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Time: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>end <span style=color:#f92672>-</span> start<span style=color:#f92672>),</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_LONG</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>inputChannel <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            inputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>outputChannel <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            outputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=13-mediastore使用>1.3 MediaStore使用<a hidden class=anchor aria-hidden=true href=#13-mediastore使用>#</a></h3><p>MediaStore是用于获取或者添加媒体文件（图片、音频、视频）信息的工具，需要配合ContentResolver使用，MediaStore定义列的名称，通过ContentResolver的query和insert方法去查询和添加文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 获取系统外部存储内所有的图片
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param context
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return list
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>ImageInfo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getImageList</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>ImageInfo<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ContentResolver contentResolver <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 查询图片需要的Uri
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Uri uri <span style=color:#f92672>=</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>EXTERNAL_CONTENT_URI</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    String<span style=color:#f92672>[]</span> projection <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    String selection <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    String<span style=color:#f92672>[]</span> selectionArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    String sortOrder <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Cursor cursor <span style=color:#f92672>=</span> contentResolver<span style=color:#f92672>.</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> projection<span style=color:#f92672>,</span> selection<span style=color:#f92672>,</span> selectionArgs<span style=color:#f92672>,</span> sortOrder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cursor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ImageInfo imageInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ImageInfo<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getInt</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndexOrThrow</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>_ID</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 组装图片uri
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span> <span style=color:#f92672>=</span> ContentUris<span style=color:#f92672>.</span><span style=color:#a6e22e>withAppendedId</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndex</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DATA</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mimeType</span> <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndexOrThrow</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MIME_TYPE</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndexOrThrow</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TITLE</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>addTime</span> <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getLong</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndex</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DATE_ADDED</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            list<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>imageInfo<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>得到uri后可以通过上面提到的方式取数据也可以直接通过<code>ImageView.setImageURI(imageInfo.uri)</code>展示出来。如果有加载缩略图的要求，也可以通过Uri获取缩略图的Bitmap，调用loadThumbnail方法，并且可以指定缩略图大小（视频文件也可以加载缩略图），通过query方式查询缩略图的方式在Android Q上基本失效。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>loadThumbnail</span><span style=color:#f92672>(</span>imageInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Size<span style=color:#f92672>(</span>50<span style=color:#f92672>,</span> 50<span style=color:#f92672>),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>除了查询之外，比较重要的是插入媒体文件的功能，比如在外部存储的应用私有目录下的图片不会显示在SAF框架中，如果需要将其显示在图片目录中，需要将文件另存到公有目录下，一般是Pictures文件夹中。同理对音频、视频文件也是如此，通过insert方法传入的Uri决定文件保存位置。在Android Q上通过Uri将文件保存到Download目录下似乎不太可行，只能依靠DownloadManager直接下载保存到Download下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>SavePictureFile</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>file <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 首先需要获取到源文件的File对象，然后根据File对象的相关信息构造Uri，比如MIME_TYPE和DISPLAY_NAME等等
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Uri uri <span style=color:#f92672>=</span> insertFileIntoMediaStore<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> file<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 然后通过FileInputStream的方式将文件拷贝到目的文件中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> copyFile<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> file<span style=color:#f92672>,</span> uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Uri <span style=color:#a6e22e>insertFileIntoMediaStore</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> File file<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isPicture<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ContentValues contentValues <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ContentValues<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    contentValues<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Video</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DISPLAY_NAME</span><span style=color:#f92672>,</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    contentValues<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Video</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MIME_TYPE</span><span style=color:#f92672>,</span> isPicture <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;image/jpeg&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;video/mp4&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> 29<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        contentValues<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Video</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DATE_TAKEN</span><span style=color:#f92672>,</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>lastModified</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Android Q如果不设置RELATIVE_PATH，则默认保存在Pictures文件夹下，可以通过RELATIVE_PATH添加
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Pictures/MyPictures子文件夹，文件将会保存在MyPictures中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// contentValues.put(MediaStore.Video.Media.RELATIVE_PATH, Environment.DIRECTORY_PICTURES + File.separator + &#34;MyPictures&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Uri uri <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过insert方法得到公有目录下目的文件的Uri
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        uri <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>insert</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>(</span>isPicture <span style=color:#f92672>?</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>EXTERNAL_CONTENT_URI</span> <span style=color:#f92672>:</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Video</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>EXTERNAL_CONTENT_URI</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>,</span> contentValues
</span></span><span style=display:flex><span>        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> uri<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 文件复制的方式同上
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>copyFile</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> File srcFile<span style=color:#f92672>,</span> Uri destFile<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ContentResolver contentResolver <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ParcelFileDescriptor parcelFileDescriptor <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parcelFileDescriptor <span style=color:#f92672>=</span> contentResolver<span style=color:#f92672>.</span><span style=color:#a6e22e>openFileDescriptor</span><span style=color:#f92672>(</span>destFile<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;w&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>FileNotFoundException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parcelFileDescriptor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    FileChannel inputChannel <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    FileChannel outputChannel <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        FileInputStream inputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileInputStream<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                srcFile<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        inputChannel <span style=color:#f92672>=</span> inputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>getChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        outputChannel <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream<span style=color:#f92672>(</span>parcelFileDescriptor<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileDescriptor</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>getChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> srcSize <span style=color:#f92672>=</span> inputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> size <span style=color:#f92672>=</span> outputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>transferFrom</span><span style=color:#f92672>(</span>inputChannel<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> srcSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>==</span> srcSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>inputChannel <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                inputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>outputChannel <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                outputChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=2-android系统路径api补充说明>2. Android系统路径API补充说明<a hidden class=anchor aria-hidden=true href=#2-android系统路径api补充说明>#</a></h2><h3 id=21-内部存储与外部存储>2.1 内部存储与外部存储<a hidden class=anchor aria-hidden=true href=#21-内部存储与外部存储>#</a></h3><p>首先是内部存储与外部存储，内部存储类似<code>/data/user/0/us.zoom.androidqdemo/</code>，其中<code>us.zoom.androidqdemo</code>是包名，可以通过以下几个方法获取到当前应用的内部路径，内部存储一个最主要的特点就是与应用绑定，如果应用卸载了那么内部存储中应用私有目录的所有文件都会被删除，另一个特点就是内部存储无法直接通过手机中的文件管理或者其他名字的系统应用查看（而外部存储可见），内部存储的空间一般较小，需要谨慎使用，外部存储空间很大。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getDataDirectory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>getFilesDir<span style=color:#f92672>().</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /data/user/0/us.zoom.androidqdemo/files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>getCacheDir<span style=color:#f92672>().</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /data/user/0/us.zoom.androidqdemo/cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>getDir<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;myFile&#34;</span><span style=color:#f92672>,</span> MODE_PRIVATE<span style=color:#f92672>).</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /data/user/0/us.zoom.androidqdemo/app_myFile
</span></span></span></code></pre></div><p>外部存储类似<code>/storage/emulated/0/Android/data/us.zoom.androidqdemo/files/</code>（外部存储的应用私有目录）、<code>/storage/emulated/0/Pictures/Screenshots/</code>（外部存储的公有目录）这样的路径，我们通过文件管理这个系统应用进入的根目录就是<code>/storage/emulated/0</code>，在Android Q之前我们会发现这个目录下有非常多的乱七八糟的文件夹，除了<code>Alarms, Android, DCIM, Download, Movies, Music, Notifications, Pictures, Podcasts, Ringtones</code>之外，其他文件或者文件夹都是由你安装的其他APP自行生成的，所以Android Q之前的文件系统极其混乱，因此在Android Q之后不允许对外部存储中公有目录随意访问（可能提示权限拒绝），而内部存储以及外部存储的应用私有目录可以直接通过路径访问，因此在Android Q上我们就会发现外部存储的根目录仅有上面我提到的几个文件夹。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /storage/emulated/0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStoragePublicDirectory</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /storage/emulated/0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>getExternalFilesDir<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /storage/emulated/0/Android/data/us.zoom.androidqdemo/files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>getExternalCacheDir<span style=color:#f92672>().</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>()</span> <span style=color:#75715e>// /storage/emulated/0/Android/data/us.zoom.androidqdemo/cache
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果手机支持SD卡扩展，那么可以通过getExternalFilesDirs(&#34;&#34;)获取所有的外部存储（手机内置外部存储+SD卡）
</span></span></span></code></pre></div><p>现在的Android手机一般情况下存储空间都非常大了基本在32GB起步，64GB比较常见，一般用到的都是外部存储，但是还是需要判断外部存储空间是否可用，比如通过<code>Environment.getExternalStorageState()</code>判断是否正常挂载，如果不可用那么就需要使用到内部存储。</p><h3 id=22-缓存与其他文件>2.2 缓存与其他文件<a hidden class=anchor aria-hidden=true href=#22-缓存与其他文件>#</a></h3><p>在内部存储和外部存储的应用私有目录下会发现两个文件夹<code>files</code>和<code>cache</code>，很显然，<code>files</code>用于存储普通数据，<code>cache</code>用于存储缓存数据，如何使用这两个目录存储应用的文件就依赖开发人员的选择了，比如如果是应用本身下载的文件但是不想对外公开，那么可以放在<code>files</code>中，如果是应用读写文件过程中产生的临时文件可以放在<code>cache</code>中，实际开发时需自行设计。</p><ul><li><p>清除缓存：我们知道应用程序在运行过程中需要经过很多过程，比如读入程序，计算，输入输出等等，这些过程中肯定会产生很多的数据，它们在内存中，以供程序运行时调用。所以清除缓存清除的是APP运行过程中所产生的临时数据。</p></li><li><p>清除数据：清除数据才是真正的删除了我们保存在文件中的数据（永久性数据，如果不人为删除的话会一直保存在文件中）例如当我们在设置里面清除了某个应用的数据，那么<code>/data/user/0/packname/</code>和<code>/storage/emulated/0/Android/data/packname/</code>下的文件里面的数据会全部删除，包括<code>cache</code>，<code>files</code>，<code>lib</code>，<code>shared_prefs</code>等等。</p></li></ul><h2 id=3-fileutils相关代码>3. FileUtils相关代码<a hidden class=anchor aria-hidden=true href=#3-fileutils相关代码>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> us.zoom.androidqdemo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Copyright (C) 2018 OpenIntents.org
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e> * you may not use this file except in compliance with the License.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * You may obtain a copy of the License at
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *      http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Unless required by applicable law or agreed to in writing, software
</span></span></span><span style=display:flex><span><span style=color:#75715e> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span style=display:flex><span><span style=color:#75715e> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * See the License for the specific language governing permissions and
</span></span></span><span style=display:flex><span><span style=color:#75715e> * limitations under the License.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.content.ContentUris<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.content.Context<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.content.Intent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.database.Cursor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.database.DatabaseUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.net.Uri<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.os.Build<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.os.Environment<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.provider.DocumentsContract<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.provider.MediaStore<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.provider.OpenableColumns<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.util.Log<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.webkit.MimeTypeMap<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> androidx.annotation.NonNull<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> androidx.annotation.Nullable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> androidx.core.content.FileProvider<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.BufferedOutputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.File<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.FileFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.FileInputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.FileOutputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.text.DecimalFormat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Comparator<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FileUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DOCUMENTS_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;documents&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// configured android:authorities in AndroidManifest (https://developer.android.com/reference/android/support/v4/content/FileProvider)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String AUTHORITY <span style=color:#f92672>=</span>  <span style=color:#e6db74>&#34;YOUR_AUTHORITY.provider&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String HIDDEN_PREFIX <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;.&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * TAG for log messages.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;FileUtils&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> DEBUG <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span> <span style=color:#75715e>// Set to true to enable logging
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * File and folder comparator. TODO Expose sorting option method
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Comparator<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>&gt;</span> sComparator <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>f1<span style=color:#f92672>,</span> f2<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Sort alphabetically by lower case, which is much cleaner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> f1<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toLowerCase</span><span style=color:#f92672>().</span><span style=color:#a6e22e>compareTo</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                f2<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toLowerCase</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * File (not directories) filter.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> FileFilter sFileFilter <span style=color:#f92672>=</span> file <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String fileName <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Return files only (not directories) and skip hidden files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>isFile</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>fileName<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>HIDDEN_PREFIX<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Folder (directories) filter.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> FileFilter sDirFilter <span style=color:#f92672>=</span> file <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String fileName <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Return directories only and skip hidden directories
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>isDirectory</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>fileName<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>HIDDEN_PREFIX<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>FileUtils</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#75715e>//private constructor to enforce Singleton pattern
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Gets the extension of a file name, like &#34;.png&#34; or &#34;.jpg&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Extension including the dot(&#34;.&#34;); &#34;&#34; if there is no extension;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * null if uri was null.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getExtension</span><span style=color:#f92672>(</span>String uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>uri <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> dot <span style=color:#f92672>=</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>lastIndexOf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dot <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>dot<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// No extension.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Whether the URI is a local one.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isLocal</span><span style=color:#f92672>(</span>String url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> url <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;https://&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return True if Uri is a MediaStore Uri.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @author paulburke
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isMediaUri</span><span style=color:#f92672>(</span>Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;media&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthority</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Convert File into Uri.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param file
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return uri
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Uri <span style=color:#a6e22e>getUri</span><span style=color:#f92672>(</span>File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>file <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> Uri<span style=color:#f92672>.</span><span style=color:#a6e22e>fromFile</span><span style=color:#f92672>(</span>file<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Returns the path only (without file name).
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param file
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> File <span style=color:#a6e22e>getPathWithoutFilename</span><span style=color:#f92672>(</span>File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>file <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>isDirectory</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// no file to be split off. Return everything
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>return</span> file<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                String filename <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                String filepath <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Construct path without file name.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String pathwithoutname <span style=color:#f92672>=</span> filepath<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        filepath<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> filename<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pathwithoutname<span style=color:#f92672>.</span><span style=color:#a6e22e>endsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    pathwithoutname <span style=color:#f92672>=</span> pathwithoutname<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> pathwithoutname<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>pathwithoutname<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return The MIME type for the given file.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getMimeType</span><span style=color:#f92672>(</span>File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String extension <span style=color:#f92672>=</span> getExtension<span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>extension<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()</span> <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> MimeTypeMap<span style=color:#f92672>.</span><span style=color:#a6e22e>getSingleton</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getMimeTypeFromExtension</span><span style=color:#f92672>(</span>extension<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>1<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;application/octet-stream&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return The MIME type for the give Uri.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getMimeType</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>getPath<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getMimeType<span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return The MIME type for the give String Uri.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getMimeType</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> String url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String type <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>(</span>Uri<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span>url<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;application/octet-stream&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> type<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri The Uri to check.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Whether the Uri authority is local.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isLocalStorageDocument</span><span style=color:#f92672>(</span>Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> AUTHORITY<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthority</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri The Uri to check.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Whether the Uri authority is ExternalStorageProvider.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isExternalStorageDocument</span><span style=color:#f92672>(</span>Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;com.android.externalstorage.documents&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthority</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri The Uri to check.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Whether the Uri authority is DownloadsProvider.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isDownloadsDocument</span><span style=color:#f92672>(</span>Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;com.android.providers.downloads.documents&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthority</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri The Uri to check.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Whether the Uri authority is MediaProvider.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isMediaDocument</span><span style=color:#f92672>(</span>Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;com.android.providers.media.documents&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthority</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri The Uri to check.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Whether the Uri authority is Google Photos.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isGooglePhotosUri</span><span style=color:#f92672>(</span>Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;com.google.android.apps.photos.content&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthority</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Get the value of the data column for this Uri. This is useful for
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * MediaStore Uris, and other file-based ContentProviders.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param context       The context.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri           The Uri to query.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param selection     (Optional) Filter used in the query.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param selectionArgs (Optional) Selection arguments used in the query.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return The value of the _data column, which is typically a file path.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getDataColumn</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> Uri uri<span style=color:#f92672>,</span> String selection<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                       String<span style=color:#f92672>[]</span> selectionArgs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Cursor cursor <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String column <span style=color:#f92672>=</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Files</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FileColumns</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DATA</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> projection <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                column
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            cursor <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> projection<span style=color:#f92672>,</span> selection<span style=color:#f92672>,</span> selectionArgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cursor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToFirst</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    DatabaseUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>dumpCursor</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> column_index <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndexOrThrow</span><span style=color:#f92672>(</span>column<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>column_index<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cursor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Get a file path from a Uri. This will get the the path for Storage Access
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Framework Documents, as well as the _data field for the MediaStore and
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * other file-based ContentProviders.&lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Callers should check whether the path is local before assuming it
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * represents a local file.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param context The context.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param uri     The Uri to query.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see #isLocal(String)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see #getFile(Context, Uri)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getPath</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Context context<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String absolutePath <span style=color:#f92672>=</span> getLocalPath<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> absolutePath <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> absolutePath <span style=color:#f92672>:</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getLocalPath</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Context context<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; File -&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Authority: &#34;</span> <span style=color:#f92672>+</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthority</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;, Fragment: &#34;</span> <span style=color:#f92672>+</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getFragment</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;, Port: &#34;</span> <span style=color:#f92672>+</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getPort</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;, Query: &#34;</span> <span style=color:#f92672>+</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getQuery</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;, Scheme: &#34;</span> <span style=color:#f92672>+</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getScheme</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;, Host: &#34;</span> <span style=color:#f92672>+</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getHost</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;, Segments: &#34;</span> <span style=color:#f92672>+</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getPathSegments</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isKitKat <span style=color:#f92672>=</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION_CODES</span><span style=color:#f92672>.</span><span style=color:#a6e22e>KITKAT</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// DocumentProvider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isKitKat <span style=color:#f92672>&amp;&amp;</span> DocumentsContract<span style=color:#f92672>.</span><span style=color:#a6e22e>isDocumentUri</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// LocalStorageProvider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isLocalStorageDocument<span style=color:#f92672>(</span>uri<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// The path is the id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>return</span> DocumentsContract<span style=color:#f92672>.</span><span style=color:#a6e22e>getDocumentId</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ExternalStorageProvider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isExternalStorageDocument<span style=color:#f92672>(</span>uri<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String docId <span style=color:#f92672>=</span> DocumentsContract<span style=color:#f92672>.</span><span style=color:#a6e22e>getDocumentId</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> split <span style=color:#f92672>=</span> docId<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;:&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String type <span style=color:#f92672>=</span> split<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;primary&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>type<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> split<span style=color:#f92672>[</span>1<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;home&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>type<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/documents/&#34;</span> <span style=color:#f92672>+</span> split<span style=color:#f92672>[</span>1<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// DownloadsProvider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isDownloadsDocument<span style=color:#f92672>(</span>uri<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String id <span style=color:#f92672>=</span> DocumentsContract<span style=color:#f92672>.</span><span style=color:#a6e22e>getDocumentId</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>id <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> id<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;raw:&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> id<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>4<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Android Q 似乎无效
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String<span style=color:#f92672>[]</span> contentUriPrefixesToTry <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;content://downloads/public_downloads&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;content://downloads/my_downloads&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;content://downloads/all_downloads&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String contentUriPrefix <span style=color:#f92672>:</span> contentUriPrefixesToTry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    Uri contentUri <span style=color:#f92672>=</span> ContentUris<span style=color:#f92672>.</span><span style=color:#a6e22e>withAppendedId</span><span style=color:#f92672>(</span>Uri<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span>contentUriPrefix<span style=color:#f92672>),</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>id<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        String path <span style=color:#f92672>=</span> getDataColumn<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> contentUri<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>path <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// path could not be retrieved using ContentResolver, therefore copy file to accessible cache using streams
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String fileName <span style=color:#f92672>=</span> getFileName<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                File cacheDir <span style=color:#f92672>=</span> getDocumentCacheDir<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                File file <span style=color:#f92672>=</span> generateFileName<span style=color:#f92672>(</span>fileName<span style=color:#f92672>,</span> cacheDir<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                String destinationPath <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>file <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    destinationPath <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getAbsolutePath</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    saveFileFromUri<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>,</span> destinationPath<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> destinationPath<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// MediaProvider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMediaDocument<span style=color:#f92672>(</span>uri<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String docId <span style=color:#f92672>=</span> DocumentsContract<span style=color:#f92672>.</span><span style=color:#a6e22e>getDocumentId</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> split <span style=color:#f92672>=</span> docId<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;:&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String type <span style=color:#f92672>=</span> split<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                Uri contentUri <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;image&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>type<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    contentUri <span style=color:#f92672>=</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Images</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>EXTERNAL_CONTENT_URI</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;video&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>type<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    contentUri <span style=color:#f92672>=</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Video</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>EXTERNAL_CONTENT_URI</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;audio&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>type<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    contentUri <span style=color:#f92672>=</span> MediaStore<span style=color:#f92672>.</span><span style=color:#a6e22e>Audio</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Media</span><span style=color:#f92672>.</span><span style=color:#a6e22e>EXTERNAL_CONTENT_URI</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String selection <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;_id=?&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> selectionArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>                        split<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> getDataColumn<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> contentUri<span style=color:#f92672>,</span> selection<span style=color:#f92672>,</span> selectionArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// MediaStore (and general)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;content&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getScheme</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Return the remote address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isGooglePhotosUri<span style=color:#f92672>(</span>uri<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getLastPathSegment</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> getDataColumn<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// File
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;file&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getScheme</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Convert Uri into File, if possible.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return file A local file that the Uri was pointing to, or null if the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Uri is unsupported or pointed to a remote resource.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @author paulburke
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see #getPath(Context, Uri)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> File <span style=color:#a6e22e>getFile</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>uri <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String path <span style=color:#f92672>=</span> getPath<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>path <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isLocal<span style=color:#f92672>(</span>path<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Get the file size in a human-readable string.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param size
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @author paulburke
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getReadableFileSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> size<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> BYTES_IN_KILOBYTES <span style=color:#f92672>=</span> 1024<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> DecimalFormat dec <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DecimalFormat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;###.#&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String KILOBYTES <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; KB&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String MEGABYTES <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; MB&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String GIGABYTES <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; GB&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>float</span> fileSize <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String suffix <span style=color:#f92672>=</span> KILOBYTES<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>&gt;</span> BYTES_IN_KILOBYTES<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            fileSize <span style=color:#f92672>=</span> size <span style=color:#f92672>/</span> BYTES_IN_KILOBYTES<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fileSize <span style=color:#f92672>&gt;</span> BYTES_IN_KILOBYTES<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                fileSize <span style=color:#f92672>=</span> fileSize <span style=color:#f92672>/</span> BYTES_IN_KILOBYTES<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fileSize <span style=color:#f92672>&gt;</span> BYTES_IN_KILOBYTES<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    fileSize <span style=color:#f92672>=</span> fileSize <span style=color:#f92672>/</span> BYTES_IN_KILOBYTES<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    suffix <span style=color:#f92672>=</span> GIGABYTES<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    suffix <span style=color:#f92672>=</span> MEGABYTES<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>dec<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span>fileSize<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> suffix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Get the Intent for selecting content to be used in an Intent Chooser.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return The intent for opening a file with Intent.createChooser()
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Intent <span style=color:#a6e22e>createGetContentIntent</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Implicitly allow the user to select a particular kind of data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> Intent intent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Intent<span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_GET_CONTENT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// The MIME data type filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;*/*&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Only return URIs that can be opened with ContentResolver
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addCategory</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>CATEGORY_OPENABLE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> intent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Creates View intent for given file
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param file
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return The intent for viewing file
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Intent <span style=color:#a6e22e>getViewIntent</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//Uri uri = Uri.fromFile(file);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Uri uri <span style=color:#f92672>=</span> FileProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>getUriForFile</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> AUTHORITY<span style=color:#f92672>,</span> file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Intent intent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Intent<span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_VIEW</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        String url <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.doc&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.docx&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Word document
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;application/msword&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.pdf&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// PDF file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;application/pdf&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.ppt&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.pptx&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Powerpoint file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;application/vnd.ms-powerpoint&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.xls&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.xlsx&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Excel file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;application/vnd.ms-excel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.zip&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.rar&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// WAV audio file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;application/x-wav&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.rtf&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// RTF file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;application/rtf&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.wav&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.mp3&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// WAV audio file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;audio/x-wav&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.gif&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// GIF file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;image/gif&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.jpg&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.jpeg&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.png&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// JPG file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;image/jpeg&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.txt&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Text file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;text/plain&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.3gp&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.mpg&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.mpeg&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.mpe&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.mp4&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.avi&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Video files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;video/*&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataAndType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;*/*&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addFlags</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_ACTIVITY_NEW_TASK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addFlags</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_GRANT_READ_URI_PERMISSION</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addFlags</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_GRANT_WRITE_URI_PERMISSION</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> intent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> File <span style=color:#a6e22e>getDownloadsDir</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStoragePublicDirectory</span><span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>DIRECTORY_DOWNLOADS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> File <span style=color:#a6e22e>getDocumentCacheDir</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        File dir <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getCacheDir</span><span style=color:#f92672>(),</span> DOCUMENTS_DIR<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>dir<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            dir<span style=color:#f92672>.</span><span style=color:#a6e22e>mkdirs</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        logDir<span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getCacheDir</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        logDir<span style=color:#f92672>(</span>dir<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dir<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logDir</span><span style=color:#f92672>(</span>File dir<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(!</span>DEBUG<span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Dir=&#34;</span> <span style=color:#f92672>+</span> dir<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        File<span style=color:#f92672>[]</span> files <span style=color:#f92672>=</span> dir<span style=color:#f92672>.</span><span style=color:#a6e22e>listFiles</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>File file <span style=color:#f92672>:</span> files<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;File=&#34;</span> <span style=color:#f92672>+</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> File <span style=color:#a6e22e>generateFileName</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> String name<span style=color:#f92672>,</span> File directory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>directory<span style=color:#f92672>,</span> name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String fileName <span style=color:#f92672>=</span> name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            String extension <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> dotIndex <span style=color:#f92672>=</span> name<span style=color:#f92672>.</span><span style=color:#a6e22e>lastIndexOf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;.&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dotIndex <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                fileName <span style=color:#f92672>=</span> name<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> dotIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                extension <span style=color:#f92672>=</span> name<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>dotIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                index<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>                name <span style=color:#f92672>=</span> fileName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;(&#39;</span> <span style=color:#f92672>+</span> index <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;)&#39;</span> <span style=color:#f92672>+</span> extension<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>directory<span style=color:#f92672>,</span> name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>createNewFile</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logDir<span style=color:#f92672>(</span>directory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> file<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//    /**
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     * Writes response body to disk
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     * @param body ResponseBody
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     * @param path file path
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     * @return File
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     */
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    public static File writeResponseBodyToDisk(ResponseBody body, String path) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        try {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            File target = new File(path);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            InputStream inputStream = null;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            OutputStream outputStream = null;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            try {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                byte[] fileReader = new byte[4096];
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                inputStream = body.byteStream();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                outputStream = new FileOutputStream(target);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                while (true) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    int read = inputStream.read(fileReader);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    if (read == -1) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        break;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    outputStream.write(fileReader, 0, read);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                outputStream.flush();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                return target;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            } catch (IOException e) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                return null;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            } finally {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                if (inputStream != null) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    inputStream.close();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                if (outputStream != null) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    outputStream.close();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        } catch (IOException e) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            return null;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveFileFromUri</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> Uri uri<span style=color:#f92672>,</span> String destinationPath<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        InputStream is <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        BufferedOutputStream bos <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            is <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>openInputStream</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            bos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedOutputStream<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FileOutputStream<span style=color:#f92672>(</span>destinationPath<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> buf <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>1024<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            is<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                bos<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>is<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>is <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> is<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bos <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> bos<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>readBytesFromFile</span><span style=color:#f92672>(</span>String filePath<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        FileInputStream fileInputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytesArray <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>filePath<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            bytesArray <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//read file into bytes[]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            fileInputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileInputStream<span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            fileInputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>bytesArray<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fileInputStream <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    fileInputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> bytesArray<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> File <span style=color:#a6e22e>createTempImageFile</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> String fileName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Create an image file name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        File storageDir <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getCacheDir</span><span style=color:#f92672>(),</span> DOCUMENTS_DIR<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> File<span style=color:#f92672>.</span><span style=color:#a6e22e>createTempFile</span><span style=color:#f92672>(</span>fileName<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;.jpg&#34;</span><span style=color:#f92672>,</span> storageDir<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getFileName</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String mimeType <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        String filename <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mimeType <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> context <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String path <span style=color:#f92672>=</span> getPath<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>path <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                filename <span style=color:#f92672>=</span> getName<span style=color:#f92672>(</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                filename <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Cursor returnCursor <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>().</span><span style=color:#a6e22e>query</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>returnCursor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> nameIndex <span style=color:#f92672>=</span> returnCursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getColumnIndex</span><span style=color:#f92672>(</span>OpenableColumns<span style=color:#f92672>.</span><span style=color:#a6e22e>DISPLAY_NAME</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                returnCursor<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToFirst</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                filename <span style=color:#f92672>=</span> returnCursor<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>nameIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                returnCursor<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> filename<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getName</span><span style=color:#f92672>(</span>String filename<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>filename <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span><span style=color:#a6e22e>lastIndexOf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> filename<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>index <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=参考>参考：<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ol><li><a href=https://developer.android.com/preview/privacy/scoped-storage>Android Q 隐私权变更：分区存储</a></li><li><a href=https://developer.android.com/training/data-storage/files/external>Save a file on external storage</a></li><li><a href=https://juejin.im/post/5d838a7af265da03ee6a90cd>Android 10(Android Q) 适配</a></li><li><a href="https://developer.android.com/guide/topics/providers/document-provider?hl=zh-cn">使用存储访问框架打开文件</a></li><li><a href=https://segmentfault.com/a/1190000019224425>Android Q 沙箱适配多媒体文件总结</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://zhoutao822.github.io/tags/android-q/>Android Q</a></li></ul><nav class=paginav><a class=prev href=https://zhoutao822.github.io/posts/shareelement/><span class=title>« Prev Page</span><br><span>Android-共享元素动画效果</span></a>
<a class=next href=https://zhoutao822.github.io/posts/rxjava/><span class=title>Next Page »</span><br><span>Android框架-RxJava</span></a></nav></footer><script src=https://utteranc.es/client.js repo=zhoutao822/zhoutao822.github.io issue-term=title theme=github-dark crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://zhoutao822.github.io/>Tao's Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>