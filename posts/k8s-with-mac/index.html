<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>K8s with Mac | Tao's Notes</title>
<meta name=keywords content="k3s,k8s,k9s,multipass">
<meta name=description content="Run k8s on Mac with k3s and multipass">
<meta name=author content="Me">
<link rel=canonical href=https://zhoutao822.github.io/posts/k8s-with-mac/>
<meta name=google-site-verification content="Tao">
<meta name=yandex-verification content="Tao">
<meta name=msvalidate.01 content="Tao">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://zhoutao822.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://zhoutao822.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://zhoutao822.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://zhoutao822.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://zhoutao822.github.io/favicon.ico>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="K8s with Mac">
<meta property="og:description" content="Run k8s on Mac with k3s and multipass">
<meta property="og:type" content="article">
<meta property="og:url" content="https://zhoutao822.github.io/posts/k8s-with-mac/"><meta property="og:image" content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-02T14:10:19+08:00">
<meta property="article:modified_time" content="2022-01-02T14:10:19+08:00"><meta property="og:site_name" content="Tao's Notes">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="K8s with Mac">
<meta name=twitter:description content="Run k8s on Mac with k3s and multipass">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zhoutao822.github.io/posts/"},{"@type":"ListItem","position":2,"name":"K8s with Mac","item":"https://zhoutao822.github.io/posts/k8s-with-mac/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"K8s with Mac","name":"K8s with Mac","description":"Run k8s on Mac with k3s and multipass","keywords":["k3s","k8s","k9s","multipass"],"articleBody":"1. Multipass \u0026\u0026 K3s \u0026\u0026 k9s 1.1 Multipass说明 Multipass是一个轻量级的可以用于开启Ubuntu虚拟机的命令行工具，你可以把它当做一个无图形界面的Virtual Box或者Parallels Desktop。在mac上可以通过brew安装，命令为\nbrew install --cask multipass 安装完成后执行multipass version，输出如下结果说明安装成功\n~ ❯ multipass version 20:45:29 multipass 1.8.1+mac multipassd 1.8.1+mac Multipass常见指令如下：\nLaunch an instance (by default you get the current Ubuntu LTS)\nmultipass launch --name foo Run commands in that instance, try running bash (logout or ctrl-d to quit)\nmultipass exec foo -- lsb_release -a Pass a cloud-init metadata file to an instance on launch. See using cloud-init with multipass for more details\nmultipass launch -n bar --cloud-init cloud-config.yaml See your instances\nmultipass list Stop and start instances\nmultipass stop foo bar multipass start foo Clean up what you don’t need\nmultipass delete bar multipass purge Find alternate images to launch with multipass\nmultipass find Get help\nmultipass help multipass help  1.2 K3s k3s用于快速搭建k8s集群，注意这里k3s不是安装到mac上的而是安装到multipass创建的Ubuntu实例中，常用k3s安装脚本如下\ncurl -sfL https://get.k3s.io | sh - 一般来说国内访问可能失败，导致无法拉取需要资源，所以可以使用国内镜像源\ncurl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh - k3s常见环境变量如下\n   Environment Variable Description     INSTALL_K3S_SKIP_DOWNLOAD 如果设置为 “true “将不会下载 K3s 的哈希值或二进制。   INSTALL_K3S_SYMLINK 默认情况下，如果路径中不存在命令，将为 kubectl、crictl 和 ctr 二进制文件创建符号链接。如果设置为’skip’将不会创建符号链接，而’force’将覆盖。   INSTALL_K3S_SKIP_ENABLE 如果设置为 “true”，将不启用或启动 K3s 服务。   INSTALL_K3S_SKIP_START 如果设置为 “true “将不会启动 K3s 服务。   INSTALL_K3S_VERSION 从 Github 下载 K3s 的版本。如果没有指定，将尝试从\"stable\"频道下载。   INSTALL_K3S_BIN_DIR 安装 K3s 二进制文件、链接和卸载脚本的目录，或者使用/usr/local/bin作为默认目录。   INSTALL_K3S_BIN_DIR_READ_ONLY 如果设置为 true 将不会把文件写入INSTALL_K3S_BIN_DIR，强制设置INSTALL_K3S_SKIP_DOWNLOAD=true。   INSTALL_K3S_SYSTEMD_DIR 安装 systemd 服务和环境文件的目录，或者使用/etc/systemd/system作为默认目录。   INSTALL_K3S_EXEC 带有标志的命令，用于在服务中启动 K3s。如果未指定命令，并且设置了K3S_URL，它将默认为“agent”。如果未设置K3S_URL，它将默认为“server”。要获得帮助，请参考此示例。   INSTALL_K3S_NAME 要创建的 systemd 服务名称，如果以服务器方式运行 k3s，则默认为’k3s'；如果以 agent 方式运行 k3s，则默认为’k3s-agent'。如果指定了服务名，则服务名将以’k3s-‘为前缀。   INSTALL_K3S_TYPE 要创建的 systemd 服务类型，如果没有指定，将默认使用 K3s exec 命令。   INSTALL_K3S_SELINUX_WARN 如果设置为 true，则在没有找到 k3s-selinux 策略的情况下将继续。   INSTALL_K3S_SKIP_SELINUX_RPM 如果设置为 “true “将跳过 k3s RPM 的自动安装。   INSTALL_K3S_CHANNEL_URL 用于获取 K3s 下载网址的频道 URL。默认为 https://update.k3s.io/v1-release/channels 。   INSTALL_K3S_CHANNEL 用于获取 K3s 下载 URL 的通道。默认值为 “stable”。选项包括：stable, latest, testing。   K3S_CONFIG_FILE 指定配置文件的位置。默认目录为/etc/rancher/k3s/config.yaml。   K3S_TOKEN 用于将 server 或 agent 加入集群的共享 secret。   K3S_TOKEN_FILE 指定 cluster-secret,token 的文件目录。    1.3 multipass-k3s脚本 k3s cluster on multipass instances给出了脚本，可以直接利用multipass和k3s创建k8s集群，我做了一些修改，比如替换了国内用的镜像源、使用2个slave节点、修改内存之类\n#!/usr/bin/env bash  # Configure your settings # Name for the cluster/configuration files NAME=\"demo-cluster\" # Ubuntu image to use (xenial/bionic) IMAGE=\"focal\" # How many additional server instances to create SERVER_COUNT_MACHINE=\"0\" # How many agent instances to create AGENT_COUNT_MACHINE=\"2\" # How many CPUs to allocate to each machine SERVER_CPU_MACHINE=\"2\" AGENT_CPU_MACHINE=\"1\" # How much disk space to allocate to each machine SERVER_DISK_MACHINE=\"5G\" AGENT_DISK_MACHINE=\"5G\" # How much memory to allocate to each machine SERVER_MEMORY_MACHINE=\"2G\" AGENT_MEMORY_MACHINE=\"1G\" # Install channel to use (embedded etcd is fully supported starting with v1.19.5+k3s1) CHANNEL=stable # Preconfigured secret to join the cluster (or autogenerated if empty) SERVER_TOKEN=\"\" # Preconfigured secret to join the cluster (or autogenerated if empty) AGENT_TOKEN=\"\" ## Nothing to change after this line if [ -x \"$(command -v multipass.exe)\"  /dev/null 2\u00261 ]; then # Windows MULTIPASSCMD=\"multipass.exe\" elif [ -x \"$(command -v multipass)\"  /dev/null 2\u00261 ]; then # Linux/MacOS MULTIPASSCMD=\"multipass\" else echo \"The multipass binary (multipass or multipass.exe) is not available or not in your \\$PATH\" exit 1 fi if [ -z $SERVER_TOKEN ]; then SERVER_TOKEN=$(cat /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | fold -w 20 | head -n 1 | tr '[:upper:]' '[:lower:]') echo \"No server token given, generated server token: ${SERVER_TOKEN}\" fi if [ -z $AGENT_TOKEN ]; then AGENT_TOKEN=$(cat /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | fold -w 20 | head -n 1 | tr '[:upper:]' '[:lower:]') echo \"No agent token given, generated agent token: ${AGENT_TOKEN}\" fi # Check if name is given or create random string if [ -z $NAME ]; then NAME=$(cat /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | fold -w 6 | head -n 1 | tr '[:upper:]' '[:lower:]') echo \"No name given, generated name: ${NAME}\" fi echo \"Creating cluster ${NAME}with $(( $SERVER_COUNT_MACHINE + 1 ))server(s) and ${AGENT_COUNT_MACHINE}agent(s)\" # Prepare cloud-init # Cloud init template read -r -d '' SERVER_INIT_CLOUDINIT_TEMPLATE #cloud-config runcmd: - '\\curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_CHANNEL=$CHANNEL K3S_TOKEN=$SERVER_TOKEN K3S_AGENT_TOKEN=$AGENT_TOKEN INSTALL_K3S_EXEC=\"server --cluster-init\" K3S_KUBECONFIG_MODE=644 sh -' EOM echo \"$SERVER_INIT_CLOUDINIT_TEMPLATE\"  \"${NAME}-init-cloud-init.yaml\" echo \"Cloud-init is created at ${NAME}-init-cloud-init.yaml\" echo \"Creating initial server instance: k3s-server-${NAME}\" echo \"Running $MULTIPASSCMDlaunch --cpus $SERVER_CPU_MACHINE--disk $SERVER_DISK_MACHINE--mem $SERVER_MEMORY_MACHINE$IMAGE--name k3s-server-$NAME--cloud-init ${NAME}-init-cloud-init.yaml\" $MULTIPASSCMD launch --cpus $SERVER_CPU_MACHINE --disk $SERVER_DISK_MACHINE --mem $SERVER_MEMORY_MACHINE $IMAGE --name k3s-server-$NAME --cloud-init \"${NAME}-init-cloud-init.yaml\" if [ $? -ne 0 ]; then echo \"There was an error launching the instance\" exit 1 fi echo \"Checking for Node being Ready on k3s-server-${NAME}\" $MULTIPASSCMD exec k3s-server-$NAME -- /bin/bash -c 'while [[ $(sudo k3s kubectl get nodes --no-headers 2/dev/null | grep -c -v \"NotReady\") -eq 0 ]]; do sleep 2; done' echo \"Node is Ready on k3s-server-${NAME}\" # Retrieve info to join agent to cluster SERVER_IP=$($MULTIPASSCMD info k3s-server-$NAME | grep IPv4 | awk '{ print $2 }') URL=\"https://$(echo $SERVER_IP | sed -e 's/[[:space:]]//g'):6443\" # Create additional servers if [ \"${SERVER_COUNT_MACHINE}\" -gt 0 ]; then read -r -d '' SERVER_CLOUDINIT_TEMPLATE #cloud-config runcmd: - '\\curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_CHANNEL=$CHANNEL K3S_TOKEN=$SERVER_TOKEN K3S_AGENT_TOKEN=$AGENT_TOKEN INSTALL_K3S_EXEC=\"server --server $URL\" K3S_KUBECONFIG_MODE=644 sh -' EOM echo \"$SERVER_CLOUDINIT_TEMPLATE\"  \"${NAME}-cloud-init.yaml\" echo \"Creating ${SERVER_COUNT_MACHINE}additional server instances\" for i in $(eval echo \"{1..$SERVER_COUNT_MACHINE}\"); do echo \"Running $MULTIPASSCMDlaunch --cpus $SERVER_CPU_MACHINE--disk $SERVER_DISK_MACHINE--mem $SERVER_MEMORY_MACHINE$IMAGE--name k3s-server-$NAME-$i--cloud-init ${NAME}-cloud-init.yaml\" $MULTIPASSCMD launch --cpus $SERVER_CPU_MACHINE --disk $SERVER_DISK_MACHINE --mem $SERVER_MEMORY_MACHINE $IMAGE --name k3s-server-$NAME-$i --cloud-init \"${NAME}-cloud-init.yaml\" if [ $? -ne 0 ]; then echo \"There was an error launching the instance\" exit 1 fi echo \"Checking for Node being Ready on k3s-server-${NAME}\" $MULTIPASSCMD exec k3s-server-$NAME-$i -- /bin/bash -c 'while [[ $(sudo k3s kubectl get nodes --no-headers 2/dev/null | grep -c -v \"NotReady\") -eq 0 ]]; do sleep 2; done' echo \"Node is Ready on k3s-server-${NAME}-${i}\" done fi if [ \"${AGENT_COUNT_MACHINE}\" -gt 0 ]; then # Prepare agent cloud-init # Cloud init template read -r -d '' AGENT_CLOUDINIT_TEMPLATE #cloud-config runcmd: - '\\curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_CHANNEL=$CHANNEL K3S_TOKEN=$AGENT_TOKEN K3S_URL=$URL sh -' EOM echo \"$AGENT_CLOUDINIT_TEMPLATE\"  \"${NAME}-agent-cloud-init.yaml\" echo \"Cloud-init is created at ${NAME}-agent-cloud-init.yaml\" for i in $(eval echo \"{1..$AGENT_COUNT_MACHINE}\"); do echo \"Running $MULTIPASSCMDlaunch --cpus $AGENT_CPU_MACHINE--disk $AGENT_DISK_MACHINE--mem $AGENT_MEMORY_MACHINE$IMAGE--name k3s-agent-$NAME-$i--cloud-init ${NAME}-agent-cloud-init.yaml\" $MULTIPASSCMD launch --cpus $AGENT_CPU_MACHINE --disk $AGENT_DISK_MACHINE --mem $AGENT_MEMORY_MACHINE $IMAGE --name k3s-agent-$NAME-$i --cloud-init \"${NAME}-agent-cloud-init.yaml\" if [ $? -ne 0 ]; then echo \"There was an error launching the instance\" exit 1 fi echo \"Checking for Node k3s-agent-$NAME-$ibeing registered\" $MULTIPASSCMD exec k3s-server-$NAME -- bash -c \"until sudo k3s kubectl get nodes --no-headers | grep -c k3s-agent-$NAME-$i/dev/null; do sleep 2; done\" echo \"Checking for Node k3s-agent-$NAME-$ibeing Ready\" $MULTIPASSCMD exec k3s-server-$NAME -- bash -c \"until sudo k3s kubectl get nodes --no-headers | grep k3s-agent-$NAME-$i| grep -c -v NotReady /dev/null; do sleep 2; done\" echo \"Node k3s-agent-$NAME-$iis Ready on k3s-server-${NAME}\" done fi $MULTIPASSCMD copy-files k3s-server-$NAME:/etc/rancher/k3s/k3s.yaml $NAME-kubeconfig-orig.yaml sed \"/^[[:space:]]*server:/ s_:.*_: \\\"https://$(echo $SERVER_IP | sed -e 's/[[:space:]]//g'):6443\\\"_\" $NAME-kubeconfig-orig.yaml  $NAME-kubeconfig.yaml echo \"k3s setup finished\" $MULTIPASSCMD exec k3s-server-$NAME -- sudo k3s kubectl get nodes echo \"You can now use the following command to connect to your cluster\" echo \"$MULTIPASSCMDexec k3s-server-${NAME}-- sudo k3s kubectl get nodes\" echo \"Or use kubectl directly\" echo \"kubectl --kubeconfig ${NAME}-kubeconfig.yaml get nodes\" 1.4 k9s K9s 提供了一个与 K8s 集群交互的终端 UI，用于简化导航、观察以及管理应用程序。K9s 会持续监控 K8s 的变化，并提供后续命令与所观察到的资源进行交互。可以利用如下GUI管理k8s\n1.5 一些问题  brew无法安装cask，超时之类，可以使用中科大的brew源； 在启用某些VPN软件时，multipass无法拉取镜像，导致无法创建Ubuntu实例或者无法安装k3s，只能关闭VPN软件； k3s启动失败，一般需要使用国内镜像源。  2. 安装与测试 步骤如下：\n Brew安装multipass、k9s和kubectl-cli； 创建k3s-launch.sh，并复制粘贴上面的脚本内容，需要自行修改以适配自己的环境； 运行bash k3s-launch.sh，等待集群部署，脚本执行成功后可以看到multipass多了3个实例，不带数字的是master节点，其他是slave节点，而且目录下多了几个文件；  ~/Projects/k3s ❯ ll 21:13:40 total 56 -rw-r--r-- 1 tao staff 216B Jan 2 14:05 demo-cluster-agent-cloud-init.yaml -rw-r--r-- 1 tao staff 283B Jan 2 14:04 demo-cluster-init-cloud-init.yaml -rw-r--r-- 1 tao staff 2.9K Jan 2 14:07 demo-cluster-kubeconfig-orig.yaml -rw-r--r-- 1 tao staff 2.9K Jan 2 14:07 demo-cluster-kubeconfig.yaml -rw-r--r--@ 1 tao staff 7.0K Jan 2 14:04 k3s-launch.sh 创建一个deploy-nginx.yaml，内容如下：  apiVersion: apps/v1 kind: Deployment metadata: name: nginx namespace: dev spec: replicas: 3 selector: matchLabels: run: nginx template: metadata: labels: run: nginx spec: containers: - image: nginx:1.17.1 name: nginx ports: - containerPort: 80 protocol: TCP 使用kubectl控制集群，运行如下命令  # get nodes查看节点是否存活 ~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml get nodes ⎈ docker-desktop 21:13:53 NAME STATUS ROLES AGE VERSION k3s-agent-demo-cluster-1 Ready  7h10m v1.22.5+k3s1 k3s-agent-demo-cluster-2 Ready  7h9m v1.22.5+k3s1 k3s-server-demo-cluster Ready control-plane,etcd,master 7h11m v1.22.5+k3s1 # create namespace dev创建dev命名空间 ~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml create namespace dev namespace/dev created # 创建测试pod ~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml create -f deploy-nginx.yaml ⎈ docker-desktop 21:48:22 deployment.apps/nginx created # 查看pod状态 ~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml get pods -n dev ⎈ docker-desktop 21:48:32 NAME READY STATUS RESTARTS AGE nginx-66ffc897cf-55b6d 1/1 Running 0 53s nginx-66ffc897cf-d5r29 1/1 Running 0 53s nginx-66ffc897cf-vfpkg 1/1 Running 0 53s # 创建暴露给外部的Service ~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml expose deploy nginx --name=svc-nginx --type=NodePort --port=80 --target-port=80 -n dev service/svc-nginx exposed # 查看Service状态和端口号映射 ~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml get svc svc-nginx -n dev -o wide ⎈ docker-desktop 21:50:14 NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR svc-nginx NodePort 10.43.227.135  80:30355/TCP 25s run=nginx # 查看master节点ip ~/Projects/k3s ❯ multipass list 21:50:39 Name State IPv4 Image k3s-agent-demo-cluster-1 Running 192.168.64.16 Ubuntu 20.04 LTS 10.42.1.0 10.42.1.1 k3s-agent-demo-cluster-2 Running 192.168.64.17 Ubuntu 20.04 LTS 10.42.2.0 10.42.2.1 k3s-server-demo-cluster Running 192.168.64.15 Ubuntu 20.04 LTS 10.42.0.0 10.42.0.1 # 访问 192.168.64.15:30355，能够输出nginx信息 ~/Projects/k3s ❯ curl 192.168.64.15:30355 21:51:45   Welcome to nginx!  body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; }    Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\nFor online documentation and support please refer to =\"http://nginx.org/\"nginx.org. Commercial support is available at =\"http://nginx.com/\"nginx.com.\nThank you for using nginx.\n  利用k9s查看k8s集群状态，详细玩法可以去看k9s官网  k9s --kubeconfig demo-cluster-kubeconfig.yaml -n dev pod状态\nservice状态\ndeploy状态\n参考  k3s cluster on multipass instances K3s: Lightweight Kubernetes Ubuntu VMs on demand for any workstation K3s 安装选项介绍 k9s Kubernetes CLI To Manage Your Clusters In Style!  ","wordCount":"1457","inLanguage":"en","datePublished":"2022-01-02T14:10:19+08:00","dateModified":"2022-01-02T14:10:19+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhoutao822.github.io/posts/k8s-with-mac/"},"publisher":{"@type":"Organization","name":"Tao's Notes","logo":{"@type":"ImageObject","url":"https://zhoutao822.github.io/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://zhoutao822.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches>
</span>
</div>
<ul id=menu>
<li>
<a href=https://zhoutao822.github.io/archives/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://zhoutao822.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://zhoutao822.github.io/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://zhoutao822.github.io/series/ title=Series>
<span>Series</span>
</a>
</li>
<li>
<a href=https://zhoutao822.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://zhoutao822.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://zhoutao822.github.io/posts/>Posts</a></div>
<h1 class=post-title>
K8s with Mac
</h1>
<div class=post-meta><span title="2022-01-02 14:10:19 +0800 +0800">January 2, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Zhoutao822/zhoutao822.github.io/tree/main/content//posts/k8s-with-mac.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul><ul>
<li>
<a href=#1-multipass--k3s--k9s aria-label="1. Multipass &amp;amp;&amp;amp; K3s &amp;amp;&amp;amp; k9s">1. Multipass && K3s && k9s</a><ul>
<li>
<a href=#11-multipass%e8%af%b4%e6%98%8e aria-label="1.1 Multipass说明">1.1 Multipass说明</a></li>
<li>
<a href=#12-k3s aria-label="1.2 K3s">1.2 K3s</a></li>
<li>
<a href=#13-multipass-k3s%e8%84%9a%e6%9c%ac aria-label="1.3 multipass-k3s脚本">1.3 multipass-k3s脚本</a></li>
<li>
<a href=#14-k9s aria-label="1.4 k9s">1.4 k9s</a></li>
<li>
<a href=#15-%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98 aria-label="1.5 一些问题">1.5 一些问题</a></li></ul>
</li>
<li>
<a href=#2-%e5%ae%89%e8%a3%85%e4%b8%8e%e6%b5%8b%e8%af%95 aria-label="2. 安装与测试">2. 安装与测试</a></li></ul>
<li>
<a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=1-multipass--k3s--k9s>1. Multipass && K3s && k9s<a hidden class=anchor aria-hidden=true href=#1-multipass--k3s--k9s>#</a></h2>
<h3 id=11-multipass说明>1.1 Multipass说明<a hidden class=anchor aria-hidden=true href=#11-multipass说明>#</a></h3>
<p>Multipass是一个轻量级的可以用于开启Ubuntu虚拟机的命令行工具，你可以把它当做一个无图形界面的<code>Virtual Box</code>或者<code>Parallels Desktop</code>。在mac上可以通过brew安装，命令为</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>brew install --cask multipass
</code></pre></div><p>安装完成后执行<code>multipass version</code>，输出如下结果说明安装成功</p>
<pre tabindex=0><code>~ ❯ multipass version                                                                                20:45:29
multipass   1.8.1+mac
multipassd  1.8.1+mac
</code></pre><p>Multipass常见指令如下：</p>
<p>Launch an instance (by default you get the current Ubuntu LTS)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass launch --name foo
</code></pre></div><p>Run commands in that instance, try running bash (logout or ctrl-d to quit)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass exec foo -- lsb_release -a
</code></pre></div><p>Pass a cloud-init metadata file to an instance on launch. See <a href=https://blog.ubuntu.com/2018/04/02/using-cloud-init-with-multipass>using cloud-init with multipass</a> for more details</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass launch -n bar --cloud-init cloud-config.yaml
</code></pre></div><p>See your instances</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass list
</code></pre></div><p>Stop and start instances</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass stop foo bar
multipass start foo
</code></pre></div><p>Clean up what you don’t need</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass delete bar
multipass purge
</code></pre></div><p>Find alternate images to launch with multipass</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass find
</code></pre></div><p>Get help</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass help
multipass help &lt;command&gt;
</code></pre></div><h3 id=12-k3s>1.2 K3s<a hidden class=anchor aria-hidden=true href=#12-k3s>#</a></h3>
<p>k3s用于快速搭建k8s集群，注意这里k3s不是安装到mac上的而是安装到multipass创建的Ubuntu实例中，常用k3s安装脚本如下</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -sfL https://get.k3s.io | sh -
</code></pre></div><p>一般来说国内访问可能失败，导致无法拉取需要资源，所以可以使用国内镜像源</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR<span style=color:#f92672>=</span>cn sh -
</code></pre></div><p>k3s常见环境变量如下</p>
<table>
<thead>
<tr>
<th>Environment Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>INSTALL_K3S_SKIP_DOWNLOAD</code></td>
<td>如果设置为 &ldquo;true &ldquo;将不会下载 K3s 的哈希值或二进制。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_SYMLINK</code></td>
<td>默认情况下，如果路径中不存在命令，将为 kubectl、crictl 和 ctr 二进制文件创建符号链接。如果设置为&rsquo;skip&rsquo;将不会创建符号链接，而&rsquo;force&rsquo;将覆盖。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_SKIP_ENABLE</code></td>
<td>如果设置为 &ldquo;true&rdquo;，将不启用或启动 K3s 服务。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_SKIP_START</code></td>
<td>如果设置为 &ldquo;true &ldquo;将不会启动 K3s 服务。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_VERSION</code></td>
<td>从 Github 下载 K3s 的版本。如果没有指定，将尝试从"stable"频道下载。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_BIN_DIR</code></td>
<td>安装 K3s 二进制文件、链接和卸载脚本的目录，或者使用<code>/usr/local/bin</code>作为默认目录。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_BIN_DIR_READ_ONLY</code></td>
<td>如果设置为 true 将不会把文件写入<code>INSTALL_K3S_BIN_DIR</code>，强制设置<code>INSTALL_K3S_SKIP_DOWNLOAD=true</code>。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_SYSTEMD_DIR</code></td>
<td>安装 systemd 服务和环境文件的目录，或者使用<code>/etc/systemd/system</code>作为默认目录。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_EXEC</code></td>
<td>带有标志的命令，用于在服务中启动 K3s。如果未指定命令，并且设置了<code>K3S_URL</code>，它将默认为“agent”。如果未设置<code>K3S_URL</code>，它将默认为“server”。要获得帮助，请参考<a href=https://docs.rancher.cn/docs/k3s/installation/install-options/how-to-flags/_index#%E7%A4%BA%E4%BE%8B-b-install_k3s_exec>此示例。</a></td>
</tr>
<tr>
<td><code>INSTALL_K3S_NAME</code></td>
<td>要创建的 systemd 服务名称，如果以服务器方式运行 k3s，则默认为&rsquo;k3s'；如果以 agent 方式运行 k3s，则默认为&rsquo;k3s-agent'。如果指定了服务名，则服务名将以&rsquo;k3s-&lsquo;为前缀。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_TYPE</code></td>
<td>要创建的 systemd 服务类型，如果没有指定，将默认使用 K3s exec 命令。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_SELINUX_WARN</code></td>
<td>如果设置为 true，则在没有找到 k3s-selinux 策略的情况下将继续。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_SKIP_SELINUX_RPM</code></td>
<td>如果设置为 &ldquo;true &ldquo;将跳过 k3s RPM 的自动安装。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_CHANNEL_URL</code></td>
<td>用于获取 K3s 下载网址的频道 URL。默认为 <a href=https://update.k3s.io/v1-release/channels>https://update.k3s.io/v1-release/channels</a> 。</td>
</tr>
<tr>
<td><code>INSTALL_K3S_CHANNEL</code></td>
<td>用于获取 K3s 下载 URL 的通道。默认值为 &ldquo;stable&rdquo;。选项包括：<code>stable</code>, <code>latest</code>, <code>testing</code>。</td>
</tr>
<tr>
<td><code>K3S_CONFIG_FILE</code></td>
<td>指定配置文件的位置。默认目录为<code>/etc/rancher/k3s/config.yaml</code>。</td>
</tr>
<tr>
<td><code>K3S_TOKEN</code></td>
<td>用于将 server 或 agent 加入集群的共享 secret。</td>
</tr>
<tr>
<td><code>K3S_TOKEN_FILE</code></td>
<td>指定 <code>cluster-secret</code>,<code>token</code> 的文件目录。</td>
</tr>
</tbody>
</table>
<h3 id=13-multipass-k3s脚本>1.3 multipass-k3s脚本<a hidden class=anchor aria-hidden=true href=#13-multipass-k3s脚本>#</a></h3>
<p><a href=https://github.com/superseb/multipass-k3s>k3s cluster on multipass instances</a>给出了脚本，可以直接利用multipass和k3s创建k8s集群，我做了一些修改，比如替换了国内用的镜像源、使用2个slave节点、修改内存之类</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#!/usr/bin/env bash
</span><span style=color:#75715e></span>
<span style=color:#75715e># Configure your settings</span>
<span style=color:#75715e># Name for the cluster/configuration files</span>
NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;demo-cluster&#34;</span>
<span style=color:#75715e># Ubuntu image to use (xenial/bionic)</span>
IMAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;focal&#34;</span>
<span style=color:#75715e># How many additional server instances to create</span>
SERVER_COUNT_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>
<span style=color:#75715e># How many agent instances to create</span>
AGENT_COUNT_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2&#34;</span>
<span style=color:#75715e># How many CPUs to allocate to each machine</span>
SERVER_CPU_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2&#34;</span>
AGENT_CPU_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span>
<span style=color:#75715e># How much disk space to allocate to each machine</span>
SERVER_DISK_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5G&#34;</span>
AGENT_DISK_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5G&#34;</span>
<span style=color:#75715e># How much memory to allocate to each machine</span>
SERVER_MEMORY_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2G&#34;</span>
AGENT_MEMORY_MACHINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1G&#34;</span>
<span style=color:#75715e># Install channel to use (embedded etcd is fully supported starting with v1.19.5+k3s1)</span>
CHANNEL<span style=color:#f92672>=</span>stable
<span style=color:#75715e># Preconfigured secret to join the cluster (or autogenerated if empty)</span>
SERVER_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
<span style=color:#75715e># Preconfigured secret to join the cluster (or autogenerated if empty)</span>
AGENT_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>


<span style=color:#75715e>## Nothing to change after this line</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -x <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>command -v multipass.exe<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    <span style=color:#75715e># Windows</span>
    MULTIPASSCMD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;multipass.exe&#34;</span>
<span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> -x <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>command -v multipass<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    <span style=color:#75715e># Linux/MacOS</span>
    MULTIPASSCMD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;multipass&#34;</span>
<span style=color:#66d9ef>else</span>
    echo <span style=color:#e6db74>&#34;The multipass binary (multipass or multipass.exe) is not available or not in your \$PATH&#34;</span>
    exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z $SERVER_TOKEN <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    SERVER_TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat /dev/urandom | base64 | tr -dc <span style=color:#e6db74>&#39;a-zA-Z0-9&#39;</span> | fold -w <span style=color:#ae81ff>20</span> | head -n <span style=color:#ae81ff>1</span> | tr <span style=color:#e6db74>&#39;[:upper:]&#39;</span> <span style=color:#e6db74>&#39;[:lower:]&#39;</span><span style=color:#66d9ef>)</span>
    echo <span style=color:#e6db74>&#34;No server token given, generated server token: </span><span style=color:#e6db74>${</span>SERVER_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z $AGENT_TOKEN <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    AGENT_TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat /dev/urandom | base64 | tr -dc <span style=color:#e6db74>&#39;a-zA-Z0-9&#39;</span> | fold -w <span style=color:#ae81ff>20</span> | head -n <span style=color:#ae81ff>1</span> | tr <span style=color:#e6db74>&#39;[:upper:]&#39;</span> <span style=color:#e6db74>&#39;[:lower:]&#39;</span><span style=color:#66d9ef>)</span>
    echo <span style=color:#e6db74>&#34;No agent token given, generated agent token: </span><span style=color:#e6db74>${</span>AGENT_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#75715e># Check if name is given or create random string</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z $NAME <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    NAME<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat /dev/urandom | base64 | tr -dc <span style=color:#e6db74>&#39;a-zA-Z0-9&#39;</span> | fold -w <span style=color:#ae81ff>6</span> | head -n <span style=color:#ae81ff>1</span> | tr <span style=color:#e6db74>&#39;[:upper:]&#39;</span> <span style=color:#e6db74>&#39;[:lower:]&#39;</span><span style=color:#66d9ef>)</span>
    echo <span style=color:#e6db74>&#34;No name given, generated name: </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>

echo <span style=color:#e6db74>&#34;Creating cluster </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74> with </span><span style=color:#66d9ef>$((</span> $SERVER_COUNT_MACHINE <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>))</span><span style=color:#e6db74> server(s) and </span><span style=color:#e6db74>${</span>AGENT_COUNT_MACHINE<span style=color:#e6db74>}</span><span style=color:#e6db74> agent(s)&#34;</span>

<span style=color:#75715e># Prepare cloud-init</span>
<span style=color:#75715e># Cloud init template</span>
read -r -d <span style=color:#e6db74>&#39;&#39;</span> SERVER_INIT_CLOUDINIT_TEMPLATE <span style=color:#e6db74>&lt;&lt; EOM
</span><span style=color:#e6db74>#cloud-config
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>runcmd:
</span><span style=color:#e6db74> - &#39;\curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_CHANNEL=$CHANNEL K3S_TOKEN=$SERVER_TOKEN K3S_AGENT_TOKEN=$AGENT_TOKEN INSTALL_K3S_EXEC=&#34;server --cluster-init&#34; K3S_KUBECONFIG_MODE=644 sh -&#39;
</span><span style=color:#e6db74>EOM</span>

echo <span style=color:#e6db74>&#34;</span>$SERVER_INIT_CLOUDINIT_TEMPLATE<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-init-cloud-init.yaml&#34;</span>
echo <span style=color:#e6db74>&#34;Cloud-init is created at </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-init-cloud-init.yaml&#34;</span>

echo <span style=color:#e6db74>&#34;Creating initial server instance: k3s-server-</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>

echo <span style=color:#e6db74>&#34;Running </span>$MULTIPASSCMD<span style=color:#e6db74> launch --cpus </span>$SERVER_CPU_MACHINE<span style=color:#e6db74> --disk </span>$SERVER_DISK_MACHINE<span style=color:#e6db74> --mem </span>$SERVER_MEMORY_MACHINE<span style=color:#e6db74> </span>$IMAGE<span style=color:#e6db74> --name k3s-server-</span>$NAME<span style=color:#e6db74> --cloud-init </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-init-cloud-init.yaml&#34;</span>
$MULTIPASSCMD launch --cpus $SERVER_CPU_MACHINE --disk $SERVER_DISK_MACHINE --mem $SERVER_MEMORY_MACHINE $IMAGE --name k3s-server-$NAME --cloud-init <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-init-cloud-init.yaml&#34;</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    echo <span style=color:#e6db74>&#34;There was an error launching the instance&#34;</span>
    exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>

echo <span style=color:#e6db74>&#34;Checking for Node being Ready on k3s-server-</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
$MULTIPASSCMD exec k3s-server-$NAME -- /bin/bash -c <span style=color:#e6db74>&#39;while [[ $(sudo k3s kubectl get nodes --no-headers 2&gt;/dev/null | grep -c -v &#34;NotReady&#34;) -eq 0 ]]; do sleep 2; done&#39;</span>
echo <span style=color:#e6db74>&#34;Node is Ready on k3s-server-</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># Retrieve info to join agent to cluster</span>
SERVER_IP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>$MULTIPASSCMD info k3s-server-$NAME | grep IPv4 | awk <span style=color:#e6db74>&#39;{ print $2 }&#39;</span><span style=color:#66d9ef>)</span>
URL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://</span><span style=color:#66d9ef>$(</span>echo $SERVER_IP | sed -e <span style=color:#e6db74>&#39;s/[[:space:]]//g&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>:6443&#34;</span>

<span style=color:#75715e># Create additional servers</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SERVER_COUNT_MACHINE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -gt <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    read -r -d <span style=color:#e6db74>&#39;&#39;</span> SERVER_CLOUDINIT_TEMPLATE <span style=color:#e6db74>&lt;&lt; EOM
</span><span style=color:#e6db74>#cloud-config
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>runcmd:
</span><span style=color:#e6db74> - &#39;\curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_CHANNEL=$CHANNEL K3S_TOKEN=$SERVER_TOKEN K3S_AGENT_TOKEN=$AGENT_TOKEN INSTALL_K3S_EXEC=&#34;server --server $URL&#34; K3S_KUBECONFIG_MODE=644 sh -&#39;
</span><span style=color:#e6db74>EOM</span>

    echo <span style=color:#e6db74>&#34;</span>$SERVER_CLOUDINIT_TEMPLATE<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-cloud-init.yaml&#34;</span>

    echo <span style=color:#e6db74>&#34;Creating </span><span style=color:#e6db74>${</span>SERVER_COUNT_MACHINE<span style=color:#e6db74>}</span><span style=color:#e6db74> additional server instances&#34;</span>
    <span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>eval echo <span style=color:#e6db74>&#34;{1..</span>$SERVER_COUNT_MACHINE<span style=color:#e6db74>}&#34;</span><span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
        echo <span style=color:#e6db74>&#34;Running </span>$MULTIPASSCMD<span style=color:#e6db74> launch --cpus </span>$SERVER_CPU_MACHINE<span style=color:#e6db74> --disk </span>$SERVER_DISK_MACHINE<span style=color:#e6db74> --mem </span>$SERVER_MEMORY_MACHINE<span style=color:#e6db74> </span>$IMAGE<span style=color:#e6db74> --name k3s-server-</span>$NAME<span style=color:#e6db74>-</span>$i<span style=color:#e6db74> --cloud-init </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-cloud-init.yaml&#34;</span>
        $MULTIPASSCMD launch --cpus $SERVER_CPU_MACHINE --disk $SERVER_DISK_MACHINE --mem $SERVER_MEMORY_MACHINE $IMAGE --name k3s-server-$NAME-$i --cloud-init <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-cloud-init.yaml&#34;</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
            echo <span style=color:#e6db74>&#34;There was an error launching the instance&#34;</span>
            exit <span style=color:#ae81ff>1</span>
        <span style=color:#66d9ef>fi</span>

        echo <span style=color:#e6db74>&#34;Checking for Node being Ready on k3s-server-</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
        $MULTIPASSCMD exec k3s-server-$NAME-$i -- /bin/bash -c <span style=color:#e6db74>&#39;while [[ $(sudo k3s kubectl get nodes --no-headers 2&gt;/dev/null | grep -c -v &#34;NotReady&#34;) -eq 0 ]]; do sleep 2; done&#39;</span>
        echo <span style=color:#e6db74>&#34;Node is Ready on k3s-server-</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
    <span style=color:#66d9ef>done</span>
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>AGENT_COUNT_MACHINE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -gt <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    <span style=color:#75715e># Prepare agent cloud-init</span>
    <span style=color:#75715e># Cloud init template</span>
    read -r -d <span style=color:#e6db74>&#39;&#39;</span> AGENT_CLOUDINIT_TEMPLATE <span style=color:#e6db74>&lt;&lt; EOM
</span><span style=color:#e6db74>#cloud-config
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>runcmd:
</span><span style=color:#e6db74> - &#39;\curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_CHANNEL=$CHANNEL K3S_TOKEN=$AGENT_TOKEN K3S_URL=$URL sh -&#39;
</span><span style=color:#e6db74>EOM</span>

    echo <span style=color:#e6db74>&#34;</span>$AGENT_CLOUDINIT_TEMPLATE<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-agent-cloud-init.yaml&#34;</span>
    echo <span style=color:#e6db74>&#34;Cloud-init is created at </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-agent-cloud-init.yaml&#34;</span>

    <span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>eval echo <span style=color:#e6db74>&#34;{1..</span>$AGENT_COUNT_MACHINE<span style=color:#e6db74>}&#34;</span><span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
        echo <span style=color:#e6db74>&#34;Running </span>$MULTIPASSCMD<span style=color:#e6db74> launch --cpus </span>$AGENT_CPU_MACHINE<span style=color:#e6db74> --disk </span>$AGENT_DISK_MACHINE<span style=color:#e6db74> --mem </span>$AGENT_MEMORY_MACHINE<span style=color:#e6db74> </span>$IMAGE<span style=color:#e6db74> --name k3s-agent-</span>$NAME<span style=color:#e6db74>-</span>$i<span style=color:#e6db74> --cloud-init </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-agent-cloud-init.yaml&#34;</span>
        $MULTIPASSCMD launch --cpus $AGENT_CPU_MACHINE --disk $AGENT_DISK_MACHINE --mem $AGENT_MEMORY_MACHINE $IMAGE --name k3s-agent-$NAME-$i --cloud-init <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-agent-cloud-init.yaml&#34;</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
            echo <span style=color:#e6db74>&#34;There was an error launching the instance&#34;</span>
            exit <span style=color:#ae81ff>1</span>
       <span style=color:#66d9ef>fi</span>
        echo <span style=color:#e6db74>&#34;Checking for Node k3s-agent-</span>$NAME<span style=color:#e6db74>-</span>$i<span style=color:#e6db74> being registered&#34;</span>
        $MULTIPASSCMD exec k3s-server-$NAME -- bash -c <span style=color:#e6db74>&#34;until sudo k3s kubectl get nodes --no-headers | grep -c k3s-agent-</span>$NAME<span style=color:#e6db74>-</span>$i<span style=color:#e6db74> &gt;/dev/null; do sleep 2; done&#34;</span> 
        echo <span style=color:#e6db74>&#34;Checking for Node k3s-agent-</span>$NAME<span style=color:#e6db74>-</span>$i<span style=color:#e6db74> being Ready&#34;</span>
        $MULTIPASSCMD exec k3s-server-$NAME -- bash -c <span style=color:#e6db74>&#34;until sudo k3s kubectl get nodes --no-headers | grep k3s-agent-</span>$NAME<span style=color:#e6db74>-</span>$i<span style=color:#e6db74> | grep -c -v NotReady &gt;/dev/null; do sleep 2; done&#34;</span>
        echo <span style=color:#e6db74>&#34;Node k3s-agent-</span>$NAME<span style=color:#e6db74>-</span>$i<span style=color:#e6db74> is Ready on k3s-server-</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
    <span style=color:#66d9ef>done</span>
<span style=color:#66d9ef>fi</span>

$MULTIPASSCMD copy-files k3s-server-$NAME:/etc/rancher/k3s/k3s.yaml $NAME-kubeconfig-orig.yaml
sed <span style=color:#e6db74>&#34;/^[[:space:]]*server:/ s_:.*_: \&#34;https://</span><span style=color:#66d9ef>$(</span>echo $SERVER_IP | sed -e <span style=color:#e6db74>&#39;s/[[:space:]]//g&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>:6443\&#34;_&#34;</span> $NAME-kubeconfig-orig.yaml &gt; $NAME-kubeconfig.yaml

echo <span style=color:#e6db74>&#34;k3s setup finished&#34;</span>
$MULTIPASSCMD exec k3s-server-$NAME -- sudo k3s kubectl get nodes
echo <span style=color:#e6db74>&#34;You can now use the following command to connect to your cluster&#34;</span>
echo <span style=color:#e6db74>&#34;</span>$MULTIPASSCMD<span style=color:#e6db74> exec k3s-server-</span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74> -- sudo k3s kubectl get nodes&#34;</span>
echo <span style=color:#e6db74>&#34;Or use kubectl directly&#34;</span>
echo <span style=color:#e6db74>&#34;kubectl --kubeconfig </span><span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-kubeconfig.yaml get nodes&#34;</span>
</code></pre></div><h3 id=14-k9s>1.4 k9s<a hidden class=anchor aria-hidden=true href=#14-k9s>#</a></h3>
<p>K9s 提供了一个与 K8s 集群交互的终端 UI，用于简化导航、观察以及管理应用程序。K9s 会持续监控 K8s 的变化，并提供后续命令与所观察到的资源进行交互。可以利用如下GUI管理k8s</p>
<p><img loading=lazy src=https://gitee.com/tao2333/hugo-pic/raw/master/pictures/202201062048276.png alt="Screen Shot 2022-01-06 at 19.43.21">
</p>
<h3 id=15-一些问题>1.5 一些问题<a hidden class=anchor aria-hidden=true href=#15-一些问题>#</a></h3>
<ol>
<li>brew无法安装cask，超时之类，可以使用<a href=https://mirrors.ustc.edu.cn/help/homebrew-cask.git.html>中科大的brew源</a>；</li>
<li>在启用某些VPN软件时，multipass无法拉取镜像，导致无法创建Ubuntu实例或者无法安装k3s，只能关闭VPN软件；</li>
<li>k3s启动失败，一般需要使用国内镜像源。</li>
</ol>
<h2 id=2-安装与测试>2. 安装与测试<a hidden class=anchor aria-hidden=true href=#2-安装与测试>#</a></h2>
<p>步骤如下：</p>
<ol>
<li>Brew安装multipass、k9s和kubectl-cli；</li>
<li>创建<code>k3s-launch.sh</code>，并复制粘贴上面的脚本内容，需要自行修改以适配自己的环境；</li>
<li>运行<code>bash k3s-launch.sh</code>，等待集群部署，脚本执行成功后可以看到multipass多了3个实例，不带数字的是master节点，其他是slave节点，而且目录下多了几个文件；</li>
</ol>
<p><img loading=lazy src=https://gitee.com/tao2333/hugo-pic/raw/master/pictures/202201022109129.png alt="Screen Shot 2022-01-02 at 21.09.22">
</p>
<pre tabindex=0><code>~/Projects/k3s ❯ ll                                                                                  21:13:40
total 56
-rw-r--r--  1 tao  staff   216B Jan  2 14:05 demo-cluster-agent-cloud-init.yaml
-rw-r--r--  1 tao  staff   283B Jan  2 14:04 demo-cluster-init-cloud-init.yaml
-rw-r--r--  1 tao  staff   2.9K Jan  2 14:07 demo-cluster-kubeconfig-orig.yaml
-rw-r--r--  1 tao  staff   2.9K Jan  2 14:07 demo-cluster-kubeconfig.yaml
-rw-r--r--@ 1 tao  staff   7.0K Jan  2 14:04 k3s-launch.sh
</code></pre><ol start=4>
<li>创建一个deploy-nginx.yaml，内容如下：</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>dev</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>run</span>: <span style=color:#ae81ff>nginx</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>nginx</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:1.17.1</span>
        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>
          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</code></pre></div><ol start=5>
<li>使用kubectl控制集群，运行如下命令</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># get nodes查看节点是否存活</span>
~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml get nodes        ⎈ docker-desktop 21:13:53
NAME                       STATUS   ROLES                       AGE     VERSION
k3s-agent-demo-cluster-1   Ready    &lt;none&gt;                      7h10m   v1.22.5+k3s1
k3s-agent-demo-cluster-2   Ready    &lt;none&gt;                      7h9m    v1.22.5+k3s1
k3s-server-demo-cluster    Ready    control-plane,etcd,master   7h11m   v1.22.5+k3s1
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># create namespace dev创建dev命名空间</span>
~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml create namespace dev
namespace/dev created
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 创建测试pod</span>
~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml create -f deploy-nginx.yaml                       ⎈ docker-desktop 21:48:22
deployment.apps/nginx created
<span style=color:#75715e># 查看pod状态</span>
~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml get pods -n dev                                   ⎈ docker-desktop 21:48:32
NAME                     READY   STATUS    RESTARTS   AGE
nginx-66ffc897cf-55b6d   1/1     Running   <span style=color:#ae81ff>0</span>          53s
nginx-66ffc897cf-d5r29   1/1     Running   <span style=color:#ae81ff>0</span>          53s
nginx-66ffc897cf-vfpkg   1/1     Running   <span style=color:#ae81ff>0</span>          53s
<span style=color:#75715e># 创建暴露给外部的Service</span>
~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml expose deploy nginx --name<span style=color:#f92672>=</span>svc-nginx --type<span style=color:#f92672>=</span>NodePort --port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span> --target-port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span> -n dev
service/svc-nginx exposed
<span style=color:#75715e># 查看Service状态和端口号映射</span>
~/Projects/k3s ❯ kubectl --kubeconfig demo-cluster-kubeconfig.yaml get svc svc-nginx -n dev -o wide                  ⎈ docker-desktop 21:50:14
NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE   SELECTOR
svc-nginx   NodePort   10.43.227.135   &lt;none&gt;        80:30355/TCP   25s   run<span style=color:#f92672>=</span>nginx
<span style=color:#75715e># 查看master节点ip</span>
~/Projects/k3s ❯ multipass list                                                                                                       21:50:39
Name                      State             IPv4             Image
k3s-agent-demo-cluster-1  Running           192.168.64.16    Ubuntu 20.04 LTS
                                            10.42.1.0
                                            10.42.1.1
k3s-agent-demo-cluster-2  Running           192.168.64.17    Ubuntu 20.04 LTS
                                            10.42.2.0
                                            10.42.2.1
k3s-server-demo-cluster   Running           192.168.64.15    Ubuntu 20.04 LTS
                                            10.42.0.0
                                            10.42.0.1
<span style=color:#75715e># 访问 192.168.64.15:30355，能够输出nginx信息</span>
~/Projects/k3s ❯ curl 192.168.64.15:30355                                                                                             21:51:45
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body <span style=color:#f92672>{</span>
        width: 35em;
        margin: <span style=color:#ae81ff>0</span> auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    <span style=color:#f92672>}</span>
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span style=color:#66d9ef>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><ol start=6>
<li>利用k9s查看k8s集群状态，详细玩法可以去看<a href=https://k9scli.io>k9s官网</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>k9s --kubeconfig demo-cluster-kubeconfig.yaml -n dev
</code></pre></div><p>pod状态</p>
<p><img loading=lazy src=https://gitee.com/tao2333/hugo-pic/raw/master/pictures/202201062054107.png alt="Screen Shot 2022-01-06 at 20.51.53">
</p>
<p>service状态</p>
<p><img loading=lazy src=https://gitee.com/tao2333/hugo-pic/raw/master/pictures/202201062054265.png alt="Screen Shot 2022-01-06 at 20.52.04">
</p>
<p>deploy状态</p>
<p><img loading=lazy src=https://gitee.com/tao2333/hugo-pic/raw/master/pictures/202201062054797.png alt="Screen Shot 2022-01-06 at 20.53.11">
</p>
<h1 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h1>
<ol>
<li><a href=https://github.com/superseb/multipass-k3s>k3s cluster on multipass instances</a></li>
<li><a href=https://k3s.io/>K3s: Lightweight Kubernetes</a></li>
<li><a href=https://multipass.run/>Ubuntu VMs on demand for any workstation</a></li>
<li><a href=https://docs.rancher.cn/docs/k3s/installation/install-options/_index>K3s 安装选项介绍</a></li>
<li><a href=https://k9scli.io>k9s Kubernetes CLI To Manage Your Clusters In Style!</a></li>
</ol>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://zhoutao822.github.io/tags/k3s/>k3s</a></li>
<li><a href=https://zhoutao822.github.io/tags/k8s/>k8s</a></li>
<li><a href=https://zhoutao822.github.io/tags/k9s/>k9s</a></li>
<li><a href=https://zhoutao822.github.io/tags/multipass/>multipass</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://zhoutao822.github.io/posts/seafile/>
<span class=title>« Prev Page</span>
<br>
<span>使用Docker方式安装Seafile私人网盘</span>
</a>
<a class=next href=https://zhoutao822.github.io/posts/android-build-commandline/>
<span class=title>Next Page »</span>
<br>
<span>Build Android App with Commandline</span>
</a>
</nav>
</footer>
<script src=https://utteranc.es/client.js repo=zhoutao822/zhoutao822.github.io issue-term=title theme=github-dark crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://zhoutao822.github.io/>Tao's Notes</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>