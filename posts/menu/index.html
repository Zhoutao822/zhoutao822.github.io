<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Material组件-Menu | Tao's Notes</title><meta name=keywords content="ToolBar,ContextMenu,PopupMenu"><meta name=description content="Menu，不同于Button、TextView之类的控件，它不需要在布局文件中指定位置，它是用于提供给用户额外的操作选择，因此不必局限于某一个固定位置，它可以搭配任何控件。"><meta name=author content="Me"><link rel=canonical href=https://zhoutao822.github.io/posts/menu/><meta name=google-site-verification content="Tao"><meta name=yandex-verification content="Tao"><meta name=msvalidate.01 content="Tao"><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://zhoutao822.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zhoutao822.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zhoutao822.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zhoutao822.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zhoutao822.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.103.1"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Material组件-Menu"><meta property="og:description" content="Menu，不同于Button、TextView之类的控件，它不需要在布局文件中指定位置，它是用于提供给用户额外的操作选择，因此不必局限于某一个固定位置，它可以搭配任何控件。"><meta property="og:type" content="article"><meta property="og:url" content="https://zhoutao822.github.io/posts/menu/"><meta property="og:image" content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-24T20:09:54+08:00"><meta property="article:modified_time" content="2019-06-24T20:09:54+08:00"><meta property="og:site_name" content="Tao's Notes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Material组件-Menu"><meta name=twitter:description content="Menu，不同于Button、TextView之类的控件，它不需要在布局文件中指定位置，它是用于提供给用户额外的操作选择，因此不必局限于某一个固定位置，它可以搭配任何控件。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zhoutao822.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Material组件-Menu","item":"https://zhoutao822.github.io/posts/menu/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Material组件-Menu","name":"Material组件-Menu","description":"Menu，不同于Button、TextView之类的控件，它不需要在布局文件中指定位置，它是用于提供给用户额外的操作选择，因此不必局限于某一个固定位置，它可以搭配任何控件。","keywords":["ToolBar","ContextMenu","PopupMenu"],"articleBody":"Menu，不同于Button、TextView之类的控件，它不需要在布局文件中指定位置，它是用于提供给用户额外的操作选择，因此不必局限于某一个固定位置，它可以搭配任何控件。\n常见的Menu可以分为三种：\nToolBar上的选项菜单，这是固定的设计，配合ToolBar实现很简单； 上下文菜单ContextMenu，与某一个控件关联，可以实现在点击（长按）的位置出现菜单选项的效果； 弹出菜单PopupMenu，动态生成，作为一个点击事件触发，出现的位置与被点击的控件位置绑定（上方或下方），与上下文菜单不同。 1. 菜单选项数据来源 如上图所示，展开的就是菜单Menu，菜单中包含一个一个的MenuItem，前面已经说了Menu不同于Button之类的控件，它的使用也是非常不同，最重要的部分其实是如何定义这些MenuItem，推荐的做法是使用xml资源文件定义MenuItem的文字内容以及Icon等等，然后在activity或fragment中处理点击事件；当然还有动态添加的方式可以使用。\n1.1 使用xml定义菜单 这里先不必考虑如何使用Menu，只是定义菜单选项，需要在res/menu/目录下建一个xml文件\n","wordCount":"4389","inLanguage":"en","datePublished":"2019-06-24T20:09:54+08:00","dateModified":"2019-06-24T20:09:54+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhoutao822.github.io/posts/menu/"},"publisher":{"@type":"Organization","name":"Tao's Notes","logo":{"@type":"ImageObject","url":"https://zhoutao822.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://zhoutao822.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://zhoutao822.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://zhoutao822.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zhoutao822.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://zhoutao822.github.io/series/ title=Series><span>Series</span></a></li><li><a href=https://zhoutao822.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zhoutao822.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://zhoutao822.github.io/posts/>Posts</a></div><h1 class=post-title>Material组件-Menu</h1><div class=post-meta><span title='2019-06-24 20:09:54 +0800 +0800'>June 24, 2019</span>&nbsp;·&nbsp;21 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Zhoutao822/zhoutao822.github.io/tree/main/content//posts/menu.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-%e8%8f%9c%e5%8d%95%e9%80%89%e9%a1%b9%e6%95%b0%e6%8d%ae%e6%9d%a5%e6%ba%90 aria-label="1. 菜单选项数据来源">1. 菜单选项数据来源</a><ul><li><a href=#11-%e4%bd%bf%e7%94%a8xml%e5%ae%9a%e4%b9%89%e8%8f%9c%e5%8d%95 aria-label="1.1 使用xml定义菜单">1.1 使用xml定义菜单</a></li><li><a href=#12-%e5%9c%a8activity%e4%b8%ad%e4%bd%bf%e7%94%a8menu aria-label="1.2 在Activity中使用Menu">1.2 在Activity中使用Menu</a></li><li><a href=#13-%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4%e7%9a%84toolbar-menu%e5%9b%be%e6%a0%87%e4%bb%a5%e5%8f%8a%e7%82%b9%e5%87%bb%e8%83%8c%e6%99%af%e8%89%b2 aria-label="1.3 修改默认的ToolBar Menu图标以及点击背景色">1.3 修改默认的ToolBar Menu图标以及点击背景色</a></li></ul></li><li><a href=#2-%e4%b8%8a%e4%b8%8b%e6%96%87%e8%8f%9c%e5%8d%95 aria-label="2. 上下文菜单">2. 上下文菜单</a></li><li><a href=#3-%e5%bc%b9%e5%87%ba%e8%8f%9c%e5%8d%95 aria-label="3. 弹出菜单">3. 弹出菜单</a></li><li><a href=#4-android%e4%ba%8b%e4%bb%b6%e5%88%86%e5%8f%91%e6%9c%ba%e5%88%b6 aria-label="4. Android事件分发机制">4. Android事件分发机制</a><ul><li><a href=#41-%e7%a6%81%e7%94%a8viewpager%e7%9a%84%e6%bb%91%e5%8a%a8%e5%ad%90view%e5%8f%af%e4%bb%a5%e6%bb%91%e5%8a%a8 aria-label="4.1 禁用ViewPager的滑动，子view可以滑动">4.1 禁用ViewPager的滑动，子view可以滑动</a></li><li><a href=#42-viewpager%e4%bb%85%e5%9c%a8%e5%ad%90view%e6%bb%91%e5%8a%a8%e5%88%b0%e5%b7%a6%e5%8f%b3%e8%be%b9%e7%95%8c%e6%97%b6%e5%8f%af%e4%bb%a5%e6%bb%91%e5%8a%a8 aria-label="4.2 ViewPager仅在子view滑动到左右边界时可以滑动">4.2 ViewPager仅在子view滑动到左右边界时可以滑动</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考：>参考：</a></li></ul></div></details></div><div class=post-content><p>Menu，不同于Button、TextView之类的控件，它不需要在布局文件中指定位置，它是用于提供给用户额外的操作选择，因此不必局限于某一个固定位置，它可以搭配任何控件。</p><p>常见的Menu可以分为三种：</p><ol><li>ToolBar上的选项菜单，这是固定的设计，配合ToolBar实现很简单；</li><li>上下文菜单ContextMenu，与某一个控件关联，可以实现在点击（长按）的位置出现菜单选项的效果；</li><li>弹出菜单PopupMenu，动态生成，作为一个点击事件触发，出现的位置与被点击的控件位置绑定（上方或下方），与上下文菜单不同。</li></ol><p><img loading=lazy src=D:%5cMyTypora%5cmyblog-master%5c2019-06-24-Material%e7%bb%84%e4%bb%b6-Menu%5c1.jpg alt=1></p><h2 id=1-菜单选项数据来源>1. 菜单选项数据来源<a hidden class=anchor aria-hidden=true href=#1-菜单选项数据来源>#</a></h2><p>如上图所示，展开的就是菜单Menu，菜单中包含一个一个的MenuItem，前面已经说了Menu不同于Button之类的控件，它的使用也是非常不同，最重要的部分其实是如何定义这些MenuItem，推荐的做法是使用<code>xml</code>资源文件定义MenuItem的文字内容以及Icon等等，然后在activity或fragment中处理点击事件；当然还有动态添加的方式可以使用。</p><h3 id=11-使用xml定义菜单>1.1 使用xml定义菜单<a hidden class=anchor aria-hidden=true href=#11-使用xml定义菜单>#</a></h3><p>这里先不必考虑如何使用Menu，只是定义菜单选项，需要在<code>res/menu/</code>目录下建一个<code>xml</code>文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- menu_main.xml --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;menu</span> <span style=color:#a6e22e>xmlns:android=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:app=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res-auto&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;item</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/action_add_a_contact&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:icon=</span><span style=color:#e6db74>&#34;@drawable/ic_add_black_24dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:title=</span><span style=color:#e6db74>&#34;Add a Contact&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:showAsAction=</span><span style=color:#e6db74>&#34;always&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;item</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/action_create_a_contact_group&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:icon=</span><span style=color:#e6db74>&#34;@drawable/ic_create_black_24dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:title=</span><span style=color:#e6db74>&#34;Create a Contact Group&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:showAsAction=</span><span style=color:#e6db74>&#34;never&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;item</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/action_add_a_app&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:title=</span><span style=color:#e6db74>&#34;Add a App&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:showAsAction=</span><span style=color:#e6db74>&#34;always&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;item</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/submenu&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:title=</span><span style=color:#e6db74>&#34;Submenu&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;menu&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;item</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/action_create_a_channel&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:icon=</span><span style=color:#e6db74>&#34;@drawable/ic_create_new_folder_black_24dp&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:title=</span><span style=color:#e6db74>&#34;Create a Channel&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>app:showAsAction=</span><span style=color:#e6db74>&#34;never&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;item</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/action_join_a_channel&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:icon=</span><span style=color:#e6db74>&#34;@drawable/ic_adjust_black_24dp&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:title=</span><span style=color:#e6db74>&#34;Join a Channel&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>app:showAsAction=</span><span style=color:#e6db74>&#34;never&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/menu&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/menu&gt;</span>
</span></span></code></pre></div><p>上面的布局文件产生的效果如下图所示</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Zhoutao822/hugo-pic/pictures/2.jpg alt=2></p><p>有几个特点：</p><ol><li>如果Item设置了Icon，那么如果出现在ToolBar上就是Icon，如果没有设置Icon，则显示大写文字；</li><li>Icon在折叠的Menu中不显示，但是在二级菜单中可以显示；</li><li>Item的顺序会被showAsAction参数影响。</li></ol><h3 id=12-在activity中使用menu>1.2 在Activity中使用Menu<a hidden class=anchor aria-hidden=true href=#12-在activity中使用menu>#</a></h3><p>只需要在activity中重写<code>onCreateOptionsMenu()</code>方法即可，将上面定义的xml资源文件加载，前提是有ToolBar</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onCreateOptionsMenu</span><span style=color:#f92672>(</span>Menu menu<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onCreateOptionsMenu</span><span style=color:#f92672>(</span>menu<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        getMenuInflater<span style=color:#f92672>().</span><span style=color:#a6e22e>inflate</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>menu</span><span style=color:#f92672>.</span><span style=color:#a6e22e>menu_main</span><span style=color:#f92672>,</span> menu<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>点击事件处理，只需要在activity中重写<code>onOptionsItemSelected()</code>方法即可</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onOptionsItemSelected</span><span style=color:#f92672>(</span>MenuItem item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>item<span style=color:#f92672>.</span><span style=color:#a6e22e>getItemId</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_add_a_contact</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_add_a_contact&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_create_a_channel</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_create_a_channel&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_create_a_contact_group</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_create_a_contact_group&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_add_a_app</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_add_a_app&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_join_a_channel</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_join_a_channel&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onOptionsItemSelected</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果需要在运行时修改MenuItem的状态，可以重写<code>onPrepareOptionsMenu()</code>方法（每点击一次都会执行一次），比如可以在这里进行状态判断以禁用某些选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>// 首先需要一个flag控制
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Boolean flag <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 其次在需要动态修改Menu状态的位置修改flag值，然后调用invalidateOptionsMenu()，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这个方法会调用onPrepareOptionsMenu()方法，从而实现Menu的状态变化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    button<span style=color:#f92672>.</span><span style=color:#a6e22e>setOnClickListener</span><span style=color:#f92672>(</span>v <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        flag <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        invalidateOptionsMenu<span style=color:#f92672>();</span>  <span style=color:#75715e>//  Android 3.0 及更高版本中必须调用invalidateOptionsMenu
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onPrepareOptionsMenu</span><span style=color:#f92672>(</span>Menu menu<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            menu<span style=color:#f92672>.</span><span style=color:#a6e22e>findItem</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_create_a_contact_group</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setVisible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            menu<span style=color:#f92672>.</span><span style=color:#a6e22e>findItem</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_join_a_channel</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setVisible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onPrepareOptionsMenu</span><span style=color:#f92672>(</span>menu<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=13-修改默认的toolbar-menu图标以及点击背景色>1.3 修改默认的ToolBar Menu图标以及点击背景色<a hidden class=anchor aria-hidden=true href=#13-修改默认的toolbar-menu图标以及点击背景色>#</a></h3><p>默认为三个点，可以在<code>styles.xml</code>中进行修改</p><p>比如ToolBar在布局文件中如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#f92672>&lt;androidx.appcompat.widget.Toolbar</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/my_toolbar&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;?attr/actionBarSize&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:elevation=</span><span style=color:#e6db74>&#34;4dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:theme=</span><span style=color:#e6db74>&#34;@style/ToolbarBase&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:popupTheme=</span><span style=color:#e6db74>&#34;@style/OverflowMenu&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/androidx.appcompat.widget.Toolbar&gt;</span>
</span></span></code></pre></div><p>两个参数</p><ul><li>theme：为整个ToolBar的主题，actionOverflowButtonStyle可以修改默认图标</li><li>popupTheme：为弹出的Menu的主题，colorControlHighlight可以修改点击背景色</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#f92672>&lt;style</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;ToolbarBase&#34;</span> <span style=color:#a6e22e>parent=</span><span style=color:#e6db74>&#34;ThemeOverlay.AppCompat.ActionBar&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;item</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;actionOverflowButtonStyle&#34;</span><span style=color:#f92672>&gt;</span>@style/OverflowButtonStyle<span style=color:#f92672>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--&lt;item name=&#34;actionOverflowMenuStyle&#34;&gt;@style/OverflowMenu&lt;/item&gt;--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/style&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;style</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;OverflowButtonStyle&#34;</span> <span style=color:#a6e22e>parent=</span><span style=color:#e6db74>&#34;@android:style/Widget.ActionButton.Overflow&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;item</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;android:src&#34;</span><span style=color:#f92672>&gt;</span>@drawable/ic_add_circle_outline_black_24dp<span style=color:#f92672>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;item</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;overlapAnchor&#34;</span><span style=color:#f92672>&gt;</span>false<span style=color:#f92672>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/style&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;style</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;OverflowMenu&#34;</span> <span style=color:#a6e22e>parent=</span><span style=color:#e6db74>&#34;ThemeOverlay.AppCompat.Light&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--遮挡属性--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;item</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;overlapAnchor&#34;</span><span style=color:#f92672>&gt;</span>false<span style=color:#f92672>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--MenuItem选中背景颜色--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;item</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;colorControlHighlight&#34;</span><span style=color:#f92672>&gt;</span>@color/holo_blue_light<span style=color:#f92672>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/style&gt;</span>
</span></span></code></pre></div><h2 id=2-上下文菜单>2. 上下文菜单<a hidden class=anchor aria-hidden=true href=#2-上下文菜单>#</a></h2><p>ContextMenu可以用在非常多的控件上，这里仅简单使用Button和RecyclerView，通常来说，触发ContextMenu的方式是长按，因此与该控件的OnLongClick事件冲突，
如果在onLongClick()方法中返回<strong>true</strong>，则代表点击事件被消耗，不再继续传递，那么ContextMenu不会触发；反之返回<strong>false</strong>，则ContextMenu被触发。由此可知，onLongClick()的优先级在ContextMenu之上，具体会在<strong>Android事件传递中分析</strong>。</p><p>ContextMenu可以在一个Activity中有多个，甚至可以在RecyclerView中使用，但是仅需要重写两个方法即可判断ContextMenu的来源。</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Zhoutao822/hugo-pic/pictures/3.jpg alt=3></p><p>如上图所示，<code>Upload</code>后面跟的是该控件的<code>ItemId</code>，三个Menu各不相同，所以显然我们可以根据控件的不同生成不同的ContextMenu，点击事件同理。</p><p>使用ContextMenu的三个步骤：</p><blockquote><p>1.注册，更确切的说法是关联，即指定需要生成ContextMenu的控件，一句话解决</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        registerForContextMenu<span style=color:#f92672>(</span>recyclerView<span style=color:#f92672>);</span> <span style=color:#75715e>// 对RecyclerView也是一样，但是这里我用的是自定义RecyclerView，稍后解释
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        registerForContextMenu<span style=color:#f92672>(</span>button<span style=color:#f92672>);</span> <span style=color:#75715e>// 直接在onCreate中注册即可，有几个控件就注册几次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        registerForContextMenu<span style=color:#f92672>(</span>button1<span style=color:#f92672>);</span>
</span></span></code></pre></div><blockquote><p>2.重写onCreateContextMenu方法，生成Menu</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onCreateContextMenu</span><span style=color:#f92672>(</span>ContextMenu menu<span style=color:#f92672>,</span> View v<span style=color:#f92672>,</span> ContextMenu<span style=color:#f92672>.</span><span style=color:#a6e22e>ContextMenuInfo</span> menuInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onCreateContextMenu</span><span style=color:#f92672>(</span>menu<span style=color:#f92672>,</span> v<span style=color:#f92672>,</span> menuInfo<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里实现了根据Id不同生成不同的Menu
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>v<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>first_button</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                addMenu<span style=color:#f92672>(</span>menu<span style=color:#f92672>,</span> v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>second_button</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                addMenu<span style=color:#f92672>(</span>menu<span style=color:#f92672>,</span> v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>recycler_view</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                addMenu<span style=color:#f92672>(</span>menu<span style=color:#f92672>,</span> v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addMenu</span><span style=color:#f92672>(</span>ContextMenu menu<span style=color:#f92672>,</span> View v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        menu<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeaderTitle</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Context Menu&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        menu<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> 0<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Upload&#34;</span> <span style=color:#f92672>+</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        menu<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> 0<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Search&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        menu<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> 0<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Share&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        menu<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> 0<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Bookmark&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 同时可以通过groupId来禁用某些选项，这是额外的功能
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        menu<span style=color:#f92672>.</span><span style=color:#a6e22e>setGroupEnabled</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>3.重写onContextItemSelected方法，点击事件响应</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onContextItemSelected</span><span style=color:#f92672>(</span>MenuItem item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里需要注意，因为RecyclerView需要传入Item的Position属性，所以需要自定义RecyclerView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RecyclerViewWithContextMenu<span style=color:#f92672>.</span><span style=color:#a6e22e>RecyclerViewContextInfo</span> info <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>RecyclerViewWithContextMenu<span style=color:#f92672>.</span><span style=color:#a6e22e>RecyclerViewContextInfo</span><span style=color:#f92672>)</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getMenuInfo</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;onCreateContextMenu position = &#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>info <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> info<span style=color:#f92672>.</span><span style=color:#a6e22e>getPosition</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;-1&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过判断点击的Item是否存在getMenuInfo获得的值，可以判断点击事件的来源，RecyclerView还是Button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>info <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> info<span style=color:#f92672>.</span><span style=color:#a6e22e>getPosition</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Selected Item: &#34;</span> <span style=color:#f92672>+</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getTitle</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; data: &#34;</span> <span style=color:#f92672>+</span> data<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>info<span style=color:#f92672>.</span><span style=color:#a6e22e>getPosition</span><span style=color:#f92672>()),</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Selected Item: &#34;</span> <span style=color:#f92672>+</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getTitle</span><span style=color:#f92672>(),</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><ol start=4><li><strong>自定义的RecyclerViewWithContextMenu</strong></li></ol></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RecyclerViewWithContextMenu</span> <span style=color:#66d9ef>extends</span> RecyclerView <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TAG <span style=color:#f92672>=</span> RecyclerViewWithContextMenu<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RecyclerViewContextInfo mContextInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RecyclerViewContextInfo<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RecyclerViewWithContextMenu</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RecyclerViewWithContextMenu</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> AttributeSet attrs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RecyclerViewWithContextMenu</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> AttributeSet attrs<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> defStyle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>,</span> defStyle<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 关键方法，重写showContextMenuForChild，将position属性传出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>showContextMenuForChild</span><span style=color:#f92672>(</span>View originalView<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> longPressPosition <span style=color:#f92672>=</span> getChildAdapterPosition<span style=color:#f92672>(</span>originalView<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>longPressPosition <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mContextInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mPosition</span> <span style=color:#f92672>=</span> longPressPosition<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>showContextMenuForChild</span><span style=color:#f92672>(</span>originalView<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> ContextMenu<span style=color:#f92672>.</span><span style=color:#a6e22e>ContextMenuInfo</span> <span style=color:#a6e22e>getContextMenuInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> mContextInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过自定义的ContextMenuInfo保存position的值，并提供调用的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RecyclerViewContextInfo</span> <span style=color:#66d9ef>implements</span> ContextMenu<span style=color:#f92672>.</span><span style=color:#a6e22e>ContextMenuInfo</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> mPosition <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getPosition</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> mPosition<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=3-弹出菜单>3. 弹出菜单<a hidden class=anchor aria-hidden=true href=#3-弹出菜单>#</a></h2><p>PopupMenu是使用上最简单的，它的效果与ContextMenu类似但不完全相同，主要是位置是相对固定的，但是PopupMenu可以动态调用，与整体的布局无关</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainActivity</span> <span style=color:#66d9ef>extends</span> AppCompatActivity <span style=color:#66d9ef>implements</span> PopupMenu<span style=color:#f92672>.</span><span style=color:#a6e22e>OnMenuItemClickListener</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TAG <span style=color:#f92672>=</span> MainActivity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onCreate</span><span style=color:#f92672>(</span>Bundle savedInstanceState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onCreate</span><span style=color:#f92672>(</span>savedInstanceState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        setContentView<span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>activity_main</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// PopupMenu通过onClick事件创建
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        findViewById<span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pop_button</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setOnClickListener</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> View<span style=color:#f92672>.</span><span style=color:#a6e22e>OnClickListener</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onClick</span><span style=color:#f92672>(</span>View v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                showPopupMenu<span style=color:#f92672>(</span>v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>showPopupMenu</span><span style=color:#f92672>(</span>View v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// new一个对象，同样可以使用xml加载选项
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PopupMenu popup <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PopupMenu<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        popup<span style=color:#f92672>.</span><span style=color:#a6e22e>inflate</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>menu</span><span style=color:#f92672>.</span><span style=color:#a6e22e>menu_main</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        popup<span style=color:#f92672>.</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里需要继承PopupMenu.OnMenuItemClickListener接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        popup<span style=color:#f92672>.</span><span style=color:#a6e22e>setOnMenuItemClickListener</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onMenuItemClick</span><span style=color:#f92672>(</span>MenuItem item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 点击事件响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>item<span style=color:#f92672>.</span><span style=color:#a6e22e>getItemId</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_add_a_contact</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_add_a_contact&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_create_a_channel</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_create_a_channel&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_create_a_contact_group</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_create_a_contact_group&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_add_a_app</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_add_a_app&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>action_join_a_channel</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;action_join_a_channel&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onOptionsItemSelected</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=4-android事件分发机制>4. Android事件分发机制<a hidden class=anchor aria-hidden=true href=#4-android事件分发机制>#</a></h2><p>之所以会想到Android事件分发机制，主要是在ContextMenu的使用上发现长按事件的处理以及冲突，从而对长按事件优先级有一点思考，结合一些参考的文章，写一下自己的理解。</p><p>在使用ContextMenu中会产生以下几个问题，根据这些问题，可以尝试在源码里找结果。</p><ul><li>为什么ContextMenu只需要注册就可以使用，而不是new一个对象出来，类似于PopupMenu？</li></ul><p>首先看与ContextMenu相关的几个方法：</p><p><code>registerForContextMenu</code></p><p><code>onCreateContextMenu</code></p><p><code>onContextItemSelected</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Activity.java registerForContextMenu这个方法仅仅是对view进行了注册listener
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Registers a context menu to be shown for the given view (multiple views
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * can show the context menu). This method will set the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link OnCreateContextMenuListener} on the view to this activity, so
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link #onCreateContextMenu(ContextMenu, View, ContextMenuInfo)} will be
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * called when it is time to show the context menu.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see #unregisterForContextMenu(View)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param view The view that should show a context menu.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerForContextMenu</span><span style=color:#f92672>(</span>View view<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        view<span style=color:#f92672>.</span><span style=color:#a6e22e>setOnCreateContextMenuListener</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// View.java 注册的过程中通过setLongClickable强制让此控件可以被long click，同时传递listener
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Register a callback to be invoked when the context menu for this view is
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * being built. If this view is not long clickable, it becomes long clickable.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param l The callback that will run
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setOnCreateContextMenuListener</span><span style=color:#f92672>(</span>OnCreateContextMenuListener l<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isLongClickable<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            setLongClickable<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        getListenerInfo<span style=color:#f92672>().</span><span style=color:#a6e22e>mOnCreateContextMenuListener</span> <span style=color:#f92672>=</span> l<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * Listener used to build the context menu.
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * This field should be made private, so it is hidden from the SDK.
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * {@hide}
</span></span></span><span style=display:flex><span><span style=color:#75715e>        */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> OnCreateContextMenuListener mOnCreateContextMenuListener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 这个listener的作用就是通过li.mOnCreateContextMenuListener.onCreateContextMenu(menu, this, menuInfo)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 将menu和menuInfo传出去，也就是说，我们在调用super.onCreateContextMenu(menu, v, menuInfo)后即可得到menu的实例，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 然后对menu实例进行处理，比如menu.add增加选项、menu.setGroupEnabled设置可点击的选项等等，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 此处暂不讨论createContextMenu是在哪里调用的，因为涉及到PhoneWindow和DecorView。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Show the context menu for this view. It is not safe to hold on to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * menu after returning from this method.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * You should normally not overload this method. Overload
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link #onCreateContextMenu(ContextMenu)} or define an
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link OnCreateContextMenuListener} to add items to the context menu.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param menu The context menu to populate
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createContextMenu</span><span style=color:#f92672>(</span>ContextMenu menu<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ContextMenuInfo menuInfo <span style=color:#f92672>=</span> getContextMenuInfo<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Sets the current menu info so all items added to menu will have
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// my extra info set.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>((</span>MenuBuilder<span style=color:#f92672>)</span>menu<span style=color:#f92672>).</span><span style=color:#a6e22e>setCurrentMenuInfo</span><span style=color:#f92672>(</span>menuInfo<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        onCreateContextMenu<span style=color:#f92672>(</span>menu<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        ListenerInfo li <span style=color:#f92672>=</span> mListenerInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>li <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnCreateContextMenuListener</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnCreateContextMenuListener</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onCreateContextMenu</span><span style=color:#f92672>(</span>menu<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> menuInfo<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Clear the extra information so subsequent items that aren&#39;t mine don&#39;t
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// have my extra info.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>((</span>MenuBuilder<span style=color:#f92672>)</span>menu<span style=color:#f92672>).</span><span style=color:#a6e22e>setCurrentMenuInfo</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mParent <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mParent<span style=color:#f92672>.</span><span style=color:#a6e22e>createContextMenu</span><span style=color:#f92672>(</span>menu<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Activity.java Item点击事件响应，除了ContextMenu，可以发现普通的ToolBar上的Menu的点击（onOptionsItemSelected）
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 也是在这里响应的。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Default implementation of
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link android.view.Window.Callback#onMenuItemSelected}
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * for activities.  This calls through to the new
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link #onOptionsItemSelected} method for the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link android.view.Window#FEATURE_OPTIONS_PANEL}
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * panel, so that subclasses of
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Activity don&#39;t need to deal with feature codes.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onMenuItemSelected</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> featureId<span style=color:#f92672>,</span> MenuItem item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        CharSequence titleCondensed <span style=color:#f92672>=</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getTitleCondensed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过featureId参数判断是来自ToolBar的Menu还是ContextMenu，显然这个参数来自于onMenuItemSelected方法被调用的地方
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 可以在ToolbarWidgetWrapper.java和PhoneWindow.java中找到
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>featureId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> Window<span style=color:#f92672>.</span><span style=color:#a6e22e>FEATURE_OPTIONS_PANEL</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Put event logging here so it gets called even if subclass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// doesn&#39;t call through to superclass&#39;s implmeentation of each
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// of these methods below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>titleCondensed <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    EventLog<span style=color:#f92672>.</span><span style=color:#a6e22e>writeEvent</span><span style=color:#f92672>(</span>50000<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> titleCondensed<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 在这里可以看到如果onOptionsItemSelected返回false，点击事件会继续传递下去，所以我们在重写onOptionsItemSelected
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 方法时会在执行对应选项的点击事件后返回true以消耗点击事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>onOptionsItemSelected<span style=color:#f92672>(</span>item<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mFragments<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchOptionsItemSelected</span><span style=color:#f92672>(</span>item<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>item<span style=color:#f92672>.</span><span style=color:#a6e22e>getItemId</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> android<span style=color:#f92672>.</span><span style=color:#a6e22e>R</span><span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>home</span> <span style=color:#f92672>&amp;&amp;</span> mActionBar <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>(</span>mActionBar<span style=color:#f92672>.</span><span style=color:#a6e22e>getDisplayOptions</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;</span> ActionBar<span style=color:#f92672>.</span><span style=color:#a6e22e>DISPLAY_HOME_AS_UP</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mParent <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> onNavigateUp<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> mParent<span style=color:#f92672>.</span><span style=color:#a6e22e>onNavigateUpFromChild</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> Window<span style=color:#f92672>.</span><span style=color:#a6e22e>FEATURE_CONTEXT_MENU</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>titleCondensed <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    EventLog<span style=color:#f92672>.</span><span style=color:#a6e22e>writeEvent</span><span style=color:#f92672>(</span>50000<span style=color:#f92672>,</span> 1<span style=color:#f92672>,</span> titleCondensed<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 同上
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>onContextItemSelected<span style=color:#f92672>(</span>item<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> mFragments<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchContextItemSelected</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            default:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>综上所述，ContextMenu其实是一个比较深层次的控件，它的创建过程被更复杂的PhoneWindow以及DecorView等控制，对开发者来说，Menu是一个直接使用就行的控件，底层不希望开发者对Menu进行指定布局选项之外的操作，因此我们不需要new一个对象出来。至于它是如何在PhoneWindow以及DecorView中创建的，我可能在接下来的博客中写一下自己的理解。</p><ul><li>ContextMenu的触发与该控件的onLongClick方法的冲突是如何产生的？</li></ul><p>在上面ContextMenu的使用过程中，会发现ContextMenu默认是长按触发，而且源码里也说明了，控件会被强制赋予长按属性，那么如果同时设置该控件的onLongClick方法会产生怎样的效果，代码很简单，这里有一个疑问了，为什么要返回true？如果返回false会怎样？为什么onClick方法不用返回值？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>       button<span style=color:#f92672>.</span><span style=color:#a6e22e>setOnLongClickListener</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> View<span style=color:#f92672>.</span><span style=color:#a6e22e>OnLongClickListener</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onLongClick</span><span style=color:#f92672>(</span>View v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>               Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span>MainActivity<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;button long click&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>               <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>});</span>
</span></span></code></pre></div><p>结果也是很明显的，测试一下就知道这里返回true，那么button的ContextMenu无法触发，Toast会正常产生；返回false，那么button的Toast会产生，而且ContextMenu也会产生，onLongClick方法在onCreateContextMenu方法之前执行。</p><p>由此产生了另一个问题，onLongClick方法是如何产生的，解决了这个问题，那么所有的问题都将迎刃而解。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// View.java 最直接的调用onLongClick方法的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Calls this view&#39;s OnLongClickListener, if it is defined. Invokes the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * context menu if the OnLongClickListener did not consume the event,
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * optionally anchoring it to an (x,y) coordinate.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param x x coordinate of the anchoring touch event, or {@link Float#NaN}
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *          to disable anchoring
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param y y coordinate of the anchoring touch event, or {@link Float#NaN}
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *          to disable anchoring
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return {@code true} if one of the above receivers consumed the event,
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         {@code false} otherwise
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>performLongClickInternal</span><span style=color:#f92672>(</span><span style=color:#66d9ef>float</span> x<span style=color:#f92672>,</span> <span style=color:#66d9ef>float</span> y<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sendAccessibilityEvent<span style=color:#f92672>(</span>AccessibilityEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE_VIEW_LONG_CLICKED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> ListenerInfo li <span style=color:#f92672>=</span> mListenerInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>li <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnLongClickListener</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// listener调用onLongClick方法的位置，返回值为handled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            handled <span style=color:#f92672>=</span> li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnLongClickListener</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onLongClick</span><span style=color:#f92672>(</span>View<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果handled为true，则不会执行下面整个方法showContextMenu，看名字也知道这是ContextMenu显示的方法了，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 所以如果onLongClick返回true，则不会显示ContextMenu；反之同理。所以上面关于执行先后顺序的疑问解决了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>handled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isAnchored <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>Float<span style=color:#f92672>.</span><span style=color:#a6e22e>isNaN</span><span style=color:#f92672>(</span>x<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>Float<span style=color:#f92672>.</span><span style=color:#a6e22e>isNaN</span><span style=color:#f92672>(</span>y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            handled <span style=color:#f92672>=</span> isAnchored <span style=color:#f92672>?</span> showContextMenu<span style=color:#f92672>(</span>x<span style=color:#f92672>,</span> y<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> showContextMenu<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>mViewFlags <span style=color:#f92672>&amp;</span> TOOLTIP<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> TOOLTIP<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果handled为true，则不会执行下面整个方法showLongClickTooltip，这个Tooltip是另一个控件，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 其触发也是与长按事件相关，暂且不表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>handled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                handled <span style=color:#f92672>=</span> showLongClickTooltip<span style=color:#f92672>((</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> x<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>handled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            performHapticFeedback<span style=color:#f92672>(</span>HapticFeedbackConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>LONG_PRESS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 最后还是返回handled的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> handled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 再看看onClick方法的调用，很明显单击事件没有其他控件与其冲突，所以它的返回值为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Call this view&#39;s OnClickListener, if it is defined.  Performs all normal
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * actions associated with clicking: reporting accessibility event, playing
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * a sound, etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return True there was an assigned OnClickListener that was called, false
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         otherwise is returned.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// NOTE: other methods on View should not call this method directly, but performClickInternal()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// instead, to guarantee that the autofill manager is notified when necessary (as subclasses
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// could extend this method without calling super.performClick()).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>performClick</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We still need to call this method to handle the cases where performClick() was called
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// externally, instead of through performClickInternal()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        notifyAutofillManagerOnClick<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> ListenerInfo li <span style=color:#f92672>=</span> mListenerInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>li <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnClickListener</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            playSoundEffect<span style=color:#f92672>(</span>SoundEffectConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>CLICK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 无返回值，没有冲突，result直接设置为true即可
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnClickListener</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onClick</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sendAccessibilityEvent<span style=color:#f92672>(</span>AccessibilityEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE_VIEW_CLICKED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        notifyEnterOrExitForAutoFillIfNeeded<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 然后就是点击事件与长按事件是如何产生的，这里牵涉到onTouchEvent方法，这里把无关代码略过，仅保留重要代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Implement this method to handle touch screen motion events.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * If this method is used to detect click actions, it is recommended that
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * the actions be performed by implementing and calling
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * {@link #performClick()}. This will ensure consistent system behavior,
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * including:
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;ul&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;li&gt;obeying click sound preferences
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;li&gt;dispatching OnClickListener calls
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;li&gt;handling {@link AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK} when
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * accessibility features are enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;/ul&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param event The motion event.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return True if the event was handled, false otherwise.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ... 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>clickable <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>viewFlags <span style=color:#f92672>&amp;</span> TOOLTIP<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> TOOLTIP<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>action<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// MotionEvent分为四种ACTION_UP、ACTION_DOWN、ACTION_CANCEL、ACTION_MOVE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 分别对应手指在屏幕的状态：抬起、按下、（例外，暂且不解释）、滑动
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 通过对这些MotionEvent的监听可以实现各种点击效果，比如多连击、定时点击等等效果，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 也可以控制事件的冲突，我们仅需要在自定义控件中重写onTouchEvent方法即可。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_UP</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 为什么要在抬起的时候触发点击事件performClick，因为长按与点击是有冲突的，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 长按会在ACTION_DOWN里触发，这是由时间控制的，因此ACTION_UP中与长按事件其实关系就不大了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 所以在这里处理点击事件是一个较为合理的设计
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>mPrivateFlags <span style=color:#f92672>&amp;</span> PFLAG_PRESSED<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0 <span style=color:#f92672>||</span> prepressed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// take focus if we don&#39;t have it already and we should in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// touch mode.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>boolean</span> focusTaken <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isFocusable<span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> isFocusableInTouchMode<span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>isFocused<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            focusTaken <span style=color:#f92672>=</span> requestFocus<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>prepressed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// The button is being released before we actually
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// showed it as pressed.  Make it show the pressed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// state now (before scheduling the click) to ensure
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// the user sees it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            setPressed<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> x<span style=color:#f92672>,</span> y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mHasPerformedLongPress <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>mIgnoreNextUpEvent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// This is a tap, so remove the longpress check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            removeLongPressCallback<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// Only perform take click actions if we were in the pressed state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>focusTaken<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>// Use a Runnable and post this rather than calling
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#75715e>// performClick directly. This lets other visual state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#75715e>// of the view update before click actions start.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mPerformClick <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    <span style=color:#75715e>// 点击事件的关键，这里的PerformClick是一个Runnable，为什么要用Runnable，之后再解释
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                    mPerformClick <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PerformClick<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>// 通过handler调用performClick方法，点击事件就完成了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>post<span style=color:#f92672>(</span>mPerformClick<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    performClickInternal<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    mIgnoreNextUpEvent <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>event<span style=color:#f92672>.</span><span style=color:#a6e22e>getSource</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> InputDevice<span style=color:#f92672>.</span><span style=color:#a6e22e>SOURCE_TOUCHSCREEN</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        mPrivateFlags3 <span style=color:#f92672>|=</span> PFLAG3_FINGER_DOWN<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// mHasPerformedLongPress用于解决长按与点击的事件冲突，具体可以看源码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    mHasPerformedLongPress <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// clickable表示该控件是否可以点击（包括点击、长按等）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>clickable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 如果控件不可点击，那么会判断是否需要显示Tooltip或者什么都不干，然后break，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// 具体可以看checkForLongClick方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        checkForLongClick<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> x<span style=color:#f92672>,</span> y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// performButtonActionOnTouchDown与外设有关，暂时不用考虑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>performButtonActionOnTouchDown<span style=color:#f92672>(</span>event<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Walk up the hierarchy to determine if we&#39;re inside a scrolling container.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>boolean</span> isInScrollingContainer <span style=color:#f92672>=</span> isInScrollingContainer<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// For views inside a scrolling container, delay the pressed feedback for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// a short period in case this is a scroll.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 该控件在一个可以滑动的container内，则会增加一个反应延时，但是最终都是调用checkForLongClick
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isInScrollingContainer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        mPrivateFlags <span style=color:#f92672>|=</span> PFLAG_PREPRESSED<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mPendingCheckForTap <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            mPendingCheckForTap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CheckForTap<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        mPendingCheckForTap<span style=color:#f92672>.</span><span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getX</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        mPendingCheckForTap<span style=color:#f92672>.</span><span style=color:#a6e22e>y</span> <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getY</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        postDelayed<span style=color:#f92672>(</span>mPendingCheckForTap<span style=color:#f92672>,</span> ViewConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>getTapTimeout</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// Not inside a scrolling container, so show the feedback right away
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        setPressed<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> x<span style=color:#f92672>,</span> y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// checkForLongClick也是一个Runnable，最终调用还是performLongClickInternal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        checkForLongClick<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> x<span style=color:#f92672>,</span> y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// ACTION_CANCEL状态比较难触发，举个例子，在MIUI中开启“传送门”功能，就可以触发
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_CANCEL</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>clickable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        setPressed<span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    removeTapCallback<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    removeLongPressCallback<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    mInContextButtonPress <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    mHasPerformedLongPress <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    mIgnoreNextUpEvent <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    mPrivateFlags3 <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>PFLAG3_FINGER_DOWN<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// ACTION_MOVE状态下removeTapCallback方法和removeLongPressCallback可以取消点击事件，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 这也就是为什么我们在按住某个按钮然后滑动出去就可以避免触发点击事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_MOVE</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>clickable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        drawableHotspotChanged<span style=color:#f92672>(</span>x<span style=color:#f92672>,</span> y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Be lenient about moving outside of buttons
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>pointInView<span style=color:#f92672>(</span>x<span style=color:#f92672>,</span> y<span style=color:#f92672>,</span> mTouchSlop<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// Outside button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// Remove any future long press/tap checks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        removeTapCallback<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        removeLongPressCallback<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>mPrivateFlags <span style=color:#f92672>&amp;</span> PFLAG_PRESSED<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            setPressed<span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        mPrivateFlags3 <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>PFLAG3_FINGER_DOWN<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>根据上述源码，我们知道了ContextMenu与长按事件冲突的原因，点击事件与长按事件是如何产生的，但是随之而来有了新的问题。</p><ul><li>为什么要使用Runnable来调用以及如果父容器有点击事件的同时子控件也有点击事件，那么事件传递的过程以及中间冲突是如何解决的？</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// View.java 从源码中可以看到，这是一个专门用于UI线程的Handler，通过这个Handler发送的Runnable都会在UI线程中运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;p&gt;Causes the Runnable to be added to the message queue.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * The runnable will be run on the user interface thread.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param action The Runnable that will be executed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Returns true if the Runnable was successfully placed in to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         message queue.  Returns false on failure, usually because the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         looper processing the message queue is exiting.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see #postDelayed
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see #removeCallbacks
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>Runnable action<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> AttachInfo attachInfo <span style=color:#f92672>=</span> mAttachInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>attachInfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> attachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mHandler</span><span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>action<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Postpone the runnable until we know on which thread it needs to run.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Assume that the runnable will be successfully placed after attach.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        getRunQueue<span style=color:#f92672>().</span><span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>action<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>结合上面的部分注释，说明一个原理，所有的点击事件以及屏幕绘制都要在UI线程中处理，这是为了方便点击触发时重绘UI</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Use a Runnable and post this rather than calling
</span></span></span><span style=display:flex><span><span style=color:#75715e>// performClick directly. This lets other visual state
</span></span></span><span style=display:flex><span><span style=color:#75715e>// of the view update before click actions start.
</span></span></span></code></pre></div><p>从上面的源码部分我们知道了点击或者长按事件是通过onTouchEvent触发的，那么再看看onTouchEvent是在哪里调用的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// View.java onTouchEvent是在dispatchTouchEvent方法中被调用，看注释就知道这个方法它是要将MotionEvent传递给target view
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Pass the touch screen motion event down to the target view, or this
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * view if it is the target.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param event The motion event to be dispatched.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return True if the event was handled by the view, false otherwise.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If the event should be handled by accessibility focus first.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>event<span style=color:#f92672>.</span><span style=color:#a6e22e>isTargetAccessibilityFocus</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// We don&#39;t have focus or no virtual descendant has it, do not handle the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isAccessibilityFocusedViewOrHost<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// We have focus and got the event, then use normal event dispatch.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            event<span style=color:#f92672>.</span><span style=color:#a6e22e>setTargetAccessibilityFocus</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// result表示这个MotionEvent是否会被消耗
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mInputEventConsistencyVerifier <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mInputEventConsistencyVerifier<span style=color:#f92672>.</span><span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> actionMasked <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getActionMasked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Defensive cleanup for new gesture
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            stopNestedScroll<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>onFilterTouchEventForSecurity<span style=color:#f92672>(</span>event<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>mViewFlags <span style=color:#f92672>&amp;</span> ENABLED_MASK<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> ENABLED <span style=color:#f92672>&amp;&amp;</span> handleScrollBarDragging<span style=color:#f92672>(</span>event<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//noinspection SimplifiableIfStatement
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ListenerInfo li <span style=color:#f92672>=</span> mListenerInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果调用了onTouch方法，那么当前result被置为true，则后面onTouchEvent不会执行，那么事件在onTouch中处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>li <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnTouchListener</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>mViewFlags <span style=color:#f92672>&amp;</span> ENABLED_MASK<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> ENABLED
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&amp;&amp;</span> li<span style=color:#f92672>.</span><span style=color:#a6e22e>mOnTouchListener</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onTouch</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> event<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// onTouchEvent调用的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>result <span style=color:#f92672>&amp;&amp;</span> onTouchEvent<span style=color:#f92672>(</span>event<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>result <span style=color:#f92672>&amp;&amp;</span> mInputEventConsistencyVerifier <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mInputEventConsistencyVerifier<span style=color:#f92672>.</span><span style=color:#a6e22e>onUnhandledEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Clean up after nested scrolls if this is the end of a gesture;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// also cancel it if we tried an ACTION_DOWN but we didn&#39;t want the rest
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// of the gesture.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_UP</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_CANCEL</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>(</span>actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>result<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            stopNestedScroll<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>再往上看，View的dispatchTouchEvent是在哪里调用的，可以往上追溯到ViewGroup的dispatchTransformedTouchEvent方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ViewGroup.java ViewGroup继承自View，但是可以把它当做一个容器，比如LinearLayout就是继承自ViewGroup，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ViewGroup的dispatchTransformedTouchEvent将MotionEvent传给指定的子view，如果子view为空，那么这个ViewGroup
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 自己就处理MotionEvent，而我们知道ViewGroup继承自View，所以可以调用super.dispatchTouchEvent(event)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Transforms a motion event into the coordinate space of a particular child view,
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * filters out irrelevant pointer ids, and overrides its action if necessary.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTransformedTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> cancel<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            View child<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> desiredPointerIdBits<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// handled标志事件是否被消耗
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> handled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Canceling motions is a special case.  We don&#39;t need to perform any transformations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// or filtering.  The important part is the action, not the contents.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> oldAction <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getAction</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ACTION_CANCEL也要传递出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cancel <span style=color:#f92672>||</span> oldAction <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_CANCEL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            event<span style=color:#f92672>.</span><span style=color:#a6e22e>setAction</span><span style=color:#f92672>(</span>MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_CANCEL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 通过判断传入的child值决定在子view中处理事件还是在当前ViewGroup中处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>child <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                handled <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            event<span style=color:#f92672>.</span><span style=color:#a6e22e>setAction</span><span style=color:#f92672>(</span>oldAction<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> handled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Calculate the number of pointers to deliver.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 这里出现了一个新的概念pointers，这是由于许多设备支持多点触控，那么同一时间可以传递多个事件，我们把这些事件成为pointers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> oldPointerIdBits <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getPointerIdBits</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> newPointerIdBits <span style=color:#f92672>=</span> oldPointerIdBits <span style=color:#f92672>&amp;</span> desiredPointerIdBits<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If for some reason we ended up in an inconsistent state where it looks like we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// might produce a motion event with no pointers in it, then drop the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>newPointerIdBits <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If the number of pointers is the same and we don&#39;t need to perform any fancy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// irreversible transformations, then we can reuse the motion event for this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// dispatch as long as we are careful to revert any changes we make.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Otherwise we need to make a copy.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> MotionEvent transformedEvent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 当事件传递过程中pointers数量保持不变时，我们可以以一个相对安全的方式将事件传递下去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>newPointerIdBits <span style=color:#f92672>==</span> oldPointerIdBits<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>child <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>hasIdentityMatrix</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 判断方式同上
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>child <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 同时可以将一些偏移量参数传入event中，这也是为什么ContextMenu可以获取到点击事件的位置的原因
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> offsetX <span style=color:#f92672>=</span> mScrollX <span style=color:#f92672>-</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>mLeft</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> offsetY <span style=color:#f92672>=</span> mScrollY <span style=color:#f92672>-</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>mTop</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    event<span style=color:#f92672>.</span><span style=color:#a6e22e>offsetLocation</span><span style=color:#f92672>(</span>offsetX<span style=color:#f92672>,</span> offsetY<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    handled <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    event<span style=color:#f92672>.</span><span style=color:#a6e22e>offsetLocation</span><span style=color:#f92672>(-</span>offsetX<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>offsetY<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> handled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            transformedEvent <span style=color:#f92672>=</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// split方法主要是根据pointers数量变化决定event的类型，具体代码可以在MotionEvent.java中找到
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            transformedEvent <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span>newPointerIdBits<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Perform any necessary transformations and dispatch.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 同理需要将transformedEvent传出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>child <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>transformedEvent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> offsetX <span style=color:#f92672>=</span> mScrollX <span style=color:#f92672>-</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>mLeft</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> offsetY <span style=color:#f92672>=</span> mScrollY <span style=color:#f92672>-</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>mTop</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            transformedEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>offsetLocation</span><span style=color:#f92672>(</span>offsetX<span style=color:#f92672>,</span> offsetY<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>hasIdentityMatrix</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                transformedEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span>child<span style=color:#f92672>.</span><span style=color:#a6e22e>getInverseMatrix</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            handled <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>transformedEvent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Done.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        transformedEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> handled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>再看一下dispatchTransformedTouchEvent被调用的位置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ViewGroup.java 这是ViewGroup的dispatchTouchEvent方法，很明显了，应该功能类似View的dispatchTouchEvent
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 都是对MotionEvent进行传递，这里代码很长，仅仅保留最重要的部分
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>onFilterTouchEventForSecurity<span style=color:#f92672>(</span>ev<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> action <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getAction</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> actionMasked <span style=color:#f92672>=</span> action <span style=color:#f92672>&amp;</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_MASK</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Handle an initial down.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Throw away all previous state when starting a new touch gesture.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// The framework may have dropped the up or cancel event for the previous gesture
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// due to an app switch, ANR, or some other state change.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                cancelAndClearTouchTargets<span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                resetTouchState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Check for interception.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 这里多了一个参数intercepted，很重要，用于截断事件的传递
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> intercepted<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>||</span> mFirstTouchTarget <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> disallowIntercept <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>mGroupFlags <span style=color:#f92672>&amp;</span> FLAG_DISALLOW_INTERCEPT<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>disallowIntercept<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// intercepted的值通过onInterceptTouchEvent方法得到，重写此方法可以截断事件的传递
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    intercepted <span style=color:#f92672>=</span> onInterceptTouchEvent<span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    ev<span style=color:#f92672>.</span><span style=color:#a6e22e>setAction</span><span style=color:#f92672>(</span>action<span style=color:#f92672>);</span> <span style=color:#75715e>// restore action in case it was changed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    intercepted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// There are no touch targets and this action is not an initial down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// so this view group continues to intercept touches.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                intercepted <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果intercepted为true，则事件不会被传递下去，如果为false，则会将事件传递下去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>canceled <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>intercepted<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// If the event is targeting accessibility focus we give it to the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// view that has accessibility focus and if it does not handle it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// we clear the flag and dispatch the event to all children as usual.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// We are looking up the accessibility focused host to avoid keeping
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// state since these events are very rare.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 循环遍历ViewGroup的所有子view，将事件传递下去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                View childWithAccessibilityFocus <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>isTargetAccessibilityFocus</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>?</span> findChildWithAccessibilityFocus<span style=color:#f92672>()</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>split <span style=color:#f92672>&amp;&amp;</span> actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_POINTER_DOWN</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>||</span> actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_HOVER_MOVE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> actionIndex <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getActionIndex</span><span style=color:#f92672>();</span> <span style=color:#75715e>// always 0 for down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> idBitsToAssign <span style=color:#f92672>=</span> split <span style=color:#f92672>?</span> 1 <span style=color:#f92672>&lt;&lt;</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getPointerId</span><span style=color:#f92672>(</span>actionIndex<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>:</span> TouchTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>ALL_POINTER_IDS</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Clean up earlier touch targets for this pointer id in case they
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// have become out of sync.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    removePointersFromTouchTargets<span style=color:#f92672>(</span>idBitsToAssign<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childrenCount <span style=color:#f92672>=</span> mChildrenCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>newTouchTarget <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> childrenCount <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> x <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getX</span><span style=color:#f92672>(</span>actionIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> y <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getY</span><span style=color:#f92672>(</span>actionIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// Find a child that can receive the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// Scan children from front to back.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>final</span> ArrayList<span style=color:#f92672>&lt;</span>View<span style=color:#f92672>&gt;</span> preorderedList <span style=color:#f92672>=</span> buildTouchDispatchChildList<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> customOrder <span style=color:#f92672>=</span> preorderedList <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>&amp;&amp;</span> isChildrenDrawingOrderEnabled<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>final</span> View<span style=color:#f92672>[]</span> children <span style=color:#f92672>=</span> mChildren<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 循环开始的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> childrenCount <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> i <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>;</span> i<span style=color:#f92672>--)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childIndex <span style=color:#f92672>=</span> getAndVerifyPreorderedIndex<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                                    childrenCount<span style=color:#f92672>,</span> i<span style=color:#f92672>,</span> customOrder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>final</span> View child <span style=color:#f92672>=</span> getAndVerifyPreorderedView<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                                    preorderedList<span style=color:#f92672>,</span> children<span style=color:#f92672>,</span> childIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// If there is a view that has accessibility focus we want it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// to get the event first and if not handled we will perform a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// normal dispatch. We may do a double iteration but this is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// safer given the timeframe.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childWithAccessibilityFocus <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childWithAccessibilityFocus <span style=color:#f92672>!=</span> child<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                childWithAccessibilityFocus <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                i <span style=color:#f92672>=</span> childrenCount <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>canViewReceivePointerEvents<span style=color:#f92672>(</span>child<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>isTransformedTouchPointInView<span style=color:#f92672>(</span>x<span style=color:#f92672>,</span> y<span style=color:#f92672>,</span> child<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                ev<span style=color:#f92672>.</span><span style=color:#a6e22e>setTargetAccessibilityFocus</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            newTouchTarget <span style=color:#f92672>=</span> getTouchTarget<span style=color:#f92672>(</span>child<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>newTouchTarget <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>// Child is already receiving touch within its bounds.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#75715e>// Give it the new pointer in addition to the ones it is handling.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                newTouchTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>pointerIdBits</span> <span style=color:#f92672>|=</span> idBitsToAssign<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            resetCancelNextUpFlag<span style=color:#f92672>(</span>child<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// 调用dispatchTransformedTouchEvent的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dispatchTransformedTouchEvent<span style=color:#f92672>(</span>ev<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> child<span style=color:#f92672>,</span> idBitsToAssign<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>// Child wants to receive touch within its bounds.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                mLastTouchDownTime <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getDownTime</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>preorderedList <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    <span style=color:#75715e>// childIndex points into presorted list, find original index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;</span> childrenCount<span style=color:#f92672>;</span> j<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>children<span style=color:#f92672>[</span>childIndex<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> mChildren<span style=color:#f92672>[</span>j<span style=color:#f92672>])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                            mLastTouchDownIndex <span style=color:#f92672>=</span> j<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    mLastTouchDownIndex <span style=color:#f92672>=</span> childIndex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                mLastTouchDownX <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getX</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                                mLastTouchDownY <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getY</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                                newTouchTarget <span style=color:#f92672>=</span> addTouchTarget<span style=color:#f92672>(</span>child<span style=color:#f92672>,</span> idBitsToAssign<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                                alreadyDispatchedToNewTouchTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// The accessibility focus didn&#39;t handle the event, so clear
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// the flag and do a normal dispatch to all children.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            ev<span style=color:#f92672>.</span><span style=color:#a6e22e>setTargetAccessibilityFocus</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>preorderedList <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> preorderedList<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>newTouchTarget <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> mFirstTouchTarget <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// Did not find a child to receive the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// Assign the pointer to the least recently added target.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        newTouchTarget <span style=color:#f92672>=</span> mFirstTouchTarget<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>newTouchTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            newTouchTarget <span style=color:#f92672>=</span> newTouchTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        newTouchTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>pointerIdBits</span> <span style=color:#f92672>|=</span> idBitsToAssign<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果intercepted为true，则在这里调用dispatchTransformedTouchEvent
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 调用dispatchTransformedTouchEvent即调用本身的onTouchEvent方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 只看核心代码就可以知道事件传递的规则
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// Dispatch to touch targets.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mFirstTouchTarget <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// No touch targets so treat this as an ordinary view.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                handled <span style=color:#f92672>=</span> dispatchTransformedTouchEvent<span style=color:#f92672>(</span>ev<span style=color:#f92672>,</span> canceled<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        TouchTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>ALL_POINTER_IDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Dispatch to touch targets, excluding the new touch target if we already
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// dispatched to it.  Cancel touch targets if necessary.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                TouchTarget predecessor <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                TouchTarget target <span style=color:#f92672>=</span> mFirstTouchTarget<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>target <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>final</span> TouchTarget next <span style=color:#f92672>=</span> target<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>alreadyDispatchedToNewTouchTarget <span style=color:#f92672>&amp;&amp;</span> target <span style=color:#f92672>==</span> newTouchTarget<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> cancelChild <span style=color:#f92672>=</span> resetCancelNextUpFlag<span style=color:#f92672>(</span>target<span style=color:#f92672>.</span><span style=color:#a6e22e>child</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>||</span> intercepted<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dispatchTransformedTouchEvent<span style=color:#f92672>(</span>ev<span style=color:#f92672>,</span> cancelChild<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                target<span style=color:#f92672>.</span><span style=color:#a6e22e>child</span><span style=color:#f92672>,</span> target<span style=color:#f92672>.</span><span style=color:#a6e22e>pointerIdBits</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cancelChild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>predecessor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                mFirstTouchTarget <span style=color:#f92672>=</span> next<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                predecessor<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> next<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                            target<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                            target <span style=color:#f92672>=</span> next<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    predecessor <span style=color:#f92672>=</span> target<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    target <span style=color:#f92672>=</span> next<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Update list of touch targets for pointer up or cancel, if needed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>canceled
</span></span><span style=display:flex><span>                    <span style=color:#f92672>||</span> actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_UP</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>||</span> actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_HOVER_MOVE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                resetTouchState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>split <span style=color:#f92672>&amp;&amp;</span> actionMasked <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_POINTER_UP</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> actionIndex <span style=color:#f92672>=</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getActionIndex</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> idBitsToRemove <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getPointerId</span><span style=color:#f92672>(</span>actionIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                removePointersFromTouchTargets<span style=color:#f92672>(</span>idBitsToRemove<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>handled <span style=color:#f92672>&amp;&amp;</span> mInputEventConsistencyVerifier <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mInputEventConsistencyVerifier<span style=color:#f92672>.</span><span style=color:#a6e22e>onUnhandledEvent</span><span style=color:#f92672>(</span>ev<span style=color:#f92672>,</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> handled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>继续往上看，我们就能发现ViewGroup的dispatchTouchEvent方法由DecorView的superDispatchTouchEvent调用，而DecorView又是由PhoneWindow或者Window的superDispatchTouchEvent调用，PhoneWindow的superDispatchTouchEvent方法又是由activity的dispatchTouchEvent方法调用，具体代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Activity.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Called to process touch screen events.  You can override this to
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * intercept all touch screen events before they are dispatched to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * window.  Be sure to call this implementation for touch screen events
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * that should be handled normally.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param ev The touch screen event.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return boolean Return true if this event was consumed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getAction</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            onUserInteraction<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 核心代码getWindow().superDispatchTouchEvent(ev)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getWindow<span style=color:#f92672>().</span><span style=color:#a6e22e>superDispatchTouchEvent</span><span style=color:#f92672>(</span>ev<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> onTouchEvent<span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Window.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Used by custom windows, such as Dialog, to pass the touch screen event
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * further down the view hierarchy. Application developers should
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * not need to implement or call this.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 抽象方法，具体由PhoneWindow实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>superDispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DecorView.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// PhoneWindow的superDispatchTouchEvent方法交由DecorView实现，DecorView继承自ViewGroup，最终调用的还是ViewGroup的dispatchTouchEvent方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>superDispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>结合前半部分自底向上和后半部分自顶向下的分析，我们知道了dispatchTouchEvent传递事件的流程：</p><p>从activity -> PhoneWindow/DecorView -> ViewGroup(如果布局中有的话) -> View</p><ul><li>dispatchTouchEvent是一种层层递归式的调用，只有在递归到View中被执行时才会返回，一般来说返回true代表事件被消耗了，而事件的处理在OnTouchEvent中；</li><li>ViewGroup中有onInterceptTouchEvent方法可以中断事件的传递，重写此方法让它返回true，那么事件不会传递到子view中，onInterceptTouchEvent默认返回false；</li><li>在OnTouchEvent中返回true，则父容器不会执行OnTouchEvent方法，在OnTouchEvent中返回false，则父容器会执行OnTouchEvent方法，且后续的所有事件都会在父容器中处理，不再向下传递。</li></ul><p><strong>举两个例子说明如何通过onInterceptTouchEvent方法中断事件的传递</strong></p><p>第一个例子，一个LinearLayout中包含一个Button，LinearLayout和Button都设置onClick方法，很显然当我们点击Button时Button的onClick方法执行，当我们点击LinearLayout时LinearLayout的onClick方法执行；如果设置了log打印diapatchTouchEvent方法的执行顺序，那么可以发现：</p><p>点击Button： activity dispatchTouchEvent -> linearlayout dispatchTouchEvent -> button dispatchTouchEvent</p><p>点击LinearLayout： activity dispatchTouchEvent -> linearlayout dispatchTouchEvent</p><p>如果我们希望LinearLayout拦截传给Button的事件，那么就需要用到onInterceptTouchEvent方法</p><p>直接在自定义LinearLayout中重写onInterceptTouchEvent方法，让它返回true，则该LinearLayout下的所有子view都无法接收到事件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onInterceptTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>第二个例子，禁止ViewPager左右滑动，首先需要明白一个问题，为什么ViewPager可以使页面左右滑动，如果ViewPager中的Fragment中也包含一个控件CustomTextView，那么滑动会产生冲突吗？</p><p>首先看一下log日志，这是在自定义的CustomViewPager和CustomTextView中与TouchEvent相关的代码执行顺序</p><pre tabindex=0><code class=language-log data-lang=log>CustomViewPager:    dispatchTouchEvent    - ACTION_DOWN
CustomViewPager:    onInterceptTouchEvent - ACTION_DOWN
CustomTextView:     dispatchTouchEvent    - ACTION_DOWN
CustomTextView:     onTouchEvent          - ACTION_DOWN
CustomViewPager:    onTouchEvent          - ACTION_DOWN
CustomViewPager:    dispatchTouchEvent    - ACTION_MOVE
CustomViewPager:    onTouchEvent          - ACTION_MOVE
CustomViewPager:    dispatchTouchEvent    - ACTION_UP
CustomViewPager:    onTouchEvent          - ACTION_UP
</code></pre><p>下面是两个自定义的代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomViewPager</span> <span style=color:#66d9ef>extends</span> ViewPager <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aaaa-CustomViewPager&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> enabled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomViewPager</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>enabled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomViewPager</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> AttributeSet attrs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>enabled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;dispatchTouchEvent - &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> ev<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>enabled</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;onTouchEvent - &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 根据后面的分析可知，对于ACTION_DOWN事件来说，super.onInterceptTouchEvent(event)默认返回false
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 这段代码看似都是返回false，对结果没有影响，但是实际上将onInterceptTouchEvent的调用从ViewGroup转到ViewPager中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onInterceptTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>enabled</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;onInterceptTouchEvent - &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onInterceptTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPagingEnabled</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> enabled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>enabled</span> <span style=color:#f92672>=</span> enabled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomTextView</span> <span style=color:#66d9ef>extends</span> AppCompatTextView <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aaaa-CustomTextView&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomTextView</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomTextView</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> AttributeSet attrs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomTextView</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> AttributeSet attrs<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> defStyleAttr<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>,</span> defStyleAttr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;dispatchTouchEvent - &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>MotionEvent event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;onTouchEvent - &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>对于ACTION_DOWN事件来说，事件传递流程为：</p><ol><li>CustomViewPager的dispatchTouchEvent（应该是来自于PhoneWindow/DecorView），调用<code>super.dispatchTouchEvent(ev)</code>，即ViewGroup的dispatchTouchEvent方法；</li><li>在上面ViewGroup的源码中我们知道，ViewGroup的dispatchTouchEvent方法中调用了onInterceptTouchEvent方法<code>intercepted = onInterceptTouchEvent(ev);</code>，由于我们在CustomViewPager中重写了onInterceptTouchEvent方法，所以会回到CustomViewPager的onInterceptTouchEvent方法；</li><li>默认情况下this.enabled为true，所以我们开始调用<code>super.onInterceptTouchEvent(event)</code>，此时super是ViewPager的onInterceptTouchEvent方法；</li><li>再看ViewPager的源码，对于ACTION_DOWN事件来说，onInterceptTouchEvent返回false，所以CustomViewPager的onInterceptTouchEvent方法直接返回false，又回到ViewGroup的dispatchTouchEvent方法中；</li><li>当<code>intercepted = onInterceptTouchEvent(ev);</code>中intercepted为false时，会执行子view的dispatchTouchEvent方法，子view即CustomTextView的dispatchTouchEvent方法；</li><li>CustomTextView的dispatchTouchEvent方法默认调用<code>super.dispatchTouchEvent(event)</code>，即View的dispatchTouchEvent方法，而从View的源码中可知其调用onTouchEvent方法，而我们的CustomTextView重写了onTouchEvent方法，但是此方法又返回到TextView的onTouchEvent方法中，最终还是回到View的onTouchEvent方法，对于ACTION_DOWN事件来说，最终CustomTextView的onTouchEvent方法返回false，则CustomTextView的super以及CustomTextView的dispatchTouchEvent方法返回false，对应5中，如果子view的dispatchTouchEvent方法返回false，则第5步中ViewGroup会执行<code>super.dispatchTouchEvent(event)</code>，即ViewGroup的父类View的dispatchTouchEvent方法，此处的View不再是子view，而是作为CustomViewPager，因为CustomViewPager重写了onTouchEvent方法，所以View的dispatchTouchEvent方法中调用的onTouchEvent方法为CustomViewPager的onTouchEvent方法，而CustomViewPager的onTouchEvent方法调用<code>super.onTouchEvent(event)</code>，即ViewPager的onTouchEvent方法；</li><li>ViewPager的onTouchEvent方法即最终实现滑动效果的地方，根据代码可知，只有在没有adapter或者滑动到最边缘的页面才会返回false，其他情况返回true；</li><li>ViewPager的onTouchEvent方法返回true即处理了ACTION_DOWN事件，那么依次CustomViewPager的onTouchEvent方法返回true，CustomViewPager的dispatchTouchEvent方法返回true，至此ACTION_DOWN事件的处理结束了。</li></ol><p>对于ACTION_MOVE和ACTION_UP事件来说（这两个事件分发流程基本相同），事件传递流程为：</p><ol><li>CustomViewPager的dispatchTouchEvent（应该是来自于PhoneWindow/DecorView），调用<code>super.dispatchTouchEvent(ev)</code>，即ViewGroup的dispatchTouchEvent方法；</li><li>ViewGroup的dispatchTouchEvent方法中intercepted为true，拦截了ACTION_MOVE事件，由自身处理，即调用CustomViewPager的onTouchEvent方法；</li><li>CustomViewPager的onTouchEvent方法调用<code>super.onTouchEvent(event)</code>，即ViewPager的onTouchEvent方法，在这里实现滑动的效果，根据代码可知，只有在没有adapter或者滑动到最边缘的页面才会返回false，其他情况返回true；</li><li>然后依次CustomViewPager的onTouchEvent返回true，CustomViewPager的dispatchTouchEvent方法返回true。</li></ol><p>简而言之，事件分发就是一系列的dispatchTouchEvent、onInterceptTouchEvent和onTouchEvent方法的相互调用，首先需要明确地就是最终实现滑动效果、点击效果的都是各个控件的onTouchEvent方法，dispatchTouchEvent仅用作事件分发的开始，而onInterceptTouchEvent方法用于终止事件向子控件传递。</p><p>以上面的代码为例可以得到一些结论：</p><ol><li>ViewPager的onInterceptTouchEvent一般对ACTION_DOWN事件返回false，即不会对ACTION_DOWN进行拦截，那么ACTION_DOWN必定传到子view中；</li><li>如果ViewPager的子view无法在onTouchEvent中进行处理，比如这里的CustomTextView，对于ACTION_DOWN事件，CustomTextView的onTouchEvent返回false（为什么无法处理ACTION_DOWN，从源码中可知是由于CustomTextView的clickable为false，所以返回false），所以CustomTextView的dispatchTouchEvent方法返回false，相当于告诉父view不要再传给我ACTION_DOWN了，我没法处理；</li><li>如果ViewPager的子view的dispatchTouchEvent方法返回false，那么ViewPager就会调用自己的onTouchEvent来处理，ViewPager的onTouchEvent可以处理ACTION_DOWN事件，并记录了点击的位置，然后返回true，从而ViewPager的dispatchTouchEvent方法返回true，ACTION_DOWN事件结束；</li><li>紧接着ACTION_DOWN事件的必定是ACTION_MOVE或ACTION_UP，以ACTION_MOVE为例，同样是从ViewPager的dispatchTouchEvent方法开始，此时没有调用onInterceptTouchEvent方法，而是直接执行onTouchEvent方法，即根据ACTION_MOVE事件带的参数实现滑动效果，然后返回true；</li><li>紧接着ACTION_MOVE的必然是ACTION_UP，流程同4；</li><li>当ViewGroup的onTouchEvent方法可以处理ACTION_DOWN事件时，即onTouchEvent方法返回true，则此ViewGroup的onInterceptTouchEvent方法不再执行（对的，就算不执行也可以拦截事件），同时后续事件被拦截，经由此ViewGroup的onTouchEvent处理。</li></ol><p>综上所述，如果ViewPager的子view无法处理ACTION_DOWN事件，那么ViewPager自己就会处理ACTION_DOWN事件，并在后续事件传递过程中拦截（不是通过onInterceptTouchEvent方法），后续的ACTION_MOVE或ACTION_UP由ViewPager进行处理，在ViewPager的onTouchEvent中实现了滑动的效果。</p><p>如果我们在ViewPager中加上HorizontalScrollView，并加上几个CustomTextView，会产生怎样的效果呢</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;LinearLayout</span> <span style=color:#a6e22e>xmlns:android=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:orientation=</span><span style=color:#e6db74>&#34;vertical&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;us.zoom.videomeetings.viewpagerdemo.custom.CustomHorizontalScrollView</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;us.zoom.videomeetings.viewpagerdemo.custom.CustomLinearLayout</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:orientation=</span><span style=color:#e6db74>&#34;horizontal&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;us.zoom.videomeetings.viewpagerdemo.custom.CustomTextView</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/custom_tv&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_gravity=</span><span style=color:#e6db74>&#34;center&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_margin=</span><span style=color:#e6db74>&#34;40dp&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:background=</span><span style=color:#e6db74>&#34;@color/colorPrimary&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:padding=</span><span style=color:#e6db74>&#34;40dp&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:text=</span><span style=color:#e6db74>&#34;Fragment&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:textSize=</span><span style=color:#e6db74>&#34;30sp&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;us.zoom.videomeetings.viewpagerdemo.custom.CustomTextView</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/custom_tv2&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_gravity=</span><span style=color:#e6db74>&#34;center&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:layout_margin=</span><span style=color:#e6db74>&#34;40dp&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:background=</span><span style=color:#e6db74>&#34;@color/colorPrimary&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:padding=</span><span style=color:#e6db74>&#34;40dp&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:text=</span><span style=color:#e6db74>&#34;Fragment&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>android:textSize=</span><span style=color:#e6db74>&#34;30sp&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/us.zoom.videomeetings.viewpagerdemo.custom.CustomLinearLayout&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/us.zoom.videomeetings.viewpagerdemo.custom.CustomHorizontalScrollView&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/LinearLayout&gt;</span>
</span></span></code></pre></div><p>CustomHorizontalScrollView和CustomLinearLayout都是直接继承，仅重写dispatchTouchEvent、onTouchEvent、onInterceptTouchEvent方法，加上log，这里就不加代码了，基本同上。</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Zhoutao822/hugo-pic/pictures/viewpager.gif alt=viewpager></p><p>在上述的演示效果中可以发现，如果滑动的位置是TextView，则ViewPager的左右滑动似乎被卡住了，但是偶尔可以切换，而且就算滑动到第二个TextView的边缘也不能切换fragment；如果滑动的位置是下方空白区域则ViewPager可以正常滑动。</p><p>根据log以及上文的分析可知，ViewPager左右滑动被卡住的原因是：</p><ol><li>ACTION_DOWN事件向下层层传递到CustomTextView，结果发现CustomTextView的onTouchEvent无法处理返回了false，然后向上层层传递直到CustomHorizontalScrollView发现自己可以处理ACTION_DOWN事件，于是其onTouchEvent返回了true，则CustomHorizontalScrollView的dispatchTouchEvent方法返回true，从而CustomViewPager的onTouchEvent无法执行；</li><li>紧接着ACTION_MOVE事件向下层层传递到CustomHorizontalScrollView，发现CustomHorizontalScrollView之前处理了ACTION_DOWN，那么后续所有事件都被CustomHorizontalScrollView拦截，通过其onTouchEvent处理，并返回true，则CustomHorizontalScrollView的dispatchTouchEvent方法返回true，从而CustomViewPager的onTouchEvent无法执行；</li><li>ACTION_UP事件同2。</li></ol><p>经过上面的分析知道了其实是CustomHorizontalScrollView能够处理所有事件，从而导致CustomViewPager无法执行onTouchEvent，因此ViewPager无法左右滑动。</p><p>因此我们可以简单完成几个对滑动控制的需求</p><h3 id=41-禁用viewpager的滑动子view可以滑动>4.1 禁用ViewPager的滑动，子view可以滑动<a hidden class=anchor aria-hidden=true href=#41-禁用viewpager的滑动子view可以滑动>#</a></h3><p>这个需求是为了解决上面提到的ViewPager偶尔可以滑动的问题，很显然这里可能是事件传递过程中触发了某种条件导致事件最终由ViewPager的onTouchEvent方法处理，我们要防止这种情况发生。解决的方法是CustomViewPager的onTouchEvent返回false（确保CustomViewPager不会处理滑动事件），同时可以在CustomViewPager的onInterceptTouchEvent返回false（可选，但是可以保证CustomViewPager不对事件进行拦截）。</p><h3 id=42-viewpager仅在子view滑动到左右边界时可以滑动>4.2 ViewPager仅在子view滑动到左右边界时可以滑动<a hidden class=anchor aria-hidden=true href=#42-viewpager仅在子view滑动到左右边界时可以滑动>#</a></h3><p>直接看代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomHorizontalScrollView</span> <span style=color:#66d9ef>extends</span> HorizontalScrollView <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TAG <span style=color:#f92672>=</span> CustomHorizontalScrollView<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomHorizontalScrollView</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomHorizontalScrollView</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> AttributeSet attrs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomHorizontalScrollView</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> AttributeSet attrs<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> defStyleAttr<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>,</span> defStyleAttr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomHorizontalScrollView</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> AttributeSet attrs<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> defStyleAttr<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> defStyleRes<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> attrs<span style=color:#f92672>,</span> defStyleAttr<span style=color:#f92672>,</span> defStyleRes<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 可以在此处理冲突
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param ev
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 还没滑到右边，请求父控件不要拦截我的事件，事件自己处理 true ；已经滑到右边，则事件交由父控件处理 false。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// getParent().requestDisallowInterceptTouchEvent(!isScrollToRight());
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 也可以在此处理冲突
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param ev
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getAction</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理的逻辑是在ACTION_MOVE事件上，如果滑动到最左或最右边则调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// getParent().requestDisallowInterceptTouchEvent(false)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 那么HorizontalScrollView的父view会拦截掉ACTION_MOVE事件，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 即ViewPager拦截ACTION_MOVE事件，由他的onTouchEvent处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_MOVE</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isScrollToLeft<span style=color:#f92672>()</span> <span style=color:#f92672>||</span> isScrollToRight<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;滑到&#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>isScrollToLeft<span style=color:#f92672>()</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;左边&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;右边&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 把事件交给父控件处理，例如：viewpager滑动
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    getParent<span style=color:#f92672>().</span><span style=color:#a6e22e>requestDisallowInterceptTouchEvent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_UP</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_CANCEL</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 请求父控件可以拦截事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                getParent<span style=color:#f92672>().</span><span style=color:#a6e22e>requestDisallowInterceptTouchEvent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            default:
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onTouchEvent</span><span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onInterceptTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onInterceptTouchEvent</span><span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 是否已经滑到了最右边
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isScrollToRight</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// getScrollX得到View的最左边的位置，若HorizontalScrollView滑到最右边，则为负值；
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// getScrollX() + getWidth()为最右边的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// getChildAt(getChildCount() - 1).getRight()恰好得到子view的最右边的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> getChildAt<span style=color:#f92672>(</span>getChildCount<span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>).</span><span style=color:#a6e22e>getRight</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> getScrollX<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> getWidth<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 是否已经滑到了最左边
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isScrollToLeft</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getScrollX<span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>滑动冲突的解决方式有两种</strong>：</p><blockquote><p>1.外部拦截法：触摸事件都先经过父容器的拦截处理，如果父容器需要此事件就拦截，不需要就不拦截（此方法符合view事件分发机制），这样就可以解决滑动冲突问题。需要重写onInterceptTouchEvent方法，伪代码如下：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onInterceptTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> intercept <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getAction</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e>// 不能拦截，否则无法传递事件给子元素
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                intercept <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_MOVE</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>// 针对不同的滑动冲突，只需要修改这个条件即可，其它均不需做修改并且也不能修改
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>滑动事件交由父容器处理<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 拦截事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    intercept <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 不拦截事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    intercept <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_UP</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_CANCEL</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 不拦截，否则子元素可能无法接收到这两个事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                intercept <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            default:
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> intercept<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>2.内部拦截法：父容器不拦截任何事件，所有的事件都传递给子元素，如果子元素需要此事件就直接消耗掉，否则就交由父容器进行处理，这种方法和android中的事件分发机制不一致，需要配合<code>requestDisallowInterceptTouchEvent</code>方法才能正常工作，使用越来较外部拦截法稍显复杂。我们可以修改<code>dispatchTouchEvent</code>方法或者onTouchEvent方法来达到目的。伪代码如下：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>MotionEvent ev<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>ev<span style=color:#f92672>.</span><span style=color:#a6e22e>getAction</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_DOWN</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                getParent<span style=color:#f92672>().</span><span style=color:#a6e22e>requestDisallowInterceptTouchEvent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_MOVE</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 针对不同的滑动冲突，只需要修改这个条件即可，其它均不需做修改并且也不能修改
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>父容器需要此类触摸事件<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    getParent<span style=color:#f92672>().</span><span style=color:#a6e22e>requestDisallowInterceptTouchEvent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_UP</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MotionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTION_CANCEL</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            default:
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchTouchEvent</span><span style=color:#f92672>(</span>ev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=参考>参考：<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ol><li><a href=https://developer.android.com/guide/topics/ui/menus>菜单</a></li><li><a href=https://developer.android.com/reference/android/view/Menu>Menu api</a></li><li><a href=https://www.jianshu.com/p/e99b5e8bd67b>图解 Android 事件分发机制</a></li><li><a href=https://blog.csdn.net/carson_ho/article/details/54136311>Android事件分发机制 详解攻略</a></li><li><a href=https://juejin.im/entry/596329686fb9a06bc903b6fd>Activity、View、Window的理解一篇文章就够了</a></li><li><a href=https://www.jianshu.com/p/2aeb2d10a831>ViewPager 与 HorizontalScrollView 滑动冲突问题</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://zhoutao822.github.io/tags/toolbar/>ToolBar</a></li><li><a href=https://zhoutao822.github.io/tags/contextmenu/>ContextMenu</a></li><li><a href=https://zhoutao822.github.io/tags/popupmenu/>PopupMenu</a></li></ul><nav class=paginav><a class=prev href=https://zhoutao822.github.io/posts/dagger2/><span class=title>« Prev Page</span><br><span>Android框架-Dagger2</span></a>
<a class=next href=https://zhoutao822.github.io/posts/python_style_rules/><span class=title>Next Page »</span><br><span>Python风格规范</span></a></nav></footer><script src=https://utteranc.es/client.js repo=zhoutao822/zhoutao822.github.io issue-term=title theme=github-dark crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://zhoutao822.github.io/>Tao's Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>