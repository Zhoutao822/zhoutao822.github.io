<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android框架-Gson | Tao's Notes</title><meta name=keywords content="Gson"><meta name=description content="json是一种数据格式，类似与键值对的形式，常用于服务器与客户端之间数据传输，以键值对形式传输的数据在客户端进行解析时必然需要对不同的key寻找其对应的value，通常来说这种解析数据的过程非常繁琐，但是没有难度，所以Google推出了Gson这个工具，用于解析json数据并直接将其实例化。"><meta name=author content="Me"><link rel=canonical href=https://zhoutao822.github.io/posts/gson/><meta name=google-site-verification content="Tao"><meta name=yandex-verification content="Tao"><meta name=msvalidate.01 content="Tao"><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://zhoutao822.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zhoutao822.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zhoutao822.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zhoutao822.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zhoutao822.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.103.1"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Android框架-Gson"><meta property="og:description" content="json是一种数据格式，类似与键值对的形式，常用于服务器与客户端之间数据传输，以键值对形式传输的数据在客户端进行解析时必然需要对不同的key寻找其对应的value，通常来说这种解析数据的过程非常繁琐，但是没有难度，所以Google推出了Gson这个工具，用于解析json数据并直接将其实例化。"><meta property="og:type" content="article"><meta property="og:url" content="https://zhoutao822.github.io/posts/gson/"><meta property="og:image" content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-20T23:09:12+08:00"><meta property="article:modified_time" content="2019-07-20T23:09:12+08:00"><meta property="og:site_name" content="Tao's Notes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Android框架-Gson"><meta name=twitter:description content="json是一种数据格式，类似与键值对的形式，常用于服务器与客户端之间数据传输，以键值对形式传输的数据在客户端进行解析时必然需要对不同的key寻找其对应的value，通常来说这种解析数据的过程非常繁琐，但是没有难度，所以Google推出了Gson这个工具，用于解析json数据并直接将其实例化。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zhoutao822.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Android框架-Gson","item":"https://zhoutao822.github.io/posts/gson/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android框架-Gson","name":"Android框架-Gson","description":"json是一种数据格式，类似与键值对的形式，常用于服务器与客户端之间数据传输，以键值对形式传输的数据在客户端进行解析时必然需要对不同的key寻找其对应的value，通常来说这种解析数据的过程非常繁琐，但是没有难度，所以Google推出了Gson这个工具，用于解析json数据并直接将其实例化。","keywords":["Gson"],"articleBody":"json是一种数据格式，类似与键值对的形式，常用于服务器与客户端之间数据传输，以键值对形式传输的数据在客户端进行解析时必然需要对不同的key寻找其对应的value，通常来说这种解析数据的过程非常繁琐，但是没有难度，所以Google推出了Gson这个工具，用于解析json数据并直接将其实例化。\n1. Gson使用 以解析和风天气的数据为例，请求返回的json数据如下\n{ \"HeWeather6\": [ { \"basic\": { \"cid\": \"CN101010100\", \"location\": \"北京\", \"parent_city\": \"北京\", \"admin_area\": \"北京\", \"cnty\": \"中国\", \"lat\": \"39.90498734\", \"lon\": \"116.4052887\", \"tz\": \"+8.00\" }, \"update\": { \"loc\": \"2019-07-18 16:45\", \"utc\": \"2019-07-18 08:45\" }, \"status\": \"ok\", \"now\": { \"cloud\": \"10\", \"cond_code\": \"101\", \"cond_txt\": \"多云\", \"fl\": \"35\", \"hum\": \"54\", \"pcpn\": \"0.0\", \"pres\": \"1000\", \"tmp\": \"32\", \"vis\": \"6\", \"wind_deg\": \"279\", \"wind_dir\": \"西风\", \"wind_sc\": \"1\", \"wind_spd\": \"3\" } } ] } 1.构造对应json数据的实体类，这里使用的Android Studio的插件GsonFormat，可以直接根据json数据生成代码\npublic class WeatherEntity { private List\u003cHeWeather6Bean\u003e HeWeather6; public List\u003cHeWeather6Bean\u003e getHeWeather6() { return HeWeather6; } public void setHeWeather6(List\u003cHeWeather6Bean\u003e HeWeather6) { this.HeWeather6 = HeWeather6; } // 重写以下toString方法，便于后续观察数据传输是否正确 @NonNull @Override public String toString() { return HeWeather6.get(0).toString(); } public static class HeWeather6Bean { /** * basic : {\"cid\":\"CN101010100\",\"location\":\"北京\",\"parent_city\":\"北京\",\"admin_area\":\"北京\",\"cnty\":\"中国\",\"lat\":\"39.90498734\",\"lon\":\"116.4052887\",\"tz\":\"+8.00\"} * update : {\"loc\":\"2019-07-18 16:45\",\"utc\":\"2019-07-18 08:45\"} * status : ok * now : {\"cloud\":\"10\",\"cond_code\":\"101\",\"cond_txt\":\"多云\",\"fl\":\"35\",\"hum\":\"54\",\"pcpn\":\"0.0\",\"pres\":\"1000\",\"tmp\":\"32\",\"vis\":\"6\",\"wind_deg\":\"279\",\"wind_dir\":\"西风\",\"wind_sc\":\"1\",\"wind_spd\":\"3\"} */ private BasicBean basic; private UpdateBean update; private String status; private NowBean now; @NonNull @Override public String toString() { return status + \" \\n \" + basic.toString() + \" \\n \" + update.toString() + \" \\n \" + now.toString(); } public BasicBean getBasic() { return basic; } public void setBasic(BasicBean basic) { this.basic = basic; } public UpdateBean getUpdate() { return update; } public void setUpdate(UpdateBean update) { this.update = update; } public String getStatus() { return status; } public void setStatus(String status) { this.status = status; } public NowBean getNow() { return now; } public void setNow(NowBean now) { this.now = now; } public static class BasicBean { /** * cid : CN101010100 * location : 北京 * parent_city : 北京 * admin_area : 北京 * cnty : 中国 * lat : 39.90498734 * lon : 116.4052887 * tz : +8.00 */ private String cid; private String location; private String parent_city; private String admin_area; private String cnty; private String lat; private String lon; private String tz; @NonNull @Override public String toString() { return \"cid : \" + cid + \"\\n\" + \"location : \" + location + \"\\n\" + \"parent_city : \" + parent_city + \"\\n\" + \"admin_area : \" + admin_area + \"\\n\" + \"cnty : \" + cnty + \"\\n\" + \"lat : \" + lat + \"\\n\" + \"lon : \" + lon + \"\\n\" + \"tz : \" + tz + \"\\n\"; } public String getCid() { return cid; } public void setCid(String cid) { this.cid = cid; } public String getLocation() { return location; } public void setLocation(String location) { this.location = location; } public String getParent_city() { return parent_city; } public void setParent_city(String parent_city) { this.parent_city = parent_city; } public String getAdmin_area() { return admin_area; } public void setAdmin_area(String admin_area) { this.admin_area = admin_area; } public String getCnty() { return cnty; } public void setCnty(String cnty) { this.cnty = cnty; } public String getLat() { return lat; } public void setLat(String lat) { this.lat = lat; } public String getLon() { return lon; } public void setLon(String lon) { this.lon = lon; } public String getTz() { return tz; } public void setTz(String tz) { this.tz = tz; } } public static class UpdateBean { /** * loc : 2019-07-18 16:45 * utc : 2019-07-18 08:45 */ private String loc; private String utc; @NonNull @Override public String toString() { return \"loc : \" + loc + \"\\n\" + \"utc : \" + utc + \"\\n\"; } public String getLoc() { return loc; } public void setLoc(String loc) { this.loc = loc; } public String getUtc() { return utc; } public void setUtc(String utc) { this.utc = utc; } } public static class NowBean { /** * cloud : 10 * cond_code : 101 * cond_txt : 多云 * fl : 35 * hum : 54 * pcpn : 0.0 * pres : 1000 * tmp : 32 * vis : 6 * wind_deg : 279 * wind_dir : 西风 * wind_sc : 1 * wind_spd : 3 */ private String cloud; private String cond_code; private String cond_txt; private String fl; private String hum; private String pcpn; private String pres; private String tmp; private String vis; private String wind_deg; private String wind_dir; private String wind_sc; private String wind_spd; @NonNull @Override public String toString() { return \"cloud : \" + cloud + \"\\n\" + \"cond_code : \" + cond_code + \"\\n\" + \"cond_txt : \" + cond_txt + \"\\n\" + \"fl : \" + fl + \"\\n\" + \"hum : \" + hum + \"\\n\" + \"pcpn : \" + pcpn + \"\\n\" + \"pres : \" + pres + \"\\n\" + \"tmp : \" + tmp + \"\\n\" + \"vis : \" + vis + \"\\n\" + \"wind_deg : \" + wind_deg + \"\\n\" + \"wind_dir : \" + wind_dir + \"\\n\" + \"wind_sc : \" + wind_sc + \"\\n\" + \"wind_spd : \" + wind_spd + \"\\n\"; } public String getCloud() { return cloud; } public void setCloud(String cloud) { this.cloud = cloud; } public String getCond_code() { return cond_code; } public void setCond_code(String cond_code) { this.cond_code = cond_code; } public String getCond_txt() { return cond_txt; } public void setCond_txt(String cond_txt) { this.cond_txt = cond_txt; } public String getFl() { return fl; } public void setFl(String fl) { this.fl = fl; } public String getHum() { return hum; } public void setHum(String hum) { this.hum = hum; } public String getPcpn() { return pcpn; } public void setPcpn(String pcpn) { this.pcpn = pcpn; } public String getPres() { return pres; } public void setPres(String pres) { this.pres = pres; } public String getTmp() { return tmp; } public void setTmp(String tmp) { this.tmp = tmp; } public String getVis() { return vis; } public void setVis(String vis) { this.vis = vis; } public String getWind_deg() { return wind_deg; } public void setWind_deg(String wind_deg) { this.wind_deg = wind_deg; } public String getWind_dir() { return wind_dir; } public void setWind_dir(String wind_dir) { this.wind_dir = wind_dir; } public String getWind_sc() { return wind_sc; } public void setWind_sc(String wind_sc) { this.wind_sc = wind_sc; } public String getWind_spd() { return wind_spd; } public void setWind_spd(String wind_spd) { this.wind_spd = wind_spd; } } } } 2.使用OkHttp构造请求\nOkHttpClient client = new OkHttpClient(); Request request = new Request.Builder() .get() .url(baseUrl) .build(); Call call = client.newCall(request); call.enqueue(new Callback() { @Override public void onFailure(@NotNull Call call, @NotNull IOException e) { } @Override public void onResponse(@NotNull Call call, @NotNull Response response) throws IOException { } }); 3.在onResponse方法中处理请求，使用Gson对response的json数据进行实例化\n@Override public void onResponse(@NotNull Call call, @NotNull Response response) throws IOException { final String ret = response.body().string(); runOnUiThread(new Runnable() { @Override public void run() { Gson gson = new Gson(); WeatherEntity weatherEntity = gson.fromJson(ret, WeatherEntity.class); textView.setText(weatherEntity.toString()); } }); } 只要对比一下就知道了，从ret到weatherEntity，完成了对json数据的实例化，我们不需要new一个对象再通过set方法赋值就可以得到一个实例，最后直接使用此实例即可。\n2. Gson源码分析 首先new了一个Gson对象\npublic Gson() { this(Excluder.DEFAULT, FieldNamingPolicy.IDENTITY, Collections.\u003cType, InstanceCreator\u003c?\u003e\u003eemptyMap(), DEFAULT_SERIALIZE_NULLS, DEFAULT_COMPLEX_MAP_KEYS, DEFAULT_JSON_NON_EXECUTABLE, DEFAULT_ESCAPE_HTML, DEFAULT_PRETTY_PRINT, DEFAULT_LENIENT, DEFAULT_SPECIALIZE_FLOAT_VALUES, LongSerializationPolicy.DEFAULT, null, DateFormat.DEFAULT, DateFormat.DEFAULT, Collections.\u003cTypeAdapterFactory\u003eemptyList(), Collections.\u003cTypeAdapterFactory\u003eemptyList(), Collections.\u003cTypeAdapterFactory\u003eemptyList()); } // 这里很明显，比较重要的类是TypeAdapterFactory，作用稍后再说 Gson(final Excluder excluder, final FieldNamingStrategy fieldNamingStrategy, final Map\u003cType, InstanceCreator\u003c?\u003e\u003e instanceCreators, boolean serializeNulls, boolean complexMapKeySerialization, boolean generateNonExecutableGson, boolean htmlSafe, boolean prettyPrinting, boolean lenient, boolean serializeSpecialFloatingPointValues, LongSerializationPolicy longSerializationPolicy, String datePattern, int dateStyle, int timeStyle, List\u003cTypeAdapterFactory\u003e builderFactories, List\u003cTypeAdapterFactory\u003e builderHierarchyFactories, List\u003cTypeAdapterFactory\u003e factoriesToBeAdded) { this.excluder = excluder; this.fieldNamingStrategy = fieldNamingStrategy; this.instanceCreators = instanceCreators; this.constructorConstructor = new ConstructorConstructor(instanceCreators); this.serializeNulls = serializeNulls; this.complexMapKeySerialization = complexMapKeySerialization; this.generateNonExecutableJson = generateNonExecutableGson; this.htmlSafe = htmlSafe; this.prettyPrinting = prettyPrinting; this.lenient = lenient; this.serializeSpecialFloatingPointValues = serializeSpecialFloatingPointValues; this.longSerializationPolicy = longSerializationPolicy; this.datePattern = datePattern; this.dateStyle = dateStyle; this.timeStyle = timeStyle; this.builderFactories = builderFactories; this.builderHierarchyFactories = builderHierarchyFactories; List\u003cTypeAdapterFactory\u003e factories = new ArrayList\u003cTypeAdapterFactory\u003e(); // 内置的TypeAdapter，比如ObjectTypeAdapter用于处理Object类型数据 // built-in type adapters that cannot be overridden factories.add(TypeAdapters.JSON_ELEMENT_FACTORY); factories.add(ObjectTypeAdapter.FACTORY); // excluder用于控制属性的是否支持序列化与反序列化，比如用@Expose修饰的属性， // 优先级必须在所有TypeAdapter之前 // the excluder must precede all adapters that handle user-defined types factories.add(excluder); // 开发人员自定义的TypeAdapter，优先级相对较高 // users' type adapters factories.addAll(factoriesToBeAdded); // 基础类型数据，包括String、Integer等包装类型 // type adapters for basic platform types factories.add(TypeAdapters.STRING_FACTORY); factories.add(TypeAdapters.INTEGER_FACTORY); factories.add(TypeAdapters.BOOLEAN_FACTORY); factories.add(TypeAdapters.BYTE_FACTORY); factories.add(TypeAdapters.SHORT_FACTORY); TypeAdapter\u003cNumber\u003e longAdapter = longAdapter(longSerializationPolicy); factories.add(TypeAdapters.newFactory(long.class, Long.class, longAdapter)); factories.add(TypeAdapters.newFactory(double.class, Double.class, doubleAdapter(serializeSpecialFloatingPointValues))); factories.add(TypeAdapters.newFactory(float.class, Float.class, floatAdapter(serializeSpecialFloatingPointValues))); factories.add(TypeAdapters.NUMBER_FACTORY); factories.add(TypeAdapters.ATOMIC_INTEGER_FACTORY); factories.add(TypeAdapters.ATOMIC_BOOLEAN_FACTORY); factories.add(TypeAdapters.newFactory(AtomicLong.class, atomicLongAdapter(longAdapter))); factories.add(TypeAdapters.newFactory(AtomicLongArray.class, atomicLongArrayAdapter(longAdapter))); factories.add(TypeAdapters.ATOMIC_INTEGER_ARRAY_FACTORY); factories.add(TypeAdapters.CHARACTER_FACTORY); factories.add(TypeAdapters.STRING_BUILDER_FACTORY); factories.add(TypeAdapters.STRING_BUFFER_FACTORY); factories.add(TypeAdapters.newFactory(BigDecimal.class, TypeAdapters.BIG_DECIMAL)); factories.add(TypeAdapters.newFactory(BigInteger.class, TypeAdapters.BIG_INTEGER)); factories.add(TypeAdapters.URL_FACTORY); factories.add(TypeAdapters.URI_FACTORY); factories.add(TypeAdapters.UUID_FACTORY); factories.add(TypeAdapters.CURRENCY_FACTORY); factories.add(TypeAdapters.LOCALE_FACTORY); factories.add(TypeAdapters.INET_ADDRESS_FACTORY); factories.add(TypeAdapters.BIT_SET_FACTORY); factories.add(DateTypeAdapter.FACTORY); factories.add(TypeAdapters.CALENDAR_FACTORY); factories.add(TimeTypeAdapter.FACTORY); factories.add(SqlDateTypeAdapter.FACTORY); factories.add(TypeAdapters.TIMESTAMP_FACTORY); factories.add(ArrayTypeAdapter.FACTORY); factories.add(TypeAdapters.CLASS_FACTORY); // 集合类型优先级较低，包括Map、Collection等 // type adapters for composite and user-defined types factories.add(new CollectionTypeAdapterFactory(constructorConstructor)); factories.add(new MapTypeAdapterFactory(constructorConstructor, complexMapKeySerialization)); this.jsonAdapterFactory = new JsonAdapterAnnotationTypeAdapterFactory(constructorConstructor); factories.add(jsonAdapterFactory); factories.add(TypeAdapters.ENUM_FACTORY); // 反射类型优先级最低，而这个反射类型就是我们自定义WeatherEntity的TypeAdapter factories.add(new ReflectiveTypeAdapterFactory( constructorConstructor, fieldNamingStrategy, excluder, jsonAdapterFactory)); this.factories = Collections.unmodifiableList(factories); } 然后直接看fromJson方法，传入的参数为String和.class，返回值为.class的实例\npublic \u003cT\u003e T fromJson(String json, Class\u003cT\u003e classOfT) throws JsonSyntaxException { // 此处只要分析fromJson方法 Object object = fromJson(json, (Type) classOfT); // wrap仅仅把基础类型转为包装类型，cast用于类型转换，把Object类型转为object的实际类型 return Primitives.wrap(classOfT).cast(object); } public \u003cT\u003e T fromJson(String json, Type typeOfT) throws JsonSyntaxException { if (json == null) { return null; } // 通过StringReader将String类型的json数据转为StringReader StringReader reader = new StringReader(json); // 又调用fromJson方法 T target = (T) fromJson(reader, typeOfT); return target; } public \u003cT\u003e T fromJson(Reader json, Type typeOfT) throws JsonIOException, JsonSyntaxException { // 又将StringReader转为JsonReader JsonReader jsonReader = newJsonReader(json); // 继续调用fromJson T object = (T) fromJson(jsonReader, typeOfT); assertFullConsumption(object, jsonReader); return object; } public \u003cT\u003e T fromJson(JsonReader reader, Type typeOfT) throws JsonIOException, JsonSyntaxException { boolean isEmpty = true; boolean oldLenient = reader.isLenient(); reader.setLenient(true); try { // 核心代码在try catch内，我们得到的JsonReader需要通过TypeAdapter的read方法转为Java对象 // 所以接下来需要分析JsonReader的功能，以及这里默认使用的TypeAdapter的功能 reader.peek(); isEmpty = false; TypeToken\u003cT\u003e typeToken = (TypeToken\u003cT\u003e) TypeToken.get(typeOfT); TypeAdapter\u003cT\u003e typeAdapter = getAdapter(typeToken); T object = typeAdapter.read(reader); return object; } catch (EOFException e) { /* * For compatibility with JSON 1.5 and earlier, we return null for empty * documents instead of throwing. */ if (isEmpty) { return null; } throw new JsonSyntaxException(e); } catch (IllegalStateException e) { throw new JsonSyntaxException(e); } catch (IOException e) { // TODO(inder): Figure out whether it is indeed right to rethrow this as JsonSyntaxException throw new JsonSyntaxException(e); } catch (AssertionError e) { throw new AssertionError(\"AssertionError (GSON \" + GsonBuildConfig.VERSION + \"): \" + e.getMessage(), e); } finally { reader.setLenient(oldLenient); } } JsonReader并不是直接通过String解析出来的，首先经过了StringReader，那么先看看StringReader的构造，StringReader继承自Reader，需要实现read方法，read方法一般是用于读取字符到buffer中\n// StringReader.java 这里只保存了String的值和长度 /** * Creates a new string reader. * * @param s String providing the character stream. */ public StringReader(String s) { this.str = s; this.length = s.length(); } JsonReader并不是继承自Reader，JsonReader需要配合TypeAdapter使用\n// Gson.java newJsonReader将StringReader转为JsonReader对象，DEFAULT_LENIENT为false，暂时不明白 /** * Returns a new JSON reader configured for the settings on this Gson instance. */ public JsonReader newJsonReader(Reader reader) { JsonReader jsonReader = new JsonReader(reader); jsonReader.setLenient(lenient); return jsonReader; } getAdapter方法如何获取到TypeAdapter\n/** * Returns the type adapter for {@code} type. * * @throws IllegalArgumentException if this GSON cannot serialize and * deserialize {@code type}. */ @SuppressWarnings(\"unchecked\") public \u003cT\u003e TypeAdapter\u003cT\u003e getAdapter(TypeToken\u003cT\u003e type) { // 初始情况下typeTokenCache为空 TypeAdapter\u003c?\u003e cached = typeTokenCache.get(type == null ? NULL_KEY_SURROGATE : type); if (cached != null) { return (TypeAdapter\u003cT\u003e) cached; } // calls初始也为空 Map\u003cTypeToken\u003c?\u003e, FutureTypeAdapter\u003c?\u003e\u003e threadCalls = calls.get(); boolean requiresThreadLocalCleanup = false; if (threadCalls == null) { threadCalls = new HashMap\u003cTypeToken\u003c?\u003e, FutureTypeAdapter\u003c?\u003e\u003e(); calls.set(threadCalls); requiresThreadLocalCleanup = true; } // ThreadLocal在这里是防止老是执行for (TypeAdapterFactory factory : factories) 递归查找， // 如果不用ThreadLocal干预的话，就会导致堆栈溢出 // the key and value type parameters always agree FutureTypeAdapter\u003cT\u003e ongoingCall = (FutureTypeAdapter\u003cT\u003e) threadCalls.get(type); if (ongoingCall != null) { return ongoingCall; } try { FutureTypeAdapter\u003cT\u003e call = new FutureTypeAdapter\u003cT\u003e(); threadCalls.put(type, call); // TypeAdapter是从Gson初始化的factories中按照顺序遍历得到的， // 所以接下来需要看这里使用的是哪个TypeAdapterFactory for (TypeAdapterFactory factory : factories) { TypeAdapter\u003cT\u003e candidate = factory.create(this, type); if (candidate != null) { call.setDelegate(candidate); typeTokenCache.put(type, candidate); return candidate; } } throw new IllegalArgumentException(\"GSON (\" + GsonBuildConfig.VERSION + \") cannot handle \" + type); } finally { threadCalls.remove(type); if (requiresThreadLocalCleanup) { calls.remove(); } } } ReflectiveTypeAdapterFactory的create方法得到我们处理WeatherEntity的TypeAdapter\n// ReflectiveTypeAdapterFactory.java create方法返回的是Adapter @Override public \u003cT\u003e TypeAdapter\u003cT\u003e create(Gson gson, final TypeToken\u003cT\u003e type) { Class\u003c? super T\u003e raw = type.getRawType(); if (!Object.class.isAssignableFrom(raw)) { return null; // it's a primitive! } ObjectConstructor\u003cT\u003e constructor = constructorConstructor.get(type); return new Adapter\u003cT\u003e(constructor, getBoundFields(gson, type, raw)); } // Adapter的read方法就是返回WeatherEntity的位置 Adapter(ObjectConstructor\u003cT\u003e constructor, Map\u003cString, BoundField\u003e boundFields) { this.constructor = constructor; this.boundFields = boundFields; } // read实际上是被递归调用的 @Override public T read(JsonReader in) throws IOException { // JsonReader中保存了我们需要解析的字符串数据，所以也封装了一些读取的函数， // 通过peek判断JsonReader是否已经读到结尾了来结束解析的过程 if (in.peek() == JsonToken.NULL) { in.nextNull(); return null; } // 两个类ObjectConstructor和BoundField，看名字就知道了ObjectConstructor // 用于构造实例，BoundField用于指定属性 T instance = constructor.construct(); try { // JsonReader有几个方法，比如beginObject和beginArray，表明要开始解析 // JsonReader的数据了，beginObject表明需要解析为对象，beginArray表明需要解析为 // 数组 in.beginObject(); // hasNext表明数据是否到达结尾 while (in.hasNext()) { // nextName可以获取json数据中的key String name = in.nextName(); // 通过将name转为BoundField，为后续生成属性做铺垫 BoundField field = boundFields.get(name); // 如果不能生成此属性或者不允许反序列化，则跳过此key对应的value数据 if (field == null || !field.deserialized) { in.skipValue(); } else { // 然后需要对属性进行赋值，因此需要看BoundField的read方法做了些什么 field.read(in, instance); } } } catch (IllegalStateException e) { throw new JsonSyntaxException(e); } catch (IllegalAccessException e) { throw new AssertionError(e); } in.endObject(); // 最后返回我们的实例 return instance; } // BoundField来源于getBoundFields方法 private Map\u003cString, BoundField\u003e getBoundFields(Gson context, TypeToken\u003c?\u003e type, Class\u003c?\u003e raw) { Map\u003cString, BoundField\u003e result = new LinkedHashMap\u003cString, BoundField\u003e(); if (raw.isInterface()) { return result; } Type declaredType = type.getType(); while (raw != Object.class) { // 首先获得我们自定义WeatherEntity的属性 Field[] fields = raw.getDeclaredFields(); for (Field field : fields) { // 对于每一个属性我们通过Excluder判断是否有@Expose或者其他注解修饰 // 根据注解的要求保存这个属性是否支持序列化serialize和反序列化deserialize boolean serialize = excludeField(field, true); boolean deserialize = excludeField(field, false); if (!serialize \u0026\u0026 !deserialize) { continue; } accessor.makeAccessible(field); Type fieldType = $Gson$Types.resolve(type.getType(), raw, field.getGenericType()); // 因为Gson支持序列化时指定key的名称，所以会有一些替代名称，替代名称可以有多个，因此需要 // 通过getFieldNames获取属性的所有序列化时的名称列表（第一个为属性名，其他可以是设置的替代名称） List\u003cString\u003e fieldNames = getFieldNames(field); BoundField previous = null; for (int i = 0, size = fieldNames.size(); i \u003c size; ++i) { String name = fieldNames.get(i); if (i != 0) serialize = false; // only serialize the default name // result的value boundField是通过createBoundField得到的，且只有第一个名称允许序列化 BoundField boundField = createBoundField(context, field, name, TypeToken.get(fieldType), serialize, deserialize); BoundField replaced = result.put(name, boundField); if (previous == null) previous = replaced; } if (previous != null) { throw new IllegalArgumentException(declaredType + \" declares multiple JSON fields named \" + previous.name); } } type = TypeToken.get($Gson$Types.resolve(type.getType(), raw, raw.getGenericSuperclass())); raw = type.getRawType(); } return result; } // createBoundField返回我们需要的BoundField private ReflectiveTypeAdapterFactory.BoundField createBoundField( final Gson context, final Field field, final String name, final TypeToken\u003c?\u003e fieldType, boolean serialize, boolean deserialize) { final boolean isPrimitive = Primitives.isPrimitive(fieldType.getRawType()); // special casing primitives here saves ~5% on Android... JsonAdapter annotation = field.getAnnotation(JsonAdapter.class); TypeAdapter\u003c?\u003e mapped = null; if (annotation != null) { mapped = jsonAdapterFactory.getTypeAdapter( constructorConstructor, context, fieldType, annotation); } // mapped也是通过getAdapter获取的，但是fieldType已经改变了，变成了我们定义的实体类的下一级 final boolean jsonAdapterPresent = mapped != null; if (mapped == null) mapped = context.getAdapter(fieldType); final TypeAdapter\u003c?\u003e typeAdapter = mapped; return new ReflectiveTypeAdapterFactory.BoundField(name, serialize, deserialize) { @SuppressWarnings({\"unchecked\", \"rawtypes\"}) // the type adapter and field type always agree @Override void write(JsonWriter writer, Object value) throws IOException, IllegalAccessException { Object fieldValue = field.get(value); TypeAdapter t = jsonAdapterPresent ? typeAdapter : new TypeAdapterRuntimeTypeWrapper(context, typeAdapter, fieldType.getType()); t.write(writer, fieldValue); } // 在调用read方法时就产生了递归 @Override void read(JsonReader reader, Object value) throws IOException, IllegalAccessException { // 由于属性的类型不同，此处的typeAdapter变为从factories遍历获取， // 如果我们这里的reader是String，那么typeAdapter为TypeAdapters.STRING_FACTORY // 然后按照TypeAdapters.STRING_FACTORY的逻辑读取数据 Object fieldValue = typeAdapter.read(reader); if (fieldValue != null || !isPrimitive) { // set方法把值fieldValue赋给对象value field.set(value, fieldValue); } } @Override public boolean writeField(Object value) throws IOException, IllegalAccessException { if (!serialized) return false; Object fieldValue = field.get(value); return fieldValue != value; // avoid recursion for example for Throwable.cause } }; } 我们目前知道了属性是通过getDeclaredFields拿到的，然后通过递归的方式调用typeAdapter的read方法，然后将从JsonReader中获取到的值赋给属性，关键是属性实例是如何得到的T instance = constructor.construct();，默认情况下是ConstructorConstructor，通过ConstructorConstructor构造某个属性的实例\n// ConstructorConstructor.java 默认instanceCreators为空 public \u003cT\u003e ObjectConstructor\u003cT\u003e get(TypeToken\u003cT\u003e typeToken) { final Type type = typeToken.getType(); final Class\u003c? super T\u003e rawType = typeToken.getRawType(); // first try an instance creator @SuppressWarnings(\"unchecked\") // types must agree final InstanceCreator\u003cT\u003e typeCreator = (InstanceCreator\u003cT\u003e) instanceCreators.get(type); if (typeCreator != null) { return new ObjectConstructor\u003cT\u003e() { @Override public T construct() { return typeCreator.createInstance(type); } }; } // Next try raw type match for instance creators @SuppressWarnings(\"unchecked\") // types must agree final InstanceCreator\u003cT\u003e rawTypeCreator = (InstanceCreator\u003cT\u003e) instanceCreators.get(rawType); if (rawTypeCreator != null) { return new ObjectConstructor\u003cT\u003e() { @Override public T construct() { return rawTypeCreator.createInstance(type); } }; } // 我们构造的实例一般是通过newDefaultConstructor得到的 ObjectConstructor\u003cT\u003e defaultConstructor = newDefaultConstructor(rawType); if (defaultConstructor != null) { return defaultConstructor; } // newDefaultImplementationConstructor用于构造Map和List以及它们的父类接口的实例 ObjectConstructor\u003cT\u003e defaultImplementation = newDefaultImplementationConstructor(type, rawType); if (defaultImplementation != null) { return defaultImplementation; } // finally try unsafe return newUnsafeAllocator(type, rawType); } private \u003cT\u003e ObjectConstructor\u003cT\u003e newDefaultConstructor(Class\u003c? super T\u003e rawType) { try { // getDeclaredConstructor通过反射得到目标类的构造函数 final Constructor\u003c? super T\u003e constructor = rawType.getDeclaredConstructor(); if (!constructor.isAccessible()) { accessor.makeAccessible(constructor); } return new ObjectConstructor\u003cT\u003e() { @SuppressWarnings(\"unchecked\") // T is the same raw type as is requested @Override public T construct() { try { Object[] args = null; // 返回初始参数都为null的实例 return (T) constructor.newInstance(args); } catch (InstantiationException e) { // TODO: JsonParseException ? throw new RuntimeException(\"Failed to invoke \" + constructor + \" with no args\", e); } catch (InvocationTargetException e) { // TODO: don't wrap if cause is unchecked! // TODO: JsonParseException ? throw new RuntimeException(\"Failed to invoke \" + constructor + \" with no args\", e.getTargetException()); } catch (IllegalAccessException e) { throw new AssertionError(e); } } }; } catch (NoSuchMethodException e) { return null; } } 读取json字符串的工作是由JsonReader完成的，以解析下面此json字符串为例（删减版），服务器传过来的数据可能没有换行\n{ \"HeWeather6\": [ { \"basic\": { \"cid\": \"CN101010100\", \"location\": \"北京\" }, \"update\": { \"loc\": \"2019-07-18 16:45\" }, \"status\": \"ok\" }] } 根据上文代码分析我们知道解析数据的起点是ReflectiveTypeAdapterFactory中Adapter的read方法\n@Override public T read(JsonReader in) throws IOException { if (in.peek() == JsonToken.NULL) { in.nextNull(); return null; } T instance = constructor.construct(); try { // 从in.beginObject开始对json数据进行解析 in.beginObject(); while (in.hasNext()) { String name = in.nextName(); // 14. 得到解析的key后构造属性 BoundField field = boundFields.get(name); if (field == null || !field.deserialized) { in.skipValue(); } else { // 15. 并且递归解析后面的数据，深度优先，这里会调用CollectionTypeAdapterFactory的Adapter的read方法 // CollectionTypeAdapterFactory用于处理集合类数据，这里会调用peek方法 field.read(in, instance); } } } catch (IllegalStateException e) { throw new JsonSyntaxException(e); } catch (IllegalAccessException e) { throw new AssertionError(e); } in.endObject(); return instance; } // JsonReader.java peeked是标志位，初始为PEEKED_NONE，表明还没有开始任何解析过程 // JsonReader解析数据的过程很有意思，它是依靠peeked标志位来决定如何处理下一个字符， // peeked初始值为PEEKED_NONE，表明标志位为空所以需要读取json数据，根据读取的字符设置peeked // 的值，然后再根据peeked的值决定下一个字符如何处理 /** * Consumes the next token from the JSON stream and asserts that it is the * beginning of a new object. */ public void beginObject() throws IOException { int p = peeked; if (p == PEEKED_NONE) { // 初始值peeked为PEEKED_NONE，调用doPeek方法设置peeked的标志 p = doPeek(); } if (p == PEEKED_BEGIN_OBJECT) { // 4. 由于doPeek将p置为PEEKED_BEGIN_OBJECT，所以需要将JsonScope.EMPTY_OBJECT // 加入stack中，并peeked重置为PEEKED_NONE push(JsonScope.EMPTY_OBJECT); peeked = PEEKED_NONE; } else { throw new IllegalStateException(\"Expected BEGIN_OBJECT but was \" + peek() + locationString()); } } // doPeek是整个解析过程中的核心代码，其他的函数都会调用到doPeek int doPeek() throws IOException { // 除了有peeked标志还有stack数组，stack数组保存解析json数据的进度，stack初始值全为0， // 初始化后将stack[0]置为JsonScope.EMPTY_DOCUMENT，表明还未开始解析 // 6. 在hasNext方法中再次执行doPeek，此时peekStack为JsonScope.NONEMPTY_OBJECT int peekStack = stack[stackSize - 1]; // 25. stack的top被置为JsonScope.EMPTY_ARRAY，表明期望的数据是Array if (peekStack == JsonScope.EMPTY_ARRAY) { // 继续重置stack top为JsonScope.NONEMPTY_ARRAY stack[stackSize - 1] = JsonScope.NONEMPTY_ARRAY; } else if (peekStack == JsonScope.NONEMPTY_ARRAY) { // Look for a comma before the next element. int c = nextNonWhitespace(true); switch (c) { case ']': return peeked = PEEKED_END_ARRAY; case ';': checkLenient(); // fall-through case ',': break; default: throw syntaxError(\"Unterminated array\"); } } else if (peekStack == JsonScope.EMPTY_OBJECT || peekStack == JsonScope.NONEMPTY_OBJECT) { // 7. 又将stack的top置为JsonScope.DANGLING_NAME stack[stackSize - 1] = JsonScope.DANGLING_NAME; // Look for a comma before the next element. if (peekStack == JsonScope.NONEMPTY_OBJECT) { int c = nextNonWhitespace(true); switch (c) { case '}': return peeked = PEEKED_END_OBJECT; case ';': checkLenient(); // fall-through case ',': break; default: throw syntaxError(\"Unterminated object\"); } } // 8. 读取下一个字符 \" int c = nextNonWhitespace(true); switch (c) { case '\"': // 9. 显然将peeked置为PEEKED_DOUBLE_QUOTED_NAME return peeked = PEEKED_DOUBLE_QUOTED_NAME; case '\\'': checkLenient(); return peeked = PEEKED_SINGLE_QUOTED_NAME; case '}': if (peekStack != JsonScope.NONEMPTY_OBJECT) { return peeked = PEEKED_END_OBJECT; } else { throw syntaxError(\"Expected name\"); } default: checkLenient(); pos--; // Don't consume the first character in an unquoted string. if (isLiteral((char) c)) { return peeked = PEEKED_UNQUOTED_NAME; } else { throw syntaxError(\"Expected name\"); } } } else if (peekStack == JsonScope.DANGLING_NAME) { // 17. 之前stack的top被置为JsonScope.DANGLING_NAME // 然后stack的top置为JsonScope.NONEMPTY_OBJECT，表明object对象还没有读取完成 stack[stackSize - 1] = JsonScope.NONEMPTY_OBJECT; // Look for a colon before the value. // 下一个字符是 : int c = nextNonWhitespace(true); switch (c) { case ':': break; case '=': checkLenient(); if ((pos \u003c limit || fillBuffer(1)) \u0026\u0026 buffer[pos] == '\u003e') { pos++; } break; default: throw syntaxError(\"Expected ':'\"); } } else if (peekStack == JsonScope.EMPTY_DOCUMENT) { // 1. peekStack初始为JsonScope.EMPTY_DOCUMENT if (lenient) { // lenient在调用read方法之前被置为true，结束后被置为false consumeNonExecutePrefix(); } // stack[0]被置为JsonScope.NONEMPTY_DOCUMENT stack[stackSize - 1] = JsonScope.NONEMPTY_DOCUMENT; } else if (peekStack == JsonScope.NONEMPTY_DOCUMENT) { int c = nextNonWhitespace(false); if (c == -1) { return peeked = PEEKED_EOF; } else { checkLenient(); pos--; } } else if (peekStack == JsonScope.CLOSED) { throw new IllegalStateException(\"JsonReader is closed\"); } // 2. c是第一个字符 { // 18. c是 [ // 26. c是 { int c = nextNonWhitespace(true); switch (c) { case ']': if (peekStack == JsonScope.EMPTY_ARRAY) { return peeked = PEEKED_END_ARRAY; } // fall-through to handle \",]\" case ';': case ',': // In lenient mode, a 0-length literal in an array means 'null'. if (peekStack == JsonScope.EMPTY_ARRAY || peekStack == JsonScope.NONEMPTY_ARRAY) { checkLenient(); pos--; return peeked = PEEKED_NULL; } else { throw syntaxError(\"Unexpected value\"); } case '\\'': checkLenient(); return peeked = PEEKED_SINGLE_QUOTED; case '\"': return peeked = PEEKED_DOUBLE_QUOTED; case '[': // 19. 将peeked置为PEEKED_BEGIN_ARRAY // 表明开始解析Array类型数据 return peeked = PEEKED_BEGIN_ARRAY; case '{': // 3. peeked被置为PEEKED_BEGIN_OBJECT // 27. peeked被置为PEEKED_BEGIN_OBJECT return peeked = PEEKED_BEGIN_OBJECT; default: pos--; // Don't consume the first character in a literal value. } int result = peekKeyword(); if (result != PEEKED_NONE) { return result; } result = peekNumber(); if (result != PEEKED_NONE) { return result; } if (!isLiteral(buffer[pos])) { throw syntaxError(\"Expected value\"); } checkLenient(); return peeked = PEEKED_UNQUOTED; } // NON_EXECUTE_PREFIX包括\")]}'\\n\"，即如果json字符串第一个字符在NON_EXECUTE_PREFIX中 // 说明这个字符出了错误，buffer是1024长度的数组用于缓存json数据，pos表示我们读取数据的位置， // consumeNonExecutePrefix用于 /** * Consumes the non-execute prefix if it exists. */ private void consumeNonExecutePrefix() throws IOException { // fast forward through the leading whitespace nextNonWhitespace(true); pos--; if (pos + NON_EXECUTE_PREFIX.length \u003e limit \u0026\u0026 !fillBuffer(NON_EXECUTE_PREFIX.length)) { return; } for (int i = 0; i \u003c NON_EXECUTE_PREFIX.length; i++) { if (buffer[pos + i] != NON_EXECUTE_PREFIX[i]) { return; // not a security token! } } // we consumed a security token! pos += NON_EXECUTE_PREFIX.length; } // 5. 在while循环里判断hasNext，显然peeked此时为PEEKED_NONE，所以执行doPeek /** * Returns true if the current array or object has another element. */ public boolean hasNext() throws IOException { int p = peeked; if (p == PEEKED_NONE) { p = doPeek(); } // 10. p为PEEKED_DOUBLE_QUOTED_NAME，显然返回true return p != PEEKED_END_OBJECT \u0026\u0026 p != PEEKED_END_ARRAY; } // 11. 然后通过in.nextName()读取json数据 /** * Returns the next token, a {@link com.google.gson.stream.JsonToken#NAME property name}, and * consumes it. * * @throws java.io.IOException if the next token in the stream is not a property * name. */ public String nextName() throws IOException { // 12. 此时peeked为PEEKED_DOUBLE_QUOTED_NAME int p = peeked; if (p == PEEKED_NONE) { p = doPeek(); } String result; if (p == PEEKED_UNQUOTED_NAME) { result = nextUnquotedValue(); } else if (p == PEEKED_SINGLE_QUOTED_NAME) { result = nextQuotedValue('\\''); } else if (p == PEEKED_DOUBLE_QUOTED_NAME) { // 13. 调用nextQuotedValue，nextQuotedValue方法读取buffer中不为 \" 的字符串， // 简而言之就是在已知我们已经读取到双引号的情况下，将两个双引号之间的数据获取到， // 所以这里的result为HeWeather6 result = nextQuotedValue('\"'); } else { throw new IllegalStateException(\"Expected a name but was \" + peek() + locationString()); } // 最后还是需要重置peeked为PEEKED_NONE peeked = PEEKED_NONE; // 将result保存到pathNames中 pathNames[stackSize - 1] = result; return result; } // 16. peek继续调用doPeek /** * Returns the type of the next token without consuming it. */ public JsonToken peek() throws IOException { int p = peeked; if (p == PEEKED_NONE) { p = doPeek(); } switch (p) { case PEEKED_BEGIN_OBJECT: return JsonToken.BEGIN_OBJECT; case PEEKED_END_OBJECT: return JsonToken.END_OBJECT; case PEEKED_BEGIN_ARRAY: // 20. 返回JsonToken.BEGIN_ARRAY return JsonToken.BEGIN_ARRAY; case PEEKED_END_ARRAY: return JsonToken.END_ARRAY; case PEEKED_SINGLE_QUOTED_NAME: case PEEKED_DOUBLE_QUOTED_NAME: case PEEKED_UNQUOTED_NAME: return JsonToken.NAME; case PEEKED_TRUE: case PEEKED_FALSE: return JsonToken.BOOLEAN; case PEEKED_NULL: return JsonToken.NULL; case PEEKED_SINGLE_QUOTED: case PEEKED_DOUBLE_QUOTED: case PEEKED_UNQUOTED: case PEEKED_BUFFERED: return JsonToken.STRING; case PEEKED_LONG: case PEEKED_NUMBER: return JsonToken.NUMBER; case PEEKED_EOF: return JsonToken.END_DOCUMENT; default: throw new AssertionError(); } } // 23. beginArray用于解析Array类型数据 /** * Consumes the next token from the JSON stream and asserts that it is the * beginning of a new array. */ public void beginArray() throws IOException { int p = peeked; if (p == PEEKED_NONE) { p = doPeek(); } // 由于peeked被置为PEEKED_BEGIN_ARRAY // stack的top被置为JsonScope.EMPTY_ARRAY if (p == PEEKED_BEGIN_ARRAY) { push(JsonScope.EMPTY_ARRAY); pathIndices[stackSize - 1] = 0; peeked = PEEKED_NONE; } else { throw new IllegalStateException(\"Expected BEGIN_ARRAY but was \" + peek() + locationString()); } } @Override public Collection\u003cE\u003e read(JsonReader in) throws IOException { // 21. in.peek()返回JsonToken.BEGIN_ARRAY if (in.peek() == JsonToken.NULL) { in.nextNull(); return null; } Collection\u003cE\u003e collection = constructor.construct(); // 22.所以调用beginArray解析数据 in.beginArray(); // 24. 继续判断hasNext，但是还是通过doPeek解析 while (in.hasNext()) { // 28. hasNext返回true，elementTypeAdapter是通过gson.getAdapter获取的， // 本质上还是ReflectiveTypeAdapterFactory的Adapter的read方法，那么下一个属性的实例化 // 又进入了递归的模式，与此同时我们对于Array类型的属性是通过构造collection对象来加入下一级的 // 对象 E instance = elementTypeAdapter.read(in); collection.add(instance); } in.endArray(); return collection; } JsonReader可以完成的内容非常多，基本可以解析大多数的数据，而你只需要调用其中的beginArray、endArray、beginObject、endObject、hasNext等方法就可以得到json字符串中正确的数据部分，而且不需要考虑括号、引号、分号等等，在这些方法中就已经帮你跳过了，所以你也可以自定义json解析规则，实例代码在JsonReader的注释中给出了\n[ { \"id\": 912345678901, \"text\": \"How do I read a JSON stream in Java?\", \"geo\": null, \"user\": { \"name\": \"json_newb\", \"followers_count\": 41 } }, { \"id\": 912345678902, \"text\": \"@json_newb just use JsonReader!\", \"geo\": [50.454722, -104.606667], \"user\": { \"name\": \"jesse\", \"followers_count\": 2 } } ] public List\u003cMessage\u003e readJsonStream(InputStream in) throws IOException { JsonReader reader = new JsonReader(new InputStreamReader(in, \"UTF-8\")); try { return readMessagesArray(reader); } finally { reader.close(); } } public List\u003cMessage\u003e readMessagesArray(JsonReader reader) throws IOException { List\u003cMessage\u003e messages = new ArrayList\u003cMessage\u003e(); reader.beginArray(); while (reader.hasNext()) { messages.add(readMessage(reader)); } reader.endArray(); return messages; } public Message readMessage(JsonReader reader) throws IOException { long id = -1; String text = null; User user = null; List\u003cDouble\u003e geo = null; reader.beginObject(); while (reader.hasNext()) { String name = reader.nextName(); if (name.equals(\"id\")) { id = reader.nextLong(); } else if (name.equals(\"text\")) { text = reader.nextString(); } else if (name.equals(\"geo\") \u0026\u0026 reader.peek() != JsonToken.NULL) { geo = readDoublesArray(reader); } else if (name.equals(\"user\")) { user = readUser(reader); } else { reader.skipValue(); } } reader.endObject(); return new Message(id, text, user, geo); } public List\u003cDouble\u003e readDoublesArray(JsonReader reader) throws IOException { List\u003cDouble\u003e doubles = new ArrayList\u003cDouble\u003e(); reader.beginArray(); while (reader.hasNext()) { doubles.add(reader.nextDouble()); } reader.endArray(); return doubles; } public User readUser(JsonReader reader) throws IOException { String username = null; int followersCount = -1; reader.beginObject(); while (reader.hasNext()) { String name = reader.nextName(); if (name.equals(\"name\")) { username = reader.nextString(); } else if (name.equals(\"followers_count\")) { followersCount = reader.nextInt(); } else { reader.skipValue(); } } reader.endObject(); return new User(username, followersCount); } 以上就是Gson解析json数据并实例化的过程，反之toJson将实例转为json数据也差不多。解析json数据是一个深度优先遍历的过程，同时根据各种括号、分号、引号判断数据类型以及数据的值，Gson在解析的过程中有一些非常亮眼的设计思路：\nTypeAdapterFactory工厂类，用于提供TypeAdapter，TypeAdapter用于将json数据转为实例，由于Java中包含大量的基础类型和自定义类型，所以Gson提供了对应的基础类型的TypeAdapterFactory工厂，这些工厂提供的Adapter可以按照设计好的方式调用JsonReader的各种方法读取数据并转为实例；同时对于自定义类型，提供了ReflectiveTypeAdapterFactory，通过反射的方式构造实例，同时根据不同的属性的类型，又可以使用TypeToken来表示便于后续查找合适的TypeAdapter； JsonReader的强大功能，为了获取到json数据中的有效数据，比如属性名称、属性的值以及属性的类型，JsonReader加入了两个非常关键的参数peeked和stack，peeked用于标志当前的解析步骤是否完成，比如在调用beginObject后，peeked经历PEEKED_NONE -\u003e PEEKED_BEGIN_OBJECT -\u003e PEEKED_NONE的过程，通过doPeek完成这些步骤的转换，只要最终为PEEKED_NONE，说明前面都没有发生错误；其次是stack，stack保存了当前进行的流程，比如JsonScope.EMPTY_ARRAY、JsonScope.NONEMPTY_ARRAY、JsonScope.NONEMPTY_OBJECT等等，通过doPeek判断字符串，我们就知道了当前json数据可能是属于什么类型，从而将符号进行划分再判断，减少了需要判断的条件。 参考： Gson User Guide ","wordCount":"3991","inLanguage":"en","datePublished":"2019-07-20T23:09:12+08:00","dateModified":"2019-07-20T23:09:12+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhoutao822.github.io/posts/gson/"},"publisher":{"@type":"Organization","name":"Tao's Notes","logo":{"@type":"ImageObject","url":"https://zhoutao822.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://zhoutao822.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://zhoutao822.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://zhoutao822.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zhoutao822.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://zhoutao822.github.io/series/ title=Series><span>Series</span></a></li><li><a href=https://zhoutao822.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zhoutao822.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://zhoutao822.github.io/posts/>Posts</a></div><h1 class=post-title>Android框架-Gson</h1><div class=post-meta><span title='2019-07-20 23:09:12 +0800 +0800'>July 20, 2019</span>&nbsp;·&nbsp;19 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Zhoutao822/zhoutao822.github.io/tree/main/content//posts/gson.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-gson%e4%bd%bf%e7%94%a8 aria-label="1. Gson使用">1. Gson使用</a></li><li><a href=#2-gson%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="2. Gson源码分析">2. Gson源码分析</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考：>参考：</a></li></ul></div></details></div><div class=post-content><p>json是一种数据格式，类似与键值对的形式，常用于服务器与客户端之间数据传输，以键值对形式传输的数据在客户端进行解析时必然需要对不同的key寻找其对应的value，通常来说这种解析数据的过程非常繁琐，但是没有难度，所以Google推出了Gson这个工具，用于解析json数据并直接将其实例化。</p><h2 id=1-gson使用>1. Gson使用<a hidden class=anchor aria-hidden=true href=#1-gson使用>#</a></h2><p>以解析和风天气的数据为例，请求返回的json数据如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;HeWeather6&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;basic&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cid&#34;</span>: <span style=color:#e6db74>&#34;CN101010100&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;北京&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;parent_city&#34;</span>: <span style=color:#e6db74>&#34;北京&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;admin_area&#34;</span>: <span style=color:#e6db74>&#34;北京&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cnty&#34;</span>: <span style=color:#e6db74>&#34;中国&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;lat&#34;</span>: <span style=color:#e6db74>&#34;39.90498734&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;lon&#34;</span>: <span style=color:#e6db74>&#34;116.4052887&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;tz&#34;</span>: <span style=color:#e6db74>&#34;+8.00&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;update&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;loc&#34;</span>: <span style=color:#e6db74>&#34;2019-07-18 16:45&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;utc&#34;</span>: <span style=color:#e6db74>&#34;2019-07-18 08:45&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ok&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;now&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cloud&#34;</span>: <span style=color:#e6db74>&#34;10&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cond_code&#34;</span>: <span style=color:#e6db74>&#34;101&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cond_txt&#34;</span>: <span style=color:#e6db74>&#34;多云&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;fl&#34;</span>: <span style=color:#e6db74>&#34;35&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;hum&#34;</span>: <span style=color:#e6db74>&#34;54&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;pcpn&#34;</span>: <span style=color:#e6db74>&#34;0.0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;pres&#34;</span>: <span style=color:#e6db74>&#34;1000&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;tmp&#34;</span>: <span style=color:#e6db74>&#34;32&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;vis&#34;</span>: <span style=color:#e6db74>&#34;6&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_deg&#34;</span>: <span style=color:#e6db74>&#34;279&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_dir&#34;</span>: <span style=color:#e6db74>&#34;西风&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_sc&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_spd&#34;</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>1.构造对应json数据的实体类，这里使用的Android Studio的插件GsonFormat，可以直接根据json数据生成代码</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WeatherEntity</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>HeWeather6Bean<span style=color:#f92672>&gt;</span> HeWeather6<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>HeWeather6Bean<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getHeWeather6</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> HeWeather6<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setHeWeather6</span><span style=color:#f92672>(</span>List<span style=color:#f92672>&lt;</span>HeWeather6Bean<span style=color:#f92672>&gt;</span> HeWeather6<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>HeWeather6</span> <span style=color:#f92672>=</span> HeWeather6<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 重写以下toString方法，便于后续观察数据传输是否正确
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> HeWeather6<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>).</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HeWeather6Bean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * basic : {&#34;cid&#34;:&#34;CN101010100&#34;,&#34;location&#34;:&#34;北京&#34;,&#34;parent_city&#34;:&#34;北京&#34;,&#34;admin_area&#34;:&#34;北京&#34;,&#34;cnty&#34;:&#34;中国&#34;,&#34;lat&#34;:&#34;39.90498734&#34;,&#34;lon&#34;:&#34;116.4052887&#34;,&#34;tz&#34;:&#34;+8.00&#34;}
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * update : {&#34;loc&#34;:&#34;2019-07-18 16:45&#34;,&#34;utc&#34;:&#34;2019-07-18 08:45&#34;}
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * status : ok
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * now : {&#34;cloud&#34;:&#34;10&#34;,&#34;cond_code&#34;:&#34;101&#34;,&#34;cond_txt&#34;:&#34;多云&#34;,&#34;fl&#34;:&#34;35&#34;,&#34;hum&#34;:&#34;54&#34;,&#34;pcpn&#34;:&#34;0.0&#34;,&#34;pres&#34;:&#34;1000&#34;,&#34;tmp&#34;:&#34;32&#34;,&#34;vis&#34;:&#34;6&#34;,&#34;wind_deg&#34;:&#34;279&#34;,&#34;wind_dir&#34;:&#34;西风&#34;,&#34;wind_sc&#34;:&#34;1&#34;,&#34;wind_spd&#34;:&#34;3&#34;}
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> BasicBean basic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> UpdateBean update<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> NowBean now<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> status <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; \n &#34;</span> <span style=color:#f92672>+</span> basic<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; \n &#34;</span> <span style=color:#f92672>+</span> update<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; \n &#34;</span> <span style=color:#f92672>+</span> now<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> BasicBean <span style=color:#a6e22e>getBasic</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> basic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBasic</span><span style=color:#f92672>(</span>BasicBean basic<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>basic</span> <span style=color:#f92672>=</span> basic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> UpdateBean <span style=color:#a6e22e>getUpdate</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> update<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUpdate</span><span style=color:#f92672>(</span>UpdateBean update<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>update</span> <span style=color:#f92672>=</span> update<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>String status<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> NowBean <span style=color:#a6e22e>getNow</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> now<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setNow</span><span style=color:#f92672>(</span>NowBean now<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> now<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BasicBean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cid : CN101010100
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * location : 北京
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * parent_city : 北京
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * admin_area : 北京
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cnty : 中国
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * lat : 39.90498734
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * lon : 116.4052887
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * tz : +8.00
</span></span></span><span style=display:flex><span><span style=color:#75715e>             */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String parent_city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String admin_area<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cnty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String lat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String lon<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String tz<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;cid : &#34;</span> <span style=color:#f92672>+</span> cid <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;location : &#34;</span> <span style=color:#f92672>+</span> location <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;parent_city : &#34;</span> <span style=color:#f92672>+</span> parent_city <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;admin_area : &#34;</span> <span style=color:#f92672>+</span> admin_area <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;cnty : &#34;</span> <span style=color:#f92672>+</span> cnty <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;lat : &#34;</span> <span style=color:#f92672>+</span> lat <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;lon : &#34;</span> <span style=color:#f92672>+</span> lon <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;tz : &#34;</span> <span style=color:#f92672>+</span> tz <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCid</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCid</span><span style=color:#f92672>(</span>String cid<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cid</span> <span style=color:#f92672>=</span> cid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLocation</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLocation</span><span style=color:#f92672>(</span>String location<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getParent_city</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> parent_city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setParent_city</span><span style=color:#f92672>(</span>String parent_city<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>parent_city</span> <span style=color:#f92672>=</span> parent_city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getAdmin_area</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> admin_area<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setAdmin_area</span><span style=color:#f92672>(</span>String admin_area<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>admin_area</span> <span style=color:#f92672>=</span> admin_area<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCnty</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cnty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCnty</span><span style=color:#f92672>(</span>String cnty<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cnty</span> <span style=color:#f92672>=</span> cnty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLat</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> lat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLat</span><span style=color:#f92672>(</span>String lat<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lat</span> <span style=color:#f92672>=</span> lat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLon</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> lon<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLon</span><span style=color:#f92672>(</span>String lon<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lon</span> <span style=color:#f92672>=</span> lon<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getTz</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> tz<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTz</span><span style=color:#f92672>(</span>String tz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tz</span> <span style=color:#f92672>=</span> tz<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UpdateBean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * loc : 2019-07-18 16:45
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * utc : 2019-07-18 08:45
</span></span></span><span style=display:flex><span><span style=color:#75715e>             */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String loc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String utc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;loc : &#34;</span> <span style=color:#f92672>+</span> loc <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;utc : &#34;</span> <span style=color:#f92672>+</span> utc <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLoc</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> loc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLoc</span><span style=color:#f92672>(</span>String loc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loc</span> <span style=color:#f92672>=</span> loc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getUtc</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> utc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUtc</span><span style=color:#f92672>(</span>String utc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>utc</span> <span style=color:#f92672>=</span> utc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NowBean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cloud : 10
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cond_code : 101
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cond_txt : 多云
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * fl : 35
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * hum : 54
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * pcpn : 0.0
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * pres : 1000
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * tmp : 32
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * vis : 6
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_deg : 279
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_dir : 西风
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_sc : 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_spd : 3
</span></span></span><span style=display:flex><span><span style=color:#75715e>             */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cloud<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cond_code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cond_txt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String fl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String hum<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String pcpn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String pres<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String tmp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String vis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_deg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_dir<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_sc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_spd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;cloud : &#34;</span> <span style=color:#f92672>+</span> cloud <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;cond_code : &#34;</span> <span style=color:#f92672>+</span> cond_code <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;cond_txt : &#34;</span> <span style=color:#f92672>+</span> cond_txt <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;fl : &#34;</span> <span style=color:#f92672>+</span> fl <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;hum : &#34;</span> <span style=color:#f92672>+</span> hum <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;pcpn : &#34;</span> <span style=color:#f92672>+</span> pcpn <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;pres : &#34;</span> <span style=color:#f92672>+</span> pres <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;tmp : &#34;</span> <span style=color:#f92672>+</span> tmp <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;vis : &#34;</span> <span style=color:#f92672>+</span> vis <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_deg : &#34;</span> <span style=color:#f92672>+</span> wind_deg <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_dir : &#34;</span> <span style=color:#f92672>+</span> wind_dir <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_sc : &#34;</span> <span style=color:#f92672>+</span> wind_sc <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_spd : &#34;</span> <span style=color:#f92672>+</span> wind_spd <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCloud</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cloud<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCloud</span><span style=color:#f92672>(</span>String cloud<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cloud</span> <span style=color:#f92672>=</span> cloud<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCond_code</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cond_code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCond_code</span><span style=color:#f92672>(</span>String cond_code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cond_code</span> <span style=color:#f92672>=</span> cond_code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCond_txt</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cond_txt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCond_txt</span><span style=color:#f92672>(</span>String cond_txt<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cond_txt</span> <span style=color:#f92672>=</span> cond_txt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getFl</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> fl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setFl</span><span style=color:#f92672>(</span>String fl<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>fl</span> <span style=color:#f92672>=</span> fl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getHum</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> hum<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setHum</span><span style=color:#f92672>(</span>String hum<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hum</span> <span style=color:#f92672>=</span> hum<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPcpn</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> pcpn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPcpn</span><span style=color:#f92672>(</span>String pcpn<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pcpn</span> <span style=color:#f92672>=</span> pcpn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPres</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> pres<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPres</span><span style=color:#f92672>(</span>String pres<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pres</span> <span style=color:#f92672>=</span> pres<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getTmp</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> tmp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTmp</span><span style=color:#f92672>(</span>String tmp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tmp</span> <span style=color:#f92672>=</span> tmp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getVis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> vis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setVis</span><span style=color:#f92672>(</span>String vis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>vis</span> <span style=color:#f92672>=</span> vis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_deg</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_deg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_deg</span><span style=color:#f92672>(</span>String wind_deg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_deg</span> <span style=color:#f92672>=</span> wind_deg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_dir</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_dir<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_dir</span><span style=color:#f92672>(</span>String wind_dir<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_dir</span> <span style=color:#f92672>=</span> wind_dir<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_sc</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_sc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_sc</span><span style=color:#f92672>(</span>String wind_sc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_sc</span> <span style=color:#f92672>=</span> wind_sc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_spd</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_spd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_spd</span><span style=color:#f92672>(</span>String wind_spd<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_spd</span> <span style=color:#f92672>=</span> wind_spd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>2.使用OkHttp构造请求</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>OkHttpClient client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>Request request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>baseUrl<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>Call call <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NotNull</span> Call call<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NotNull</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NotNull</span> Call call<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NotNull</span> Response response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>});</span>
</span></span></code></pre></div><blockquote><p>3.在onResponse方法中处理请求，使用Gson对response的json数据进行实例化</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NotNull</span> Call call<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NotNull</span> Response response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String ret <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>string</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    runOnUiThread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Gson gson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            WeatherEntity weatherEntity <span style=color:#f92672>=</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>ret<span style=color:#f92672>,</span> WeatherEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            textView<span style=color:#f92672>.</span><span style=color:#a6e22e>setText</span><span style=color:#f92672>(</span>weatherEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>只要对比一下就知道了，从ret到weatherEntity，完成了对json数据的实例化，我们不需要new一个对象再通过set方法赋值就可以得到一个实例，最后直接使用此实例即可。</p><h2 id=2-gson源码分析>2. Gson源码分析<a hidden class=anchor aria-hidden=true href=#2-gson源码分析>#</a></h2><p>首先new了一个Gson对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Gson</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>Excluder<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>,</span> FieldNamingPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>IDENTITY</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Collections<span style=color:#f92672>.&lt;</span>Type<span style=color:#f92672>,</span> InstanceCreator<span style=color:#f92672>&lt;?&gt;&gt;</span>emptyMap<span style=color:#f92672>(),</span> DEFAULT_SERIALIZE_NULLS<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        DEFAULT_COMPLEX_MAP_KEYS<span style=color:#f92672>,</span> DEFAULT_JSON_NON_EXECUTABLE<span style=color:#f92672>,</span> DEFAULT_ESCAPE_HTML<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        DEFAULT_PRETTY_PRINT<span style=color:#f92672>,</span> DEFAULT_LENIENT<span style=color:#f92672>,</span> DEFAULT_SPECIALIZE_FLOAT_VALUES<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        LongSerializationPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> DateFormat<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>,</span> DateFormat<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Collections<span style=color:#f92672>.&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;</span>emptyList<span style=color:#f92672>(),</span> Collections<span style=color:#f92672>.&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;</span>emptyList<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        Collections<span style=color:#f92672>.&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;</span>emptyList<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 这里很明显，比较重要的类是TypeAdapterFactory，作用稍后再说
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Gson<span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Excluder excluder<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> FieldNamingStrategy fieldNamingStrategy<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Type<span style=color:#f92672>,</span> InstanceCreator<span style=color:#f92672>&lt;?&gt;&gt;</span> instanceCreators<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> serializeNulls<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> complexMapKeySerialization<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> generateNonExecutableGson<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> htmlSafe<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> prettyPrinting<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> lenient<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> serializeSpecialFloatingPointValues<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      LongSerializationPolicy longSerializationPolicy<span style=color:#f92672>,</span> String datePattern<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> dateStyle<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> timeStyle<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;</span> builderFactories<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      List<span style=color:#f92672>&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;</span> builderHierarchyFactories<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      List<span style=color:#f92672>&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;</span> factoriesToBeAdded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>excluder</span> <span style=color:#f92672>=</span> excluder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>fieldNamingStrategy</span> <span style=color:#f92672>=</span> fieldNamingStrategy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>instanceCreators</span> <span style=color:#f92672>=</span> instanceCreators<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>constructorConstructor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConstructorConstructor<span style=color:#f92672>(</span>instanceCreators<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serializeNulls</span> <span style=color:#f92672>=</span> serializeNulls<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>complexMapKeySerialization</span> <span style=color:#f92672>=</span> complexMapKeySerialization<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>generateNonExecutableJson</span> <span style=color:#f92672>=</span> generateNonExecutableGson<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>htmlSafe</span> <span style=color:#f92672>=</span> htmlSafe<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>prettyPrinting</span> <span style=color:#f92672>=</span> prettyPrinting<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lenient</span> <span style=color:#f92672>=</span> lenient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serializeSpecialFloatingPointValues</span> <span style=color:#f92672>=</span> serializeSpecialFloatingPointValues<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>longSerializationPolicy</span> <span style=color:#f92672>=</span> longSerializationPolicy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>datePattern</span> <span style=color:#f92672>=</span> datePattern<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dateStyle</span> <span style=color:#f92672>=</span> dateStyle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeStyle</span> <span style=color:#f92672>=</span> timeStyle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>builderFactories</span> <span style=color:#f92672>=</span> builderFactories<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>builderHierarchyFactories</span> <span style=color:#f92672>=</span> builderHierarchyFactories<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;</span> factories <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>TypeAdapterFactory<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 内置的TypeAdapter，比如ObjectTypeAdapter用于处理Object类型数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// built-in type adapters that cannot be overridden
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>JSON_ELEMENT_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>ObjectTypeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// excluder用于控制属性的是否支持序列化与反序列化，比如用@Expose修饰的属性，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 优先级必须在所有TypeAdapter之前
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// the excluder must precede all adapters that handle user-defined types
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>excluder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开发人员自定义的TypeAdapter，优先级相对较高
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// users&#39; type adapters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>factoriesToBeAdded<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 基础类型数据，包括String、Integer等包装类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// type adapters for basic platform types
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>STRING_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>INTEGER_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>BOOLEAN_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>BYTE_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>SHORT_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    TypeAdapter<span style=color:#f92672>&lt;</span>Number<span style=color:#f92672>&gt;</span> longAdapter <span style=color:#f92672>=</span> longAdapter<span style=color:#f92672>(</span>longSerializationPolicy<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>newFactory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> longAdapter<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>newFactory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>double</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            doubleAdapter<span style=color:#f92672>(</span>serializeSpecialFloatingPointValues<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>newFactory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Float<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            floatAdapter<span style=color:#f92672>(</span>serializeSpecialFloatingPointValues<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>NUMBER_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>ATOMIC_INTEGER_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>ATOMIC_BOOLEAN_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>newFactory</span><span style=color:#f92672>(</span>AtomicLong<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> atomicLongAdapter<span style=color:#f92672>(</span>longAdapter<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>newFactory</span><span style=color:#f92672>(</span>AtomicLongArray<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> atomicLongArrayAdapter<span style=color:#f92672>(</span>longAdapter<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>ATOMIC_INTEGER_ARRAY_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>CHARACTER_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>STRING_BUILDER_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>STRING_BUFFER_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>newFactory</span><span style=color:#f92672>(</span>BigDecimal<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>BIG_DECIMAL</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>newFactory</span><span style=color:#f92672>(</span>BigInteger<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>BIG_INTEGER</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>URL_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>URI_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>UUID_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>CURRENCY_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>LOCALE_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>INET_ADDRESS_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>BIT_SET_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>DateTypeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>CALENDAR_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TimeTypeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>SqlDateTypeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>TIMESTAMP_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>ArrayTypeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>CLASS_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 集合类型优先级较低，包括Map、Collection等
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// type adapters for composite and user-defined types
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CollectionTypeAdapterFactory<span style=color:#f92672>(</span>constructorConstructor<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> MapTypeAdapterFactory<span style=color:#f92672>(</span>constructorConstructor<span style=color:#f92672>,</span> complexMapKeySerialization<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>jsonAdapterFactory</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JsonAdapterAnnotationTypeAdapterFactory<span style=color:#f92672>(</span>constructorConstructor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>jsonAdapterFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>TypeAdapters<span style=color:#f92672>.</span><span style=color:#a6e22e>ENUM_FACTORY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 反射类型优先级最低，而这个反射类型就是我们自定义WeatherEntity的TypeAdapter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    factories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ReflectiveTypeAdapterFactory<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        constructorConstructor<span style=color:#f92672>,</span> fieldNamingStrategy<span style=color:#f92672>,</span> excluder<span style=color:#f92672>,</span> jsonAdapterFactory<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>factories</span> <span style=color:#f92672>=</span> Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>unmodifiableList</span><span style=color:#f92672>(</span>factories<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>然后直接看fromJson方法，传入的参数为String和.class，返回值为.class的实例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>String json<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> classOfT<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> JsonSyntaxException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 此处只要分析fromJson方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Object object <span style=color:#f92672>=</span> fromJson<span style=color:#f92672>(</span>json<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>Type<span style=color:#f92672>)</span> classOfT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wrap仅仅把基础类型转为包装类型，cast用于类型转换，把Object类型转为object的实际类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> Primitives<span style=color:#f92672>.</span><span style=color:#a6e22e>wrap</span><span style=color:#f92672>(</span>classOfT<span style=color:#f92672>).</span><span style=color:#a6e22e>cast</span><span style=color:#f92672>(</span>object<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>String json<span style=color:#f92672>,</span> Type typeOfT<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> JsonSyntaxException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>json <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过StringReader将String类型的json数据转为StringReader
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    StringReader reader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringReader<span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 又调用fromJson方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    T target <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span> fromJson<span style=color:#f92672>(</span>reader<span style=color:#f92672>,</span> typeOfT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> target<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>Reader json<span style=color:#f92672>,</span> Type typeOfT<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> JsonIOException<span style=color:#f92672>,</span> JsonSyntaxException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 又将StringReader转为JsonReader
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    JsonReader jsonReader <span style=color:#f92672>=</span> newJsonReader<span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 继续调用fromJson
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    T object <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span> fromJson<span style=color:#f92672>(</span>jsonReader<span style=color:#f92672>,</span> typeOfT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    assertFullConsumption<span style=color:#f92672>(</span>object<span style=color:#f92672>,</span> jsonReader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> object<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>JsonReader reader<span style=color:#f92672>,</span> Type typeOfT<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> JsonIOException<span style=color:#f92672>,</span> JsonSyntaxException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isEmpty <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> oldLenient <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>isLenient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    reader<span style=color:#f92672>.</span><span style=color:#a6e22e>setLenient</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 核心代码在try catch内，我们得到的JsonReader需要通过TypeAdapter的read方法转为Java对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 所以接下来需要分析JsonReader的功能，以及这里默认使用的TypeAdapter的功能
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      reader<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      isEmpty <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      TypeToken<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> typeToken <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>TypeToken<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;)</span> TypeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>typeOfT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      TypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> typeAdapter <span style=color:#f92672>=</span> getAdapter<span style=color:#f92672>(</span>typeToken<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      T object <span style=color:#f92672>=</span> typeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>reader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> object<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>EOFException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>       * For compatibility with JSON 1.5 and earlier, we return null for empty
</span></span></span><span style=display:flex><span><span style=color:#75715e>       * documents instead of throwing.
</span></span></span><span style=display:flex><span><span style=color:#75715e>       */</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isEmpty<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> JsonSyntaxException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalStateException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> JsonSyntaxException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// TODO(inder): Figure out whether it is indeed right to rethrow this as JsonSyntaxException
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> JsonSyntaxException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>AssertionError e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;AssertionError (GSON &#34;</span> <span style=color:#f92672>+</span> GsonBuildConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;): &#34;</span> <span style=color:#f92672>+</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      reader<span style=color:#f92672>.</span><span style=color:#a6e22e>setLenient</span><span style=color:#f92672>(</span>oldLenient<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>JsonReader并不是直接通过String解析出来的，首先经过了StringReader，那么先看看StringReader的构造，StringReader继承自Reader，需要实现read方法，read方法一般是用于读取字符到buffer中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// StringReader.java 这里只保存了String的值和长度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Creates a new string reader.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param s  String providing the character stream.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>StringReader</span><span style=color:#f92672>(</span>String s<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>str</span> <span style=color:#f92672>=</span> s<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>JsonReader并不是继承自Reader，JsonReader需要配合TypeAdapter使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Gson.java newJsonReader将StringReader转为JsonReader对象，DEFAULT_LENIENT为false，暂时不明白
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns a new JSON reader configured for the settings on this Gson instance.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> JsonReader <span style=color:#a6e22e>newJsonReader</span><span style=color:#f92672>(</span>Reader reader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    JsonReader jsonReader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JsonReader<span style=color:#f92672>(</span>reader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    jsonReader<span style=color:#f92672>.</span><span style=color:#a6e22e>setLenient</span><span style=color:#f92672>(</span>lenient<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> jsonReader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>getAdapter方法如何获取到TypeAdapter</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns the type adapter for {@code} type.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @throws IllegalArgumentException if this GSON cannot serialize and
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *     deserialize {@code type}.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> TypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAdapter</span><span style=color:#f92672>(</span>TypeToken<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始情况下typeTokenCache为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TypeAdapter<span style=color:#f92672>&lt;?&gt;</span> cached <span style=color:#f92672>=</span> typeTokenCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>type <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> NULL_KEY_SURROGATE <span style=color:#f92672>:</span> type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cached <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>TypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;)</span> cached<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// calls初始也为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Map<span style=color:#f92672>&lt;</span>TypeToken<span style=color:#f92672>&lt;?&gt;,</span> FutureTypeAdapter<span style=color:#f92672>&lt;?&gt;&gt;</span> threadCalls <span style=color:#f92672>=</span> calls<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> requiresThreadLocalCleanup <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>threadCalls <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      threadCalls <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>TypeToken<span style=color:#f92672>&lt;?&gt;,</span> FutureTypeAdapter<span style=color:#f92672>&lt;?&gt;&gt;();</span>
</span></span><span style=display:flex><span>      calls<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>threadCalls<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      requiresThreadLocalCleanup <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ThreadLocal在这里是防止老是执行for (TypeAdapterFactory factory : factories) 递归查找，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 如果不用ThreadLocal干预的话，就会导致堆栈溢出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// the key and value type parameters always agree
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    FutureTypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> ongoingCall <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>FutureTypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;)</span> threadCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ongoingCall <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> ongoingCall<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      FutureTypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FutureTypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>      threadCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// TypeAdapter是从Gson初始化的factories中按照顺序遍历得到的，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 所以接下来需要看这里使用的是哪个TypeAdapterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>TypeAdapterFactory factory <span style=color:#f92672>:</span> factories<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        TypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> candidate <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>candidate <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          call<span style=color:#f92672>.</span><span style=color:#a6e22e>setDelegate</span><span style=color:#f92672>(</span>candidate<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          typeTokenCache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> candidate<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> candidate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;GSON (&#34;</span> <span style=color:#f92672>+</span> GsonBuildConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;) cannot handle &#34;</span> <span style=color:#f92672>+</span> type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      threadCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requiresThreadLocalCleanup<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        calls<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ReflectiveTypeAdapterFactory的create方法得到我们处理WeatherEntity的TypeAdapter</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ReflectiveTypeAdapterFactory.java create方法返回的是Adapter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> TypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>Gson gson<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> TypeToken<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> T<span style=color:#f92672>&gt;</span> raw <span style=color:#f92672>=</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>getRawType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>raw<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>// it&#39;s a primitive!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> constructor <span style=color:#f92672>=</span> constructorConstructor<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Adapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;(</span>constructor<span style=color:#f92672>,</span> getBoundFields<span style=color:#f92672>(</span>gson<span style=color:#f92672>,</span> type<span style=color:#f92672>,</span> raw<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Adapter的read方法就是返回WeatherEntity的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Adapter<span style=color:#f92672>(</span>ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> constructor<span style=color:#f92672>,</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> BoundField<span style=color:#f92672>&gt;</span> boundFields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>constructor</span> <span style=color:#f92672>=</span> constructor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>boundFields</span> <span style=color:#f92672>=</span> boundFields<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// read实际上是被递归调用的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>JsonReader in<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// JsonReader中保存了我们需要解析的字符串数据，所以也封装了一些读取的函数，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 通过peek判断JsonReader是否已经读到结尾了来结束解析的过程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>in<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>NULL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        in<span style=color:#f92672>.</span><span style=color:#a6e22e>nextNull</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 两个类ObjectConstructor和BoundField，看名字就知道了ObjectConstructor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 用于构造实例，BoundField用于指定属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      T instance <span style=color:#f92672>=</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>construct</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// JsonReader有几个方法，比如beginObject和beginArray，表明要开始解析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// JsonReader的数据了，beginObject表明需要解析为对象，beginArray表明需要解析为
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        in<span style=color:#f92672>.</span><span style=color:#a6e22e>beginObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// hasNext表明数据是否到达结尾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>in<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// nextName可以获取json数据中的key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          String name <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>nextName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 通过将name转为BoundField，为后续生成属性做铺垫
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          BoundField field <span style=color:#f92672>=</span> boundFields<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 如果不能生成此属性或者不允许反序列化，则跳过此key对应的value数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>field <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>deserialized</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            in<span style=color:#f92672>.</span><span style=color:#a6e22e>skipValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 然后需要对属性进行赋值，因此需要看BoundField的read方法做了些什么
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            field<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>in<span style=color:#f92672>,</span> instance<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalStateException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> JsonSyntaxException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      in<span style=color:#f92672>.</span><span style=color:#a6e22e>endObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 最后返回我们的实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> instance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// BoundField来源于getBoundFields方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> BoundField<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getBoundFields</span><span style=color:#f92672>(</span>Gson context<span style=color:#f92672>,</span> TypeToken<span style=color:#f92672>&lt;?&gt;</span> type<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> raw<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> BoundField<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> BoundField<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>raw<span style=color:#f92672>.</span><span style=color:#a6e22e>isInterface</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Type declaredType <span style=color:#f92672>=</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>raw <span style=color:#f92672>!=</span> Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 首先获得我们自定义WeatherEntity的属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      Field<span style=color:#f92672>[]</span> fields <span style=color:#f92672>=</span> raw<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Field field <span style=color:#f92672>:</span> fields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 对于每一个属性我们通过Excluder判断是否有@Expose或者其他注解修饰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 根据注解的要求保存这个属性是否支持序列化serialize和反序列化deserialize
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> serialize <span style=color:#f92672>=</span> excludeField<span style=color:#f92672>(</span>field<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> deserialize <span style=color:#f92672>=</span> excludeField<span style=color:#f92672>(</span>field<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>serialize <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>deserialize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        accessor<span style=color:#f92672>.</span><span style=color:#a6e22e>makeAccessible</span><span style=color:#f92672>(</span>field<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Type fieldType <span style=color:#f92672>=</span> $Gson$Types<span style=color:#f92672>.</span><span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>(),</span> raw<span style=color:#f92672>,</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericType</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 因为Gson支持序列化时指定key的名称，所以会有一些替代名称，替代名称可以有多个，因此需要
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 通过getFieldNames获取属性的所有序列化时的名称列表（第一个为属性名，其他可以是设置的替代名称）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> fieldNames <span style=color:#f92672>=</span> getFieldNames<span style=color:#f92672>(</span>field<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        BoundField previous <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> size <span style=color:#f92672>=</span> fieldNames<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> size<span style=color:#f92672>;</span> <span style=color:#f92672>++</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          String name <span style=color:#f92672>=</span> fieldNames<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> serialize <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span> <span style=color:#75715e>// only serialize the default name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#75715e>// result的value boundField是通过createBoundField得到的，且只有第一个名称允许序列化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          BoundField boundField <span style=color:#f92672>=</span> createBoundField<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> field<span style=color:#f92672>,</span> name<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>              TypeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fieldType<span style=color:#f92672>),</span> serialize<span style=color:#f92672>,</span> deserialize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          BoundField replaced <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> boundField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>previous <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> previous <span style=color:#f92672>=</span> replaced<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>previous <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>declaredType
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; declares multiple JSON fields named &#34;</span> <span style=color:#f92672>+</span> previous<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      type <span style=color:#f92672>=</span> TypeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>$Gson$Types<span style=color:#f92672>.</span><span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>(),</span> raw<span style=color:#f92672>,</span> raw<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericSuperclass</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>      raw <span style=color:#f92672>=</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>getRawType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// createBoundField返回我们需要的BoundField
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> ReflectiveTypeAdapterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>BoundField</span> <span style=color:#a6e22e>createBoundField</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> Gson context<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Field field<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> String name<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> TypeToken<span style=color:#f92672>&lt;?&gt;</span> fieldType<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> serialize<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> deserialize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isPrimitive <span style=color:#f92672>=</span> Primitives<span style=color:#f92672>.</span><span style=color:#a6e22e>isPrimitive</span><span style=color:#f92672>(</span>fieldType<span style=color:#f92672>.</span><span style=color:#a6e22e>getRawType</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// special casing primitives here saves ~5% on Android...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    JsonAdapter annotation <span style=color:#f92672>=</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>JsonAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    TypeAdapter<span style=color:#f92672>&lt;?&gt;</span> mapped <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      mapped <span style=color:#f92672>=</span> jsonAdapterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getTypeAdapter</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          constructorConstructor<span style=color:#f92672>,</span> context<span style=color:#f92672>,</span> fieldType<span style=color:#f92672>,</span> annotation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mapped也是通过getAdapter获取的，但是fieldType已经改变了，变成了我们定义的实体类的下一级
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> jsonAdapterPresent <span style=color:#f92672>=</span> mapped <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mapped <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> mapped <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getAdapter</span><span style=color:#f92672>(</span>fieldType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> TypeAdapter<span style=color:#f92672>&lt;?&gt;</span> typeAdapter <span style=color:#f92672>=</span> mapped<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ReflectiveTypeAdapterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>BoundField</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> serialize<span style=color:#f92672>,</span> deserialize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>({</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;rawtypes&#34;</span><span style=color:#f92672>})</span> <span style=color:#75715e>// the type adapter and field type always agree
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>JsonWriter writer<span style=color:#f92672>,</span> Object value<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> IllegalAccessException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Object fieldValue <span style=color:#f92672>=</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        TypeAdapter t <span style=color:#f92672>=</span> jsonAdapterPresent <span style=color:#f92672>?</span> typeAdapter
</span></span><span style=display:flex><span>            <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> TypeAdapterRuntimeTypeWrapper<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> typeAdapter<span style=color:#f92672>,</span> fieldType<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>writer<span style=color:#f92672>,</span> fieldValue<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 在调用read方法时就产生了递归
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>JsonReader reader<span style=color:#f92672>,</span> Object value<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> IllegalAccessException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 由于属性的类型不同，此处的typeAdapter变为从factories遍历获取，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 如果我们这里的reader是String，那么typeAdapter为TypeAdapters.STRING_FACTORY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 然后按照TypeAdapters.STRING_FACTORY的逻辑读取数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object fieldValue <span style=color:#f92672>=</span> typeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>reader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fieldValue <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>isPrimitive<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// set方法把值fieldValue赋给对象value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          field<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>value<span style=color:#f92672>,</span> fieldValue<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>writeField</span><span style=color:#f92672>(</span>Object value<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> IllegalAccessException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>serialized<span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        Object fieldValue <span style=color:#f92672>=</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> fieldValue <span style=color:#f92672>!=</span> value<span style=color:#f92672>;</span> <span style=color:#75715e>// avoid recursion for example for Throwable.cause
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们目前知道了属性是通过getDeclaredFields拿到的，然后通过递归的方式调用typeAdapter的read方法，然后将从JsonReader中获取到的值赋给属性，关键是属性实例是如何得到的<code>T instance = constructor.construct();</code>，默认情况下是ConstructorConstructor，通过ConstructorConstructor构造某个属性的实例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ConstructorConstructor.java 默认instanceCreators为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>TypeToken<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> typeToken<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Type type <span style=color:#f92672>=</span> typeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> T<span style=color:#f92672>&gt;</span> rawType <span style=color:#f92672>=</span> typeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>getRawType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// first try an instance creator
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// types must agree
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> InstanceCreator<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> typeCreator <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>InstanceCreator<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;)</span> instanceCreators<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>typeCreator <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>construct</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> typeCreator<span style=color:#f92672>.</span><span style=color:#a6e22e>createInstance</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Next try raw type match for instance creators
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// types must agree
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> InstanceCreator<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> rawTypeCreator <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>(</span>InstanceCreator<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;)</span> instanceCreators<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>rawType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rawTypeCreator <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>construct</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> rawTypeCreator<span style=color:#f92672>.</span><span style=color:#a6e22e>createInstance</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 我们构造的实例一般是通过newDefaultConstructor得到的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> defaultConstructor <span style=color:#f92672>=</span> newDefaultConstructor<span style=color:#f92672>(</span>rawType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>defaultConstructor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> defaultConstructor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// newDefaultImplementationConstructor用于构造Map和List以及它们的父类接口的实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> defaultImplementation <span style=color:#f92672>=</span> newDefaultImplementationConstructor<span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> rawType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>defaultImplementation <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> defaultImplementation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// finally try unsafe
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> newUnsafeAllocator<span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> rawType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>newDefaultConstructor</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> T<span style=color:#f92672>&gt;</span> rawType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// getDeclaredConstructor通过反射得到目标类的构造函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>final</span> Constructor<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> T<span style=color:#f92672>&gt;</span> constructor <span style=color:#f92672>=</span> rawType<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredConstructor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>isAccessible</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        accessor<span style=color:#f92672>.</span><span style=color:#a6e22e>makeAccessible</span><span style=color:#f92672>(</span>constructor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ObjectConstructor<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// T is the same raw type as is requested
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>construct</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 返回初始参数都为null的实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InstantiationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// TODO: JsonParseException ?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Failed to invoke &#34;</span> <span style=color:#f92672>+</span> constructor <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; with no args&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InvocationTargetException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// TODO: don&#39;t wrap if cause is unchecked!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// TODO: JsonParseException ?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Failed to invoke &#34;</span> <span style=color:#f92672>+</span> constructor <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; with no args&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                e<span style=color:#f92672>.</span><span style=color:#a6e22e>getTargetException</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchMethodException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>读取json字符串的工作是由JsonReader完成的，以解析下面此json字符串为例（删减版），服务器传过来的数据可能没有换行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;HeWeather6&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;basic&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cid&#34;</span>: <span style=color:#e6db74>&#34;CN101010100&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;北京&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;update&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;loc&#34;</span>: <span style=color:#e6db74>&#34;2019-07-18 16:45&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ok&#34;</span>
</span></span><span style=display:flex><span>        }]
</span></span><span style=display:flex><span>}    
</span></span></code></pre></div><p>根据上文代码分析我们知道解析数据的起点是ReflectiveTypeAdapterFactory中Adapter的read方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>JsonReader in<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>in<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>NULL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        in<span style=color:#f92672>.</span><span style=color:#a6e22e>nextNull</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      T instance <span style=color:#f92672>=</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>construct</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从in.beginObject开始对json数据进行解析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        in<span style=color:#f92672>.</span><span style=color:#a6e22e>beginObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>in<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          String name <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>nextName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 14. 得到解析的key后构造属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          BoundField field <span style=color:#f92672>=</span> boundFields<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>field <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>deserialized</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            in<span style=color:#f92672>.</span><span style=color:#a6e22e>skipValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 15. 并且递归解析后面的数据，深度优先，这里会调用CollectionTypeAdapterFactory的Adapter的read方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// CollectionTypeAdapterFactory用于处理集合类数据，这里会调用peek方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            field<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>in<span style=color:#f92672>,</span> instance<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalStateException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> JsonSyntaxException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      in<span style=color:#f92672>.</span><span style=color:#a6e22e>endObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> instance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// JsonReader.java peeked是标志位，初始为PEEKED_NONE，表明还没有开始任何解析过程
</span></span></span><span style=display:flex><span><span style=color:#75715e>// JsonReader解析数据的过程很有意思，它是依靠peeked标志位来决定如何处理下一个字符，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// peeked初始值为PEEKED_NONE，表明标志位为空所以需要读取json数据，根据读取的字符设置peeked
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 的值，然后再根据peeked的值决定下一个字符如何处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Consumes the next token from the JSON stream and asserts that it is the
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * beginning of a new object.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beginObject</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> p <span style=color:#f92672>=</span> peeked<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_NONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 初始值peeked为PEEKED_NONE，调用doPeek方法设置peeked的标志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      p <span style=color:#f92672>=</span> doPeek<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_BEGIN_OBJECT<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 4. 由于doPeek将p置为PEEKED_BEGIN_OBJECT，所以需要将JsonScope.EMPTY_OBJECT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 加入stack中，并peeked重置为PEEKED_NONE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      push<span style=color:#f92672>(</span>JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_OBJECT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      peeked <span style=color:#f92672>=</span> PEEKED_NONE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expected BEGIN_OBJECT but was &#34;</span> <span style=color:#f92672>+</span> peek<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> locationString<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// doPeek是整个解析过程中的核心代码，其他的函数都会调用到doPeek
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>doPeek</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 除了有peeked标志还有stack数组，stack数组保存解析json数据的进度，stack初始值全为0，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 初始化后将stack[0]置为JsonScope.EMPTY_DOCUMENT，表明还未开始解析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 6. 在hasNext方法中再次执行doPeek，此时peekStack为JsonScope.NONEMPTY_OBJECT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> peekStack <span style=color:#f92672>=</span> stack<span style=color:#f92672>[</span>stackSize <span style=color:#f92672>-</span> 1<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 25. stack的top被置为JsonScope.EMPTY_ARRAY，表明期望的数据是Array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_ARRAY</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 继续重置stack top为JsonScope.NONEMPTY_ARRAY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      stack<span style=color:#f92672>[</span>stackSize <span style=color:#f92672>-</span> 1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_ARRAY</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_ARRAY</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Look for a comma before the next element.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> nextNonWhitespace<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;]&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_END_ARRAY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;;&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        checkLenient<span style=color:#f92672>();</span> <span style=color:#75715e>// fall-through
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> syntaxError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unterminated array&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_OBJECT</span> <span style=color:#f92672>||</span> peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_OBJECT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 7. 又将stack的top置为JsonScope.DANGLING_NAME
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      stack<span style=color:#f92672>[</span>stackSize <span style=color:#f92672>-</span> 1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>DANGLING_NAME</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Look for a comma before the next element.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_OBJECT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> nextNonWhitespace<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;}&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_END_OBJECT<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;;&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          checkLenient<span style=color:#f92672>();</span> <span style=color:#75715e>// fall-through
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> syntaxError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unterminated object&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 8. 读取下一个字符 &#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> nextNonWhitespace<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;&#34;&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 9. 显然将peeked置为PEEKED_DOUBLE_QUOTED_NAME
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_DOUBLE_QUOTED_NAME<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\&#39;&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        checkLenient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_SINGLE_QUOTED_NAME<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;}&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>!=</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_OBJECT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_END_OBJECT<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> syntaxError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expected name&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        checkLenient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        pos<span style=color:#f92672>--;</span> <span style=color:#75715e>// Don&#39;t consume the first character in an unquoted string.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isLiteral<span style=color:#f92672>((</span><span style=color:#66d9ef>char</span><span style=color:#f92672>)</span> c<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_UNQUOTED_NAME<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> syntaxError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expected name&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>DANGLING_NAME</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 17. 之前stack的top被置为JsonScope.DANGLING_NAME
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 然后stack的top置为JsonScope.NONEMPTY_OBJECT，表明object对象还没有读取完成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      stack<span style=color:#f92672>[</span>stackSize <span style=color:#f92672>-</span> 1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_OBJECT</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Look for a colon before the value.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 下一个字符是 :
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> nextNonWhitespace<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;:&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;=&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        checkLenient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>pos <span style=color:#f92672>&lt;</span> limit <span style=color:#f92672>||</span> fillBuffer<span style=color:#f92672>(</span>1<span style=color:#f92672>))</span> <span style=color:#f92672>&amp;&amp;</span> buffer<span style=color:#f92672>[</span>pos<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&gt;&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          pos<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> syntaxError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expected &#39;:&#39;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_DOCUMENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 1. peekStack初始为JsonScope.EMPTY_DOCUMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>lenient<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// lenient在调用read方法之前被置为true，结束后被置为false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        consumeNonExecutePrefix<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// stack[0]被置为JsonScope.NONEMPTY_DOCUMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      stack<span style=color:#f92672>[</span>stackSize <span style=color:#f92672>-</span> 1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_DOCUMENT</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_DOCUMENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> nextNonWhitespace<span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>c <span style=color:#f92672>==</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_EOF<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        checkLenient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        pos<span style=color:#f92672>--;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>CLOSED</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;JsonReader is closed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. c是第一个字符 {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 18. c是 [
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 26. c是 {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> nextNonWhitespace<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;]&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_ARRAY</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_END_ARRAY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// fall-through to handle &#34;,]&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;;&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// In lenient mode, a 0-length literal in an array means &#39;null&#39;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_ARRAY</span> <span style=color:#f92672>||</span> peekStack <span style=color:#f92672>==</span> JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>NONEMPTY_ARRAY</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        checkLenient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        pos<span style=color:#f92672>--;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_NULL<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> syntaxError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unexpected value&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\&#39;&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      checkLenient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_SINGLE_QUOTED<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;&#34;&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_DOUBLE_QUOTED<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;[&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 19. 将peeked置为PEEKED_BEGIN_ARRAY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 表明开始解析Array类型数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_BEGIN_ARRAY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;{&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. peeked被置为PEEKED_BEGIN_OBJECT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 27. peeked被置为PEEKED_BEGIN_OBJECT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_BEGIN_OBJECT<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      pos<span style=color:#f92672>--;</span> <span style=color:#75715e>// Don&#39;t consume the first character in a literal value.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> peekKeyword<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>!=</span> PEEKED_NONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> peekNumber<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>!=</span> PEEKED_NONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isLiteral<span style=color:#f92672>(</span>buffer<span style=color:#f92672>[</span>pos<span style=color:#f92672>]))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> syntaxError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expected value&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    checkLenient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> peeked <span style=color:#f92672>=</span> PEEKED_UNQUOTED<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NON_EXECUTE_PREFIX包括&#34;)]}&#39;\n&#34;，即如果json字符串第一个字符在NON_EXECUTE_PREFIX中
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 说明这个字符出了错误，buffer是1024长度的数组用于缓存json数据，pos表示我们读取数据的位置，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// consumeNonExecutePrefix用于
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Consumes the non-execute prefix if it exists.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>consumeNonExecutePrefix</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// fast forward through the leading whitespace
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    nextNonWhitespace<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    pos<span style=color:#f92672>--;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pos <span style=color:#f92672>+</span> NON_EXECUTE_PREFIX<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> limit <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>fillBuffer<span style=color:#f92672>(</span>NON_EXECUTE_PREFIX<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> NON_EXECUTE_PREFIX<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>buffer<span style=color:#f92672>[</span>pos <span style=color:#f92672>+</span> i<span style=color:#f92672>]</span> <span style=color:#f92672>!=</span> NON_EXECUTE_PREFIX<span style=color:#f92672>[</span>i<span style=color:#f92672>])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span> <span style=color:#75715e>// not a security token!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// we consumed a security token!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    pos <span style=color:#f92672>+=</span> NON_EXECUTE_PREFIX<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 5. 在while循环里判断hasNext，显然peeked此时为PEEKED_NONE，所以执行doPeek
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns true if the current array or object has another element.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>hasNext</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> p <span style=color:#f92672>=</span> peeked<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_NONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      p <span style=color:#f92672>=</span> doPeek<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 10. p为PEEKED_DOUBLE_QUOTED_NAME，显然返回true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> p <span style=color:#f92672>!=</span> PEEKED_END_OBJECT <span style=color:#f92672>&amp;&amp;</span> p <span style=color:#f92672>!=</span> PEEKED_END_ARRAY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 11. 然后通过in.nextName()读取json数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns the next token, a {@link com.google.gson.stream.JsonToken#NAME property name}, and
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * consumes it.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @throws java.io.IOException if the next token in the stream is not a property
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *     name.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>nextName</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 12. 此时peeked为PEEKED_DOUBLE_QUOTED_NAME
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> p <span style=color:#f92672>=</span> peeked<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_NONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      p <span style=color:#f92672>=</span> doPeek<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    String result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_UNQUOTED_NAME<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> nextUnquotedValue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_SINGLE_QUOTED_NAME<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> nextQuotedValue<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;\&#39;&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_DOUBLE_QUOTED_NAME<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 13. 调用nextQuotedValue，nextQuotedValue方法读取buffer中不为 &#34; 的字符串，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 简而言之就是在已知我们已经读取到双引号的情况下，将两个双引号之间的数据获取到，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 所以这里的result为HeWeather6
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      result <span style=color:#f92672>=</span> nextQuotedValue<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;&#34;&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expected a name but was &#34;</span> <span style=color:#f92672>+</span> peek<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> locationString<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最后还是需要重置peeked为PEEKED_NONE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    peeked <span style=color:#f92672>=</span> PEEKED_NONE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将result保存到pathNames中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    pathNames<span style=color:#f92672>[</span>stackSize <span style=color:#f92672>-</span> 1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 16. peek继续调用doPeek
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns the type of the next token without consuming it.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> JsonToken <span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> p <span style=color:#f92672>=</span> peeked<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_NONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      p <span style=color:#f92672>=</span> doPeek<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>p<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_BEGIN_OBJECT<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>BEGIN_OBJECT</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_END_OBJECT<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>END_OBJECT</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_BEGIN_ARRAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 20. 返回JsonToken.BEGIN_ARRAY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>BEGIN_ARRAY</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_END_ARRAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>END_ARRAY</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_SINGLE_QUOTED_NAME<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_DOUBLE_QUOTED_NAME<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_UNQUOTED_NAME<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>NAME</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_TRUE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_FALSE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>BOOLEAN</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_NULL<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>NULL</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_SINGLE_QUOTED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_DOUBLE_QUOTED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_UNQUOTED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_BUFFERED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>STRING</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_LONG<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_NUMBER<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>NUMBER</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> PEEKED_EOF<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>END_DOCUMENT</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 23. beginArray用于解析Array类型数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Consumes the next token from the JSON stream and asserts that it is the
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * beginning of a new array.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beginArray</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> p <span style=color:#f92672>=</span> peeked<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_NONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      p <span style=color:#f92672>=</span> doPeek<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 由于peeked被置为PEEKED_BEGIN_ARRAY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// stack的top被置为JsonScope.EMPTY_ARRAY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> PEEKED_BEGIN_ARRAY<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      push<span style=color:#f92672>(</span>JsonScope<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_ARRAY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      pathIndices<span style=color:#f92672>[</span>stackSize <span style=color:#f92672>-</span> 1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      peeked <span style=color:#f92672>=</span> PEEKED_NONE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expected BEGIN_ARRAY but was &#34;</span> <span style=color:#f92672>+</span> peek<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> locationString<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Collection<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>JsonReader in<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 21. in.peek()返回JsonToken.BEGIN_ARRAY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>in<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>NULL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        in<span style=color:#f92672>.</span><span style=color:#a6e22e>nextNull</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      Collection<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> collection <span style=color:#f92672>=</span> constructor<span style=color:#f92672>.</span><span style=color:#a6e22e>construct</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 22.所以调用beginArray解析数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      in<span style=color:#f92672>.</span><span style=color:#a6e22e>beginArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 24. 继续判断hasNext，但是还是通过doPeek解析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>in<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 28. hasNext返回true，elementTypeAdapter是通过gson.getAdapter获取的，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 本质上还是ReflectiveTypeAdapterFactory的Adapter的read方法，那么下一个属性的实例化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 又进入了递归的模式，与此同时我们对于Array类型的属性是通过构造collection对象来加入下一级的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        E instance <span style=color:#f92672>=</span> elementTypeAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>in<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        collection<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>instance<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      in<span style=color:#f92672>.</span><span style=color:#a6e22e>endArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> collection<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>JsonReader可以完成的内容非常多，基本可以解析大多数的数据，而你只需要调用其中的beginArray、endArray、beginObject、endObject、hasNext等方法就可以得到json字符串中正确的数据部分，而且不需要考虑括号、引号、分号等等，在这些方法中就已经帮你跳过了，所以你也可以自定义json解析规则，实例代码在JsonReader的注释中给出了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>912345678901</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;How do I read a JSON stream in Java?&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;geo&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;user&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;json_newb&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;followers_count&#34;</span>: <span style=color:#ae81ff>41</span>
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>912345678902</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;@json_newb just use JsonReader!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;geo&#34;</span>: [<span style=color:#ae81ff>50.454722</span>, <span style=color:#ae81ff>-104.606667</span>],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;user&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;jesse&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;followers_count&#34;</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Message<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>readJsonStream</span><span style=color:#f92672>(</span>InputStream in<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  JsonReader reader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JsonReader<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> InputStreamReader<span style=color:#f92672>(</span>in<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> readMessagesArray<span style=color:#f92672>(</span>reader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    reader<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Message<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>readMessagesArray</span><span style=color:#f92672>(</span>JsonReader reader<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>Message<span style=color:#f92672>&gt;</span> messages <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>Message<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>beginArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>reader<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    messages<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>readMessage<span style=color:#f92672>(</span>reader<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>endArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> messages<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Message <span style=color:#a6e22e>readMessage</span><span style=color:#f92672>(</span>JsonReader reader<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  String text <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> geo <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>beginObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>reader<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String name <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>nextName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      id <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>nextLong</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;text&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      text <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>nextString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;geo&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>NULL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      geo <span style=color:#f92672>=</span> readDoublesArray<span style=color:#f92672>(</span>reader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      user <span style=color:#f92672>=</span> readUser<span style=color:#f92672>(</span>reader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      reader<span style=color:#f92672>.</span><span style=color:#a6e22e>skipValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>endObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Message<span style=color:#f92672>(</span>id<span style=color:#f92672>,</span> text<span style=color:#f92672>,</span> user<span style=color:#f92672>,</span> geo<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>readDoublesArray</span><span style=color:#f92672>(</span>JsonReader reader<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> doubles <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>beginArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>reader<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    doubles<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>reader<span style=color:#f92672>.</span><span style=color:#a6e22e>nextDouble</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>endArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> doubles<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>readUser</span><span style=color:#f92672>(</span>JsonReader reader<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  String username <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> followersCount <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>beginObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>reader<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String name <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>nextName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      username <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>nextString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;followers_count&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      followersCount <span style=color:#f92672>=</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      reader<span style=color:#f92672>.</span><span style=color:#a6e22e>skipValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  reader<span style=color:#f92672>.</span><span style=color:#a6e22e>endObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span>username<span style=color:#f92672>,</span> followersCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以上就是Gson解析json数据并实例化的过程，反之toJson将实例转为json数据也差不多。解析json数据是一个深度优先遍历的过程，同时根据各种括号、分号、引号判断数据类型以及数据的值，Gson在解析的过程中有一些非常亮眼的设计思路：</p><ol><li>TypeAdapterFactory工厂类，用于提供TypeAdapter，TypeAdapter用于将json数据转为实例，由于Java中包含大量的基础类型和自定义类型，所以Gson提供了对应的基础类型的TypeAdapterFactory工厂，这些工厂提供的Adapter可以按照设计好的方式调用JsonReader的各种方法读取数据并转为实例；同时对于自定义类型，提供了ReflectiveTypeAdapterFactory，通过反射的方式构造实例，同时根据不同的属性的类型，又可以使用TypeToken来表示便于后续查找合适的TypeAdapter；</li><li>JsonReader的强大功能，为了获取到json数据中的有效数据，比如属性名称、属性的值以及属性的类型，JsonReader加入了两个非常关键的参数peeked和stack，peeked用于标志当前的解析步骤是否完成，比如在调用beginObject后，peeked经历PEEKED_NONE -> PEEKED_BEGIN_OBJECT -> PEEKED_NONE的过程，通过doPeek完成这些步骤的转换，只要最终为PEEKED_NONE，说明前面都没有发生错误；其次是stack，stack保存了当前进行的流程，比如JsonScope.EMPTY_ARRAY、JsonScope.NONEMPTY_ARRAY、JsonScope.NONEMPTY_OBJECT等等，通过doPeek判断字符串，我们就知道了当前json数据可能是属于什么类型，从而将符号进行划分再判断，减少了需要判断的条件。</li></ol><h2 id=参考>参考：<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ol><li><a href=https://github.com/google/gson/blob/master/UserGuide.md>Gson User Guide</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://zhoutao822.github.io/tags/gson/>Gson</a></li></ul><nav class=paginav><a class=prev href=https://zhoutao822.github.io/posts/snackbar/><span class=title>« Prev Page</span><br><span>Material组件-Snackbar</span></a>
<a class=next href=https://zhoutao822.github.io/posts/retrofit/><span class=title>Next Page »</span><br><span>Android框架-Retrofit与OkHttp</span></a></nav></footer><script src=https://utteranc.es/client.js repo=zhoutao822/zhoutao822.github.io issue-term=title theme=github-dark crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://zhoutao822.github.io/>Tao's Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>