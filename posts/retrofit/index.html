<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android框架-Retrofit与OkHttp | Tao's Notes</title><meta name=keywords content="Https,Retrofit,OkHttp"><meta name=description content="Http，超文本传输协议，Https，更加安全的超文本传输协议，目前大量用于客户端与服务端之间的信息交流，属于应用层协议，下面有传输层TCP协议、网络层IP协议以及数据链路层为其提供保障。以登录功能为例，每一次输入账户密码后点击登录按钮就做了一次对服务器的Http请求（POST），我们收到的结果比如账号密码错误或者登录成功等信息就是服务器对Http请求的回复。Http与Https的区别在于后者采用了SSL（Secure Socket Layer安全套接层），简而言之就是对传输的数据进行了加密。具体细节可以在HTTPS Tutorials或者其他资料中找到。"><meta name=author content="Me"><link rel=canonical href=https://zhoutao822.github.io/posts/retrofit/><meta name=google-site-verification content="Tao"><meta name=yandex-verification content="Tao"><meta name=msvalidate.01 content="Tao"><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://zhoutao822.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zhoutao822.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zhoutao822.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zhoutao822.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zhoutao822.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.103.1"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Android框架-Retrofit与OkHttp"><meta property="og:description" content="Http，超文本传输协议，Https，更加安全的超文本传输协议，目前大量用于客户端与服务端之间的信息交流，属于应用层协议，下面有传输层TCP协议、网络层IP协议以及数据链路层为其提供保障。以登录功能为例，每一次输入账户密码后点击登录按钮就做了一次对服务器的Http请求（POST），我们收到的结果比如账号密码错误或者登录成功等信息就是服务器对Http请求的回复。Http与Https的区别在于后者采用了SSL（Secure Socket Layer安全套接层），简而言之就是对传输的数据进行了加密。具体细节可以在HTTPS Tutorials或者其他资料中找到。"><meta property="og:type" content="article"><meta property="og:url" content="https://zhoutao822.github.io/posts/retrofit/"><meta property="og:image" content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-20T09:58:58+08:00"><meta property="article:modified_time" content="2019-07-20T09:58:58+08:00"><meta property="og:site_name" content="Tao's Notes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhoutao822.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Android框架-Retrofit与OkHttp"><meta name=twitter:description content="Http，超文本传输协议，Https，更加安全的超文本传输协议，目前大量用于客户端与服务端之间的信息交流，属于应用层协议，下面有传输层TCP协议、网络层IP协议以及数据链路层为其提供保障。以登录功能为例，每一次输入账户密码后点击登录按钮就做了一次对服务器的Http请求（POST），我们收到的结果比如账号密码错误或者登录成功等信息就是服务器对Http请求的回复。Http与Https的区别在于后者采用了SSL（Secure Socket Layer安全套接层），简而言之就是对传输的数据进行了加密。具体细节可以在HTTPS Tutorials或者其他资料中找到。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zhoutao822.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Android框架-Retrofit与OkHttp","item":"https://zhoutao822.github.io/posts/retrofit/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android框架-Retrofit与OkHttp","name":"Android框架-Retrofit与OkHttp","description":"Http，超文本传输协议，Https，更加安全的超文本传输协议，目前大量用于客户端与服务端之间的信息交流，属于应用层协议，下面有传输层TCP协议、网络层IP协议以及数据链路层为其提供保障。以登录功能为例，每一次输入账户密码后点击登录按钮就做了一次对服务器的Http请求（POST），我们收到的结果比如账号密码错误或者登录成功等信息就是服务器对Http请求的回复。Http与Https的区别在于后者采用了SSL（Secure Socket Layer安全套接层），简而言之就是对传输的数据进行了加密。具体细节可以在HTTPS Tutorials或者其他资料中找到。","keywords":["Https","Retrofit","OkHttp"],"articleBody":"Http，超文本传输协议，Https，更加安全的超文本传输协议，目前大量用于客户端与服务端之间的信息交流，属于应用层协议，下面有传输层TCP协议、网络层IP协议以及数据链路层为其提供保障。以登录功能为例，每一次输入账户密码后点击登录按钮就做了一次对服务器的Http请求（POST），我们收到的结果比如账号密码错误或者登录成功等信息就是服务器对Http请求的回复。Http与Https的区别在于后者采用了SSL（Secure Socket Layer安全套接层），简而言之就是对传输的数据进行了加密。具体细节可以在HTTPS Tutorials或者其他资料中找到。\n1. GET和POST Http协议中比较常用的请求是GET和POST请求，可以说大部分客户端与服务端之间的数据交互都是通过这两个请求方法，以GET和POST请求为例\nGET用于请求数据，按照设计要求，GET请求不会对服务器数据进行修改，也就是说我们通过GET可以请求各种资源（静态页面等等），其中比较重要的参数包括：\nHost：需要请求的服务器\nUser-Agent：代理，表明你的身份，一般来说浏览器发送的请求会自动添加，可以人为修改伪造身份\nConnection：可以建立TCP长连接，属于HTTP/1.1的优化功能\n这个GET请求的目的就是从www.wrox.com这个服务器取index.htm这个页面\nGET /index.htm HTTP/1.1 Host: www.wrox.com User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6) Gecko/20050225 Firefox/1.0.1 Connection: Keep-Alive POST请求用于修改服务器数据，按照设计的要求，可以通过POST方法可以向服务器提交数据由服务器处理后返回，这里比较重要的参数包括：\nContent-Type：请求实体的格式\nContent-Length：请求实体的长度\n以及请求实体的内容，会空一行再写，比如这里的name1=value1\u0026name2=value2\n这个POST请求的目的是向w3schools.com服务器下/test/demo_form.asp发送数据参数name1=value1\u0026name2=value2，然后服务器会返回处理后的结果\nPOST /test/demo_form.asp HTTP/1.1 Host: w3schools.com User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6) Gecko/20050225 Firefox/1.0.1 Content-Type: application/x-www-form-urlencoded Content-Length: 40 Connection: Keep-Alive name1=value1\u0026name2=value2 以上就是Http中GET和POST方法的简要介绍了，实际上Http协议还包括一些其他方法，以及TCP握手、SSL握手等建立连接的过程、对称与非对称加密等细节步骤，这里就不多描述，可以看其他资料。\n2. OkHttp OkHttp是一个封装好的Http请求客户端，它既可用于Java项目也可以用于Android项目，通过调用构建好的http client，我们就可以发出http请求。\nAndroid中需要网络权限\n2.1 OkHttp.GET 1.创建OkHttpClient对象\nOkHttpClient client = new OkHttpClient(); 2.创建Request对象，URL则为我们需要的请求URL，一般来说此URL包含了Host、请求内容，比如https://zhoutao822.coding.me/2019/01/03/XGBoost/0.png\nRequest request = new Request.Builder() .url(URL) .build(); 3.将Request封装为Call\nCall call = client.newCall(request); 4.调用同步或异步的请求方法\n// 这是异步调用，通过enqueue方法 call.enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { Toast.makeText(MainActivity.this, \"get failed\", Toast.LENGTH_SHORT).show(); } @Override public void onResponse(Call call, Response response) throws IOException { final String ret = response.body().string(); runOnUiThread(new Runnable() { @Override public void run() { textView.setText(ret); } }); } }); // 这是同步调用 Response response = call.execute(); 异步调用意味着可以在主线程中调用call.enqueue方法，而同步调用方式只能在另一个线程中调用，通过handler将数据传回主线程，完整代码为\npublic class MainActivity extends AppCompatActivity { private final static String URL = \"https://free-api.heweather.net/s6/weather/now?location=beijing\u0026key=XXXXXXXXX\"; private static Handler handler = new Handler(); @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); final TextView textView = findViewById(R.id.text); OkHttpClient client = new OkHttpClient(); Request request = new Request.Builder() .get() .url(URL) .build(); Call call = client.newCall(request); call.enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { Toast.makeText(MainActivity.this, \"get failed\", Toast.LENGTH_SHORT).show(); } @Override public void onResponse(Call call, Response response) throws IOException { final String ret = response.body().string(); runOnUiThread(new Runnable() { @Override public void run() { textView.setText(ret); } }); } }); // 下面是同步调用 // new Thread(new Runnable() { // @Override // public void run() { // OkHttpClient client = new OkHttpClient(); // Request request = new Request.Builder() // .get() // .url(URL) // .build(); // Call call = client.newCall(request); // try { // final Response response = call.execute(); // handler.post(new Runnable() { // @Override // public void run() { // try { // textView.setText(response.body().string()); // } catch (IOException e) { // e.printStackTrace(); // } // } // }); // } catch (IOException e) { // e.printStackTrace(); // } // // } // }).start(); } } GET请求下载文件，对于图片url，我们也可以通过GET的方式进行下载，将返回的数据转为本地图片或者直接用在ImageView上\npublic void downloadImg(View view) { OkHttpClient client = new OkHttpClient(); Request request = new Request.Builder() .get() .url(URL) .build(); Call call = client.newCall(request); call.enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { Log.e(\"aaaa\", \"onFailure: \"); } @Override public void onResponse(Call call, Response response) throws IOException { //拿到字节流 InputStream is = response.body().byteStream(); int len = 0; File file = new File(Environment.getExternalStorageDirectory(), \"image.png\"); FileOutputStream fos = new FileOutputStream(file); byte[] buf = new byte[128]; while ((len = is.read(buf)) != -1) { fos.write(buf, 0, len); } fos.flush(); //关闭流 fos.close(); is.close(); // 下面是直接把图片放到ImageView上 // final Bitmap bitmap = BitmapFactory.decodeStream(is); // runOnUiThread(new Runnable() { // @Override // public void run() { // imageView.setImageBitmap(bitmap); // } // }); // // is.close(); } }); } GET请求下载文件的同时我们可以计算出下载进度，通过response.body().contentLength()拿到文件总大小，只需要修改上面的onResponse方法\n@Override public void onResponse(Call call, Response response) throws IOException { //拿到字节流 InputStream is = response.body().byteStream(); int len = 0; long sum = 0L; final long total = response.body().contentLength(); File file = new File(Environment.getExternalStorageDirectory(), \"image.png\"); FileOutputStream fos = new FileOutputStream(file); byte[] buf = new byte[128]; while ((len = is.read(buf)) != -1) { fos.write(buf, 0, len); sum += len; final long finalSum = sum; Log.i(\"aaaa\", \"onResponse: \" + finalSum + \"/\" + total); runOnUiThread(new Runnable() { @Override public void run() { //将进度设置到TextView中 textView.setText(finalSum + \"/\" + total); } }); } fos.flush(); //关闭流 fos.close(); is.close(); } 2.2 OkHttp.POST POST与GET非常类似，以传入键值对数据为例\n1.创建OkHttpClient对象\nOkHttpClient client = new OkHttpClient(); 2.构建FormBody，传入参数\nFormBody formBody = new FormBody.Builder() .add(\"username\", \"admin\") .add(\"password\", \"admin\") .build(); 3.创建Request对象，URL则为我们需要的请求URL，一般将此URL作为BaseUrl，比如https://www.wanandroid.com/user/login，我们就知道通过这个URL可以发送登录请求，根据API文档直到传入的参数包括username和password，因此需要FormBody\nRequest request = new Request.Builder() .url(URL) .post(formBody) .build(); 4.将Request封装为Call\nCall call = client.newCall(request); 5.调用异步的请求方法\ncall.enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { Log.e(\"aaaa\", \"onFailure: \"); } @Override public void onResponse(Call call, Response response) throws IOException { final String res = response.body().string(); runOnUiThread(new Runnable() { @Override public void run() { textView.setText(res); } }); } }); POST除了可以发送键值对FormBody形式的请求外，还可以发送json字符串，将FormBody替换为RequestBody\nRequestBody requestBody = RequestBody.create(MediaType.parse(\"text/plain;charset=utf-8\"), \"{username:admin;password:admin}\"); 除了以上两种形式的数据之外，Http还可以接受表单形式的数据请求，这也是正常情况下登录流程中发送账号密码的要求，通过表单保存这些数据，再发送到服务器上\nFile file = new File(Environment.getExternalStorageDirectory(), \"image.png\"); if (!file.exists()){ Toast.makeText(this, \"文件不存在\", Toast.LENGTH_SHORT).show(); return; } RequestBody muiltipartBody = new MultipartBody.Builder() //一定要设置这句 .setType(MultipartBody.FORM) .addFormDataPart(\"username\", \"admin\") .addFormDataPart(\"password\", \"admin\") .addFormDataPart(\"myfile\", \"image.png\", RequestBody.create(MediaType.parse(\"application/octet-stream\"), file)) .build(); 在发送表单请求时，除了字符串还可以添加二进制文件，比如这里将图片转为二进制加入到了表单中。\n除了在表单中上传文件之外，还可以直接发送二进制文件，需要存储权限\nFile file = new File(Environment.getExternalStorageDirectory(), \"image.png\"); if (!file.exists()){ Toast.makeText(this, \"文件不存在\", Toast.LENGTH_SHORT).show(); }else{ RequestBody requestBody2 = RequestBody.create(MediaType.parse(\"application/octet-stream\"), file); } POST也可以显示上传进度，但是需要自定义接口\npublic class CountingRequestBody extends RequestBody { //实际起作用的RequestBody private RequestBody delegate; //回调监听 private Listener listener; private CountingSink countingSink; /** * 构造函数初始化成员变量 * @param delegate * @param listener */ public CountingRequestBody(RequestBody delegate, Listener listener){ this.delegate = delegate; this.listener = listener; } @Override public MediaType contentType() { return delegate.contentType(); } @Override public void writeTo(BufferedSink sink) throws IOException { countingSink = new CountingSink(sink); //将CountingSink转化为BufferedSink供writeTo()使用 BufferedSink bufferedSink = Okio.buffer(countingSink); delegate.writeTo(bufferedSink); bufferedSink.flush(); } protected final class CountingSink extends ForwardingSink{ private long byteWritten; public CountingSink(Sink delegate) { super(delegate); } /** * 上传时调用该方法,在其中调用回调函数将上传进度暴露出去,该方法提供了缓冲区的自己大小 * @param source * @param byteCount * @throws IOException */ @Override public void write(Buffer source, long byteCount) throws IOException { super.write(source, byteCount); byteWritten += byteCount; listener.onRequestProgress(byteWritten, contentLength()); } } /** * 返回文件总的字节大小 * 如果文件大小获取失败则返回-1 * @return */ @Override public long contentLength(){ try { return delegate.contentLength(); } catch (IOException e) { return -1; } } /** * 回调监听接口 */ public static interface Listener{ /** * 暴露出上传进度 * @param byteWritted 已经上传的字节大小 * @param contentLength 文件的总字节大小 */ void onRequestProgress(long byteWritted, long contentLength); } } File file = new File(Environment.getExternalStorageDirectory(), \"image.png\"); if (!file.exists()){ Toast.makeText(this, \"文件不存在\", Toast.LENGTH_SHORT).show(); }else{ RequestBody requestBody2 = RequestBody.create(MediaType.parse(\"application/octet-stream\"), file); } //使用我们自己封装的类 CountingRequestBody countingRequestBody = new CountingRequestBody(requestBody2, new CountingRequestBody.Listener() { @Override public void onRequestProgress(long byteWritted, long contentLength) { //打印进度 Log.d(\"aaaa\", \"进度 ：\" + byteWritted + \"/\" + contentLength); } }); 2.3 OkHttp源码分析 以发送表单数据请求为例，大致有4步：OkHttpClient构建 -\u003e RequestBody构建 -\u003e Request构建 -\u003e Call构建并调用\n首先看一下OkHttpClient到底是个什么东西，从注释中可以知道OkHttpClient时Call的工厂，具体发送HTTP请求以及接收服务器响应都是通过Call来实现的。\nOkHttpClient还包括以下几个特性：\nOkHttpClient应该用单例模式，这样是为了复用减少内存消耗； 每一个OkHttpClient都持有独立的连接池和线程池； 直接new出来的OkHttpClient是默认配置的； new OkHttpClient.Builder()可以对Client进行配置； 通过client.newBuilder()可以得到一个与client共享连接池和线程池的OkHttpClient，仅在特殊情形下需要； OkHttpClient不是必须主动关闭，client持有的线程和连接在空闲的情况下会被自动回收； 如果需要主动回收，client.dispatcher().executorService().shutdown()可以回收执行的Service，但会导致之后的call被拒绝； client.connectionPool().evictAll()会回收连接池； client.cache().close()会回收Client的缓存（如果在第4步中配置了的话）。 调用默认构造方法话，则默认参数为\npublic Builder() { dispatcher = new Dispatcher(); // Dispatcher持有ExecutorService，通过ExecutorService调用call protocols = DEFAULT_PROTOCOLS; // 默认支持HTTP/2和HTTP/1.1 connectionSpecs = DEFAULT_CONNECTION_SPECS; // 默认连接配置，支持TLS加密的https和普通的不加密http eventListenerFactory = EventListener.factory(EventListener.NONE); // 提供监听各种Event的Listener，通常需要继承EventListener并实现其方法 proxySelector = ProxySelector.getDefault(); // 设置代理，默认是获取系统范围的代理 if (proxySelector == null) { proxySelector = new NullProxySelector(); // 如果系统没有设置代理则将proxySelector设置为NullProxySelector } cookieJar = CookieJar.NO_COOKIES; // CookieJar是一个接口，实现这个接口的方法可以保存Cookies，也可以在发送请求时加上Cookies socketFactory = SocketFactory.getDefault(); // SocketFactory用于构建socket，默认返回DefaultSocketFactory，通过DefaultSocketFactory可以创建Socket hostnameVerifier = OkHostnameVerifier.INSTANCE; // 用于在握手期间验证URL主机名和server的身份信息是否相同 certificatePinner = CertificatePinner.DEFAULT; // CertificatePinner用于在发送请求的过程中嵌入证书（Certificate Pinning），可以防止连接到危险的服务器 proxyAuthenticator = Authenticator.NONE; // 代理服务器需要身份验证的时候需要用到，默认不需要身份验证 authenticator = Authenticator.NONE; connectionPool = new ConnectionPool(); // 默认连接池允许最大5个空闲连接，超过5分钟空闲会被回收 dns = Dns.SYSTEM; // DNS服务，默认使用系统的DNS服务 followSslRedirects = true; // 重定向到https域名，下面都是一些简单配置参数 followRedirects = true; retryOnConnectionFailure = true; callTimeout = 0; connectTimeout = 10_000; readTimeout = 10_000; writeTimeout = 10_000; pingInterval = 0; } client只在后面构建Call的时候用到，那先看一下RequestBody，RequestBody是个抽象类\n// 如果需要自定义RequestBody，则需要继承RequestBody并实现两个抽象方法contentType和writeTo， // 一般来说contentType返回此RequestBody的Content-Type，contentLength返回Content的大小， // 重写writeTo方法实际上是调用BufferedSink的write(content)方法 // RequestBody包含几个默认的create，如果只是发送简单请求，Content的内容不太复杂可以直接使用 public abstract class RequestBody { /** Returns the Content-Type header for this body. */ public abstract @Nullable MediaType contentType(); /** * Returns the number of bytes that will be written to {@code sink} in a call to {@link #writeTo}, * or -1 if that count is unknown. */ public long contentLength() throws IOException { return -1; } /** Writes the content of this request to {@code sink}. */ public abstract void writeTo(BufferedSink sink) throws IOException; /** * Returns a new request body that transmits {@code content}. If {@code contentType} is non-null * and lacks a charset, this will use UTF-8. */ public static RequestBody create(@Nullable MediaType contentType, String content) { Charset charset = Util.UTF_8; if (contentType != null) { charset = contentType.charset(); if (charset == null) { charset = Util.UTF_8; contentType = MediaType.parse(contentType + \"; charset=utf-8\"); } } byte[] bytes = content.getBytes(charset); return create(contentType, bytes); } /** Returns a new request body that transmits {@code content}. */ public static RequestBody create( final @Nullable MediaType contentType, final ByteString content) { return new RequestBody() { @Override public @Nullable MediaType contentType() { return contentType; } @Override public long contentLength() throws IOException { return content.size(); } @Override public void writeTo(BufferedSink sink) throws IOException { sink.write(content); } }; } /** Returns a new request body that transmits {@code content}. */ public static RequestBody create(final @Nullable MediaType contentType, final byte[] content) { return create(contentType, content, 0, content.length); } /** Returns a new request body that transmits {@code content}. */ public static RequestBody create(final @Nullable MediaType contentType, final byte[] content, final int offset, final int byteCount) { if (content == null) throw new NullPointerException(\"content == null\"); Util.checkOffsetAndCount(content.length, offset, byteCount); return new RequestBody() { @Override public @Nullable MediaType contentType() { return contentType; } @Override public long contentLength() { return byteCount; } @Override public void writeTo(BufferedSink sink) throws IOException { sink.write(content, offset, byteCount); } }; } /** Returns a new request body that transmits the content of {@code file}. */ public static RequestBody create(final @Nullable MediaType contentType, final File file) { if (file == null) throw new NullPointerException(\"file == null\"); return new RequestBody() { @Override public @Nullable MediaType contentType() { return contentType; } @Override public long contentLength() { return file.length(); } @Override public void writeTo(BufferedSink sink) throws IOException { Source source = null; try { source = Okio.source(file); sink.writeAll(source); } finally { Util.closeQuietly(source); } } }; } } MultipartBody继承自RequestBody，通过MultipartBody构建RequestBody可以发送更加复杂的数据，比如multipart/form-data表单数据，通过MultipartBody的内部类Builder可以对MultipartBody进行配置（建造者模式）\n// Builder有几个重要的方法 // setType：设置MultipartBody请求的Content-Type，如果是表单数据则为MultipartBody.FORM； // addPart：因为HTTP请求包括Header和Body，因此通过内部类Part封装号Header和Body， // 将Part保存到RequestBody的List中，可能是为了一次发送多个请求； // addFormDataPart：通过Part构造表单请求； // build：最后通过build方法创建MultipartBody实例，参数来源于前面三个方法 public static final class Builder { private final ByteString boundary; private MediaType type = MIXED; private final List\u003cPart\u003e parts = new ArrayList\u003c\u003e(); public Builder() { // 初始化一个随机的boundary，暂时还不知道有什么用 this(UUID.randomUUID().toString()); } public Builder(String boundary) { this.boundary = ByteString.encodeUtf8(boundary); } /** * Set the MIME type. Expected values for {@code type} are {@link #MIXED} (the default), {@link * #ALTERNATIVE}, {@link #DIGEST}, {@link #PARALLEL} and {@link #FORM}. */ public Builder setType(MediaType type) { if (type == null) { throw new NullPointerException(\"type == null\"); } if (!type.type().equals(\"multipart\")) { throw new IllegalArgumentException(\"multipart != \" + type); } this.type = type; return this; } /** Add a part to the body. */ public Builder addPart(RequestBody body) { return addPart(Part.create(body)); } /** Add a part to the body. */ public Builder addPart(@Nullable Headers headers, RequestBody body) { return addPart(Part.create(headers, body)); } /** Add a form data part to the body. */ public Builder addFormDataPart(String name, String value) { return addPart(Part.createFormData(name, value)); } /** Add a form data part to the body. */ public Builder addFormDataPart(String name, @Nullable String filename, RequestBody body) { return addPart(Part.createFormData(name, filename, body)); } /** Add a part to the body. */ public Builder addPart(Part part) { if (part == null) throw new NullPointerException(\"part == null\"); parts.add(part); return this; } /** Assemble the specified parts into a request body. */ public MultipartBody build() { if (parts.isEmpty()) { throw new IllegalStateException(\"Multipart body must have at least one part.\"); } return new MultipartBody(boundary, type, parts); } } // Part用于构造包含Header和RequestBody的实例，简单来说就是用Header封装好要发送请求的首部参数， // 用RequestBody封装要发送请求的请求数据 public static final class Part { public static Part create(RequestBody body) { return create(null, body); } public static Part create(@Nullable Headers headers, RequestBody body) { if (body == null) { throw new NullPointerException(\"body == null\"); } if (headers != null \u0026\u0026 headers.get(\"Content-Type\") != null) { throw new IllegalArgumentException(\"Unexpected header: Content-Type\"); } if (headers != null \u0026\u0026 headers.get(\"Content-Length\") != null) { throw new IllegalArgumentException(\"Unexpected header: Content-Length\"); } return new Part(headers, body); } public static Part createFormData(String name, String value) { return createFormData(name, null, RequestBody.create(null, value)); } public static Part createFormData(String name, @Nullable String filename, RequestBody body) { if (name == null) { throw new NullPointerException(\"name == null\"); } StringBuilder disposition = new StringBuilder(\"form-data; name=\"); appendQuotedString(disposition, name); if (filename != null) { disposition.append(\"; filename=\"); appendQuotedString(disposition, filename); } return create(Headers.of(\"Content-Disposition\", disposition.toString()), body); } final @Nullable Headers headers; final RequestBody body; private Part(@Nullable Headers headers, RequestBody body) { this.headers = headers; this.body = body; } public @Nullable Headers headers() { return headers; } public RequestBody body() { return body; } } RequestBody包含了请求首部参数以及请求数据，接下来需要分析Request，Request连接了请求的主机url和RequestBody\n// Request默认构造的是GET请求 public Builder() { this.method = \"GET\"; this.headers = new Headers.Builder(); } // 通过url方法设置请求的主机名，如果直接传入的是HttpUrl也可以，传入String也可以， // 但是会进行格式验证，会把ws:开头和wss:开头的主机名转换为http:和https: public Builder url(HttpUrl url) { if (url == null) throw new NullPointerException(\"url == null\"); this.url = url; return this; } /** * Sets the URL target of this request. * * @throws IllegalArgumentException if {@code url} is not a valid HTTP or HTTPS URL. Avoid this * exception by calling {@link HttpUrl#parse}; it returns null for invalid URLs. */ public Builder url(String url) { if (url == null) throw new NullPointerException(\"url == null\"); // Silently replace web socket URLs with HTTP URLs. if (url.regionMatches(true, 0, \"ws:\", 0, 3)) { url = \"http:\" + url.substring(3); } else if (url.regionMatches(true, 0, \"wss:\", 0, 4)) { url = \"https:\" + url.substring(4); } return url(HttpUrl.get(url)); } // post以及其他方法都是通过传入字符POST或者其他方式调用method public Builder get() { return method(\"GET\", null); } public Builder head() { return method(\"HEAD\", null); } public Builder post(RequestBody body) { return method(\"POST\", body); } public Builder delete(@Nullable RequestBody body) { return method(\"DELETE\", body); } public Builder delete() { return delete(Util.EMPTY_REQUEST); } public Builder put(RequestBody body) { return method(\"PUT\", body); } public Builder patch(RequestBody body) { return method(\"PATCH\", body); } // method方法还是将Request的属性设为method传入的值 public Builder method(String method, @Nullable RequestBody body) { if (method == null) throw new NullPointerException(\"method == null\"); if (method.length() == 0) throw new IllegalArgumentException(\"method.length() == 0\"); if (body != null \u0026\u0026 !HttpMethod.permitsRequestBody(method)) { throw new IllegalArgumentException(\"method \" + method + \" must not have a request body.\"); } if (body == null \u0026\u0026 HttpMethod.requiresRequestBody(method)) { throw new IllegalArgumentException(\"method \" + method + \" must have a request body.\"); } this.method = method; this.body = body; return this; } // build()方法返回Request对象，并且传入了上面设置的属性 public Request build() { if (url == null) throw new IllegalStateException(\"url == null\"); return new Request(this); } // 其实Request对象也没有什么具体的功能，也是类似RequestBody封装了HTTP请求的一些参数，包括url请求主机名，method请求的方法， // headers这里也有headers，也就是说我们可以在RequestBody中加入请求首部参数，也可以在Request中加入请求参数，而且Request会覆盖 // RequestBody的参数，在两个地方都封装Header，我觉得应该是为了复用，有些时候Header对于一些请求来说都是相同的，区别只是Body不同 // 因此在Request中设置Header能减少冗余的代码 Request(Builder builder) { this.url = builder.url; this.method = builder.method; this.headers = builder.headers.build(); this.body = builder.body; this.tags = Util.immutableMap(builder.tags); } 以上的RequestBody和Request实际上并没有任何复杂的功能，都是对一个完整的HTTP请求参数的封装，利用了建造者模式，同时将请求数据与请求首部参数以及请求方法和主机名进行解耦，使得开发人员可以灵活的使用各个模块组建一个完整的Request，如何发送这个Request，并接收回调则是在Call中进行的\n// OkHttpClient.java 之前说过OkHttpClient是Call的工厂类，通过newCall方法传入上面构造的Request实例， // 得到一个Call实例，具体的实现是通过RealCall.newRealCall方法 @Override public Call newCall(Request request) { return RealCall.newRealCall(this, request, false /* for web socket */); } 在看RealCall.newRealCall之前首先看一下Call\n// 根据注释说明，我们直到Call是一个接口，Call接口的实现类能够完成具体的HTTP请求发送，且包含request/response对， // 也就意味着可以通过Call的回调获取到服务器返回的数据，一个call不能被执行两次 /** * A call is a request that has been prepared for execution. A call can be canceled. As this object * represents a single request/response pair (stream), it cannot be executed twice. */ public interface Call extends Cloneable { /** Returns the original request that initiated this call. */ Request request(); // execute方法执行时会阻塞当前线程，直到处理完response Response execute() throws IOException; // enqueue方法会通过dispatcher安排request进入队列等待执行，执行完毕后通过Callback回调 void enqueue(Callback responseCallback); // 调用cancel方法可以取消request void cancel(); // 判断call是否已经在执行，比如调用了execute或者enqueue方法 boolean isExecuted(); // 判断call是否被取消 boolean isCanceled(); // 返回整个call执行期间的耗时，包括DNS寻址、连接、写入request body、服务器处理、读取response body等过程 Timeout timeout(); // 复制此call，利用clone得到的call可以继续执行 Call clone(); interface Factory { Call newCall(Request request); } } RealCall实现了Call的接口，所以上面用到的方法都是在RealCall中实现的，首先看RealCall.newRealCall\nprivate RealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) { this.client = client; this.originalRequest = originalRequest; this.forWebSocket = forWebSocket; this.retryAndFollowUpInterceptor = new RetryAndFollowUpInterceptor(client, forWebSocket); this.timeout = new AsyncTimeout() { @Override protected void timedOut() { cancel(); } }; this.timeout.timeout(client.callTimeoutMillis(), MILLISECONDS); } // newRealCall方法也是仅仅只做了参数传递的工作，最主要的参数是client和originalRequest static RealCall newRealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) { // Safely publish the Call instance to the EventListener. RealCall call = new RealCall(client, originalRequest, forWebSocket); call.eventListener = client.eventListenerFactory().create(call); return call; } 当我们调用call.execute方法时\n@Override public Response execute() throws IOException { // synchronized锁，确保同一个Call不会被执行两次 synchronized (this) { if (executed) throw new IllegalStateException(\"Already Executed\"); executed = true; } // captureCallStackTrace跟踪call执行的堆栈 captureCallStackTrace(); // timeout.enter开始记录timeout timeout.enter(); // 将Call Start事件传递出去，通过自定义eventListenerFactory可以对事件进行处理 eventListener.callStart(this); try { // 通过dispatcher调用executed执行请求发送，实际上只是把call加到一个队列中，并没有执行发送请求 client.dispatcher().executed(this); // 通过getResponseWithInterceptorChain获取服务器返回的response，这里才是真正的call被发送出去 Response result = getResponseWithInterceptorChain(); if (result == null) throw new IOException(\"Canceled\"); return result; } catch (IOException e) { e = timeoutExit(e); eventListener.callFailed(this, e); throw e; } finally { client.dispatcher().finished(this); } } // Dispatcher.java client.dispatcher().executed(this); /** Used by {@code Call#execute} to signal it is in-flight. */ synchronized void executed(RealCall call) { runningSyncCalls.add(call); } // Interceptor也是一个接口，实现Interceptor接口的类可以对Request进行拦截，也就是通过 // 各种Interceptor来实现HTTP请求，比如这里的BridgeInterceptor、CacheInterceptor、 // ConnectInterceptor等等 Response getResponseWithInterceptorChain() throws IOException { // Build a full stack of interceptors. // 注意默认构造的client.interceptors()为空 List\u003cInterceptor\u003e interceptors = new ArrayList\u003c\u003e(); interceptors.addAll(client.interceptors()); interceptors.add(retryAndFollowUpInterceptor); interceptors.add(new BridgeInterceptor(client.cookieJar())); interceptors.add(new CacheInterceptor(client.internalCache())); interceptors.add(new ConnectInterceptor(client)); if (!forWebSocket) { interceptors.addAll(client.networkInterceptors()); } interceptors.add(new CallServerInterceptor(forWebSocket)); // 这里调用的时候，注意index为0，而RealInterceptorChain调用proceed方法 Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0, originalRequest, this, eventListener, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis()); return chain.proceed(originalRequest); } // RealInterceptorChain.java chain.proceed(originalRequest)的位置，这里的index为0 public Response proceed(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec, RealConnection connection) throws IOException { if (index \u003e= interceptors.size()) throw new AssertionError(); calls++; // If we already have a stream, confirm that the incoming request will use it. if (this.httpCodec != null \u0026\u0026 !this.connection.supportsUrl(request.url())) { throw new IllegalStateException(\"network interceptor \" + interceptors.get(index - 1) + \" must retain the same host and port\"); } // If we already have a stream, confirm that this is the only call to chain.proceed(). if (this.httpCodec != null \u0026\u0026 calls \u003e 1) { throw new IllegalStateException(\"network interceptor \" + interceptors.get(index - 1) + \" must call proceed() exactly once\"); } // 注意这里，创建了next RealInterceptorChain，index为1，而interceptors.get(index)拿的就是上文对应的retryAndFollowUpInterceptor // Call the next interceptor in the chain. RealInterceptorChain next = new RealInterceptorChain(interceptors, streamAllocation, httpCodec, connection, index + 1, request, call, eventListener, connectTimeout, readTimeout, writeTimeout); Interceptor interceptor = interceptors.get(index); // 即response时通过BridgeInterceptor的intercept方法得到的 Response response = interceptor.intercept(next); // Confirm that the next interceptor made its required call to chain.proceed(). if (httpCodec != null \u0026\u0026 index + 1 \u003c interceptors.size() \u0026\u0026 next.calls != 1) { throw new IllegalStateException(\"network interceptor \" + interceptor + \" must call proceed() exactly once\"); } // Confirm that the intercepted response isn't null. if (response == null) { throw new NullPointerException(\"interceptor \" + interceptor + \" returned null\"); } if (response.body() == null) { throw new IllegalStateException( \"interceptor \" + interceptor + \" returned a response with no body\"); } return response; } // RetryAndFollowUpInterceptor.java RetryAndFollowUpInterceptor用于请求重连，通过connectionPool // 构建StreamAllocation，StreamAllocation用于管理连接、数据流以及Calls @Override public Response intercept(Chain chain) throws IOException { Request request = chain.request(); RealInterceptorChain realChain = (RealInterceptorChain) chain; Call call = realChain.call(); EventListener eventListener = realChain.eventListener(); StreamAllocation streamAllocation = new StreamAllocation(client.connectionPool(), createAddress(request.url()), call, eventListener, callStackTrace); this.streamAllocation = streamAllocation; int followUpCount = 0; Response priorResponse = null; // 通过while死循环发送request while (true) { if (canceled) { streamAllocation.release(); throw new IOException(\"Canceled\"); } Response response; boolean releaseConnection = true; try { // 这里的realChain交接给BridgeInterceptor response = realChain.proceed(request, streamAllocation, null, null); releaseConnection = false; } catch (RouteException e) { // The attempt to connect via a route failed. The request will not have been sent. if (!recover(e.getLastConnectException(), streamAllocation, false, request)) { throw e.getFirstConnectException(); } releaseConnection = false; continue; } catch (IOException e) { // An attempt to communicate with a server failed. The request may have been sent. boolean requestSendStarted = !(e instanceof ConnectionShutdownException); if (!recover(e, streamAllocation, requestSendStarted, request)) throw e; releaseConnection = false; continue; } finally { // We're throwing an unchecked exception. Release any resources. if (releaseConnection) { streamAllocation.streamFailed(null); streamAllocation.release(); } } // Attach the prior response if it exists. Such responses never have a body. if (priorResponse != null) { response = response.newBuilder() .priorResponse(priorResponse.newBuilder() .body(null) .build()) .build(); } // 仅仅在发送请求后接收到response，并且没有后续的request时返回，返回值为response Request followUp; try { followUp = followUpRequest(response, streamAllocation.route()); } catch (IOException e) { streamAllocation.release(); throw e; } if (followUp == null) { streamAllocation.release(); return response; } closeQuietly(response.body()); if (++followUpCount \u003e MAX_FOLLOW_UPS) { streamAllocation.release(); throw new ProtocolException(\"Too many follow-up requests: \" + followUpCount); } if (followUp.body() instanceof UnrepeatableRequestBody) { streamAllocation.release(); throw new HttpRetryException(\"Cannot retry streamed HTTP body\", response.code()); } if (!sameConnection(response, followUp.url())) { streamAllocation.release(); streamAllocation = new StreamAllocation(client.connectionPool(), createAddress(followUp.url()), call, eventListener, callStackTrace); this.streamAllocation = streamAllocation; } else if (streamAllocation.codec() != null) { throw new IllegalStateException(\"Closing the body of \" + response + \" didn't close its backing stream. Bad interceptor?\"); } request = followUp; priorResponse = response; } } // BridgeInterceptor.java @Override public Response intercept(Chain chain) throws IOException { // 通过chain得到request Request userRequest = chain.request(); Request.Builder requestBuilder = userRequest.newBuilder(); // 拿到body RequestBody body = userRequest.body(); if (body != null) { MediaType contentType = body.contentType(); if (contentType != null) { // 重新构造header requestBuilder.header(\"Content-Type\", contentType.toString()); } long contentLength = body.contentLength(); if (contentLength != -1) { requestBuilder.header(\"Content-Length\", Long.toString(contentLength)); requestBuilder.removeHeader(\"Transfer-Encoding\"); } else { requestBuilder.header(\"Transfer-Encoding\", \"chunked\"); requestBuilder.removeHeader(\"Content-Length\"); } } if (userRequest.header(\"Host\") == null) { requestBuilder.header(\"Host\", hostHeader(userRequest.url(), false)); } if (userRequest.header(\"Connection\") == null) { requestBuilder.header(\"Connection\", \"Keep-Alive\"); } // If we add an \"Accept-Encoding: gzip\" header field we're responsible for also decompressing // the transfer stream. boolean transparentGzip = false; if (userRequest.header(\"Accept-Encoding\") == null \u0026\u0026 userRequest.header(\"Range\") == null) { transparentGzip = true; requestBuilder.header(\"Accept-Encoding\", \"gzip\"); } // 构造带Cookies的header，默认Cookies为空 List\u003cCookie\u003e cookies = cookieJar.loadForRequest(userRequest.url()); if (!cookies.isEmpty()) { requestBuilder.header(\"Cookie\", cookieHeader(cookies)); } if (userRequest.header(\"User-Agent\") == null) { requestBuilder.header(\"User-Agent\", Version.userAgent()); } // 注意这里的chain的index为1，所以再次调用chain.proceed会使index为2，即CacheInterceptor Response networkResponse = chain.proceed(requestBuilder.build()); HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers()); Response.Builder responseBuilder = networkResponse.newBuilder() .request(userRequest); if (transparentGzip \u0026\u0026 \"gzip\".equalsIgnoreCase(networkResponse.header(\"Content-Encoding\")) \u0026\u0026 HttpHeaders.hasBody(networkResponse)) { GzipSource responseBody = new GzipSource(networkResponse.body().source()); Headers strippedHeaders = networkResponse.headers().newBuilder() .removeAll(\"Content-Encoding\") .removeAll(\"Content-Length\") .build(); responseBuilder.headers(strippedHeaders); String contentType = networkResponse.header(\"Content-Type\"); responseBuilder.body(new RealResponseBody(contentType, -1L, Okio.buffer(responseBody))); } return responseBuilder.build(); } // CacheInterceptor.java CacheInterceptor用于从cache中取request以及向cache中写入response // 如果cache中保存了相同request的response，那么可以实现断网也可以获取response @Override public Response intercept(Chain chain) throws IOException { Response cacheCandidate = cache != null ? cache.get(chain.request()) : null; long now = System.currentTimeMillis(); CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(), cacheCandidate).get(); Request networkRequest = strategy.networkRequest; Response cacheResponse = strategy.cacheResponse; if (cache != null) { cache.trackResponse(strategy); } if (cacheCandidate != null \u0026\u0026 cacheResponse == null) { closeQuietly(cacheCandidate.body()); // The cache candidate wasn't applicable. Close it. } // If we're forbidden from using the network and the cache is insufficient, fail. if (networkRequest == null \u0026\u0026 cacheResponse == null) { return new Response.Builder() .request(chain.request()) .protocol(Protocol.HTTP_1_1) .code(504) .message(\"Unsatisfiable Request (only-if-cached)\") .body(Util.EMPTY_RESPONSE) .sentRequestAtMillis(-1L) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); } // 没有网络则从cache中取对应的response // If we don't need the network, we're done. if (networkRequest == null) { return cacheResponse.newBuilder() .cacheResponse(stripBody(cacheResponse)) .build(); } Response networkResponse = null; try { // 注意这里同理chain交接给下一个ConnectInterceptor networkResponse = chain.proceed(networkRequest); } finally { // If we're crashing on I/O or otherwise, don't leak the cache body. if (networkResponse == null \u0026\u0026 cacheCandidate != null) { closeQuietly(cacheCandidate.body()); } } // If we have a cache response too, then we're doing a conditional get. if (cacheResponse != null) { if (networkResponse.code() == HTTP_NOT_MODIFIED) { Response response = cacheResponse.newBuilder() .headers(combine(cacheResponse.headers(), networkResponse.headers())) .sentRequestAtMillis(networkResponse.sentRequestAtMillis()) .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis()) .cacheResponse(stripBody(cacheResponse)) .networkResponse(stripBody(networkResponse)) .build(); networkResponse.body().close(); // Update the cache after combining headers but before stripping the // Content-Encoding header (as performed by initContentStream()). cache.trackConditionalCacheHit(); cache.update(cacheResponse, response); return response; } else { closeQuietly(cacheResponse.body()); } } Response response = networkResponse.newBuilder() .cacheResponse(stripBody(cacheResponse)) .networkResponse(stripBody(networkResponse)) .build(); if (cache != null) { if (HttpHeaders.hasBody(response) \u0026\u0026 CacheStrategy.isCacheable(response, networkRequest)) { // Offer this request to the cache. CacheRequest cacheRequest = cache.put(response); return cacheWritingResponse(cacheRequest, response); } if (HttpMethod.invalidatesCache(networkRequest.method())) { try { cache.remove(networkRequest); } catch (IOException ignored) { // The cache cannot be written. } } } return response; } // ConnectInterceptor.java StreamAllocation在RetryAndFollowUpInterceptor中被构造用于管理连接 // 因此ConnectInterceptor用于创建真实的HTTP连接RealConnection @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; Request request = realChain.request(); StreamAllocation streamAllocation = realChain.streamAllocation(); // We need the network to satisfy this request. Possibly for validating a conditional GET. boolean doExtensiveHealthChecks = !request.method().equals(\"GET\"); HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); RealConnection connection = streamAllocation.connection(); // 同理下一任是CallServerInterceptor，因为networkInterceptors为空 return realChain.proceed(request, streamAllocation, httpCodec, connection); } // CallServerInterceptor.java CallServerInterceptor是最后一任Interceptor，它的功能是发送网络Call到服务器 @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; HttpCodec httpCodec = realChain.httpStream(); StreamAllocation streamAllocation = realChain.streamAllocation(); RealConnection connection = (RealConnection) realChain.connection(); Request request = realChain.request(); long sentRequestMillis = System.currentTimeMillis(); // 将HeadersStart和HeadersEnd通过eventListener传出去 realChain.eventListener().requestHeadersStart(realChain.call()); // 发送请求的方式是通过httpCodec数据流，首先传出去request httpCodec.writeRequestHeaders(request); realChain.eventListener().requestHeadersEnd(realChain.call(), request); // 然后通过httpCodec读取response，其中涉及到request的首部是否包含Expect: 100-continue，不过问题不大 Response.Builder responseBuilder = null; if (HttpMethod.permitsRequestBody(request.method()) \u0026\u0026 request.body() != null) { // If there's a \"Expect: 100-continue\" header on the request, wait for a \"HTTP/1.1 100 // Continue\" response before transmitting the request body. If we don't get that, return // what we did get (such as a 4xx response) without ever transmitting the request body. if (\"100-continue\".equalsIgnoreCase(request.header(\"Expect\"))) { // 如果request的首部包含Expect: 100-continue参数，responseBuilder会被置为null httpCodec.flushRequest(); realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(true); } if (responseBuilder == null) { // Write the request body if the \"Expect: 100-continue\" expectation was met. realChain.eventListener().requestBodyStart(realChain.call()); long contentLength = request.body().contentLength(); // 通过httpCodec创建request数据流，可以通过CountingSink监控数据传输 CountingSink requestBodyOut = new CountingSink(httpCodec.createRequestBody(request, contentLength)); BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut); request.body().writeTo(bufferedRequestBody); bufferedRequestBody.close(); realChain.eventListener() .requestBodyEnd(realChain.call(), requestBodyOut.successfulCount); } else if (!connection.isMultiplexed()) { // If the \"Expect: 100-continue\" expectation wasn't met, prevent the HTTP/1 connection // from being reused. Otherwise we're still obligated to transmit the request body to // leave the connection in a consistent state. streamAllocation.noNewStreams(); } } httpCodec.finishRequest(); if (responseBuilder == null) { realChain.eventListener().responseHeadersStart(realChain.call()); // 通过httpCodec的readResponseHeaders读取response的header信息，此时responseBuilder不为空 responseBuilder = httpCodec.readResponseHeaders(false); } // 通过responseBuilder构建完整的response Response response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); int code = response.code(); if (code == 100) { // server sent a 100-continue even though we did not request one. // try again to read the actual response responseBuilder = httpCodec.readResponseHeaders(false); response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); code = response.code(); } realChain.eventListener() .responseHeadersEnd(realChain.call(), response); if (forWebSocket \u0026\u0026 code == 101) { // Connection is upgrading, but we need to ensure interceptors see a non-null response body. response = response.newBuilder() .body(Util.EMPTY_RESPONSE) .build(); } else { // 通过httpCodec的openResponseBody创建读取response的body的数据流 response = response.newBuilder() .body(httpCodec.openResponseBody(response)) .build(); } if (\"close\".equalsIgnoreCase(response.request().header(\"Connection\")) || \"close\".equalsIgnoreCase(response.header(\"Connection\"))) { streamAllocation.noNewStreams(); } if ((code == 204 || code == 205) \u0026\u0026 response.body().contentLength() \u003e 0) { throw new ProtocolException( \"HTTP \" + code + \" had non-zero Content-Length: \" + response.body().contentLength()); } // 最后返回构建好的response return response; } 以上就是通过call.execute返回response的流程，这里可以发现并没有使用到Service或者多线程，因此在等待服务器响应的过程中会阻塞当前线程，因此Android中不宜直接使用execute方法。\n当我们调用call.enqueue方法时\n@Override public void enqueue(Callback responseCallback) { synchronized (this) { if (executed) throw new IllegalStateException(\"Already Executed\"); executed = true; } captureCallStackTrace(); eventListener.callStart(this); // 通过dispatcher将responseCallback入队 client.dispatcher().enqueue(new AsyncCall(responseCallback)); } // Dispatcher.java void enqueue(AsyncCall call) { synchronized (this) { readyAsyncCalls.add(call); } // 调用promoteAndExecute执行发送请求 promoteAndExecute(); } /** * Promotes eligible calls from {@link #readyAsyncCalls} to {@link #runningAsyncCalls} and runs * them on the executor service. Must not be called with synchronization because executing calls * can call into user code. * * @return true if the dispatcher is currently running calls. */ private boolean promoteAndExecute() { assert (!Thread.holdsLock(this)); List\u003cAsyncCall\u003e executableCalls = new ArrayList\u003c\u003e(); boolean isRunning; synchronized (this) { // 将readyAsyncCalls中的Call加入到executableCalls中 for (Iterator\u003cAsyncCall\u003e i = readyAsyncCalls.iterator(); i.hasNext(); ) { AsyncCall asyncCall = i.next(); if (runningAsyncCalls.size() \u003e= maxRequests) break; // Max capacity. if (runningCallsForHost(asyncCall) \u003e= maxRequestsPerHost) continue; // Host max capacity. i.remove(); executableCalls.add(asyncCall); runningAsyncCalls.add(asyncCall); } isRunning = runningCallsCount() \u003e 0; } for (int i = 0, size = executableCalls.size(); i \u003c size; i++) { AsyncCall asyncCall = executableCalls.get(i); // 通过遍历executableCalls，调用每一个Call的executeOn方法，其中使用到了初始化过程中引入的线程池executorService asyncCall.executeOn(executorService()); } return isRunning; } public synchronized ExecutorService executorService() { if (executorService == null) { executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue\u003cRunnable\u003e(), Util.threadFactory(\"OkHttp Dispatcher\", false)); } return executorService; } /** * Attempt to enqueue this async call on {@code executorService}. This will attempt to clean up * if the executor has been shut down by reporting the call as failed. */ void executeOn(ExecutorService executorService) { assert (!Thread.holdsLock(client.dispatcher())); boolean success = false; try { // 关键代码通过线程池executorService执行此Call，又因为AsyncCall继承自NamedRunnable，因此，调用 // AsyncCall的run方法时，执行的是NamedRunnable的run executorService.execute(this); success = true; } catch (RejectedExecutionException e) { InterruptedIOException ioException = new InterruptedIOException(\"executor rejected\"); ioException.initCause(e); eventListener.callFailed(RealCall.this, ioException); responseCallback.onFailure(RealCall.this, ioException); } finally { if (!success) { client.dispatcher().finished(this); // This call is no longer running! } } } /** * Runnable implementation which always sets its thread name. */ public abstract class NamedRunnable implements Runnable { protected final String name; public NamedRunnable(String format, Object... args) { this.name = Util.format(format, args); } @Override public final void run() { String oldName = Thread.currentThread().getName(); Thread.currentThread().setName(name); try { // 这里的execute由AsyncCall实现 execute(); } finally { Thread.currentThread().setName(oldName); } } protected abstract void execute(); } @Override protected void execute() { boolean signalledCallback = false; timeout.enter(); try { // 最终又回到了getResponseWithInterceptorChain方法，后面的不用多说 Response response = getResponseWithInterceptorChain(); if (retryAndFollowUpInterceptor.isCanceled()) { signalledCallback = true; // 与此同时我们通过responseCallback.onFailure将事件回调出去 responseCallback.onFailure(RealCall.this, new IOException(\"Canceled\")); } else { signalledCallback = true; // 同上 responseCallback.onResponse(RealCall.this, response); } } catch (IOException e) { e = timeoutExit(e); if (signalledCallback) { // Do not signal the callback twice! Platform.get().log(INFO, \"Callback failure for \" + toLoggableString(), e); } else { eventListener.callFailed(RealCall.this, e); responseCallback.onFailure(RealCall.this, e); } } finally { client.dispatcher().finished(this); } } } 综上，OkHttp的源码中采用了非常多的有意思的设计模式，比如建造者模式，对于HTTP请求来说，我们需要一些公用的资源比如线程池、连接池等，将这些公共资源设置在OkHttpClient中，然后通过单例模式引用，节省了很多资源消耗；\n对于RequestBody以及Request这种参数设置非常多的实体，通过建造者模式保存其参数；\n在构建请求实体Call的时候采用了OkHttpClient工厂类，同时发送request的过程中利用了链式传递的方式，既增加了开发人员自定义的Interceptor，又可以利用原本定义好的Interceptor。\n3. Retrofit Retrofit也是一个网络请求框架，且Retrofit是基于OkHttp的，实际网络请求的功能由OkHttp来实现，但是Retrofit实现了额外的功能，比如利用Gson进行数据实体化、兼容RxJava等等，是一个比较流行的网络请求工具。\n3.1 Retrofit使用 需要implementation 'com.squareup.retrofit2:retrofit:2.6.0'\n以请求和风天气数据为例，通过GET请求，加上location参数和key参数，服务器返回json数据，我们将json数据实体化，首先看一下返回的json格式\n{ \"HeWeather6\": [ { \"basic\": { \"cid\": \"CN101010100\", \"location\": \"北京\", \"parent_city\": \"北京\", \"admin_area\": \"北京\", \"cnty\": \"中国\", \"lat\": \"39.90498734\", \"lon\": \"116.4052887\", \"tz\": \"+8.00\" }, \"update\": { \"loc\": \"2019-07-18 16:45\", \"utc\": \"2019-07-18 08:45\" }, \"status\": \"ok\", \"now\": { \"cloud\": \"10\", \"cond_code\": \"101\", \"cond_txt\": \"多云\", \"fl\": \"35\", \"hum\": \"54\", \"pcpn\": \"0.0\", \"pres\": \"1000\", \"tmp\": \"32\", \"vis\": \"6\", \"wind_deg\": \"279\", \"wind_dir\": \"西风\", \"wind_sc\": \"1\", \"wind_spd\": \"3\" } } ] } 1.根据json数据构建我们的实体类WeatherEntity，这里使用的Android Studio的插件GsonFormat，可以直接根据json数据生成代码\npublic class WeatherEntity { private List\u003cHeWeather6Bean\u003e HeWeather6; public List\u003cHeWeather6Bean\u003e getHeWeather6() { return HeWeather6; } public void setHeWeather6(List\u003cHeWeather6Bean\u003e HeWeather6) { this.HeWeather6 = HeWeather6; } // 重写以下toString方法，便于后续观察数据传输是否正确 @NonNull @Override public String toString() { return HeWeather6.get(0).toString(); } public static class HeWeather6Bean { /** * basic : {\"cid\":\"CN101010100\",\"location\":\"北京\",\"parent_city\":\"北京\",\"admin_area\":\"北京\",\"cnty\":\"中国\",\"lat\":\"39.90498734\",\"lon\":\"116.4052887\",\"tz\":\"+8.00\"} * update : {\"loc\":\"2019-07-18 16:45\",\"utc\":\"2019-07-18 08:45\"} * status : ok * now : {\"cloud\":\"10\",\"cond_code\":\"101\",\"cond_txt\":\"多云\",\"fl\":\"35\",\"hum\":\"54\",\"pcpn\":\"0.0\",\"pres\":\"1000\",\"tmp\":\"32\",\"vis\":\"6\",\"wind_deg\":\"279\",\"wind_dir\":\"西风\",\"wind_sc\":\"1\",\"wind_spd\":\"3\"} */ private BasicBean basic; private UpdateBean update; private String status; private NowBean now; @NonNull @Override public String toString() { return status + \" \\n \" + basic.toString() + \" \\n \" + update.toString() + \" \\n \" + now.toString(); } public BasicBean getBasic() { return basic; } public void setBasic(BasicBean basic) { this.basic = basic; } public UpdateBean getUpdate() { return update; } public void setUpdate(UpdateBean update) { this.update = update; } public String getStatus() { return status; } public void setStatus(String status) { this.status = status; } public NowBean getNow() { return now; } public void setNow(NowBean now) { this.now = now; } public static class BasicBean { /** * cid : CN101010100 * location : 北京 * parent_city : 北京 * admin_area : 北京 * cnty : 中国 * lat : 39.90498734 * lon : 116.4052887 * tz : +8.00 */ private String cid; private String location; private String parent_city; private String admin_area; private String cnty; private String lat; private String lon; private String tz; @NonNull @Override public String toString() { return \"cid : \" + cid + \"\\n\" + \"location : \" + location + \"\\n\" + \"parent_city : \" + parent_city + \"\\n\" + \"admin_area : \" + admin_area + \"\\n\" + \"cnty : \" + cnty + \"\\n\" + \"lat : \" + lat + \"\\n\" + \"lon : \" + lon + \"\\n\" + \"tz : \" + tz + \"\\n\"; } public String getCid() { return cid; } public void setCid(String cid) { this.cid = cid; } public String getLocation() { return location; } public void setLocation(String location) { this.location = location; } public String getParent_city() { return parent_city; } public void setParent_city(String parent_city) { this.parent_city = parent_city; } public String getAdmin_area() { return admin_area; } public void setAdmin_area(String admin_area) { this.admin_area = admin_area; } public String getCnty() { return cnty; } public void setCnty(String cnty) { this.cnty = cnty; } public String getLat() { return lat; } public void setLat(String lat) { this.lat = lat; } public String getLon() { return lon; } public void setLon(String lon) { this.lon = lon; } public String getTz() { return tz; } public void setTz(String tz) { this.tz = tz; } } public static class UpdateBean { /** * loc : 2019-07-18 16:45 * utc : 2019-07-18 08:45 */ private String loc; private String utc; @NonNull @Override public String toString() { return \"loc : \" + loc + \"\\n\" + \"utc : \" + utc + \"\\n\"; } public String getLoc() { return loc; } public void setLoc(String loc) { this.loc = loc; } public String getUtc() { return utc; } public void setUtc(String utc) { this.utc = utc; } } public static class NowBean { /** * cloud : 10 * cond_code : 101 * cond_txt : 多云 * fl : 35 * hum : 54 * pcpn : 0.0 * pres : 1000 * tmp : 32 * vis : 6 * wind_deg : 279 * wind_dir : 西风 * wind_sc : 1 * wind_spd : 3 */ private String cloud; private String cond_code; private String cond_txt; private String fl; private String hum; private String pcpn; private String pres; private String tmp; private String vis; private String wind_deg; private String wind_dir; private String wind_sc; private String wind_spd; @NonNull @Override public String toString() { return \"cloud : \" + cloud + \"\\n\" + \"cond_code : \" + cond_code + \"\\n\" + \"cond_txt : \" + cond_txt + \"\\n\" + \"fl : \" + fl + \"\\n\" + \"hum : \" + hum + \"\\n\" + \"pcpn : \" + pcpn + \"\\n\" + \"pres : \" + pres + \"\\n\" + \"tmp : \" + tmp + \"\\n\" + \"vis : \" + vis + \"\\n\" + \"wind_deg : \" + wind_deg + \"\\n\" + \"wind_dir : \" + wind_dir + \"\\n\" + \"wind_sc : \" + wind_sc + \"\\n\" + \"wind_spd : \" + wind_spd + \"\\n\"; } public String getCloud() { return cloud; } public void setCloud(String cloud) { this.cloud = cloud; } public String getCond_code() { return cond_code; } public void setCond_code(String cond_code) { this.cond_code = cond_code; } public String getCond_txt() { return cond_txt; } public void setCond_txt(String cond_txt) { this.cond_txt = cond_txt; } public String getFl() { return fl; } public void setFl(String fl) { this.fl = fl; } public String getHum() { return hum; } public void setHum(String hum) { this.hum = hum; } public String getPcpn() { return pcpn; } public void setPcpn(String pcpn) { this.pcpn = pcpn; } public String getPres() { return pres; } public void setPres(String pres) { this.pres = pres; } public String getTmp() { return tmp; } public void setTmp(String tmp) { this.tmp = tmp; } public String getVis() { return vis; } public void setVis(String vis) { this.vis = vis; } public String getWind_deg() { return wind_deg; } public void setWind_deg(String wind_deg) { this.wind_deg = wind_deg; } public String getWind_dir() { return wind_dir; } public void setWind_dir(String wind_dir) { this.wind_dir = wind_dir; } public String getWind_sc() { return wind_sc; } public void setWind_sc(String wind_sc) { this.wind_sc = wind_sc; } public String getWind_spd() { return wind_spd; } public void setWind_spd(String wind_spd) { this.wind_spd = wind_spd; } } } } 2.构建请求Api，请求url格式为https://free-api.heweather.net/s6/weather/now?location=beijing\u0026key=xxx，因此将https://free-api.heweather.net/s6/weather/作为baseUrl（baseUrl必须以/结尾），now?作为请求url主体，后面的两个作为参数通过@Query加入\npublic interface Api { // 通过@Query(\"location\")的方式可以自动将location=location连接到我们的请求url后面 @GET(\"now?\") Call\u003cWeatherEntity\u003e getNowWeather(@Query(\"location\") String location, @Query(\"key\") String key); // 如果需要使用RxJava，需要修改返回类型为Observable // @GET(\"now?\") // Observable getNowWeather(@Query(\"location\") String location, @Query(\"key\") String key); } 3.构建Retrofit实体，需要implementation 'com.squareup.retrofit2:converter-gson:2.6.0'，这里的版本号和Retrofit相同即可，如果需要RxJava2，则添加implementation 'com.squareup.retrofit2:adapter-rxjava2:2.6.0'\nRetrofit retrofit = new Retrofit.Builder() .baseUrl(URL) // 设置网络请求的公共Url地址 .addConverterFactory(GsonConverterFactory.create()) // 设置数据解析器Gson // .addCallAdapterFactory(RxJava2CallAdapterFactory.create()) // 如果需要使用RxJava2 .build(); 4.构造接口实体\nApi api = retrofit.create(Api.class); 5.构造Call，这里的Call是retrofit2的Call，与okHttp的Call还是不一样的，如果是使用RxJava2，则为Observable\nretrofit2.Call\u003cWeatherEntity\u003e call = api.getNowWeather(\"beijing\", KEY); // Observable observable = api.getNowWeather(\"beijing\", KEY); 6.调用call.enqueue发送请求\ncall.enqueue(new retrofit2.Callback\u003cWeatherEntity\u003e() { @Override public void onResponse(retrofit2.Call\u003cWeatherEntity\u003e call, retrofit2.Response\u003cWeatherEntity\u003e response) { WeatherEntity entity = response.body(); textView.setText(entity.toString()); } @Override public void onFailure(retrofit2.Call\u003cWeatherEntity\u003e call, Throwable t) { } }); // 如果是RxJava则按照设计在io线程请求数据，在mainThread主线程显示结果 // observable.subscribeOn(Schedulers.io()) // .observeOn(AndroidSchedulers.mainThread()) // .subscribe(new Consumer() { // @Override // public void accept(WeatherEntity weatherEntity) throws Exception { // } // }, new Consumer() { // @Override // public void accept(Throwable throwable) throws Exception { // } // }); 3.2 Retrofit源码分析 Retrofit也采用了建造者模式，通过new Retrofit.Builder()初始化Retrofit对象\n// Retrofit.java 这里初始化Retrofit对象的时候需要参数Platform，看来是和平台相关 // 我们直到OkHttp是Java和Android相同都可以使用的，但是OkHttp没有做平台判断， // Retrofit需要平台判断应该是与后面一些功能相关 public Builder() { this(Platform.get()); } // -------------------------------------------------------------------------- // Platform.java private static final Platform PLATFORM = findPlatform(); static Platform get() { return PLATFORM; } // 通过findPlatform获取平台信息 private static Platform findPlatform() { try { // 判断的方式简单粗暴，直接通过Class.forName找系统的类，通过抛出异常终止，妙啊妙啊 Class.forName(\"android.os.Build\"); if (Build.VERSION.SDK_INT != 0) { // 这里只看Android类 return new Android(); } } catch (ClassNotFoundException ignored) { } try { // 同理对Java平台 Class.forName(\"java.util.Optional\"); return new Java8(); } catch (ClassNotFoundException ignored) { } return new Platform(); } // Android继承自Platform static class Android extends Platform { @IgnoreJRERequirement // Guarded by API check. @Override boolean isDefaultMethod(Method method) { if (Build.VERSION.SDK_INT \u003c 24) { return false; } return method.isDefault(); } // defaultCallbackExecutor返回了MainThreadExecutor，Executor是一个接口， // 实现此接口的类需要完成execute方法，通过execute方法可以运行Runnable对象 @Override public Executor defaultCallbackExecutor() { return new MainThreadExecutor(); } // 两个关键的类CallAdapter和Converter，CallAdapter用于转换Call的类型，以RxJava2CallAdapterFactory为例， // 如果在构造Retrofit对象时加上了addCallAdapterFactory(RxJava2CallAdapterFactory.create())， // 则需要对Api类中的方法返回值类型进行修改，改为RxJava支持的Observable类型，然后就可以通过RxJava的方式发送请求； // Converter用于对Response的Body进行格式转换，以GsonConverterFactory为例，可以将Response的Body中的json数据实体化， // 直接转换为我们定义的对象。 @Override List\u003c? extends CallAdapter.Factory\u003e defaultCallAdapterFactories( @Nullable Executor callbackExecutor) { if (callbackExecutor == null) throw new AssertionError(); // 根据BuildSDKVersion决定用DefaultCallAdapterFactory还是CompletableFutureCallAdapterFactory // 暂时用不到，稍后再分析 DefaultCallAdapterFactory executorFactory = new DefaultCallAdapterFactory(callbackExecutor); return Build.VERSION.SDK_INT \u003e= 24 ? asList(CompletableFutureCallAdapterFactory.INSTANCE, executorFactory) : singletonList(executorFactory); } @Override int defaultCallAdapterFactoriesSize() { return Build.VERSION.SDK_INT \u003e= 24 ? 2 : 1; } @Override List\u003c? extends Converter.Factory\u003e defaultConverterFactories() { // 同CallAdapter return Build.VERSION.SDK_INT \u003e= 24 ? singletonList(OptionalConverterFactory.INSTANCE) : Collections.\u003cConverter.Factory\u003eemptyList(); } @Override int defaultConverterFactoriesSize() { return Build.VERSION.SDK_INT \u003e= 24 ? 1 : 0; } // MainThreadExecutor实现了Executor接口，通过主线程的Handler运行Runnable对象 static class MainThreadExecutor implements Executor { private final Handler handler = new Handler(Looper.getMainLooper()); @Override public void execute(Runnable r) { handler.post(r); } } } // -------------------------------------------------------------------------- // Retrofit.java Retrofit初始化仅保存了平台信息 Builder(Platform platform) { this.platform = platform; } // 然后是baseUrl方法 /** * Set the API base URL. * * @see #baseUrl(HttpUrl) */ public Builder baseUrl(String baseUrl) { checkNotNull(baseUrl, \"baseUrl == null\"); return baseUrl(HttpUrl.get(baseUrl)); } // 对baseUrl的格式进行判断，必须以 / 结尾，否则抛出异常 public Builder baseUrl(HttpUrl baseUrl) { checkNotNull(baseUrl, \"baseUrl == null\"); List\u003cString\u003e pathSegments = baseUrl.pathSegments(); if (!\"\".equals(pathSegments.get(pathSegments.size() - 1))) { throw new IllegalArgumentException(\"baseUrl must end in /: \" + baseUrl); } this.baseUrl = baseUrl; return this; } // 接下来是addConverterFactory方法，看起没有什么复杂的功能，只是将Converter.Factory的实现加入了list中， // 我们稍后再看GsonConverterFactory的源码 private final List\u003cConverter.Factory\u003e converterFactories = new ArrayList\u003c\u003e(); /** Add converter factory for serialization and deserialization of objects. */ public Builder addConverterFactory(Converter.Factory factory) { converterFactories.add(checkNotNull(factory, \"factory == null\")); return this; } // 最后是build方法 /** * Create the {@link Retrofit} instance using the configured values. * * Note: If neither {@link #client} nor {@link #callFactory} is called a default {@link * OkHttpClient} will be created and used. */ public Retrofit build() { if (baseUrl == null) { throw new IllegalStateException(\"Base URL required.\"); } // 注意这里初始化了一个OkHttpClient对象 okhttp3.Call.Factory callFactory = this.callFactory; if (callFactory == null) { callFactory = new OkHttpClient(); } Executor callbackExecutor = this.callbackExecutor; if (callbackExecutor == null) { // 我们知道默认情况下，在Android平台，这个callbackExecutor是主线程的Executor callbackExecutor = platform.defaultCallbackExecutor(); } // Make a defensive copy of the adapters and add the default Call adapter. // callAdapterFactories包括通过Retrofit初始化调用addCallAdapterFactory加入的CallAdapter.Factory， // 还包括Android平台默认的platform.defaultCallAdapterFactories List\u003cCallAdapter.Factory\u003e callAdapterFactories = new ArrayList\u003c\u003e(this.callAdapterFactories); callAdapterFactories.addAll(platform.defaultCallAdapterFactories(callbackExecutor)); // Make a defensive copy of the converters. // converterFactories同理，但是多一个BuiltInConverters，暂时不去管不同的Converter的具体实现 List\u003cConverter.Factory\u003e converterFactories = new ArrayList\u003c\u003e( 1 + this.converterFactories.size() + platform.defaultConverterFactoriesSize()); // Add the built-in converter factory first. This prevents overriding its behavior but also // ensures correct behavior when using converters that consume all types. converterFactories.add(new BuiltInConverters()); converterFactories.addAll(this.converterFactories); converterFactories.addAll(platform.defaultConverterFactories()); // 最后完成了Retrofit对象的初始化，引入了几个参数，包括OkHttpClient对象，baseUrl，CallAdapter， // Converter以及Executor，validateEagerly默认为false return new Retrofit(callFactory, baseUrl, unmodifiableList(converterFactories), unmodifiableList(callAdapterFactories), callbackExecutor, validateEagerly); } 接下来是Api api = retrofit.create(Api.class);，Retrofit通过调用create方法将接口类实例化\n@SuppressWarnings(\"unchecked\") // Single-interface proxy creation guarded by parameter safety. public \u003cT\u003e T create(final Class\u003cT\u003e service) { // validateServiceInterface主要判断service是否为接口且没有继承自其他接口 Utils.validateServiceInterface(service); // validateEagerly为false if (validateEagerly) { eagerlyValidateMethods(service); } // 通过代理的方式反射接口，将其实例化 return (T) Proxy.newProxyInstance(service.getClassLoader(), new Class\u003c?\u003e[] { service }, new InvocationHandler() { // 这里不同的平台有不同的方式 private final Platform platform = Platform.get(); private final Object[] emptyArgs = new Object[0]; @Override public @Nullable Object invoke(Object proxy, Method method, @Nullable Object[] args) throws Throwable { // If the method is a method from Object then defer to normal invocation. // 这里的invoke，Object方法都走这里，比如equals、toString、hashCode什么的 if (method.getDeclaringClass() == Object.class) { return method.invoke(this, args); } // 如果是Java Web项目则通过platform.invokeDefaultMethod if (platform.isDefaultMethod(method)) { return platform.invokeDefaultMethod(method, service, proxy, args); } // 如果是Android则通过loadServiceMethod return loadServiceMethod(method).invoke(args != null ? args : emptyArgs); } }); } private void eagerlyValidateMethods(Class\u003c?\u003e service) { Platform platform = Platform.get(); for (Method method : service.getDeclaredMethods()) { if (!platform.isDefaultMethod(method) \u0026\u0026 !Modifier.isStatic(method.getModifiers())) { loadServiceMethod(method); } } } ServiceMethod\u003c?\u003e loadServiceMethod(Method method) { ServiceMethod\u003c?\u003e result = serviceMethodCache.get(method); if (result != null) return result; // 默认result为空，通过单例模式取result，简而言之就是得到接口里面定义的方法 // 并且在方法被调用的时候将参数传入，从而得到结果 synchronized (serviceMethodCache) { result = serviceMethodCache.get(method); if (result == null) { // result = ServiceMethod.parseAnnotations(this, method); serviceMethodCache.put(method, result); } } return result; } // -------------------------------------------------------------------------- // ServiceMethod.java abstract class ServiceMethod\u003cT\u003e { // parseAnnotations还是通过RequestFactory解析接口的方法，因为我们定义的方法是包含注解的，所以必定需要通过 // 解析注解的值来控制方法的参数 static \u003cT\u003e ServiceMethod\u003cT\u003e parseAnnotations(Retrofit retrofit, Method method) { // RequestFactory看名字就知道应该和构建HTTP请求相关，应该是将retrofit定义的baseUrl等信息以及接口定义的方法， // 包括注解里的信息整合 RequestFactory requestFactory = RequestFactory.parseAnnotations(retrofit, method); Type returnType = method.getGenericReturnType(); if (Utils.hasUnresolvableType(returnType)) { throw methodError(method, \"Method return type must not include a type variable or wildcard: %s\", returnType); } if (returnType == void.class) { throw methodError(method, \"Service methods cannot return void.\"); } // HttpServiceMethod继承自ServiceMethod，实现invoke方法，即最终我们调用接口中的方式时将参数传入 return HttpServiceMethod.parseAnnotations(retrofit, method, requestFactory); } abstract @Nullable T invoke(Object[] args); } // -------------------------------------------------------------------------- // RequestFactory.java static RequestFactory parseAnnotations(Retrofit retrofit, Method method) { return new Builder(retrofit, method).build(); } // build方法构建的实例 RequestFactory build() { for (Annotation annotation : methodAnnotations) { // 在parseMethodAnnotation中处理接口方法的注解，这里仅保存了请求方法以及 // 方法注解中的value parseMethodAnnotation(annotation); } if (httpMethod == null) { throw methodError(method, \"HTTP method annotation is required (e.g., @GET, @POST, etc.).\"); } if (!hasBody) { if (isMultipart) { throw methodError(method, \"Multipart can only be specified on HTTP methods with request body (e.g., @POST).\"); } if (isFormEncoded) { throw methodError(method, \"FormUrlEncoded can only be specified on HTTP methods with \" + \"request body (e.g., @POST).\"); } } // parameterAnnotationsArray是通过Method传过来的，简单来说就是方法的参数注解， // 即我们使用的@Query(\"location\")和@Query(\"key\") int parameterCount = parameterAnnotationsArray.length; parameterHandlers = new ParameterHandler\u003c?\u003e[parameterCount]; for (int p = 0, lastParameter = parameterCount - 1; p \u003c parameterCount; p++) { // 通过parseParameter方法处理参数注解，并保存在parameterHandlers中 parameterHandlers[p] = parseParameter(p, parameterTypes[p], parameterAnnotationsArray[p], p == lastParameter); } if (relativeUrl == null \u0026\u0026 !gotUrl) { throw methodError(method, \"Missing either @%s URL or @Url parameter.\", httpMethod); } if (!isFormEncoded \u0026\u0026 !isMultipart \u0026\u0026 !hasBody \u0026\u0026 gotBody) { throw methodError(method, \"Non-body HTTP method cannot contain @Body.\"); } if (isFormEncoded \u0026\u0026 !gotField) { throw methodError(method, \"Form-encoded method must contain at least one @Field.\"); } if (isMultipart \u0026\u0026 !gotPart) { throw methodError(method, \"Multipart method must contain at least one @Part.\"); } return new RequestFactory(this); } // parseMethodAnnotation处理的是方法注解即 @GET(\"now?\") ，now?作为value // 根据不同的注解类型，构造不同的请求方法 private void parseMethodAnnotation(Annotation annotation) { if (annotation instanceof DELETE) { parseHttpMethodAndPath(\"DELETE\", ((DELETE) annotation).value(), false); } else if (annotation instanceof GET) { parseHttpMethodAndPath(\"GET\", ((GET) annotation).value(), false); } else if (annotation instanceof HEAD) { parseHttpMethodAndPath(\"HEAD\", ((HEAD) annotation).value(), false); } else if (annotation instanceof PATCH) { parseHttpMethodAndPath(\"PATCH\", ((PATCH) annotation).value(), true); } else if (annotation instanceof POST) { parseHttpMethodAndPath(\"POST\", ((POST) annotation).value(), true); } else if (annotation instanceof PUT) { parseHttpMethodAndPath(\"PUT\", ((PUT) annotation).value(), true); } else if (annotation instanceof OPTIONS) { parseHttpMethodAndPath(\"OPTIONS\", ((OPTIONS) annotation).value(), false); } else if (annotation instanceof HTTP) { HTTP http = (HTTP) annotation; parseHttpMethodAndPath(http.method(), http.path(), http.hasBody()); } else if (annotation instanceof retrofit2.http.Headers) { String[] headersToParse = ((retrofit2.http.Headers) annotation).value(); if (headersToParse.length == 0) { throw methodError(method, \"@Headers annotation is empty.\"); } headers = parseHeaders(headersToParse); } else if (annotation instanceof Multipart) { if (isFormEncoded) { throw methodError(method, \"Only one encoding annotation is allowed.\"); } isMultipart = true; } else if (annotation instanceof FormUrlEncoded) { if (isMultipart) { throw methodError(method, \"Only one encoding annotation is allowed.\"); } isFormEncoded = true; } } private void parseHttpMethodAndPath(String httpMethod, String value, boolean hasBody) { if (this.httpMethod != null) { throw methodError(method, \"Only one HTTP method is allowed. Found: %s and %s.\", this.httpMethod, httpMethod); } // 保存了请求方法 this.httpMethod = httpMethod; this.hasBody = hasBody; if (value.isEmpty()) { return; } // Get the relative URL path and existing query string, if present. // 这里的判断是确保@GET(\"now?location={location}\u0026key={key}\")其中的location={location}\u0026key={key}不会出现， // 因为需要通过@Query注解构建，所以这里不允许使用 int question = value.indexOf('?'); if (question != -1 \u0026\u0026 question \u003c value.length() - 1) { // Ensure the query string does not have any named parameters. String queryParams = value.substring(question + 1); Matcher queryParamMatcher = PARAM_URL_REGEX.matcher(queryParams); if (queryParamMatcher.find()) { throw methodError(method, \"URL query string \\\"%s\\\" must not have replace block. \" + \"For dynamic query parameters use @Query.\", queryParams); } } this.relativeUrl = value; this.relativeUrlParamNames = parsePathParameters(value); } // parseParameter方法，对于同一个参数似乎可以使用多个参数注解Annotation[] annotations private @Nullable ParameterHandler\u003c?\u003e parseParameter( int p, Type parameterType, @Nullable Annotation[] annotations, boolean allowContinuation) { ParameterHandler\u003c?\u003e result = null; if (annotations != null) { for (Annotation annotation : annotations) { // 调用parseParameterAnnotation对参数注解进行处理，其中还包括传入的参数类型parameterType ParameterHandler\u003c?\u003e annotationAction = parseParameterAnnotation(p, parameterType, annotations, annotation); if (annotationAction == null) { continue; } if (result != null) { throw parameterError(method, p, \"Multiple Retrofit annotations found, only one allowed.\"); } result = annotationAction; } } if (result == null) { if (allowContinuation) { try { if (Utils.getRawType(parameterType) == Continuation.class) { isKotlinSuspendFunction = true; return null; } } catch (NoClassDefFoundError ignored) { } } throw parameterError(method, p, \"No Retrofit annotation found.\"); } return result; } // parseParameterAnnotation方法，这里判断参数注解的类型，我们只看@Query @Nullable private ParameterHandler\u003c?\u003e parseParameterAnnotation( int p, Type type, Annotation[] annotations, Annotation annotation) { if (annotation instanceof Url) { // ... } else if (annotation instanceof Path) { // ... } else if (annotation instanceof Query) { validateResolvableType(p, type); Query query = (Query) annotation; String name = query.value(); boolean encoded = query.encoded(); Class\u003c?\u003e rawParameterType = Utils.getRawType(type); gotQuery = true; // 判断参数类型是否为可迭代类或者Array类，目前我们的参数是String，所以直接到最后一个条件 if (Iterable.class.isAssignableFrom(rawParameterType)) { if (!(type instanceof ParameterizedType)) { throw parameterError(method, p, rawParameterType.getSimpleName() + \" must include generic type (e.g., \" + rawParameterType.getSimpleName() + \")\"); } ParameterizedType parameterizedType = (ParameterizedType) type; Type iterableType = Utils.getParameterUpperBound(0, parameterizedType); Converter\u003c?, String\u003e converter = retrofit.stringConverter(iterableType, annotations); return new ParameterHandler.Query\u003c\u003e(name, converter, encoded).iterable(); } else if (rawParameterType.isArray()) { Class\u003c?\u003e arrayComponentType = boxIfPrimitive(rawParameterType.getComponentType()); Converter\u003c?, String\u003e converter = retrofit.stringConverter(arrayComponentType, annotations); return new ParameterHandler.Query\u003c\u003e(name, converter, encoded).array(); } else { // 这里调用了retrofit.stringConverter方法，将参数类型和注解进行处理， // 这里ParameterHandler.Query\u003c\u003e保存了参数注解的value、Converter以及参数注解的编码方式 Converter\u003c?, String\u003e converter = retrofit.stringConverter(type, annotations); return new ParameterHandler.Query\u003c\u003e(name, converter, encoded); } } // ... return null; // Not a Retrofit annotation. } // -------------------------------------------------------------------------- // Retrofit.java stringConverter通过遍历converterFactories，调用它们的stringConverter方法， // 看谁能够处理并返回一个Converter，如果都没有则调用BuiltInConverters， // 而Converter是用于构造HTTP请求 /** * Returns a {@link Converter} for {@code type} to {@link String} from the available * {@linkplain #converterFactories() factories}. */ public \u003cT\u003e Converter\u003cT, String\u003e stringConverter(Type type, Annotation[] annotations) { checkNotNull(type, \"type == null\"); checkNotNull(annotations, \"annotations == null\"); for (int i = 0, count = converterFactories.size(); i \u003c count; i++) { Converter\u003c?, String\u003e converter = converterFactories.get(i).stringConverter(type, annotations, this); if (converter != null) { //noinspection unchecked return (Converter\u003cT, String\u003e) converter; } } // Nothing matched. Resort to default converter which just calls toString(). //noinspection unchecked return (Converter\u003cT, String\u003e) BuiltInConverters.ToStringConverter.INSTANCE; } 以上的代码完成了RequestFactory的构建，也就是说，这个RequestFactory包含了HTTP请求的部分信息，比如请求方法、请求url的参数、参数类型以及参数的位置，通过HttpServiceMethod.parseAnnotations(retrofit, method, requestFactory);对请求进行适配，包括通过Converter对返回的Response body数据处理以及通过CallAdapter修改Call类型\n// HttpServiceMethod.java HttpServiceMethod继承自ServiceMethod /** * Inspects the annotations on an interface method to construct a reusable service method that * speaks HTTP. This requires potentially-expensive reflection so it is best to build each service * method only once and reuse it. */ static \u003cResponseT, ReturnT\u003e HttpServiceMethod\u003cResponseT, ReturnT\u003e parseAnnotations( Retrofit retrofit, Method method, RequestFactory requestFactory) { boolean isKotlinSuspendFunction = requestFactory.isKotlinSuspendFunction; boolean continuationWantsResponse = false; boolean continuationBodyNullable = false; Annotation[] annotations = method.getAnnotations(); Type adapterType; if (isKotlinSuspendFunction) { Type[] parameterTypes = method.getGenericParameterTypes(); Type responseType = Utils.getParameterLowerBound(0, (ParameterizedType) parameterTypes[parameterTypes.length - 1]); if (getRawType(responseType) == Response.class \u0026\u0026 responseType instanceof ParameterizedType) { // Unwrap the actual body type from Response. responseType = Utils.getParameterUpperBound(0, (ParameterizedType) responseType); continuationWantsResponse = true; } else { // TODO figure out if type is nullable or not // Metadata metadata = method.getDeclaringClass().getAnnotation(Metadata.class) // Find the entry for method // Determine if return type is nullable or not } adapterType = new Utils.ParameterizedTypeImpl(null, Call.class, responseType); annotations = SkipCallbackExecutorImpl.ensurePresent(annotations); } else { adapterType = method.getGenericReturnType(); } CallAdapter\u003cResponseT, ReturnT\u003e callAdapter = createCallAdapter(retrofit, method, adapterType, annotations); Type responseType = callAdapter.responseType(); if (responseType == okhttp3.Response.class) { throw methodError(method, \"'\" + getRawType(responseType).getName() + \"' is not a valid response body type. Did you mean ResponseBody?\"); } if (responseType == Response.class) { throw methodError(method, \"Response must include generic type (e.g., Response)\"); } // TODO support Unit for Kotlin? if (requestFactory.httpMethod.equals(\"HEAD\") \u0026\u0026 !Void.class.equals(responseType)) { throw methodError(method, \"HEAD method must use Void as response type.\"); } Converter\u003cResponseBody, ResponseT\u003e responseConverter = createResponseConverter(retrofit, method, responseType); okhttp3.Call.Factory callFactory = retrofit.callFactory; // isKotlinSuspendFunction和continuationWantsResponse默认为false，所以返回的是SuspendForBody if (!isKotlinSuspendFunction) { return new CallAdapted\u003c\u003e(requestFactory, callFactory, responseConverter, callAdapter); } else if (continuationWantsResponse) { //noinspection unchecked Kotlin compiler guarantees ReturnT to be Object. return (HttpServiceMethod\u003cResponseT, ReturnT\u003e) new SuspendForResponse\u003c\u003e(requestFactory, callFactory, responseConverter, (CallAdapter\u003cResponseT, Call\u003cResponseT\u003e\u003e) callAdapter); } else { //noinspection unchecked Kotlin compiler guarantees ReturnT to be Object. return (HttpServiceMethod\u003cResponseT, ReturnT\u003e) new SuspendForBody\u003c\u003e(requestFactory, callFactory, responseConverter, (CallAdapter\u003cResponseT, Call\u003cResponseT\u003e\u003e) callAdapter, continuationBodyNullable); } } // Retrofit的create方法调用了loadServiceMethod(method).invoke(args != null ? args : emptyArgs); // 此处的invoke即HttpServiceMethod的invoke方法，这里创建了OkHttpCall， // 此处的adapt即SuspendForBody的adapt方法，而SuspendForBody的adapt方法调用了callAdapter的adapt方法， // 最终回到了我们在Retrofit初始化时使用的DefaultCallAdapterFactory的adapt方法，如果我们使用其他callAdapter， // 比如RxJava2CallAdapterFactory，那么返回值就是RxJava2CallAdapterFactory的adapt方法的返回值 @Override final @Nullable ReturnT invoke(Object[] args) { Call\u003cResponseT\u003e call = new OkHttpCall\u003c\u003e(requestFactory, args, callFactory, responseConverter); return adapt(call, args); } // DefaultCallAdapterFactory.java 返回了一个Call ExecutorCallbackCall @Override public Call\u003cObject\u003e adapt(Call\u003cObject\u003e call) { return executor == null ? call : new ExecutorCallbackCall\u003c\u003e(executor, call); } static final class ExecutorCallbackCall\u003cT\u003e implements Call\u003cT\u003e { final Executor callbackExecutor; final Call\u003cT\u003e delegate; ExecutorCallbackCall(Executor callbackExecutor, Call\u003cT\u003e delegate) { this.callbackExecutor = callbackExecutor; this.delegate = delegate; } // ExecutorCallbackCall是通过callbackExecutor执行Runnable，还记得在Platform类中的Android内部类的默认Executor吗， // MainThreadExecutor，所以后续调用call.enqueue时都是在这里处理的，而且delegate为OkHttpCall，OkHttpCall执行enqueue @Override public void enqueue(final Callback\u003cT\u003e callback) { checkNotNull(callback, \"callback == null\"); delegate.enqueue(new Callback\u003cT\u003e() { @Override public void onResponse(Call\u003cT\u003e call, final Response\u003cT\u003e response) { callbackExecutor.execute(new Runnable() { @Override public void run() { if (delegate.isCanceled()) { // Emulate OkHttp's behavior of throwing/delivering an IOException on cancellation. callback.onFailure(ExecutorCallbackCall.this, new IOException(\"Canceled\")); } else { callback.onResponse(ExecutorCallbackCall.this, response); } } }); } @Override public void onFailure(Call\u003cT\u003e call, final Throwable t) { callbackExecutor.execute(new Runnable() { @Override public void run() { callback.onFailure(ExecutorCallbackCall.this, t); } }); } }); } @Override public boolean isExecuted() { return delegate.isExecuted(); } @Override public Response\u003cT\u003e execute() throws IOException { return delegate.execute(); } @Override public void cancel() { delegate.cancel(); } @Override public boolean isCanceled() { return delegate.isCanceled(); } @SuppressWarnings(\"CloneDoesntCallSuperClone\") // Performing deep clone. @Override public Call\u003cT\u003e clone() { return new ExecutorCallbackCall\u003c\u003e(callbackExecutor, delegate.clone()); } @Override public Request request() { return delegate.request(); } } 通过上述代码，Api api = retrofit.create(Api.class);主要还是通过代理反射创建了Api接口的实例，后续直接调用api.getNowWeather(\"beijing\", KEY);就可以构造一个Call对象；在retrofit.create的过程中需要通过ServiceMethod以及初始化的Retrofit对象对Method的注解进行解析，转换为HttpServiceMethod对象进行请求适配，包括处理response body数据以及修改Call类型等等，然后构建OkHttpCall，返回ExecutorCallbackCall，所以后续OkHttpCall的enqueue方法可以进行回调。\n// OkHttpCall.java 继承自Call，这里执行的代码非常类似OkHttp的RealCall类 @Override public void enqueue(final Callback\u003cT\u003e callback) { checkNotNull(callback, \"callback == null\"); okhttp3.Call call; Throwable failure; synchronized (this) { if (executed) throw new IllegalStateException(\"Already executed.\"); executed = true; call = rawCall; failure = creationFailure; if (call == null \u0026\u0026 failure == null) { try { // 我们需要把this，也就是OkHttpCall转换为OkHttpClient接受的Call，所以需要OkHttp的callFactory call = rawCall = createRawCall(); } catch (Throwable t) { throwIfFatal(t); failure = creationFailure = t; } } } if (failure != null) { callback.onFailure(this, failure); return; } if (canceled) { call.cancel(); } // 这里就直接使用了OkHttp的enqueue方法，然后再onResponse中处理rawResponse， // 通过parseResponse将返回的response body转为我们定义的数据，比如json-\u003eWeatherEntity // 所以回调函数的结果包括Response call.enqueue(new okhttp3.Callback() { @Override public void onResponse(okhttp3.Call call, okhttp3.Response rawResponse) { Response\u003cT\u003e response; try { response = parseResponse(rawResponse); } catch (Throwable e) { throwIfFatal(e); callFailure(e); return; } try { // 回调函数传出去 callback.onResponse(OkHttpCall.this, response); } catch (Throwable t) { throwIfFatal(t); t.printStackTrace(); // TODO this is not great } } @Override public void onFailure(okhttp3.Call call, IOException e) { callFailure(e); } private void callFailure(Throwable e) { try { callback.onFailure(OkHttpCall.this, e); } catch (Throwable t) { throwIfFatal(t); t.printStackTrace(); // TODO this is not great } } }); } // 将Call转换为OkHttp的Call，requestFactory.create(args)会构造RequestBuilder， // RequestBuilder就是将我们之前保存在各种对象中的参数拿出来组建出一个Http请求， // callFactory就是OkHttpClient对象 private okhttp3.Call createRawCall() throws IOException { okhttp3.Call call = callFactory.newCall(requestFactory.create(args)); if (call == null) { throw new NullPointerException(\"Call.Factory returned null.\"); } return call; } Response\u003cT\u003e parseResponse(okhttp3.Response rawResponse) throws IOException { ResponseBody rawBody = rawResponse.body(); // Remove the body's source (the only stateful object) so we can pass the response along. rawResponse = rawResponse.newBuilder() .body(new NoContentResponseBody(rawBody.contentType(), rawBody.contentLength())) .build(); int code = rawResponse.code(); if (code \u003c 200 || code \u003e= 300) { try { // Buffer the entire body to avoid future I/O. ResponseBody bufferedBody = Utils.buffer(rawBody); return Response.error(bufferedBody, rawResponse); } finally { rawBody.close(); } } if (code == 204 || code == 205) { rawBody.close(); return Response.success(null, rawResponse); } // 一般来说数据请求正确，返回code为200，因此走这条路，注意responseConverter.convert，也就是我们使用的 // 再Retrofit初始化的converterFactories，包括我们加入的GsonConverterFactory，最终Response的body被转换为 // WeatherEntity ExceptionCatchingResponseBody catchingBody = new ExceptionCatchingResponseBody(rawBody); try { T body = responseConverter.convert(catchingBody); return Response.success(body, rawResponse); } catch (RuntimeException e) { // If the underlying source threw an exception, propagate that rather than indicating it was // a runtime exception. catchingBody.throwIfCaught(); throw e; } } // -------------------------------------------------------------------------- // GsonConverterFactory.java 提供GsonResponseBodyConverter给Retrofit对Response进行数据转换 public final class GsonConverterFactory extends Converter.Factory { /** * Create an instance using a default {@link Gson} instance for conversion. Encoding to JSON and * decoding from JSON (when no charset is specified by a header) will use UTF-8. */ public static GsonConverterFactory create() { return create(new Gson()); } /** * Create an instance using {@code gson} for conversion. Encoding to JSON and * decoding from JSON (when no charset is specified by a header) will use UTF-8. */ @SuppressWarnings(\"ConstantConditions\") // Guarding public API nullability. public static GsonConverterFactory create(Gson gson) { if (gson == null) throw new NullPointerException(\"gson == null\"); return new GsonConverterFactory(gson); } private final Gson gson; private GsonConverterFactory(Gson gson) { this.gson = gson; } // responseBodyConverter被调用的位置是HttpServiceMethod的createResponseConverter @Override public Converter\u003cResponseBody, ?\u003e responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit) { TypeAdapter\u003c?\u003e adapter = gson.getAdapter(TypeToken.get(type)); return new GsonResponseBodyConverter\u003c\u003e(gson, adapter); } // requestBodyConverter被调用的位置在RequestFactory的parseParameterAnnotation @Override public Converter\u003c?, RequestBody\u003e requestBodyConverter(Type type, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) { TypeAdapter\u003c?\u003e adapter = gson.getAdapter(TypeToken.get(type)); return new GsonRequestBodyConverter\u003c\u003e(gson, adapter); } } // GsonResponseBodyConverter.java final class GsonResponseBodyConverter\u003cT\u003e implements Converter\u003cResponseBody, T\u003e { private final Gson gson; private final TypeAdapter\u003cT\u003e adapter; GsonResponseBodyConverter(Gson gson, TypeAdapter\u003cT\u003e adapter) { this.gson = gson; this.adapter = adapter; } // convert方法被执行的位置，也就是说通过TypeAdapter读取json数据并转换为java对象，这个具体实现需要分析Gson的源码 @Override public T convert(ResponseBody value) throws IOException { JsonReader jsonReader = gson.newJsonReader(value.charStream()); try { T result = adapter.read(jsonReader); if (jsonReader.peek() != JsonToken.END_DOCUMENT) { throw new JsonIOException(\"JSON document was not fully consumed.\"); } return result; } finally { value.close(); } } } 除了GsonConverterFactory，还可以分析一下RxJava2CallAdapterFactory，我们知道HttpServiceMethod的invoke返回的对象即为我们调用api.getNowWeather(\"beijing\", KEY);得到的对象，而这个对象是通过callAdapter调用adapt方法返回的，默认情况下是DefaultCallAdapterFactory，如果我们在Retrofit初始化时通过addCallAdapterFactory增加了其他的CallAdapterFactory比如RxJava2CallAdapterFactory，那么会通过RxJava2CallAdapterFactory调用RxJava2CallAdapter的adapt方法\n// RxJava2CallAdapterFactory.java RxJava2CallAdapterFactory的get方法必定返回RxJava2CallAdapter对象 public static RxJava2CallAdapterFactory create() { return new RxJava2CallAdapterFactory(null, false); } private RxJava2CallAdapterFactory(@Nullable Scheduler scheduler, boolean isAsync) { this.scheduler = scheduler; this.isAsync = isAsync; } // RxJava2CallAdapter.java 所以具体的adapt方法由RxJava2CallAdapter实现 @Override public Object adapt(Call\u003cR\u003e call) { // 主要请求的完成过程在CallEnqueueObservable中，异步的 Observable\u003cResponse\u003cR\u003e\u003e responseObservable = isAsync ? new CallEnqueueObservable\u003c\u003e(call) : new CallExecuteObservable\u003c\u003e(call); Observable\u003c?\u003e observable; // ResultObservable和BodyObservable都是继承自Observable，用于返回结果 if (isResult) { observable = new ResultObservable\u003c\u003e(responseObservable); } else if (isBody) { observable = new BodyObservable\u003c\u003e(responseObservable); } else { observable = responseObservable; } if (scheduler != null) { observable = observable.subscribeOn(scheduler); } if (isFlowable) { return observable.toFlowable(BackpressureStrategy.LATEST); } if (isSingle) { return observable.singleOrError(); } if (isMaybe) { return observable.singleElement(); } if (isCompletable) { return observable.ignoreElements(); } return RxJavaPlugins.onAssembly(observable); } // CallEnqueueObservable.java 当我们得到的observable执行subscribe方法时 // 实际调用了subscribeActual方法，对应上面的CallEnqueueObservable @Override protected void subscribeActual(Observer\u003c? super Response\u003cT\u003e\u003e observer) { // Since Call is a one-shot type, clone it for each new observer. Call\u003cT\u003e call = originalCall.clone(); CallCallback\u003cT\u003e callback = new CallCallback\u003c\u003e(call, observer); observer.onSubscribe(callback); if (!callback.isDisposed()) { // 这个call是在HttpServiceMethod中构建的OkHttpCall，OkHttpCall调用enqueue不必多说了吧 call.enqueue(callback); } } 综上所述，Retrofit是一个比较灵活的网络请求框架，从设计上就是为了便于增加其他组件而设计的，首先是Api接口的设计，为了更加方便控制请求参数，通过接口加注解设计请求的url，而同时我们又不必实现此接口，通过代理反射的方式对接口实体化，相当于解耦了请求url与Retrofit实例；\n其次是CallAdapter的设计，我们可以灵活的设计自己的CallAdapter用于同步或异步请求，因为在HttpServiceMethod被调用的时候是通过获取Retrofit初始化时设置的CallAdapter来实现返回，所以只需要自定义CallAdapter，我们就可以按照自己的需求处理请求的过程并拿到返回值；\n然后是与Gson的联动，在拿到返回Response的时候，对json数据进行转换，并且将实体通过回调传出来，都是为了灵活使用而设计的；\n最后是Retrofit与OkHttp的结合，Retrofit本质上还是调用OkHttp的请求，但是通过上述方式增加其灵活性，而且由于OkHttpCall的连接，我们一方面可以直接使用OkHttpClient，另一方面返回的Response可以直接处理，其中又包括非常多的泛型，这种设计思路真是妙啊妙啊。\n参考： HTTPS Tutorials HTTP 协议入门 Retrofit OkHttp OkHttp使用详解 Introduction to Retrofit Android Retrofit 2.5.0使用基础详解 Retrofit使用拦截器添加Cookie Factory Pattern ","wordCount":"8431","inLanguage":"en","datePublished":"2019-07-20T09:58:58+08:00","dateModified":"2019-07-20T09:58:58+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhoutao822.github.io/posts/retrofit/"},"publisher":{"@type":"Organization","name":"Tao's Notes","logo":{"@type":"ImageObject","url":"https://zhoutao822.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://zhoutao822.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://zhoutao822.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://zhoutao822.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zhoutao822.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://zhoutao822.github.io/series/ title=Series><span>Series</span></a></li><li><a href=https://zhoutao822.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zhoutao822.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://zhoutao822.github.io/posts/>Posts</a></div><h1 class=post-title>Android框架-Retrofit与OkHttp</h1><div class=post-meta><span title='2019-07-20 09:58:58 +0800 +0800'>July 20, 2019</span>&nbsp;·&nbsp;40 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Zhoutao822/zhoutao822.github.io/tree/main/content//posts/retrofit.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-get%e5%92%8cpost aria-label="1. GET和POST">1. GET和POST</a></li><li><a href=#2-okhttp aria-label="2. OkHttp">2. OkHttp</a><ul><li><a href=#21-okhttpget aria-label="2.1 OkHttp.GET">2.1 OkHttp.GET</a></li><li><a href=#22-okhttppost aria-label="2.2 OkHttp.POST">2.2 OkHttp.POST</a></li><li><a href=#23-okhttp%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="2.3 OkHttp源码分析">2.3 OkHttp源码分析</a></li></ul></li><li><a href=#3-retrofit aria-label="3. Retrofit">3. Retrofit</a><ul><li><a href=#31-retrofit%e4%bd%bf%e7%94%a8 aria-label="3.1 Retrofit使用">3.1 Retrofit使用</a></li><li><a href=#32-retrofit%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="3.2 Retrofit源码分析">3.2 Retrofit源码分析</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考：>参考：</a></li></ul></div></details></div><div class=post-content><p>Http，超文本传输协议，Https，更加安全的超文本传输协议，目前大量用于客户端与服务端之间的信息交流，属于应用层协议，下面有传输层TCP协议、网络层IP协议以及数据链路层为其提供保障。以登录功能为例，每一次输入账户密码后点击登录按钮就做了一次对服务器的Http请求（POST），我们收到的结果比如账号密码错误或者登录成功等信息就是服务器对Http请求的回复。Http与Https的区别在于后者采用了SSL（Secure Socket Layer安全套接层），简而言之就是对传输的数据进行了加密。具体细节可以在<a href=https://www.tutorialsteacher.com/https>HTTPS Tutorials</a>或者其他资料中找到。</p><h2 id=1-get和post>1. GET和POST<a hidden class=anchor aria-hidden=true href=#1-get和post>#</a></h2><p>Http协议中比较常用的请求是GET和POST请求，可以说大部分客户端与服务端之间的数据交互都是通过这两个请求方法，以GET和POST请求为例</p><p>GET用于请求数据，按照设计要求，GET请求不会对服务器数据进行修改，也就是说我们通过GET可以请求各种资源（静态页面等等），其中比较重要的参数包括：</p><p>Host：需要请求的服务器</p><p>User-Agent：代理，表明你的身份，一般来说浏览器发送的请求会自动添加，可以人为修改伪造身份</p><p>Connection：可以建立TCP长连接，属于HTTP/1.1的优化功能</p><p>这个GET请求的目的就是从www.wrox.com这个服务器取index.htm这个页面</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>GET</span> /index.htm <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>www.wrox.com</span>
</span></span><span style=display:flex><span>User-Agent<span style=color:#f92672>:</span> <span style=color:#ae81ff>Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6)</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Gecko/20050225</span> <span style=color:#ae81ff>Firefox/1.0.1</span>
</span></span><span style=display:flex><span>Connection<span style=color:#f92672>:</span> <span style=color:#ae81ff>Keep-Alive</span>
</span></span></code></pre></div><p>POST请求用于修改服务器数据，按照设计的要求，可以通过POST方法可以向服务器提交数据由服务器处理后返回，这里比较重要的参数包括：</p><p>Content-Type：请求实体的格式</p><p>Content-Length：请求实体的长度</p><p>以及请求实体的内容，会空一行再写，比如这里的name1=value1&name2=value2</p><p>这个POST请求的目的是向w3schools.com服务器下/test/demo_form.asp发送数据参数name1=value1&name2=value2，然后服务器会返回处理后的结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /test/demo_form.asp <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>w3schools.com</span>
</span></span><span style=display:flex><span>User-Agent<span style=color:#f92672>:</span> <span style=color:#ae81ff>Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6)</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Gecko/20050225</span> <span style=color:#ae81ff>Firefox/1.0.1</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/x-www-form-urlencoded</span>
</span></span><span style=display:flex><span>Content-Length<span style=color:#f92672>:</span> <span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>Connection<span style=color:#f92672>:</span> <span style=color:#ae81ff>Keep-Alive</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>name1=value1&amp;name2=value2
</span></span></code></pre></div><p>以上就是Http中GET和POST方法的简要介绍了，实际上Http协议还包括一些其他方法，以及TCP握手、SSL握手等建立连接的过程、对称与非对称加密等细节步骤，这里就不多描述，可以看其他资料。</p><h2 id=2-okhttp>2. OkHttp<a hidden class=anchor aria-hidden=true href=#2-okhttp>#</a></h2><p>OkHttp是一个封装好的Http请求客户端，它既可用于Java项目也可以用于Android项目，通过调用构建好的http client，我们就可以发出http请求。</p><p><strong>Android中需要网络权限</strong><code>&lt;uses-permission android:name="android.permission.INTERNET" /></code></p><h3 id=21-okhttpget>2.1 OkHttp.GET<a hidden class=anchor aria-hidden=true href=#21-okhttpget>#</a></h3><blockquote><p>1.创建OkHttpClient对象</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>OkHttpClient client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span></code></pre></div><blockquote><p>2.创建Request对象，URL则为我们需要的请求URL，一般来说此URL包含了Host、请求内容，比如<code>https://zhoutao822.coding.me/2019/01/03/XGBoost/0.png</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Request request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><blockquote><p>3.将Request封装为Call</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Call call <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span></code></pre></div><blockquote><p>4.调用同步或异步的请求方法</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 这是异步调用，通过enqueue方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span>MainActivity<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;get failed&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> Response response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String ret <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>string</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        runOnUiThread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                textView<span style=color:#f92672>.</span><span style=color:#a6e22e>setText</span><span style=color:#f92672>(</span>ret<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>});</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 这是同步调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Response response <span style=color:#f92672>=</span> call<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>异步调用意味着可以在主线程中调用call.enqueue方法，而同步调用方式只能在另一个线程中调用，通过handler将数据传回主线程，完整代码为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainActivity</span> <span style=color:#66d9ef>extends</span> AppCompatActivity <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://free-api.heweather.net/s6/weather/now?location=beijing&amp;key=XXXXXXXXX&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Handler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onCreate</span><span style=color:#f92672>(</span>Bundle savedInstanceState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onCreate</span><span style=color:#f92672>(</span>savedInstanceState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        setContentView<span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>activity_main</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> TextView textView <span style=color:#f92672>=</span> findViewById<span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>text</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        OkHttpClient client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Request request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Call call <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span>MainActivity<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;get failed&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> Response response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String ret <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>string</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                runOnUiThread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        textView<span style=color:#f92672>.</span><span style=color:#a6e22e>setText</span><span style=color:#f92672>(</span>ret<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 下面是同步调用
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        new Thread(new Runnable() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            @Override
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            public void run() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                OkHttpClient client = new OkHttpClient();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                Request request = new Request.Builder()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        .get()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        .url(URL)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        .build();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                Call call = client.newCall(request);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                try {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    final Response response = call.execute();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    handler.post(new Runnable() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        @Override
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        public void run() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                            try {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                                textView.setText(response.body().string());
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                            } catch (IOException e) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                                e.printStackTrace();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                            }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    });
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                } catch (IOException e) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    e.printStackTrace();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        }).start();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>GET请求下载文件，对于图片url，我们也可以通过GET的方式进行下载，将返回的数据转为本地图片或者直接用在ImageView上</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>downloadImg</span><span style=color:#f92672>(</span>View view<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        OkHttpClient client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Request request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Call call <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;aaaa&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;onFailure: &#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> Response response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//拿到字节流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                InputStream is <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>byteStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;image.png&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                FileOutputStream fos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream<span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> buf <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>128<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>len <span style=color:#f92672>=</span> is<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    fos<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> len<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                fos<span style=color:#f92672>.</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//关闭流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                fos<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                is<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 下面是直接把图片放到ImageView上                
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                final Bitmap bitmap = BitmapFactory.decodeStream(is);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                runOnUiThread(new Runnable() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    @Override
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    public void run() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                        imageView.setImageBitmap(bitmap);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                    }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                });
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                is.close();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>GET请求下载文件的同时我们可以计算出下载进度，通过<code>response.body().contentLength()</code>拿到文件总大小，只需要修改上面的<code>onResponse</code>方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> Response response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//拿到字节流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                InputStream is <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>byteStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>long</span> sum <span style=color:#f92672>=</span> 0L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> total <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;image.png&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                FileOutputStream fos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream<span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> buf <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>128<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>len <span style=color:#f92672>=</span> is<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    fos<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> len<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    sum <span style=color:#f92672>+=</span> len<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> finalSum <span style=color:#f92672>=</span> sum<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;aaaa&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;onResponse: &#34;</span> <span style=color:#f92672>+</span> finalSum <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> total<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    runOnUiThread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>//将进度设置到TextView中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            textView<span style=color:#f92672>.</span><span style=color:#a6e22e>setText</span><span style=color:#f92672>(</span>finalSum <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> total<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                fos<span style=color:#f92672>.</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//关闭流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                fos<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                is<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=22-okhttppost>2.2 OkHttp.POST<a hidden class=anchor aria-hidden=true href=#22-okhttppost>#</a></h3><p>POST与GET非常类似，以传入键值对数据为例</p><blockquote><p>1.创建OkHttpClient对象</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>OkHttpClient client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span></code></pre></div><blockquote><p>2.构建FormBody，传入参数</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>FormBody formBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FormBody<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;admin&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;password&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;admin&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><blockquote><p>3.创建Request对象，URL则为我们需要的请求URL，一般将此URL作为BaseUrl，比如<code>https://www.wanandroid.com/user/login</code>，我们就知道通过这个URL可以发送登录请求，根据API文档直到传入的参数包括<code>username</code>和<code>password</code>，因此需要FormBody</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Request request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>formBody<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><blockquote><p>4.将Request封装为Call</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Call call <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span></code></pre></div><blockquote><p>5.调用异步的请求方法</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;aaaa&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;onFailure: &#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call call<span style=color:#f92672>,</span> Response response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String res <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>string</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        runOnUiThread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                textView<span style=color:#f92672>.</span><span style=color:#a6e22e>setText</span><span style=color:#f92672>(</span>res<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>});</span>
</span></span></code></pre></div><p>POST除了可以发送键值对FormBody形式的请求外，还可以发送json字符串，将FormBody替换为RequestBody</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>RequestBody requestBody <span style=color:#f92672>=</span> RequestBody<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;text/plain;charset=utf-8&#34;</span><span style=color:#f92672>),</span> <span style=color:#e6db74>&#34;{username:admin;password:admin}&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>除了以上两种形式的数据之外，Http还可以接受表单形式的数据请求，这也是正常情况下登录流程中发送账号密码的要求，通过表单保存这些数据，再发送到服务器上</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;image.png&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>    Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;文件不存在&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>RequestBody muiltipartBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MultipartBody<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//一定要设置这句
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setType</span><span style=color:#f92672>(</span>MultipartBody<span style=color:#f92672>.</span><span style=color:#a6e22e>FORM</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>addFormDataPart</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;admin&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>addFormDataPart</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;password&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;admin&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>addFormDataPart</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;myfile&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;image.png&#34;</span><span style=color:#f92672>,</span> RequestBody<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;application/octet-stream&#34;</span><span style=color:#f92672>),</span> file<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>在发送表单请求时，除了字符串还可以添加二进制文件，比如这里将图片转为二进制加入到了表单中。</p><p>除了在表单中上传文件之外，还可以直接发送二进制文件，需要存储权限<code>&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/></code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;image.png&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>    Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;文件不存在&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    RequestBody requestBody2 <span style=color:#f92672>=</span> RequestBody<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;application/octet-stream&#34;</span><span style=color:#f92672>),</span> file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>POST也可以显示上传进度，但是需要自定义接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CountingRequestBody</span> <span style=color:#66d9ef>extends</span> RequestBody <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//实际起作用的RequestBody
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> RequestBody delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//回调监听
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Listener listener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> CountingSink countingSink<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 构造函数初始化成员变量
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param delegate
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param listener
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CountingRequestBody</span><span style=color:#f92672>(</span>RequestBody delegate<span style=color:#f92672>,</span> Listener listener<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>delegate</span> <span style=color:#f92672>=</span> delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> listener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MediaType <span style=color:#a6e22e>contentType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>contentType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeTo</span><span style=color:#f92672>(</span>BufferedSink sink<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        countingSink <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CountingSink<span style=color:#f92672>(</span>sink<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//将CountingSink转化为BufferedSink供writeTo()使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        BufferedSink bufferedSink <span style=color:#f92672>=</span> Okio<span style=color:#f92672>.</span><span style=color:#a6e22e>buffer</span><span style=color:#f92672>(</span>countingSink<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>writeTo</span><span style=color:#f92672>(</span>bufferedSink<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        bufferedSink<span style=color:#f92672>.</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CountingSink</span> <span style=color:#66d9ef>extends</span> ForwardingSink<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> byteWritten<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CountingSink</span><span style=color:#f92672>(</span>Sink delegate<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>delegate<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 上传时调用该方法,在其中调用回调函数将上传进度暴露出去,该方法提供了缓冲区的自己大小
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * @param source
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * @param byteCount
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * @throws IOException
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>Buffer source<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> byteCount<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>source<span style=color:#f92672>,</span> byteCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            byteWritten <span style=color:#f92672>+=</span> byteCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onRequestProgress</span><span style=color:#f92672>(</span>byteWritten<span style=color:#f92672>,</span> contentLength<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 返回文件总的字节大小
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 如果文件大小获取失败则返回-1
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>contentLength</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 回调监听接口
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Listener</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 暴露出上传进度
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * @param byteWritted  已经上传的字节大小
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * @param contentLength 文件的总字节大小
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onRequestProgress</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> byteWritted<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> contentLength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getExternalStorageDirectory</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;image.png&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>exists</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>    Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>makeText</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;文件不存在&#34;</span><span style=color:#f92672>,</span> Toast<span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_SHORT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    RequestBody requestBody2 <span style=color:#f92672>=</span> RequestBody<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;application/octet-stream&#34;</span><span style=color:#f92672>),</span> file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//使用我们自己封装的类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>CountingRequestBody countingRequestBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CountingRequestBody<span style=color:#f92672>(</span>requestBody2<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> CountingRequestBody<span style=color:#f92672>.</span><span style=color:#a6e22e>Listener</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onRequestProgress</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> byteWritted<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> contentLength<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//打印进度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;aaaa&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;进度 ：&#34;</span> <span style=color:#f92672>+</span> byteWritted <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> contentLength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>});</span>
</span></span></code></pre></div><h3 id=23-okhttp源码分析>2.3 OkHttp源码分析<a hidden class=anchor aria-hidden=true href=#23-okhttp源码分析>#</a></h3><p>以发送表单数据请求为例，大致有4步：OkHttpClient构建 -> RequestBody构建 -> Request构建 -> Call构建并调用</p><p>首先看一下OkHttpClient到底是个什么东西，从注释中可以知道OkHttpClient时Call的工厂，具体发送HTTP请求以及接收服务器响应都是通过Call来实现的。</p><p>OkHttpClient还包括以下几个特性：</p><ol><li>OkHttpClient应该用单例模式，这样是为了复用减少内存消耗；</li><li>每一个OkHttpClient都持有独立的连接池和线程池；</li><li>直接new出来的OkHttpClient是默认配置的；</li><li><code>new OkHttpClient.Builder()</code>可以对Client进行配置；</li><li>通过<code>client.newBuilder()</code>可以得到一个与client共享连接池和线程池的OkHttpClient，仅在特殊情形下需要；</li><li>OkHttpClient不是必须主动关闭，client持有的线程和连接在空闲的情况下会被自动回收；</li><li>如果需要主动回收，<code>client.dispatcher().executorService().shutdown()</code>可以回收执行的Service，但会导致之后的call被拒绝；</li><li><code>client.connectionPool().evictAll()</code>会回收连接池；</li><li><code>client.cache().close()</code>会回收Client的缓存（如果在第4步中配置了的话）。</li></ol><p>调用默认构造方法话，则默认参数为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    dispatcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Dispatcher<span style=color:#f92672>();</span> <span style=color:#75715e>// Dispatcher持有ExecutorService，通过ExecutorService调用call
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    protocols <span style=color:#f92672>=</span> DEFAULT_PROTOCOLS<span style=color:#f92672>;</span> <span style=color:#75715e>// 默认支持HTTP/2和HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    connectionSpecs <span style=color:#f92672>=</span> DEFAULT_CONNECTION_SPECS<span style=color:#f92672>;</span> <span style=color:#75715e>// 默认连接配置，支持TLS加密的https和普通的不加密http
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    eventListenerFactory <span style=color:#f92672>=</span> EventListener<span style=color:#f92672>.</span><span style=color:#a6e22e>factory</span><span style=color:#f92672>(</span>EventListener<span style=color:#f92672>.</span><span style=color:#a6e22e>NONE</span><span style=color:#f92672>);</span> <span style=color:#75715e>// 提供监听各种Event的Listener，通常需要继承EventListener并实现其方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    proxySelector <span style=color:#f92672>=</span> ProxySelector<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>();</span> <span style=color:#75715e>// 设置代理，默认是获取系统范围的代理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>proxySelector <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    proxySelector <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NullProxySelector<span style=color:#f92672>();</span> <span style=color:#75715e>// 如果系统没有设置代理则将proxySelector设置为NullProxySelector
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    cookieJar <span style=color:#f92672>=</span> CookieJar<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_COOKIES</span><span style=color:#f92672>;</span> <span style=color:#75715e>// CookieJar是一个接口，实现这个接口的方法可以保存Cookies，也可以在发送请求时加上Cookies
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    socketFactory <span style=color:#f92672>=</span> SocketFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>();</span> <span style=color:#75715e>// SocketFactory用于构建socket，默认返回DefaultSocketFactory，通过DefaultSocketFactory可以创建Socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    hostnameVerifier <span style=color:#f92672>=</span> OkHostnameVerifier<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>;</span> <span style=color:#75715e>// 用于在握手期间验证URL主机名和server的身份信息是否相同
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    certificatePinner <span style=color:#f92672>=</span> CertificatePinner<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>;</span> <span style=color:#75715e>// CertificatePinner用于在发送请求的过程中嵌入证书（Certificate Pinning），可以防止连接到危险的服务器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    proxyAuthenticator <span style=color:#f92672>=</span> Authenticator<span style=color:#f92672>.</span><span style=color:#a6e22e>NONE</span><span style=color:#f92672>;</span> <span style=color:#75715e>// 代理服务器需要身份验证的时候需要用到，默认不需要身份验证
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    authenticator <span style=color:#f92672>=</span> Authenticator<span style=color:#f92672>.</span><span style=color:#a6e22e>NONE</span><span style=color:#f92672>;</span> 
</span></span><span style=display:flex><span>    connectionPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionPool<span style=color:#f92672>();</span> <span style=color:#75715e>// 默认连接池允许最大5个空闲连接，超过5分钟空闲会被回收
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    dns <span style=color:#f92672>=</span> Dns<span style=color:#f92672>.</span><span style=color:#a6e22e>SYSTEM</span><span style=color:#f92672>;</span> <span style=color:#75715e>// DNS服务，默认使用系统的DNS服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    followSslRedirects <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span> <span style=color:#75715e>// 重定向到https域名，下面都是一些简单配置参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    followRedirects <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    retryOnConnectionFailure <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    callTimeout <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    connectTimeout <span style=color:#f92672>=</span> 10_000<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    readTimeout <span style=color:#f92672>=</span> 10_000<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    writeTimeout <span style=color:#f92672>=</span> 10_000<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    pingInterval <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>client只在后面构建Call的时候用到，那先看一下RequestBody，RequestBody是个抽象类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 如果需要自定义RequestBody，则需要继承RequestBody并实现两个抽象方法contentType和writeTo，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 一般来说contentType返回此RequestBody的Content-Type，contentLength返回Content的大小，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 重写writeTo方法实际上是调用BufferedSink的write(content)方法
</span></span></span><span style=display:flex><span><span style=color:#75715e>// RequestBody包含几个默认的create，如果只是发送简单请求，Content的内容不太复杂可以直接使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestBody</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Returns the Content-Type header for this body. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>@Nullable</span> MediaType <span style=color:#a6e22e>contentType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns the number of bytes that will be written to {@code sink} in a call to {@link #writeTo},
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * or -1 if that count is unknown.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>contentLength</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Writes the content of this request to {@code sink}. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeTo</span><span style=color:#f92672>(</span>BufferedSink sink<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns a new request body that transmits {@code content}. If {@code contentType} is non-null
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * and lacks a charset, this will use UTF-8.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestBody <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> MediaType contentType<span style=color:#f92672>,</span> String content<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Charset charset <span style=color:#f92672>=</span> Util<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>contentType <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      charset <span style=color:#f92672>=</span> contentType<span style=color:#f92672>.</span><span style=color:#a6e22e>charset</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>charset <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        charset <span style=color:#f92672>=</span> Util<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        contentType <span style=color:#f92672>=</span> MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span>contentType <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;; charset=utf-8&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes <span style=color:#f92672>=</span> content<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>charset<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> create<span style=color:#f92672>(</span>contentType<span style=color:#f92672>,</span> bytes<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Returns a new request body that transmits {@code content}. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestBody <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> MediaType contentType<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> ByteString content<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestBody<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> MediaType <span style=color:#a6e22e>contentType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> contentType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>contentLength</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> content<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeTo</span><span style=color:#f92672>(</span>BufferedSink sink<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sink<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>content<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Returns a new request body that transmits {@code content}. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestBody <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> MediaType contentType<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> content<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> create<span style=color:#f92672>(</span>contentType<span style=color:#f92672>,</span> content<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> content<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Returns a new request body that transmits {@code content}. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestBody <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> MediaType contentType<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> content<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> offset<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> byteCount<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>content <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;content == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Util<span style=color:#f92672>.</span><span style=color:#a6e22e>checkOffsetAndCount</span><span style=color:#f92672>(</span>content<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>,</span> offset<span style=color:#f92672>,</span> byteCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestBody<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> MediaType <span style=color:#a6e22e>contentType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> contentType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>contentLength</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> byteCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeTo</span><span style=color:#f92672>(</span>BufferedSink sink<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sink<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>content<span style=color:#f92672>,</span> offset<span style=color:#f92672>,</span> byteCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Returns a new request body that transmits the content of {@code file}. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestBody <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> MediaType contentType<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>file <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;file == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestBody<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> MediaType <span style=color:#a6e22e>contentType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> contentType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>contentLength</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeTo</span><span style=color:#f92672>(</span>BufferedSink sink<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Source source <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          source <span style=color:#f92672>=</span> Okio<span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          sink<span style=color:#f92672>.</span><span style=color:#a6e22e>writeAll</span><span style=color:#f92672>(</span>source<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          Util<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>source<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>MultipartBody继承自RequestBody，通过MultipartBody构建RequestBody可以发送更加复杂的数据，比如<code>multipart/form-data</code>表单数据，通过MultipartBody的内部类Builder可以对MultipartBody进行配置（建造者模式）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Builder有几个重要的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e>// setType：设置MultipartBody请求的Content-Type，如果是表单数据则为MultipartBody.FORM；
</span></span></span><span style=display:flex><span><span style=color:#75715e>// addPart：因为HTTP请求包括Header和Body，因此通过内部类Part封装号Header和Body，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 将Part保存到RequestBody的List&lt;Part&gt;中，可能是为了一次发送多个请求；
</span></span></span><span style=display:flex><span><span style=color:#75715e>// addFormDataPart：通过Part构造表单请求；
</span></span></span><span style=display:flex><span><span style=color:#75715e>// build：最后通过build方法创建MultipartBody实例，参数来源于前面三个方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Builder</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ByteString boundary<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> MediaType type <span style=color:#f92672>=</span> MIXED<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>Part<span style=color:#f92672>&gt;</span> parts <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 初始化一个随机的boundary，暂时还不知道有什么用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Builder</span><span style=color:#f92672>(</span>String boundary<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>boundary</span> <span style=color:#f92672>=</span> ByteString<span style=color:#f92672>.</span><span style=color:#a6e22e>encodeUtf8</span><span style=color:#f92672>(</span>boundary<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Set the MIME type. Expected values for {@code type} are {@link #MIXED} (the default), {@link
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * #ALTERNATIVE}, {@link #DIGEST}, {@link #PARALLEL} and {@link #FORM}.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>setType</span><span style=color:#f92672>(</span>MediaType type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;type == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;multipart&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;multipart != &#34;</span> <span style=color:#f92672>+</span> type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>=</span> type<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Add a part to the body. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>addPart</span><span style=color:#f92672>(</span>RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> addPart<span style=color:#f92672>(</span>Part<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>body<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Add a part to the body. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>addPart</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Headers headers<span style=color:#f92672>,</span> RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> addPart<span style=color:#f92672>(</span>Part<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>headers<span style=color:#f92672>,</span> body<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Add a form data part to the body. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>addFormDataPart</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>,</span> String value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> addPart<span style=color:#f92672>(</span>Part<span style=color:#f92672>.</span><span style=color:#a6e22e>createFormData</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> value<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Add a form data part to the body. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>addFormDataPart</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> String filename<span style=color:#f92672>,</span> RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> addPart<span style=color:#f92672>(</span>Part<span style=color:#f92672>.</span><span style=color:#a6e22e>createFormData</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> filename<span style=color:#f92672>,</span> body<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Add a part to the body. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>addPart</span><span style=color:#f92672>(</span>Part part<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>part <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;part == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      parts<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>part<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Assemble the specified parts into a request body. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MultipartBody <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parts<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Multipart body must have at least one part.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MultipartBody<span style=color:#f92672>(</span>boundary<span style=color:#f92672>,</span> type<span style=color:#f92672>,</span> parts<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Part用于构造包含Header和RequestBody的实例，简单来说就是用Header封装好要发送请求的首部参数，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 用RequestBody封装要发送请求的请求数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Part</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Part <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> create<span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Part <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Headers headers<span style=color:#f92672>,</span> RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>body <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;body == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>headers <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> headers<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unexpected header: Content-Type&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>headers <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> headers<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Length&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unexpected header: Content-Length&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Part<span style=color:#f92672>(</span>headers<span style=color:#f92672>,</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Part <span style=color:#a6e22e>createFormData</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>,</span> String value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> createFormData<span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> RequestBody<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> value<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Part <span style=color:#a6e22e>createFormData</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> String filename<span style=color:#f92672>,</span> RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      StringBuilder disposition <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;form-data; name=&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      appendQuotedString<span style=color:#f92672>(</span>disposition<span style=color:#f92672>,</span> name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>filename <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        disposition<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;; filename=&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        appendQuotedString<span style=color:#f92672>(</span>disposition<span style=color:#f92672>,</span> filename<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> create<span style=color:#f92672>(</span>Headers<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Disposition&#34;</span><span style=color:#f92672>,</span> disposition<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()),</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> Headers headers<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> RequestBody body<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Part</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Headers headers<span style=color:#f92672>,</span> RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span> <span style=color:#f92672>=</span> headers<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> body<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> Headers <span style=color:#a6e22e>headers</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> headers<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> RequestBody <span style=color:#a6e22e>body</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> body<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>RequestBody包含了请求首部参数以及请求数据，接下来需要分析Request，Request连接了请求的主机url和RequestBody</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Request默认构造的是GET请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>method</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GET&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Headers<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通过url方法设置请求的主机名，如果直接传入的是HttpUrl也可以，传入String也可以，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 但是会进行格式验证，会把ws:开头和wss:开头的主机名转换为http:和https:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>HttpUrl url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;url == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Sets the URL target of this request.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @throws IllegalArgumentException if {@code url} is not a valid HTTP or HTTPS URL. Avoid this
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * exception by calling {@link HttpUrl#parse}; it returns null for invalid URLs.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>String url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;url == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Silently replace web socket URLs with HTTP URLs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>regionMatches</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ws:&#34;</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> 3<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http:&#34;</span> <span style=color:#f92672>+</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>3<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>regionMatches</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;wss:&#34;</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> 4<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https:&#34;</span> <span style=color:#f92672>+</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>4<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> url<span style=color:#f92672>(</span>HttpUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>url<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// post以及其他方法都是通过传入字符POST或者其他方式调用method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;GET&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>head</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HEAD&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;POST&#34;</span><span style=color:#f92672>,</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DELETE&#34;</span><span style=color:#f92672>,</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>delete</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> delete<span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_REQUEST</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;PUT&#34;</span><span style=color:#f92672>,</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>patch</span><span style=color:#f92672>(</span>RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;PATCH&#34;</span><span style=color:#f92672>,</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// method方法还是将Request的属性设为method传入的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>method</span><span style=color:#f92672>(</span>String method<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> RequestBody body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>method <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;method == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;method.length() == 0&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>body <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>permitsRequestBody</span><span style=color:#f92672>(</span>method<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;method &#34;</span> <span style=color:#f92672>+</span> method <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; must not have a request body.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>body <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>requiresRequestBody</span><span style=color:#f92672>(</span>method<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;method &#34;</span> <span style=color:#f92672>+</span> method <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; must have a request body.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>method</span> <span style=color:#f92672>=</span> method<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> body<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// build()方法返回Request对象，并且传入了上面设置的属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> Request <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>url <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;url == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 其实Request对象也没有什么具体的功能，也是类似RequestBody封装了HTTP请求的一些参数，包括url请求主机名，method请求的方法，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// headers这里也有headers，也就是说我们可以在RequestBody中加入请求首部参数，也可以在Request中加入请求参数，而且Request会覆盖
</span></span></span><span style=display:flex><span><span style=color:#75715e>// RequestBody的参数，在两个地方都封装Header，我觉得应该是为了复用，有些时候Header对于一些请求来说都是相同的，区别只是Body不同
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 因此在Request中设置Header能减少冗余的代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Request<span style=color:#f92672>(</span>Builder builder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>method</span> <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>method</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span> <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tags</span> <span style=color:#f92672>=</span> Util<span style=color:#f92672>.</span><span style=color:#a6e22e>immutableMap</span><span style=color:#f92672>(</span>builder<span style=color:#f92672>.</span><span style=color:#a6e22e>tags</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以上的RequestBody和Request实际上并没有任何复杂的功能，都是对一个完整的HTTP请求参数的封装，利用了建造者模式，同时将请求数据与请求首部参数以及请求方法和主机名进行解耦，使得开发人员可以灵活的使用各个模块组建一个完整的Request，如何发送这个Request，并接收回调则是在Call中进行的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// OkHttpClient.java 之前说过OkHttpClient是Call的工厂类，通过newCall方法传入上面构造的Request实例，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 得到一个Call实例，具体的实现是通过RealCall.newRealCall方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Call <span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>Request request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RealCall<span style=color:#f92672>.</span><span style=color:#a6e22e>newRealCall</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>/* for web socket */</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在看RealCall.newRealCall之前首先看一下Call</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 根据注释说明，我们直到Call是一个接口，Call接口的实现类能够完成具体的HTTP请求发送，且包含request/response对，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 也就意味着可以通过Call的回调获取到服务器返回的数据，一个call不能被执行两次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * A call is a request that has been prepared for execution. A call can be canceled. As this object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * represents a single request/response pair (stream), it cannot be executed twice.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Call</span> <span style=color:#66d9ef>extends</span> Cloneable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Returns the original request that initiated this call. */</span>
</span></span><span style=display:flex><span>  Request <span style=color:#a6e22e>request</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// execute方法执行时会阻塞当前线程，直到处理完response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Response <span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// enqueue方法会通过dispatcher安排request进入队列等待执行，执行完毕后通过Callback回调
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>Callback responseCallback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 调用cancel方法可以取消request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cancel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 判断call是否已经在执行，比如调用了execute或者enqueue方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isExecuted</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 判断call是否被取消
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 返回整个call执行期间的耗时，包括DNS寻址、连接、写入request body、服务器处理、读取response body等过程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Timeout <span style=color:#a6e22e>timeout</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 复制此call，利用clone得到的call可以继续执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Call <span style=color:#a6e22e>clone</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Factory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Call <span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>Request request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>RealCall实现了Call的接口，所以上面用到的方法都是在RealCall中实现的，首先看RealCall.newRealCall</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>RealCall</span><span style=color:#f92672>(</span>OkHttpClient client<span style=color:#f92672>,</span> Request originalRequest<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> forWebSocket<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>originalRequest</span> <span style=color:#f92672>=</span> originalRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>forWebSocket</span> <span style=color:#f92672>=</span> forWebSocket<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>retryAndFollowUpInterceptor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RetryAndFollowUpInterceptor<span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> forWebSocket<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AsyncTimeout<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>timedOut</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        cancel<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeout</span><span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>callTimeoutMillis</span><span style=color:#f92672>(),</span> MILLISECONDS<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// newRealCall方法也是仅仅只做了参数传递的工作，最主要的参数是client和originalRequest
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> RealCall <span style=color:#a6e22e>newRealCall</span><span style=color:#f92672>(</span>OkHttpClient client<span style=color:#f92672>,</span> Request originalRequest<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> forWebSocket<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Safely publish the Call instance to the EventListener.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RealCall call <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RealCall<span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> originalRequest<span style=color:#f92672>,</span> forWebSocket<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    call<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span> <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListenerFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> call<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>当我们调用call.execute方法时</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Response <span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// synchronized锁，确保同一个Call不会被执行两次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>executed<span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Already Executed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      executed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// captureCallStackTrace跟踪call执行的堆栈
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    captureCallStackTrace<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// timeout.enter开始记录timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    timeout<span style=color:#f92672>.</span><span style=color:#a6e22e>enter</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将Call Start事件传递出去，通过自定义eventListenerFactory可以对事件进行处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    eventListener<span style=color:#f92672>.</span><span style=color:#a6e22e>callStart</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//  通过dispatcher调用executed执行请求发送，实际上只是把call加到一个队列中，并没有执行发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      client<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatcher</span><span style=color:#f92672>().</span><span style=color:#a6e22e>executed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 通过getResponseWithInterceptorChain获取服务器返回的response，这里才是真正的call被发送出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      Response result <span style=color:#f92672>=</span> getResponseWithInterceptorChain<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Canceled&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      e <span style=color:#f92672>=</span> timeoutExit<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      eventListener<span style=color:#f92672>.</span><span style=color:#a6e22e>callFailed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      client<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatcher</span><span style=color:#f92672>().</span><span style=color:#a6e22e>finished</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Dispatcher.java client.dispatcher().executed(this);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/** Used by {@code Call#execute} to signal it is in-flight. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>executed</span><span style=color:#f92672>(</span>RealCall call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    runningSyncCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Interceptor也是一个接口，实现Interceptor接口的类可以对Request进行拦截，也就是通过
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 各种Interceptor来实现HTTP请求，比如这里的BridgeInterceptor、CacheInterceptor、
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ConnectInterceptor等等
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Response <span style=color:#a6e22e>getResponseWithInterceptorChain</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Build a full stack of interceptors.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 注意默认构造的client.interceptors()为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>Interceptor<span style=color:#f92672>&gt;</span> interceptors <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>interceptors</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>retryAndFollowUpInterceptor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BridgeInterceptor<span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>cookieJar</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CacheInterceptor<span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>internalCache</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ConnectInterceptor<span style=color:#f92672>(</span>client<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>forWebSocket<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>networkInterceptors</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CallServerInterceptor<span style=color:#f92672>(</span>forWebSocket<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 这里调用的时候，注意index为0，而RealInterceptorChain调用proceed方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Interceptor<span style=color:#f92672>.</span><span style=color:#a6e22e>Chain</span> chain <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RealInterceptorChain<span style=color:#f92672>(</span>interceptors<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        originalRequest<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> eventListener<span style=color:#f92672>,</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>connectTimeoutMillis</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span><span style=color:#a6e22e>readTimeoutMillis</span><span style=color:#f92672>(),</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>writeTimeoutMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>(</span>originalRequest<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// RealInterceptorChain.java chain.proceed(originalRequest)的位置，这里的index为0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> Response <span style=color:#a6e22e>proceed</span><span style=color:#f92672>(</span>Request request<span style=color:#f92672>,</span> StreamAllocation streamAllocation<span style=color:#f92672>,</span> HttpCodec httpCodec<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      RealConnection connection<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>index <span style=color:#f92672>&gt;=</span> interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>())</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    calls<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If we already have a stream, confirm that the incoming request will use it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>httpCodec</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>connection</span><span style=color:#f92672>.</span><span style=color:#a6e22e>supportsUrl</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;network interceptor &#34;</span> <span style=color:#f92672>+</span> interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>index <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; must retain the same host and port&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If we already have a stream, confirm that this is the only call to chain.proceed().
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>httpCodec</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> calls <span style=color:#f92672>&gt;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;network interceptor &#34;</span> <span style=color:#f92672>+</span> interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>index <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; must call proceed() exactly once&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 注意这里，创建了next RealInterceptorChain，index为1，而interceptors.get(index)拿的就是上文对应的retryAndFollowUpInterceptor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Call the next interceptor in the chain.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RealInterceptorChain next <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RealInterceptorChain<span style=color:#f92672>(</span>interceptors<span style=color:#f92672>,</span> streamAllocation<span style=color:#f92672>,</span> httpCodec<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        connection<span style=color:#f92672>,</span> index <span style=color:#f92672>+</span> 1<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> call<span style=color:#f92672>,</span> eventListener<span style=color:#f92672>,</span> connectTimeout<span style=color:#f92672>,</span> readTimeout<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        writeTimeout<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Interceptor interceptor <span style=color:#f92672>=</span> interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>index<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 即response时通过BridgeInterceptor的intercept方法得到的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Response response <span style=color:#f92672>=</span> interceptor<span style=color:#f92672>.</span><span style=color:#a6e22e>intercept</span><span style=color:#f92672>(</span>next<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Confirm that the next interceptor made its required call to chain.proceed().
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>httpCodec <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> index <span style=color:#f92672>+</span> 1 <span style=color:#f92672>&lt;</span> interceptors<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> next<span style=color:#f92672>.</span><span style=color:#a6e22e>calls</span> <span style=color:#f92672>!=</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;network interceptor &#34;</span> <span style=color:#f92672>+</span> interceptor
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; must call proceed() exactly once&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Confirm that the intercepted response isn&#39;t null.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>response <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;interceptor &#34;</span> <span style=color:#f92672>+</span> interceptor <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; returned null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;interceptor &#34;</span> <span style=color:#f92672>+</span> interceptor <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; returned a response with no body&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// RetryAndFollowUpInterceptor.java RetryAndFollowUpInterceptor用于请求重连，通过connectionPool
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 构建StreamAllocation，StreamAllocation用于管理连接、数据流以及Calls
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Response <span style=color:#a6e22e>intercept</span><span style=color:#f92672>(</span>Chain chain<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Request request <span style=color:#f92672>=</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    RealInterceptorChain realChain <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>RealInterceptorChain<span style=color:#f92672>)</span> chain<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Call call <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    EventListener eventListener <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    StreamAllocation streamAllocation <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StreamAllocation<span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>connectionPool</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        createAddress<span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>()),</span> call<span style=color:#f92672>,</span> eventListener<span style=color:#f92672>,</span> callStackTrace<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>streamAllocation</span> <span style=color:#f92672>=</span> streamAllocation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> followUpCount <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Response priorResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过while死循环发送request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>canceled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Canceled&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      Response response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> releaseConnection <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里的realChain交接给BridgeInterceptor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        response <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> streamAllocation<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        releaseConnection <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RouteException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// The attempt to connect via a route failed. The request will not have been sent.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>recover<span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getLastConnectException</span><span style=color:#f92672>(),</span> streamAllocation<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> request<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getFirstConnectException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        releaseConnection <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// An attempt to communicate with a server failed. The request may have been sent.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> requestSendStarted <span style=color:#f92672>=</span> <span style=color:#f92672>!(</span>e <span style=color:#66d9ef>instanceof</span> ConnectionShutdownException<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>recover<span style=color:#f92672>(</span>e<span style=color:#f92672>,</span> streamAllocation<span style=color:#f92672>,</span> requestSendStarted<span style=color:#f92672>,</span> request<span style=color:#f92672>))</span> <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        releaseConnection <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We&#39;re throwing an unchecked exception. Release any resources.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>releaseConnection<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>streamFailed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Attach the prior response if it exists. Such responses never have a body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>priorResponse <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>priorResponse</span><span style=color:#f92672>(</span>priorResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 仅仅在发送请求后接收到response，并且没有后续的request时返回，返回值为response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      Request followUp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        followUp <span style=color:#f92672>=</span> followUpRequest<span style=color:#f92672>(</span>response<span style=color:#f92672>,</span> streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>route</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>followUp <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      closeQuietly<span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(++</span>followUpCount <span style=color:#f92672>&gt;</span> MAX_FOLLOW_UPS<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ProtocolException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Too many follow-up requests: &#34;</span> <span style=color:#f92672>+</span> followUpCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>followUp<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>instanceof</span> UnrepeatableRequestBody<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> HttpRetryException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot retry streamed HTTP body&#34;</span><span style=color:#f92672>,</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>sameConnection<span style=color:#f92672>(</span>response<span style=color:#f92672>,</span> followUp<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        streamAllocation <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StreamAllocation<span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>connectionPool</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>            createAddress<span style=color:#f92672>(</span>followUp<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>()),</span> call<span style=color:#f92672>,</span> eventListener<span style=color:#f92672>,</span> callStackTrace<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>streamAllocation</span> <span style=color:#f92672>=</span> streamAllocation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>codec</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Closing the body of &#34;</span> <span style=color:#f92672>+</span> response
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; didn&#39;t close its backing stream. Bad interceptor?&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      request <span style=color:#f92672>=</span> followUp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      priorResponse <span style=color:#f92672>=</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// BridgeInterceptor.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Response <span style=color:#a6e22e>intercept</span><span style=color:#f92672>(</span>Chain chain<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过chain得到request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Request userRequest <span style=color:#f92672>=</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span> requestBuilder <span style=color:#f92672>=</span> userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 拿到body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RequestBody body <span style=color:#f92672>=</span> userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>body <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      MediaType contentType <span style=color:#f92672>=</span> body<span style=color:#f92672>.</span><span style=color:#a6e22e>contentType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>contentType <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 重新构造header
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>,</span> contentType<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>long</span> contentLength <span style=color:#f92672>=</span> body<span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>contentLength <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Length&#34;</span><span style=color:#f92672>,</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(</span>contentLength<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>removeHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Transfer-Encoding&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Transfer-Encoding&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;chunked&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>removeHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Length&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Host&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Host&#34;</span><span style=color:#f92672>,</span> hostHeader<span style=color:#f92672>(</span>userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connection&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connection&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Keep-Alive&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If we add an &#34;Accept-Encoding: gzip&#34; header field we&#39;re responsible for also decompressing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// the transfer stream.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> transparentGzip <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Accept-Encoding&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Range&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      transparentGzip <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Accept-Encoding&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;gzip&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 构造带Cookies的header，默认Cookies为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>Cookie<span style=color:#f92672>&gt;</span> cookies <span style=color:#f92672>=</span> cookieJar<span style=color:#f92672>.</span><span style=color:#a6e22e>loadForRequest</span><span style=color:#f92672>(</span>userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>cookies<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cookie&#34;</span><span style=color:#f92672>,</span> cookieHeader<span style=color:#f92672>(</span>cookies<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;User-Agent&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;User-Agent&#34;</span><span style=color:#f92672>,</span> Version<span style=color:#f92672>.</span><span style=color:#a6e22e>userAgent</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注意这里的chain的index为1，所以再次调用chain.proceed会使index为2，即CacheInterceptor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Response networkResponse <span style=color:#f92672>=</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>(</span>requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>receiveHeaders</span><span style=color:#f92672>(</span>cookieJar<span style=color:#f92672>,</span> userRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(),</span> networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Response<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span> responseBuilder <span style=color:#f92672>=</span> networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>(</span>userRequest<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>transparentGzip
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#34;gzip&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Encoding&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;&amp;</span> HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>hasBody</span><span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      GzipSource responseBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GzipSource<span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>source</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      Headers strippedHeaders <span style=color:#f92672>=</span> networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>().</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>removeAll</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Encoding&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>removeAll</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Length&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      responseBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>(</span>strippedHeaders<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      String contentType <span style=color:#f92672>=</span> networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      responseBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> RealResponseBody<span style=color:#f92672>(</span>contentType<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>1L<span style=color:#f92672>,</span> Okio<span style=color:#f92672>.</span><span style=color:#a6e22e>buffer</span><span style=color:#f92672>(</span>responseBody<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> responseBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// CacheInterceptor.java CacheInterceptor用于从cache中取request以及向cache中写入response
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果cache中保存了相同request的response，那么可以实现断网也可以获取response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Response <span style=color:#a6e22e>intercept</span><span style=color:#f92672>(</span>Chain chain<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Response cacheCandidate <span style=color:#f92672>=</span> cache <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>chain<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> now <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CacheStrategy strategy <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>(</span>now<span style=color:#f92672>,</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>(),</span> cacheCandidate<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Request networkRequest <span style=color:#f92672>=</span> strategy<span style=color:#f92672>.</span><span style=color:#a6e22e>networkRequest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Response cacheResponse <span style=color:#f92672>=</span> strategy<span style=color:#f92672>.</span><span style=color:#a6e22e>cacheResponse</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cache <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      cache<span style=color:#f92672>.</span><span style=color:#a6e22e>trackResponse</span><span style=color:#f92672>(</span>strategy<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cacheCandidate <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> cacheResponse <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      closeQuietly<span style=color:#f92672>(</span>cacheCandidate<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>());</span> <span style=color:#75715e>// The cache candidate wasn&#39;t applicable. Close it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If we&#39;re forbidden from using the network and the cache is insufficient, fail.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>networkRequest <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> cacheResponse <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>(</span>chain<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>(</span>Protocol<span style=color:#f92672>.</span><span style=color:#a6e22e>HTTP_1_1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>(</span>504<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>message</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unsatisfiable Request (only-if-cached)&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_RESPONSE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>sentRequestAtMillis</span><span style=color:#f92672>(-</span>1L<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>receivedResponseAtMillis</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 没有网络则从cache中取对应的response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// If we don&#39;t need the network, we&#39;re done.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>networkRequest <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> cacheResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>cacheResponse</span><span style=color:#f92672>(</span>stripBody<span style=color:#f92672>(</span>cacheResponse<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Response networkResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 注意这里同理chain交接给下一个ConnectInterceptor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      networkResponse <span style=color:#f92672>=</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>(</span>networkRequest<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// If we&#39;re crashing on I/O or otherwise, don&#39;t leak the cache body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>networkResponse <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> cacheCandidate <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        closeQuietly<span style=color:#f92672>(</span>cacheCandidate<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If we have a cache response too, then we&#39;re doing a conditional get.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cacheResponse <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> HTTP_NOT_MODIFIED<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Response response <span style=color:#f92672>=</span> cacheResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>(</span>combine<span style=color:#f92672>(</span>cacheResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>(),</span> networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>()))</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>sentRequestAtMillis</span><span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>sentRequestAtMillis</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>receivedResponseAtMillis</span><span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>receivedResponseAtMillis</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>cacheResponse</span><span style=color:#f92672>(</span>stripBody<span style=color:#f92672>(</span>cacheResponse<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>networkResponse</span><span style=color:#f92672>(</span>stripBody<span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Update the cache after combining headers but before stripping the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Content-Encoding header (as performed by initContentStream()).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        cache<span style=color:#f92672>.</span><span style=color:#a6e22e>trackConditionalCacheHit</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        cache<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>cacheResponse<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        closeQuietly<span style=color:#f92672>(</span>cacheResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Response response <span style=color:#f92672>=</span> networkResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>cacheResponse</span><span style=color:#f92672>(</span>stripBody<span style=color:#f92672>(</span>cacheResponse<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>networkResponse</span><span style=color:#f92672>(</span>stripBody<span style=color:#f92672>(</span>networkResponse<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cache <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>hasBody</span><span style=color:#f92672>(</span>response<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> CacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>isCacheable</span><span style=color:#f92672>(</span>response<span style=color:#f92672>,</span> networkRequest<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Offer this request to the cache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CacheRequest cacheRequest <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cacheWritingResponse<span style=color:#f92672>(</span>cacheRequest<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>invalidatesCache</span><span style=color:#f92672>(</span>networkRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>method</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          cache<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>networkRequest<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// The cache cannot be written.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ConnectInterceptor.java StreamAllocation在RetryAndFollowUpInterceptor中被构造用于管理连接
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 因此ConnectInterceptor用于创建真实的HTTP连接RealConnection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Response <span style=color:#a6e22e>intercept</span><span style=color:#f92672>(</span>Chain chain<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    RealInterceptorChain realChain <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>RealInterceptorChain<span style=color:#f92672>)</span> chain<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Request request <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    StreamAllocation streamAllocation <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>streamAllocation</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We need the network to satisfy this request. Possibly for validating a conditional GET.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> doExtensiveHealthChecks <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>method</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;GET&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    HttpCodec httpCodec <span style=color:#f92672>=</span> streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>newStream</span><span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> chain<span style=color:#f92672>,</span> doExtensiveHealthChecks<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    RealConnection connection <span style=color:#f92672>=</span> streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>connection</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 同理下一任是CallServerInterceptor，因为networkInterceptors为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> streamAllocation<span style=color:#f92672>,</span> httpCodec<span style=color:#f92672>,</span> connection<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// CallServerInterceptor.java CallServerInterceptor是最后一任Interceptor，它的功能是发送网络Call到服务器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Response <span style=color:#a6e22e>intercept</span><span style=color:#f92672>(</span>Chain chain<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    RealInterceptorChain realChain <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>RealInterceptorChain<span style=color:#f92672>)</span> chain<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    HttpCodec httpCodec <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>httpStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    StreamAllocation streamAllocation <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>streamAllocation</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    RealConnection connection <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>RealConnection<span style=color:#f92672>)</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>connection</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Request request <span style=color:#f92672>=</span> realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> sentRequestMillis <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 将HeadersStart和HeadersEnd通过eventListener传出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>().</span><span style=color:#a6e22e>requestHeadersStart</span><span style=color:#f92672>(</span>realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送请求的方式是通过httpCodec数据流，首先传出去request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>writeRequestHeaders</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>().</span><span style=color:#a6e22e>requestHeadersEnd</span><span style=color:#f92672>(</span>realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>(),</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 然后通过httpCodec读取response，其中涉及到request的首部是否包含Expect: 100-continue，不过问题不大
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Response<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span> responseBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>permitsRequestBody</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>method</span><span style=color:#f92672>())</span> <span style=color:#f92672>&amp;&amp;</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// If there&#39;s a &#34;Expect: 100-continue&#34; header on the request, wait for a &#34;HTTP/1.1 100
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// Continue&#34; response before transmitting the request body. If we don&#39;t get that, return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// what we did get (such as a 4xx response) without ever transmitting the request body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;100-continue&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expect&#34;</span><span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果request的首部包含Expect: 100-continue参数，responseBuilder会被置为null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>flushRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>().</span><span style=color:#a6e22e>responseHeadersStart</span><span style=color:#f92672>(</span>realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        responseBuilder <span style=color:#f92672>=</span> httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>readResponseHeaders</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responseBuilder <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Write the request body if the &#34;Expect: 100-continue&#34; expectation was met.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>().</span><span style=color:#a6e22e>requestBodyStart</span><span style=color:#f92672>(</span>realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> contentLength <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过httpCodec创建request数据流，可以通过CountingSink监控数据传输
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CountingSink requestBodyOut <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> CountingSink<span style=color:#f92672>(</span>httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestBody</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> contentLength<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        BufferedSink bufferedRequestBody <span style=color:#f92672>=</span> Okio<span style=color:#f92672>.</span><span style=color:#a6e22e>buffer</span><span style=color:#f92672>(</span>requestBodyOut<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>writeTo</span><span style=color:#f92672>(</span>bufferedRequestBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        bufferedRequestBody<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>requestBodyEnd</span><span style=color:#f92672>(</span>realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>(),</span> requestBodyOut<span style=color:#f92672>.</span><span style=color:#a6e22e>successfulCount</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>connection<span style=color:#f92672>.</span><span style=color:#a6e22e>isMultiplexed</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If the &#34;Expect: 100-continue&#34; expectation wasn&#39;t met, prevent the HTTP/1 connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// from being reused. Otherwise we&#39;re still obligated to transmit the request body to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// leave the connection in a consistent state.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>noNewStreams</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>finishRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responseBuilder <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>().</span><span style=color:#a6e22e>responseHeadersStart</span><span style=color:#f92672>(</span>realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 通过httpCodec的readResponseHeaders读取response的header信息，此时responseBuilder不为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      responseBuilder <span style=color:#f92672>=</span> httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>readResponseHeaders</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通过responseBuilder构建完整的response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Response response <span style=color:#f92672>=</span> responseBuilder
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>(</span>request<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>handshake</span><span style=color:#f92672>(</span>streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>connection</span><span style=color:#f92672>().</span><span style=color:#a6e22e>handshake</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>sentRequestAtMillis</span><span style=color:#f92672>(</span>sentRequestMillis<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>receivedResponseAtMillis</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> code <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>code <span style=color:#f92672>==</span> 100<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// server sent a 100-continue even though we did not request one.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// try again to read the actual response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      responseBuilder <span style=color:#f92672>=</span> httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>readResponseHeaders</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      response <span style=color:#f92672>=</span> responseBuilder
</span></span><span style=display:flex><span>              <span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>(</span>request<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>.</span><span style=color:#a6e22e>handshake</span><span style=color:#f92672>(</span>streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>connection</span><span style=color:#f92672>().</span><span style=color:#a6e22e>handshake</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>.</span><span style=color:#a6e22e>sentRequestAtMillis</span><span style=color:#f92672>(</span>sentRequestMillis<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>.</span><span style=color:#a6e22e>receivedResponseAtMillis</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      code <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>eventListener</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>responseHeadersEnd</span><span style=color:#f92672>(</span>realChain<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>(),</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>forWebSocket <span style=color:#f92672>&amp;&amp;</span> code <span style=color:#f92672>==</span> 101<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Connection is upgrading, but we need to ensure interceptors see a non-null response body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      response <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>EMPTY_RESPONSE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 通过httpCodec的openResponseBody创建读取response的body的数据流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      response <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span>httpCodec<span style=color:#f92672>.</span><span style=color:#a6e22e>openResponseBody</span><span style=color:#f92672>(</span>response<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;close&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>().</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connection&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;close&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connection&#34;</span><span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      streamAllocation<span style=color:#f92672>.</span><span style=color:#a6e22e>noNewStreams</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>code <span style=color:#f92672>==</span> 204 <span style=color:#f92672>||</span> code <span style=color:#f92672>==</span> 205<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>()</span> <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ProtocolException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;HTTP &#34;</span> <span style=color:#f92672>+</span> code <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; had non-zero Content-Length: &#34;</span> <span style=color:#f92672>+</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 最后返回构建好的response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以上就是通过call.execute返回response的流程，这里可以发现并没有使用到Service或者多线程，因此在等待服务器响应的过程中会阻塞当前线程，因此Android中不宜直接使用execute方法。</p><blockquote><p>当我们调用call.enqueue方法时</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>Callback responseCallback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>executed<span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Already Executed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      executed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    captureCallStackTrace<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    eventListener<span style=color:#f92672>.</span><span style=color:#a6e22e>callStart</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过dispatcher将responseCallback入队
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    client<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatcher</span><span style=color:#f92672>().</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> AsyncCall<span style=color:#f92672>(</span>responseCallback<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Dispatcher.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>AsyncCall call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      readyAsyncCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用promoteAndExecute执行发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    promoteAndExecute<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Promotes eligible calls from {@link #readyAsyncCalls} to {@link #runningAsyncCalls} and runs
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * them on the executor service. Must not be called with synchronization because executing calls
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * can call into user code.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @return true if the dispatcher is currently running calls.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>promoteAndExecute</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> <span style=color:#f92672>(!</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>holdsLock</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>AsyncCall<span style=color:#f92672>&gt;</span> executableCalls <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isRunning<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 将readyAsyncCalls中的Call加入到executableCalls中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Iterator<span style=color:#f92672>&lt;</span>AsyncCall<span style=color:#f92672>&gt;</span> i <span style=color:#f92672>=</span> readyAsyncCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>();</span> i<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>();</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        AsyncCall asyncCall <span style=color:#f92672>=</span> i<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>runningAsyncCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>&gt;=</span> maxRequests<span style=color:#f92672>)</span> <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span> <span style=color:#75715e>// Max capacity.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>runningCallsForHost<span style=color:#f92672>(</span>asyncCall<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;=</span> maxRequestsPerHost<span style=color:#f92672>)</span> <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span> <span style=color:#75715e>// Host max capacity.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        i<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        executableCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>asyncCall<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        runningAsyncCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>asyncCall<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      isRunning <span style=color:#f92672>=</span> runningCallsCount<span style=color:#f92672>()</span> <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> size <span style=color:#f92672>=</span> executableCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> size<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      AsyncCall asyncCall <span style=color:#f92672>=</span> executableCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 通过遍历executableCalls，调用每一个Call的executeOn方法，其中使用到了初始化过程中引入的线程池executorService
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      asyncCall<span style=color:#f92672>.</span><span style=color:#a6e22e>executeOn</span><span style=color:#f92672>(</span>executorService<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> isRunning<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> ExecutorService <span style=color:#a6e22e>executorService</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>executorService <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      executorService <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadPoolExecutor<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_VALUE</span><span style=color:#f92672>,</span> 60<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>new</span> SynchronousQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;(),</span> Util<span style=color:#f92672>.</span><span style=color:#a6e22e>threadFactory</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;OkHttp Dispatcher&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> executorService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Attempt to enqueue this async call on {@code executorService}. This will attempt to clean up
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * if the executor has been shut down by reporting the call as failed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>executeOn</span><span style=color:#f92672>(</span>ExecutorService executorService<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>assert</span> <span style=color:#f92672>(!</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>holdsLock</span><span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatcher</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> success <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关键代码通过线程池executorService执行此Call，又因为AsyncCall继承自NamedRunnable，因此，调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// AsyncCall的run方法时，执行的是NamedRunnable的run
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        success <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RejectedExecutionException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        InterruptedIOException ioException <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InterruptedIOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;executor rejected&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        ioException<span style=color:#f92672>.</span><span style=color:#a6e22e>initCause</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        eventListener<span style=color:#f92672>.</span><span style=color:#a6e22e>callFailed</span><span style=color:#f92672>(</span>RealCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> ioException<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        responseCallback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>RealCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> ioException<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>success<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          client<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatcher</span><span style=color:#f92672>().</span><span style=color:#a6e22e>finished</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span> <span style=color:#75715e>// This call is no longer running!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Runnable implementation which always sets its thread name.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NamedRunnable</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>final</span> String name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>NamedRunnable</span><span style=color:#f92672>(</span>String format<span style=color:#f92672>,</span> Object<span style=color:#f92672>...</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> Util<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span>format<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String oldName <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 这里的execute由AsyncCall实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      execute<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span>oldName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> signalledCallback <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      timeout<span style=color:#f92672>.</span><span style=color:#a6e22e>enter</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 最终又回到了getResponseWithInterceptorChain方法，后面的不用多说
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Response response <span style=color:#f92672>=</span> getResponseWithInterceptorChain<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>retryAndFollowUpInterceptor<span style=color:#f92672>.</span><span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          signalledCallback <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 与此同时我们通过responseCallback.onFailure将事件回调出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          responseCallback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>RealCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> IOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Canceled&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          signalledCallback <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 同上
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          responseCallback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>RealCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e <span style=color:#f92672>=</span> timeoutExit<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>signalledCallback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Do not signal the callback twice!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          Platform<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Callback failure for &#34;</span> <span style=color:#f92672>+</span> toLoggableString<span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          eventListener<span style=color:#f92672>.</span><span style=color:#a6e22e>callFailed</span><span style=color:#f92672>(</span>RealCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          responseCallback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>RealCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span><span style=color:#a6e22e>dispatcher</span><span style=color:#f92672>().</span><span style=color:#a6e22e>finished</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>综上，OkHttp的源码中采用了非常多的有意思的设计模式，比如建造者模式，对于HTTP请求来说，我们需要一些公用的资源比如线程池、连接池等，将这些公共资源设置在OkHttpClient中，然后通过单例模式引用，节省了很多资源消耗；</p><p>对于RequestBody以及Request这种参数设置非常多的实体，通过建造者模式保存其参数；</p><p>在构建请求实体Call的时候采用了OkHttpClient工厂类，同时发送request的过程中利用了链式传递的方式，既增加了开发人员自定义的Interceptor，又可以利用原本定义好的Interceptor。</p><h2 id=3-retrofit>3. Retrofit<a hidden class=anchor aria-hidden=true href=#3-retrofit>#</a></h2><p>Retrofit也是一个网络请求框架，且Retrofit是基于OkHttp的，实际网络请求的功能由OkHttp来实现，但是Retrofit实现了额外的功能，比如利用Gson进行数据实体化、兼容RxJava等等，是一个比较流行的网络请求工具。</p><h3 id=31-retrofit使用>3.1 Retrofit使用<a hidden class=anchor aria-hidden=true href=#31-retrofit使用>#</a></h3><p>需要<code>implementation 'com.squareup.retrofit2:retrofit:2.6.0'</code></p><p>以请求和风天气数据为例，通过GET请求，加上location参数和key参数，服务器返回json数据，我们将json数据实体化，首先看一下返回的json格式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;HeWeather6&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;basic&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cid&#34;</span>: <span style=color:#e6db74>&#34;CN101010100&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;北京&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;parent_city&#34;</span>: <span style=color:#e6db74>&#34;北京&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;admin_area&#34;</span>: <span style=color:#e6db74>&#34;北京&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cnty&#34;</span>: <span style=color:#e6db74>&#34;中国&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;lat&#34;</span>: <span style=color:#e6db74>&#34;39.90498734&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;lon&#34;</span>: <span style=color:#e6db74>&#34;116.4052887&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;tz&#34;</span>: <span style=color:#e6db74>&#34;+8.00&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;update&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;loc&#34;</span>: <span style=color:#e6db74>&#34;2019-07-18 16:45&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;utc&#34;</span>: <span style=color:#e6db74>&#34;2019-07-18 08:45&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ok&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;now&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cloud&#34;</span>: <span style=color:#e6db74>&#34;10&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cond_code&#34;</span>: <span style=color:#e6db74>&#34;101&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;cond_txt&#34;</span>: <span style=color:#e6db74>&#34;多云&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;fl&#34;</span>: <span style=color:#e6db74>&#34;35&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;hum&#34;</span>: <span style=color:#e6db74>&#34;54&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;pcpn&#34;</span>: <span style=color:#e6db74>&#34;0.0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;pres&#34;</span>: <span style=color:#e6db74>&#34;1000&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;tmp&#34;</span>: <span style=color:#e6db74>&#34;32&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;vis&#34;</span>: <span style=color:#e6db74>&#34;6&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_deg&#34;</span>: <span style=color:#e6db74>&#34;279&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_dir&#34;</span>: <span style=color:#e6db74>&#34;西风&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_sc&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wind_spd&#34;</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>1.根据json数据构建我们的实体类WeatherEntity，这里使用的Android Studio的插件GsonFormat，可以直接根据json数据生成代码</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WeatherEntity</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>HeWeather6Bean<span style=color:#f92672>&gt;</span> HeWeather6<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>HeWeather6Bean<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getHeWeather6</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> HeWeather6<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setHeWeather6</span><span style=color:#f92672>(</span>List<span style=color:#f92672>&lt;</span>HeWeather6Bean<span style=color:#f92672>&gt;</span> HeWeather6<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>HeWeather6</span> <span style=color:#f92672>=</span> HeWeather6<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 重写以下toString方法，便于后续观察数据传输是否正确
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> HeWeather6<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>).</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HeWeather6Bean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * basic : {&#34;cid&#34;:&#34;CN101010100&#34;,&#34;location&#34;:&#34;北京&#34;,&#34;parent_city&#34;:&#34;北京&#34;,&#34;admin_area&#34;:&#34;北京&#34;,&#34;cnty&#34;:&#34;中国&#34;,&#34;lat&#34;:&#34;39.90498734&#34;,&#34;lon&#34;:&#34;116.4052887&#34;,&#34;tz&#34;:&#34;+8.00&#34;}
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * update : {&#34;loc&#34;:&#34;2019-07-18 16:45&#34;,&#34;utc&#34;:&#34;2019-07-18 08:45&#34;}
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * status : ok
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * now : {&#34;cloud&#34;:&#34;10&#34;,&#34;cond_code&#34;:&#34;101&#34;,&#34;cond_txt&#34;:&#34;多云&#34;,&#34;fl&#34;:&#34;35&#34;,&#34;hum&#34;:&#34;54&#34;,&#34;pcpn&#34;:&#34;0.0&#34;,&#34;pres&#34;:&#34;1000&#34;,&#34;tmp&#34;:&#34;32&#34;,&#34;vis&#34;:&#34;6&#34;,&#34;wind_deg&#34;:&#34;279&#34;,&#34;wind_dir&#34;:&#34;西风&#34;,&#34;wind_sc&#34;:&#34;1&#34;,&#34;wind_spd&#34;:&#34;3&#34;}
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> BasicBean basic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> UpdateBean update<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> NowBean now<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> status <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; \n &#34;</span> <span style=color:#f92672>+</span> basic<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; \n &#34;</span> <span style=color:#f92672>+</span> update<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; \n &#34;</span> <span style=color:#f92672>+</span> now<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> BasicBean <span style=color:#a6e22e>getBasic</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> basic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBasic</span><span style=color:#f92672>(</span>BasicBean basic<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>basic</span> <span style=color:#f92672>=</span> basic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> UpdateBean <span style=color:#a6e22e>getUpdate</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> update<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUpdate</span><span style=color:#f92672>(</span>UpdateBean update<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>update</span> <span style=color:#f92672>=</span> update<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>String status<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> NowBean <span style=color:#a6e22e>getNow</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> now<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setNow</span><span style=color:#f92672>(</span>NowBean now<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> now<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BasicBean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cid : CN101010100
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * location : 北京
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * parent_city : 北京
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * admin_area : 北京
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cnty : 中国
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * lat : 39.90498734
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * lon : 116.4052887
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * tz : +8.00
</span></span></span><span style=display:flex><span><span style=color:#75715e>             */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String parent_city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String admin_area<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cnty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String lat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String lon<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String tz<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;cid : &#34;</span> <span style=color:#f92672>+</span> cid <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;location : &#34;</span> <span style=color:#f92672>+</span> location <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;parent_city : &#34;</span> <span style=color:#f92672>+</span> parent_city <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;admin_area : &#34;</span> <span style=color:#f92672>+</span> admin_area <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;cnty : &#34;</span> <span style=color:#f92672>+</span> cnty <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;lat : &#34;</span> <span style=color:#f92672>+</span> lat <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;lon : &#34;</span> <span style=color:#f92672>+</span> lon <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;tz : &#34;</span> <span style=color:#f92672>+</span> tz <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCid</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCid</span><span style=color:#f92672>(</span>String cid<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cid</span> <span style=color:#f92672>=</span> cid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLocation</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLocation</span><span style=color:#f92672>(</span>String location<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> location<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getParent_city</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> parent_city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setParent_city</span><span style=color:#f92672>(</span>String parent_city<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>parent_city</span> <span style=color:#f92672>=</span> parent_city<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getAdmin_area</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> admin_area<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setAdmin_area</span><span style=color:#f92672>(</span>String admin_area<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>admin_area</span> <span style=color:#f92672>=</span> admin_area<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCnty</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cnty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCnty</span><span style=color:#f92672>(</span>String cnty<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cnty</span> <span style=color:#f92672>=</span> cnty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLat</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> lat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLat</span><span style=color:#f92672>(</span>String lat<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lat</span> <span style=color:#f92672>=</span> lat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLon</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> lon<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLon</span><span style=color:#f92672>(</span>String lon<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lon</span> <span style=color:#f92672>=</span> lon<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getTz</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> tz<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTz</span><span style=color:#f92672>(</span>String tz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tz</span> <span style=color:#f92672>=</span> tz<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UpdateBean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * loc : 2019-07-18 16:45
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * utc : 2019-07-18 08:45
</span></span></span><span style=display:flex><span><span style=color:#75715e>             */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String loc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String utc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;loc : &#34;</span> <span style=color:#f92672>+</span> loc <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;utc : &#34;</span> <span style=color:#f92672>+</span> utc <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getLoc</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> loc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLoc</span><span style=color:#f92672>(</span>String loc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loc</span> <span style=color:#f92672>=</span> loc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getUtc</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> utc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUtc</span><span style=color:#f92672>(</span>String utc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>utc</span> <span style=color:#f92672>=</span> utc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NowBean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cloud : 10
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cond_code : 101
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * cond_txt : 多云
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * fl : 35
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * hum : 54
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * pcpn : 0.0
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * pres : 1000
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * tmp : 32
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * vis : 6
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_deg : 279
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_dir : 西风
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_sc : 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>             * wind_spd : 3
</span></span></span><span style=display:flex><span><span style=color:#75715e>             */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cloud<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cond_code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String cond_txt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String fl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String hum<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String pcpn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String pres<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String tmp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String vis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_deg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_dir<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_sc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> String wind_spd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;cloud : &#34;</span> <span style=color:#f92672>+</span> cloud <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;cond_code : &#34;</span> <span style=color:#f92672>+</span> cond_code <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;cond_txt : &#34;</span> <span style=color:#f92672>+</span> cond_txt <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;fl : &#34;</span> <span style=color:#f92672>+</span> fl <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;hum : &#34;</span> <span style=color:#f92672>+</span> hum <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;pcpn : &#34;</span> <span style=color:#f92672>+</span> pcpn <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;pres : &#34;</span> <span style=color:#f92672>+</span> pres <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;tmp : &#34;</span> <span style=color:#f92672>+</span> tmp <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;vis : &#34;</span> <span style=color:#f92672>+</span> vis <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_deg : &#34;</span> <span style=color:#f92672>+</span> wind_deg <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_dir : &#34;</span> <span style=color:#f92672>+</span> wind_dir <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_sc : &#34;</span> <span style=color:#f92672>+</span> wind_sc <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;wind_spd : &#34;</span> <span style=color:#f92672>+</span> wind_spd <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCloud</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cloud<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCloud</span><span style=color:#f92672>(</span>String cloud<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cloud</span> <span style=color:#f92672>=</span> cloud<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCond_code</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cond_code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCond_code</span><span style=color:#f92672>(</span>String cond_code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cond_code</span> <span style=color:#f92672>=</span> cond_code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getCond_txt</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> cond_txt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCond_txt</span><span style=color:#f92672>(</span>String cond_txt<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cond_txt</span> <span style=color:#f92672>=</span> cond_txt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getFl</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> fl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setFl</span><span style=color:#f92672>(</span>String fl<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>fl</span> <span style=color:#f92672>=</span> fl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getHum</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> hum<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setHum</span><span style=color:#f92672>(</span>String hum<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hum</span> <span style=color:#f92672>=</span> hum<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPcpn</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> pcpn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPcpn</span><span style=color:#f92672>(</span>String pcpn<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pcpn</span> <span style=color:#f92672>=</span> pcpn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPres</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> pres<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPres</span><span style=color:#f92672>(</span>String pres<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pres</span> <span style=color:#f92672>=</span> pres<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getTmp</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> tmp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTmp</span><span style=color:#f92672>(</span>String tmp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tmp</span> <span style=color:#f92672>=</span> tmp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getVis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> vis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setVis</span><span style=color:#f92672>(</span>String vis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>vis</span> <span style=color:#f92672>=</span> vis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_deg</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_deg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_deg</span><span style=color:#f92672>(</span>String wind_deg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_deg</span> <span style=color:#f92672>=</span> wind_deg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_dir</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_dir<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_dir</span><span style=color:#f92672>(</span>String wind_dir<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_dir</span> <span style=color:#f92672>=</span> wind_dir<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_sc</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_sc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_sc</span><span style=color:#f92672>(</span>String wind_sc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_sc</span> <span style=color:#f92672>=</span> wind_sc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getWind_spd</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> wind_spd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWind_spd</span><span style=color:#f92672>(</span>String wind_spd<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>wind_spd</span> <span style=color:#f92672>=</span> wind_spd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>2.构建请求Api，请求url格式为<code>https://free-api.heweather.net/s6/weather/now?location=beijing&key=xxx</code>，因此将<code>https://free-api.heweather.net/s6/weather/</code>作为baseUrl（baseUrl必须以<code>/</code>结尾），<code>now?</code>作为请求url主体，后面的两个作为参数通过<code>@Query</code>加入</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Api</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过@Query(&#34;location&#34;)的方式可以自动将location=location连接到我们的请求url后面
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@GET</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;now?&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Call<span style=color:#f92672>&lt;</span>WeatherEntity<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getNowWeather</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Query</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;location&#34;</span><span style=color:#f92672>)</span> String location<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Query</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;key&#34;</span><span style=color:#f92672>)</span> String key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果需要使用RxJava，需要修改返回类型为Observable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// @GET(&#34;now?&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Observable&lt;WeatherEntity&gt; getNowWeather(@Query(&#34;location&#34;) String location, @Query(&#34;key&#34;) String key);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>3.构建Retrofit实体，需要<code>implementation 'com.squareup.retrofit2:converter-gson:2.6.0'</code>，这里的版本号和Retrofit相同即可，如果需要RxJava2，则添加<code>implementation 'com.squareup.retrofit2:adapter-rxjava2:2.6.0'</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Retrofit retrofit <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>baseUrl</span><span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span> <span style=color:#75715e>// 设置网络请求的公共Url地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>addConverterFactory</span><span style=color:#f92672>(</span>GsonConverterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>())</span> <span style=color:#75715e>// 设置数据解析器Gson
</span></span></span><span style=display:flex><span><span style=color:#75715e>//      .addCallAdapterFactory(RxJava2CallAdapterFactory.create())   // 如果需要使用RxJava2     
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>     
</span></span></code></pre></div><blockquote><p>4.构造接口实体</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Api api <span style=color:#f92672>=</span> retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>Api<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><blockquote><p>5.构造Call，这里的Call是retrofit2的Call，与okHttp的Call还是不一样的，如果是使用RxJava2，则为Observable</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>&lt;</span>WeatherEntity<span style=color:#f92672>&gt;</span> call <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span><span style=color:#a6e22e>getNowWeather</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;beijing&#34;</span><span style=color:#f92672>,</span> KEY<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Observable&lt;WeatherEntity&gt; observable = api.getNowWeather(&#34;beijing&#34;, KEY);
</span></span></span></code></pre></div><blockquote><p>6.调用call.enqueue发送请求</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>Callback</span><span style=color:#f92672>&lt;</span>WeatherEntity<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>&lt;</span>WeatherEntity<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>Response</span><span style=color:#f92672>&lt;</span>WeatherEntity<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        WeatherEntity entity <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        textView<span style=color:#f92672>.</span><span style=color:#a6e22e>setText</span><span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>&lt;</span>WeatherEntity<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果是RxJava则按照设计在io线程请求数据，在mainThread主线程显示结果
</span></span></span><span style=display:flex><span><span style=color:#75715e>// observable.subscribeOn(Schedulers.io())
</span></span></span><span style=display:flex><span><span style=color:#75715e>//         .observeOn(AndroidSchedulers.mainThread())
</span></span></span><span style=display:flex><span><span style=color:#75715e>//         .subscribe(new Consumer&lt;WeatherEntity&gt;() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//             @Override
</span></span></span><span style=display:flex><span><span style=color:#75715e>//             public void accept(WeatherEntity weatherEntity) throws Exception {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//             }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//         }, new Consumer&lt;Throwable&gt;() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//             @Override
</span></span></span><span style=display:flex><span><span style=color:#75715e>//             public void accept(Throwable throwable) throws Exception {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                
</span></span><span style=display:flex><span><span style=color:#75715e>//             }
</span></span></span><span style=display:flex><span><span style=color:#75715e>//         });
</span></span></span></code></pre></div><h3 id=32-retrofit源码分析>3.2 Retrofit源码分析<a hidden class=anchor aria-hidden=true href=#32-retrofit源码分析>#</a></h3><p>Retrofit也采用了建造者模式，通过<code>new Retrofit.Builder()</code>初始化Retrofit对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Retrofit.java 这里初始化Retrofit对象的时候需要参数Platform，看来是和平台相关
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 我们直到OkHttp是Java和Android相同都可以使用的，但是OkHttp没有做平台判断，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Retrofit需要平台判断应该是与后面一些功能相关
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>Platform<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Platform.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Platform PLATFORM <span style=color:#f92672>=</span> findPlatform<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> Platform <span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> PLATFORM<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通过findPlatform获取平台信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Platform <span style=color:#a6e22e>findPlatform</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 判断的方式简单粗暴，直接通过Class.forName找系统的类，通过抛出异常终止，妙啊妙啊
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;android.os.Build&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里只看Android类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Android<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ClassNotFoundException ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 同理对Java平台
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;java.util.Optional&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Java8<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ClassNotFoundException ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Platform<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Android继承自Platform
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Android</span> <span style=color:#66d9ef>extends</span> Platform <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@IgnoreJRERequirement</span> <span style=color:#75715e>// Guarded by API check.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isDefaultMethod</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&lt;</span> 24<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>isDefault</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// defaultCallbackExecutor返回了MainThreadExecutor，Executor是一个接口，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 实现此接口的类需要完成execute方法，通过execute方法可以运行Runnable对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Executor <span style=color:#a6e22e>defaultCallbackExecutor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MainThreadExecutor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 两个关键的类CallAdapter和Converter，CallAdapter用于转换Call的类型，以RxJava2CallAdapterFactory为例，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 如果在构造Retrofit对象时加上了addCallAdapterFactory(RxJava2CallAdapterFactory.create())，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 则需要对Api类中的方法返回值类型进行修改，改为RxJava支持的Observable类型，然后就可以通过RxJava的方式发送请求；
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Converter用于对Response的Body进行格式转换，以GsonConverterFactory为例，可以将Response的Body中的json数据实体化，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 直接转换为我们定义的对象。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span> List<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CallAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>defaultCallAdapterFactories</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Nullable</span> Executor callbackExecutor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callbackExecutor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 根据BuildSDKVersion决定用DefaultCallAdapterFactory还是CompletableFutureCallAdapterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 暂时用不到，稍后再分析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      DefaultCallAdapterFactory executorFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultCallAdapterFactory<span style=color:#f92672>(</span>callbackExecutor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> 24
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> asList<span style=color:#f92672>(</span>CompletableFutureCallAdapterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>,</span> executorFactory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> singletonList<span style=color:#f92672>(</span>executorFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>defaultCallAdapterFactoriesSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> 24 <span style=color:#f92672>?</span> 2 <span style=color:#f92672>:</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> List<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>defaultConverterFactories</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 同CallAdapter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> 24
</span></span><span style=display:flex><span>          <span style=color:#f92672>?</span> singletonList<span style=color:#f92672>(</span>OptionalConverterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>:</span> Collections<span style=color:#f92672>.&lt;</span>Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span>emptyList<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>defaultConverterFactoriesSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> 24 <span style=color:#f92672>?</span> 1 <span style=color:#f92672>:</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// MainThreadExecutor实现了Executor接口，通过主线程的Handler运行Runnable对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainThreadExecutor</span> <span style=color:#66d9ef>implements</span> Executor <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Handler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>getMainLooper</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        handler<span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Retrofit.java Retrofit初始化仅保存了平台信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Builder<span style=color:#f92672>(</span>Platform platform<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>platform</span> <span style=color:#f92672>=</span> platform<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 然后是baseUrl方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Set the API base URL.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see #baseUrl(HttpUrl)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>baseUrl</span><span style=color:#f92672>(</span>String baseUrl<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      checkNotNull<span style=color:#f92672>(</span>baseUrl<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;baseUrl == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> baseUrl<span style=color:#f92672>(</span>HttpUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>baseUrl<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 对baseUrl的格式进行判断，必须以 / 结尾，否则抛出异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>baseUrl</span><span style=color:#f92672>(</span>HttpUrl baseUrl<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      checkNotNull<span style=color:#f92672>(</span>baseUrl<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;baseUrl == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> pathSegments <span style=color:#f92672>=</span> baseUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>pathSegments</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>pathSegments<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>pathSegments<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;baseUrl must end in /: &#34;</span> <span style=color:#f92672>+</span> baseUrl<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>baseUrl</span> <span style=color:#f92672>=</span> baseUrl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 接下来是addConverterFactory方法，看起没有什么复杂的功能，只是将Converter.Factory的实现加入了list中，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 我们稍后再看GsonConverterFactory的源码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> converterFactories <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Add converter factory for serialization and deserialization of objects. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>addConverterFactory</span><span style=color:#f92672>(</span>Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> factory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>checkNotNull<span style=color:#f92672>(</span>factory<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;factory == null&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 最后是build方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Create the {@link Retrofit} instance using the configured values.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Note: If neither {@link #client} nor {@link #callFactory} is called a default {@link
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * OkHttpClient} will be created and used.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Retrofit <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>baseUrl <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Base URL required.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 注意这里初始化了一个OkHttpClient对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> callFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callFactory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        callFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      Executor callbackExecutor <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callbackExecutor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callbackExecutor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 我们知道默认情况下，在Android平台，这个callbackExecutor是主线程的Executor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        callbackExecutor <span style=color:#f92672>=</span> platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultCallbackExecutor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Make a defensive copy of the adapters and add the default Call adapter.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// callAdapterFactories包括通过Retrofit初始化调用addCallAdapterFactory加入的CallAdapter.Factory，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 还包括Android平台默认的platform.defaultCallAdapterFactories
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      List<span style=color:#f92672>&lt;</span>CallAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> callAdapterFactories <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callAdapterFactories</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultCallAdapterFactories</span><span style=color:#f92672>(</span>callbackExecutor<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Make a defensive copy of the converters.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// converterFactories同理，但是多一个BuiltInConverters，暂时不去管不同的Converter的具体实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      List<span style=color:#f92672>&lt;</span>Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> converterFactories <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>          1 <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>converterFactories</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultConverterFactoriesSize</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Add the built-in converter factory first. This prevents overriding its behavior but also
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// ensures correct behavior when using converters that consume all types.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BuiltInConverters<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>converterFactories</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultConverterFactories</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 最后完成了Retrofit对象的初始化，引入了几个参数，包括OkHttpClient对象，baseUrl，CallAdapter，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// Converter以及Executor，validateEagerly默认为false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Retrofit<span style=color:#f92672>(</span>callFactory<span style=color:#f92672>,</span> baseUrl<span style=color:#f92672>,</span> unmodifiableList<span style=color:#f92672>(</span>converterFactories<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>          unmodifiableList<span style=color:#f92672>(</span>callAdapterFactories<span style=color:#f92672>),</span> callbackExecutor<span style=color:#f92672>,</span> validateEagerly<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>接下来是<code>Api api = retrofit.create(Api.class);</code>，Retrofit通过调用create方法将接口类实例化</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// Single-interface proxy creation guarded by parameter safety.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> service<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// validateServiceInterface主要判断service是否为接口且没有继承自其他接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateServiceInterface</span><span style=color:#f92672>(</span>service<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// validateEagerly为false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>validateEagerly<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      eagerlyValidateMethods<span style=color:#f92672>(</span>service<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过代理的方式反射接口，将其实例化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span> Proxy<span style=color:#f92672>.</span><span style=color:#a6e22e>newProxyInstance</span><span style=color:#f92672>(</span>service<span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>&lt;?&gt;[]</span> <span style=color:#f92672>{</span> service <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> InvocationHandler<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 这里不同的平台有不同的方式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Platform platform <span style=color:#f92672>=</span> Platform<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Object<span style=color:#f92672>[]</span> emptyArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> Object <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object proxy<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>@Nullable</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// If the method is a method from Object then defer to normal invocation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 这里的invoke，Object方法都走这里，比如equals、toString、hashCode什么的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果是Java Web项目则通过platform.invokeDefaultMethod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>isDefaultMethod</span><span style=color:#f92672>(</span>method<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> platform<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeDefaultMethod</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> service<span style=color:#f92672>,</span> proxy<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果是Android则通过loadServiceMethod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> loadServiceMethod<span style=color:#f92672>(</span>method<span style=color:#f92672>).</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>args <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> args <span style=color:#f92672>:</span> emptyArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>eagerlyValidateMethods</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> service<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Platform platform <span style=color:#f92672>=</span> Platform<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Method method <span style=color:#f92672>:</span> service<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredMethods</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>isDefaultMethod</span><span style=color:#f92672>(</span>method<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isStatic</span><span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        loadServiceMethod<span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ServiceMethod<span style=color:#f92672>&lt;?&gt;</span> loadServiceMethod<span style=color:#f92672>(</span>Method method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ServiceMethod<span style=color:#f92672>&lt;?&gt;</span> result <span style=color:#f92672>=</span> serviceMethodCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认result为空，通过单例模式取result，简而言之就是得到接口里面定义的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 并且在方法被调用的时候将参数传入，从而得到结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>serviceMethodCache<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> serviceMethodCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        result <span style=color:#f92672>=</span> ServiceMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        serviceMethodCache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> result<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ServiceMethod.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceMethod</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// parseAnnotations还是通过RequestFactory解析接口的方法，因为我们定义的方法是包含注解的，所以必定需要通过
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 解析注解的值来控制方法的参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> ServiceMethod<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>Retrofit retrofit<span style=color:#f92672>,</span> Method method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// RequestFactory看名字就知道应该和构建HTTP请求相关，应该是将retrofit定义的baseUrl等信息以及接口定义的方法，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 包括注解里的信息整合
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RequestFactory requestFactory <span style=color:#f92672>=</span> RequestFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Type returnType <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericReturnType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasUnresolvableType</span><span style=color:#f92672>(</span>returnType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Method return type must not include a type variable or wildcard: %s&#34;</span><span style=color:#f92672>,</span> returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>returnType <span style=color:#f92672>==</span> <span style=color:#66d9ef>void</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Service methods cannot return void.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// HttpServiceMethod继承自ServiceMethod，实现invoke方法，即最终我们调用接口中的方式时将参数传入
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> HttpServiceMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>,</span> requestFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>@Nullable</span> T <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RequestFactory.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> RequestFactory <span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>Retrofit retrofit<span style=color:#f92672>,</span> Method method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Builder<span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// build方法构建的实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RequestFactory <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Annotation annotation <span style=color:#f92672>:</span> methodAnnotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 在parseMethodAnnotation中处理接口方法的注解，这里仅保存了请求方法以及
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 方法注解中的value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        parseMethodAnnotation<span style=color:#f92672>(</span>annotation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>httpMethod <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;HTTP method annotation is required (e.g., @GET, @POST, etc.).&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>hasBody<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMultipart<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;Multipart can only be specified on HTTP methods with request body (e.g., @POST).&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isFormEncoded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;FormUrlEncoded can only be specified on HTTP methods with &#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;request body (e.g., @POST).&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// parameterAnnotationsArray是通过Method传过来的，简单来说就是方法的参数注解，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 即我们使用的@Query(&#34;location&#34;)和@Query(&#34;key&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>int</span> parameterCount <span style=color:#f92672>=</span> parameterAnnotationsArray<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      parameterHandlers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ParameterHandler<span style=color:#f92672>&lt;?&gt;[</span>parameterCount<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> p <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> lastParameter <span style=color:#f92672>=</span> parameterCount <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> p <span style=color:#f92672>&lt;</span> parameterCount<span style=color:#f92672>;</span> p<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过parseParameter方法处理参数注解，并保存在parameterHandlers中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        parameterHandlers<span style=color:#f92672>[</span>p<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            parseParameter<span style=color:#f92672>(</span>p<span style=color:#f92672>,</span> parameterTypes<span style=color:#f92672>[</span>p<span style=color:#f92672>],</span> parameterAnnotationsArray<span style=color:#f92672>[</span>p<span style=color:#f92672>],</span> p <span style=color:#f92672>==</span> lastParameter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>relativeUrl <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>gotUrl<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Missing either @%s URL or @Url parameter.&#34;</span><span style=color:#f92672>,</span> httpMethod<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isFormEncoded <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>isMultipart <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>hasBody <span style=color:#f92672>&amp;&amp;</span> gotBody<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Non-body HTTP method cannot contain @Body.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isFormEncoded <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>gotField<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Form-encoded method must contain at least one @Field.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMultipart <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>gotPart<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Multipart method must contain at least one @Part.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestFactory<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// parseMethodAnnotation处理的是方法注解即 @GET(&#34;now?&#34;) ，now?作为value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 根据不同的注解类型，构造不同的请求方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>parseMethodAnnotation</span><span style=color:#f92672>(</span>Annotation annotation<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> DELETE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DELETE&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>((</span>DELETE<span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> GET<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;GET&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>((</span>GET<span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> HEAD<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HEAD&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>((</span>HEAD<span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> PATCH<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;PATCH&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>((</span>PATCH<span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> POST<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;POST&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>((</span>POST<span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> PUT<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;PUT&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>((</span>PUT<span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> OPTIONS<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;OPTIONS&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>((</span>OPTIONS<span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> HTTP<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HTTP http <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HTTP<span style=color:#f92672>)</span> annotation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        parseHttpMethodAndPath<span style=color:#f92672>(</span>http<span style=color:#f92672>.</span><span style=color:#a6e22e>method</span><span style=color:#f92672>(),</span> http<span style=color:#f92672>.</span><span style=color:#a6e22e>path</span><span style=color:#f92672>(),</span> http<span style=color:#f92672>.</span><span style=color:#a6e22e>hasBody</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>http</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Headers</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String<span style=color:#f92672>[]</span> headersToParse <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>http</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Headers</span><span style=color:#f92672>)</span> annotation<span style=color:#f92672>).</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>headersToParse<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;@Headers annotation is empty.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> parseHeaders<span style=color:#f92672>(</span>headersToParse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> Multipart<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isFormEncoded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Only one encoding annotation is allowed.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        isMultipart <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> FormUrlEncoded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMultipart<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Only one encoding annotation is allowed.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        isFormEncoded <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>parseHttpMethodAndPath</span><span style=color:#f92672>(</span>String httpMethod<span style=color:#f92672>,</span> String value<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> hasBody<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>httpMethod</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Only one HTTP method is allowed. Found: %s and %s.&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>httpMethod</span><span style=color:#f92672>,</span> httpMethod<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 保存了请求方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>httpMethod</span> <span style=color:#f92672>=</span> httpMethod<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasBody</span> <span style=color:#f92672>=</span> hasBody<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>value<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Get the relative URL path and existing query string, if present.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 这里的判断是确保@GET(&#34;now?location={location}&amp;key={key}&#34;)其中的location={location}&amp;key={key}不会出现，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 因为需要通过@Query注解构建，所以这里不允许使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>int</span> question <span style=color:#f92672>=</span> value<span style=color:#f92672>.</span><span style=color:#a6e22e>indexOf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;?&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>question <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1 <span style=color:#f92672>&amp;&amp;</span> question <span style=color:#f92672>&lt;</span> value<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Ensure the query string does not have any named parameters.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String queryParams <span style=color:#f92672>=</span> value<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>question <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Matcher queryParamMatcher <span style=color:#f92672>=</span> PARAM_URL_REGEX<span style=color:#f92672>.</span><span style=color:#a6e22e>matcher</span><span style=color:#f92672>(</span>queryParams<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>queryParamMatcher<span style=color:#f92672>.</span><span style=color:#a6e22e>find</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;URL query string \&#34;%s\&#34; must not have replace block. &#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;For dynamic query parameters use @Query.&#34;</span><span style=color:#f92672>,</span> queryParams<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>relativeUrl</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>relativeUrlParamNames</span> <span style=color:#f92672>=</span> parsePathParameters<span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// parseParameter方法，对于同一个参数似乎可以使用多个参数注解Annotation[] annotations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>@Nullable</span> ParameterHandler<span style=color:#f92672>&lt;?&gt;</span> parseParameter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> p<span style=color:#f92672>,</span> Type parameterType<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> allowContinuation<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      ParameterHandler<span style=color:#f92672>&lt;?&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotations <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Annotation annotation <span style=color:#f92672>:</span> annotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 调用parseParameterAnnotation对参数注解进行处理，其中还包括传入的参数类型parameterType
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          ParameterHandler<span style=color:#f92672>&lt;?&gt;</span> annotationAction <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>              parseParameterAnnotation<span style=color:#f92672>(</span>p<span style=color:#f92672>,</span> parameterType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>,</span> annotation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationAction <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> parameterError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> p<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Multiple Retrofit annotations found, only one allowed.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          result <span style=color:#f92672>=</span> annotationAction<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>allowContinuation<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getRawType</span><span style=color:#f92672>(</span>parameterType<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> Continuation<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              isKotlinSuspendFunction <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoClassDefFoundError ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> parameterError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> p<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;No Retrofit annotation found.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// parseParameterAnnotation方法，这里判断参数注解的类型，我们只看@Query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ParameterHandler<span style=color:#f92672>&lt;?&gt;</span> parseParameterAnnotation<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> p<span style=color:#f92672>,</span> Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> Annotation annotation<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> Url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> Path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#66d9ef>instanceof</span> Query<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        validateResolvableType<span style=color:#f92672>(</span>p<span style=color:#f92672>,</span> type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Query query <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Query<span style=color:#f92672>)</span> annotation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> query<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> encoded <span style=color:#f92672>=</span> query<span style=color:#f92672>.</span><span style=color:#a6e22e>encoded</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Class<span style=color:#f92672>&lt;?&gt;</span> rawParameterType <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getRawType</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        gotQuery <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断参数类型是否为可迭代类或者Array类，目前我们的参数是String，所以直接到最后一个条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Iterable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>rawParameterType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>type <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> parameterError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> p<span style=color:#f92672>,</span> rawParameterType<span style=color:#f92672>.</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; must include generic type (e.g., &#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> rawParameterType<span style=color:#f92672>.</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;String&gt;)&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          ParameterizedType parameterizedType <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> type<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          Type iterableType <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterUpperBound</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> parameterizedType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          Converter<span style=color:#f92672>&lt;?,</span> String<span style=color:#f92672>&gt;</span> converter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>              retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>stringConverter</span><span style=color:#f92672>(</span>iterableType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ParameterHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>Query</span><span style=color:#f92672>&lt;&gt;(</span>name<span style=color:#f92672>,</span> converter<span style=color:#f92672>,</span> encoded<span style=color:#f92672>).</span><span style=color:#a6e22e>iterable</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rawParameterType<span style=color:#f92672>.</span><span style=color:#a6e22e>isArray</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          Class<span style=color:#f92672>&lt;?&gt;</span> arrayComponentType <span style=color:#f92672>=</span> boxIfPrimitive<span style=color:#f92672>(</span>rawParameterType<span style=color:#f92672>.</span><span style=color:#a6e22e>getComponentType</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>          Converter<span style=color:#f92672>&lt;?,</span> String<span style=color:#f92672>&gt;</span> converter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>              retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>stringConverter</span><span style=color:#f92672>(</span>arrayComponentType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ParameterHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>Query</span><span style=color:#f92672>&lt;&gt;(</span>name<span style=color:#f92672>,</span> converter<span style=color:#f92672>,</span> encoded<span style=color:#f92672>).</span><span style=color:#a6e22e>array</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 这里调用了retrofit.stringConverter方法，将参数类型和注解进行处理，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#75715e>// 这里ParameterHandler.Query&lt;&gt;保存了参数注解的value、Converter以及参数注解的编码方式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          Converter<span style=color:#f92672>&lt;?,</span> String<span style=color:#f92672>&gt;</span> converter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>              retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>stringConverter</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ParameterHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>Query</span><span style=color:#f92672>&lt;&gt;(</span>name<span style=color:#f92672>,</span> converter<span style=color:#f92672>,</span> encoded<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> 
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>// Not a Retrofit annotation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Retrofit.java stringConverter通过遍历converterFactories，调用它们的stringConverter方法，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 看谁能够处理并返回一个Converter&lt;T, String&gt;，如果都没有则调用BuiltInConverters，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 而Converter是用于构造HTTP请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns a {@link Converter} for {@code type} to {@link String} from the available
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * {@linkplain #converterFactories() factories}.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Converter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>stringConverter</span><span style=color:#f92672>(</span>Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    checkNotNull<span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;type == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    checkNotNull<span style=color:#f92672>(</span>annotations<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;annotations == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> count <span style=color:#f92672>=</span> converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> count<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Converter<span style=color:#f92672>&lt;?,</span> String<span style=color:#f92672>&gt;</span> converter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>stringConverter</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> annotations<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>converter <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//noinspection unchecked
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>Converter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;)</span> converter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Nothing matched. Resort to default converter which just calls toString().
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//noinspection unchecked
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>Converter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;)</span> BuiltInConverters<span style=color:#f92672>.</span><span style=color:#a6e22e>ToStringConverter</span><span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以上的代码完成了RequestFactory的构建，也就是说，这个RequestFactory包含了HTTP请求的部分信息，比如请求方法、请求url的参数、参数类型以及参数的位置，通过<code>HttpServiceMethod.parseAnnotations(retrofit, method, requestFactory);</code>对请求进行适配，包括通过Converter对返回的Response body数据处理以及通过CallAdapter修改Call类型</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// HttpServiceMethod.java HttpServiceMethod继承自ServiceMethod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Inspects the annotations on an interface method to construct a reusable service method that
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * speaks HTTP. This requires potentially-expensive reflection so it is best to build each service
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * method only once and reuse it.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      Retrofit retrofit<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span> RequestFactory requestFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isKotlinSuspendFunction <span style=color:#f92672>=</span> requestFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>isKotlinSuspendFunction</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> continuationWantsResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> continuationBodyNullable <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Annotation<span style=color:#f92672>[]</span> annotations <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotations</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Type adapterType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isKotlinSuspendFunction<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Type<span style=color:#f92672>[]</span> parameterTypes <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericParameterTypes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      Type responseType <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterLowerBound</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> parameterTypes<span style=color:#f92672>[</span>parameterTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getRawType<span style=color:#f92672>(</span>responseType<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>&amp;&amp;</span> responseType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Unwrap the actual body type from Response&lt;T&gt;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        responseType <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterUpperBound</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        continuationWantsResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// TODO figure out if type is nullable or not
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Metadata metadata = method.getDeclaringClass().getAnnotation(Metadata.class)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Find the entry for method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Determine if return type is nullable or not
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      adapterType <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>ParameterizedTypeImpl</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      annotations <span style=color:#f92672>=</span> SkipCallbackExecutorImpl<span style=color:#f92672>.</span><span style=color:#a6e22e>ensurePresent</span><span style=color:#f92672>(</span>annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      adapterType <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericReturnType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> callAdapter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        createCallAdapter<span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>,</span> adapterType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Type responseType <span style=color:#f92672>=</span> callAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>responseType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responseType <span style=color:#f92672>==</span> okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Response</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> getRawType<span style=color:#f92672>(</span>responseType<span style=color:#f92672>).</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is not a valid response body type. Did you mean ResponseBody?&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responseType <span style=color:#f92672>==</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Response must include generic type (e.g., Response&lt;String&gt;)&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO support Unit for Kotlin?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>httpMethod</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HEAD&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>Void<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>responseType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;HEAD method must use Void as response type.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> ResponseT<span style=color:#f92672>&gt;</span> responseConverter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        createResponseConverter<span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>,</span> responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> callFactory <span style=color:#f92672>=</span> retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>callFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// isKotlinSuspendFunction和continuationWantsResponse默认为false，所以返回的是SuspendForBody
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isKotlinSuspendFunction<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CallAdapted<span style=color:#f92672>&lt;&gt;(</span>requestFactory<span style=color:#f92672>,</span> callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>,</span> callAdapter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>continuationWantsResponse<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;)</span> <span style=color:#66d9ef>new</span> SuspendForResponse<span style=color:#f92672>&lt;&gt;(</span>requestFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;)</span> callAdapter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;)</span> <span style=color:#66d9ef>new</span> SuspendForBody<span style=color:#f92672>&lt;&gt;(</span>requestFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;)</span> callAdapter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          continuationBodyNullable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Retrofit的create方法调用了loadServiceMethod(method).invoke(args != null ? args : emptyArgs);
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 此处的invoke即HttpServiceMethod的invoke方法，这里创建了OkHttpCall，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 此处的adapt即SuspendForBody的adapt方法，而SuspendForBody的adapt方法调用了callAdapter的adapt方法，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 最终回到了我们在Retrofit初始化时使用的DefaultCallAdapterFactory的adapt方法，如果我们使用其他callAdapter，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 比如RxJava2CallAdapterFactory，那么返回值就是RxJava2CallAdapterFactory的adapt方法的返回值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> ReturnT <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> call <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpCall<span style=color:#f92672>&lt;&gt;(</span>requestFactory<span style=color:#f92672>,</span> args<span style=color:#f92672>,</span> callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> adapt<span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// DefaultCallAdapterFactory.java 返回了一个Call ExecutorCallbackCall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Call<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> executor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>?</span> call
</span></span><span style=display:flex><span>            <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> ExecutorCallbackCall<span style=color:#f92672>&lt;&gt;(</span>executor<span style=color:#f92672>,</span> call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExecutorCallbackCall</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Executor callbackExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ExecutorCallbackCall<span style=color:#f92672>(</span>Executor callbackExecutor<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> delegate<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callbackExecutor</span> <span style=color:#f92672>=</span> callbackExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>delegate</span> <span style=color:#f92672>=</span> delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ExecutorCallbackCall是通过callbackExecutor执行Runnable，还记得在Platform类中的Android内部类的默认Executor吗，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// MainThreadExecutor，所以后续调用call.enqueue时都是在这里处理的，而且delegate为OkHttpCall，OkHttpCall执行enqueue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Callback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      checkNotNull<span style=color:#f92672>(</span>callback<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;callback == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          callbackExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Emulate OkHttp&#39;s behavior of throwing/delivering an IOException on cancellation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>ExecutorCallbackCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> IOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Canceled&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>ExecutorCallbackCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          callbackExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>ExecutorCallbackCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isExecuted</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>isExecuted</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cancel</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CloneDoesntCallSuperClone&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// Performing deep clone.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>clone</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ExecutorCallbackCall<span style=color:#f92672>&lt;&gt;(</span>callbackExecutor<span style=color:#f92672>,</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Request <span style=color:#a6e22e>request</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过上述代码，<code>Api api = retrofit.create(Api.class);</code>主要还是通过代理反射创建了Api接口的实例，后续直接调用<code>api.getNowWeather("beijing", KEY);</code>就可以构造一个Call对象；在retrofit.create的过程中需要通过ServiceMethod以及初始化的Retrofit对象对Method的注解进行解析，转换为HttpServiceMethod对象进行请求适配，包括处理response body数据以及修改Call类型等等，然后构建OkHttpCall，返回ExecutorCallbackCall，所以后续OkHttpCall的enqueue方法可以进行回调。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// OkHttpCall.java 继承自Call，这里执行的代码非常类似OkHttp的RealCall类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Callback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    checkNotNull<span style=color:#f92672>(</span>callback<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;callback == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> call<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Throwable failure<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>executed<span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Already executed.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      executed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      call <span style=color:#f92672>=</span> rawCall<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      failure <span style=color:#f92672>=</span> creationFailure<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>call <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> failure <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 我们需要把this，也就是OkHttpCall转换为OkHttpClient接受的Call，所以需要OkHttp的callFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          call <span style=color:#f92672>=</span> rawCall <span style=color:#f92672>=</span> createRawCall<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          throwIfFatal<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          failure <span style=color:#f92672>=</span> creationFailure <span style=color:#f92672>=</span> t<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>failure <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> failure<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>canceled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      call<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 这里就直接使用了OkHttp的enqueue方法，然后再onResponse中处理rawResponse，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 通过parseResponse将返回的response body转为我们定义的数据，比如json-&gt;WeatherEntity
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 所以回调函数的结果包括Response&lt;WeatherEntity&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Callback</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> call<span style=color:#f92672>,</span> okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Response</span> rawResponse<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          response <span style=color:#f92672>=</span> parseResponse<span style=color:#f92672>(</span>rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          throwIfFatal<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          callFailure<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 回调函数传出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>OkHttpCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          throwIfFatal<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          t<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span> <span style=color:#75715e>// TODO this is not great
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> call<span style=color:#f92672>,</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        callFailure<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>callFailure</span><span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>OkHttpCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          throwIfFatal<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          t<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span> <span style=color:#75715e>// TODO this is not great
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 将Call转换为OkHttp的Call，requestFactory.create(args)会构造RequestBuilder，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// RequestBuilder就是将我们之前保存在各种对象中的参数拿出来组建出一个Http请求，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// callFactory就是OkHttpClient对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> <span style=color:#a6e22e>createRawCall</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> call <span style=color:#f92672>=</span> callFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>requestFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>args<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>call <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Call.Factory returned null.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> call<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>parseResponse</span><span style=color:#f92672>(</span>okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Response</span> rawResponse<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ResponseBody rawBody <span style=color:#f92672>=</span> rawResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove the body&#39;s source (the only stateful object) so we can pass the response along.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rawResponse <span style=color:#f92672>=</span> rawResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> NoContentResponseBody<span style=color:#f92672>(</span>rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>contentType</span><span style=color:#f92672>(),</span> rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>()))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> code <span style=color:#f92672>=</span> rawResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>code <span style=color:#f92672>&lt;</span> 200 <span style=color:#f92672>||</span> code <span style=color:#f92672>&gt;=</span> 300<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Buffer the entire body to avoid future I/O.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ResponseBody bufferedBody <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>buffer</span><span style=color:#f92672>(</span>rawBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>bufferedBody<span style=color:#f92672>,</span> rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>code <span style=color:#f92672>==</span> 204 <span style=color:#f92672>||</span> code <span style=color:#f92672>==</span> 205<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 一般来说数据请求正确，返回code为200，因此走这条路，注意responseConverter.convert，也就是我们使用的
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 再Retrofit初始化的converterFactories，包括我们加入的GsonConverterFactory，最终Response的body被转换为
</span></span></span><span style=display:flex><span><span style=color:#75715e>// WeatherEntity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ExceptionCatchingResponseBody catchingBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ExceptionCatchingResponseBody<span style=color:#f92672>(</span>rawBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      T body <span style=color:#f92672>=</span> responseConverter<span style=color:#f92672>.</span><span style=color:#a6e22e>convert</span><span style=color:#f92672>(</span>catchingBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>(</span>body<span style=color:#f92672>,</span> rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// If the underlying source threw an exception, propagate that rather than indicating it was
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// a runtime exception.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      catchingBody<span style=color:#f92672>.</span><span style=color:#a6e22e>throwIfCaught</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GsonConverterFactory.java 提供GsonResponseBodyConverter给Retrofit对Response进行数据转换
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GsonConverterFactory</span> <span style=color:#66d9ef>extends</span> Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Create an instance using a default {@link Gson} instance for conversion. Encoding to JSON and
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * decoding from JSON (when no charset is specified by a header) will use UTF-8.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> GsonConverterFactory <span style=color:#a6e22e>create</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> create<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Create an instance using {@code gson} for conversion. Encoding to JSON and
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * decoding from JSON (when no charset is specified by a header) will use UTF-8.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ConstantConditions&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// Guarding public API nullability.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> GsonConverterFactory <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>Gson gson<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>gson <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gson == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> GsonConverterFactory<span style=color:#f92672>(</span>gson<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Gson gson<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>GsonConverterFactory</span><span style=color:#f92672>(</span>Gson gson<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gson</span> <span style=color:#f92672>=</span> gson<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// responseBodyConverter被调用的位置是HttpServiceMethod的createResponseConverter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> responseBodyConverter<span style=color:#f92672>(</span>Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    TypeAdapter<span style=color:#f92672>&lt;?&gt;</span> adapter <span style=color:#f92672>=</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>getAdapter</span><span style=color:#f92672>(</span>TypeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>type<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> GsonResponseBodyConverter<span style=color:#f92672>&lt;&gt;(</span>gson<span style=color:#f92672>,</span> adapter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// requestBodyConverter被调用的位置在RequestFactory的parseParameterAnnotation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Converter<span style=color:#f92672>&lt;?,</span> RequestBody<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>requestBodyConverter</span><span style=color:#f92672>(</span>Type type<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Annotation<span style=color:#f92672>[]</span> parameterAnnotations<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> methodAnnotations<span style=color:#f92672>,</span> Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    TypeAdapter<span style=color:#f92672>&lt;?&gt;</span> adapter <span style=color:#f92672>=</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>getAdapter</span><span style=color:#f92672>(</span>TypeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>type<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> GsonRequestBodyConverter<span style=color:#f92672>&lt;&gt;(</span>gson<span style=color:#f92672>,</span> adapter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GsonResponseBodyConverter.java 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GsonResponseBodyConverter</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Gson gson<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> TypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> adapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  GsonResponseBodyConverter<span style=color:#f92672>(</span>Gson gson<span style=color:#f92672>,</span> TypeAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> adapter<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gson</span> <span style=color:#f92672>=</span> gson<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>adapter</span> <span style=color:#f92672>=</span> adapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// convert方法被执行的位置，也就是说通过TypeAdapter读取json数据并转换为java对象，这个具体实现需要分析Gson的源码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>convert</span><span style=color:#f92672>(</span>ResponseBody value<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    JsonReader jsonReader <span style=color:#f92672>=</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>newJsonReader</span><span style=color:#f92672>(</span>value<span style=color:#f92672>.</span><span style=color:#a6e22e>charStream</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      T result <span style=color:#f92672>=</span> adapter<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>jsonReader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>jsonReader<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> JsonToken<span style=color:#f92672>.</span><span style=color:#a6e22e>END_DOCUMENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> JsonIOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;JSON document was not fully consumed.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      value<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>除了GsonConverterFactory，还可以分析一下RxJava2CallAdapterFactory，我们知道HttpServiceMethod的invoke返回的对象即为我们调用<code>api.getNowWeather("beijing", KEY);</code>得到的对象，而这个对象是通过callAdapter调用adapt方法返回的，默认情况下是DefaultCallAdapterFactory，如果我们在Retrofit初始化时通过addCallAdapterFactory增加了其他的CallAdapterFactory比如RxJava2CallAdapterFactory，那么会通过RxJava2CallAdapterFactory调用RxJava2CallAdapter的adapt方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// RxJava2CallAdapterFactory.java RxJava2CallAdapterFactory的get方法必定返回RxJava2CallAdapter对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RxJava2CallAdapterFactory <span style=color:#a6e22e>create</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RxJava2CallAdapterFactory<span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>RxJava2CallAdapterFactory</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Scheduler scheduler<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isAsync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>scheduler</span> <span style=color:#f92672>=</span> scheduler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAsync</span> <span style=color:#f92672>=</span> isAsync<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RxJava2CallAdapter.java 所以具体的adapt方法由RxJava2CallAdapter实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 主要请求的完成过程在CallEnqueueObservable中，异步的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Observable<span style=color:#f92672>&lt;</span>Response<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;&gt;</span> responseObservable <span style=color:#f92672>=</span> isAsync
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> <span style=color:#66d9ef>new</span> CallEnqueueObservable<span style=color:#f92672>&lt;&gt;(</span>call<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> CallExecuteObservable<span style=color:#f92672>&lt;&gt;(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Observable<span style=color:#f92672>&lt;?&gt;</span> observable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ResultObservable和BodyObservable都是继承自Observable，用于返回结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isResult<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      observable <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ResultObservable<span style=color:#f92672>&lt;&gt;(</span>responseObservable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isBody<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      observable <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BodyObservable<span style=color:#f92672>&lt;&gt;(</span>responseObservable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      observable <span style=color:#f92672>=</span> responseObservable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>scheduler <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      observable <span style=color:#f92672>=</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>subscribeOn</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isFlowable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>toFlowable</span><span style=color:#f92672>(</span>BackpressureStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>LATEST</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isSingle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>singleOrError</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMaybe<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>singleElement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isCompletable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>ignoreElements</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RxJavaPlugins<span style=color:#f92672>.</span><span style=color:#a6e22e>onAssembly</span><span style=color:#f92672>(</span>observable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// CallEnqueueObservable.java 当我们得到的observable执行subscribe方法时
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 实际调用了subscribeActual方法，对应上面的CallEnqueueObservable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>subscribeActual</span><span style=color:#f92672>(</span>Observer<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> observer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Since Call is a one-shot type, clone it for each new observer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call <span style=color:#f92672>=</span> originalCall<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    CallCallback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> callback <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CallCallback<span style=color:#f92672>&lt;&gt;(</span>call<span style=color:#f92672>,</span> observer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    observer<span style=color:#f92672>.</span><span style=color:#a6e22e>onSubscribe</span><span style=color:#f92672>(</span>callback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>callback<span style=color:#f92672>.</span><span style=color:#a6e22e>isDisposed</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 这个call是在HttpServiceMethod中构建的OkHttpCall，OkHttpCall调用enqueue不必多说了吧
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>callback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>综上所述，Retrofit是一个比较灵活的网络请求框架，从设计上就是为了便于增加其他组件而设计的，首先是Api接口的设计，为了更加方便控制请求参数，通过接口加注解设计请求的url，而同时我们又不必实现此接口，通过代理反射的方式对接口实体化，相当于解耦了请求url与Retrofit实例；</p><p>其次是CallAdapter的设计，我们可以灵活的设计自己的CallAdapter用于同步或异步请求，因为在HttpServiceMethod被调用的时候是通过获取Retrofit初始化时设置的CallAdapter来实现返回，所以只需要自定义CallAdapter，我们就可以按照自己的需求处理请求的过程并拿到返回值；</p><p>然后是与Gson的联动，在拿到返回Response的时候，对json数据进行转换，并且将实体通过回调传出来，都是为了灵活使用而设计的；</p><p>最后是Retrofit与OkHttp的结合，Retrofit本质上还是调用OkHttp的请求，但是通过上述方式增加其灵活性，而且由于OkHttpCall的连接，我们一方面可以直接使用OkHttpClient，另一方面返回的Response可以直接处理，其中又包括非常多的泛型，这种设计思路真是妙啊妙啊。</p><h2 id=参考>参考：<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ol><li><a href=https://www.tutorialsteacher.com/https>HTTPS Tutorials</a></li><li><a href=http://www.ruanyifeng.com/blog/2016/08/http.html>HTTP 协议入门</a></li><li><a href=https://square.github.io/retrofit/>Retrofit</a></li><li><a href=https://square.github.io/okhttp/>OkHttp</a></li><li><a href=https://juejin.im/post/5a31db566fb9a045257820b2#heading-2>OkHttp使用详解</a></li><li><a href=https://www.baeldung.com/retrofit>Introduction to Retrofit</a></li><li><a href=https://juejin.im/post/5c9cb008e51d455ec63f7aa6>Android Retrofit 2.5.0使用基础详解</a></li><li><a href=https://juejin.im/post/5d1f2462f265da1bbc6ff5e8#heading-13>Retrofit使用拦截器添加Cookie</a></li><li><a href=https://design-patterns.readthedocs.io/zh_CN/latest/creational_patterns/simple_factory.html>Factory Pattern</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://zhoutao822.github.io/tags/https/>Https</a></li><li><a href=https://zhoutao822.github.io/tags/retrofit/>Retrofit</a></li><li><a href=https://zhoutao822.github.io/tags/okhttp/>OkHttp</a></li></ul><nav class=paginav><a class=prev href=https://zhoutao822.github.io/posts/gson/><span class=title>« Prev Page</span><br><span>Android框架-Gson</span></a>
<a class=next href=https://zhoutao822.github.io/posts/dagger2/><span class=title>Next Page »</span><br><span>Android框架-Dagger2</span></a></nav></footer><script src=https://utteranc.es/client.js repo=zhoutao822/zhoutao822.github.io issue-term=title theme=github-dark crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://zhoutao822.github.io/>Tao's Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>